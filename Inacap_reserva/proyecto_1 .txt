

################################################################################
üìÅ Carpeta: D:\todo\Universidad\4_semestre\proyecto_integrado\Backend\Reservadeaula\Inacap_reserva
################################################################################


===== manage.py =====
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'project_core.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()

============================================================


################################################################################
üìÅ Carpeta: D:\todo\Universidad\4_semestre\proyecto_integrado\Backend\Reservadeaula\Inacap_reserva\reservas
################################################################################


===== admin.py =====
from django.contrib import admin
from .models import Area, PerfilUsuario, Equipamiento, Espacio, Reserva, HistorialAprobacion, Notificacion, Mantenimiento, HorariosDisponibilidad, Incidencia

@admin.register(Area)
class AreaAdmin(admin.ModelAdmin):
    list_display = ['nombre_area', 'descripcion']
    search_fields = ['nombre_area']

@admin.register(PerfilUsuario)
class PerfilUsuarioAdmin(admin.ModelAdmin):
    list_display = ['user', 'rol', 'departamento', 'estado', 'fecha_registro']
    list_filter = ['rol', 'estado']
    search_fields = ['user__username', 'user__email', 'departamento']

@admin.register(Equipamiento)
class EquipamientoAdmin(admin.ModelAdmin):
    list_display = ['nombre_equipo', 'tipo_equipo', 'id_espacio', 'marca_modelo']
    list_filter = ['tipo_equipo']
    search_fields = ['nombre_equipo', 'marca_modelo']

@admin.register(Espacio)
class EspacioAdmin(admin.ModelAdmin):
    list_display = ['nombre', 'tipo', 'edificio', 'piso', 'capacidad', 'estado']
    list_filter = ['tipo', 'estado', 'edificio']
    search_fields = ['nombre', 'edificio']

@admin.register(Reserva)
class ReservaAdmin(admin.ModelAdmin):
    list_display = ['espacio', 'solicitante', 'fecha_reserva', 'hora_inicio', 'hora_fin', 'estado']
    list_filter = ['estado', 'fecha_reserva']
    search_fields = ['espacio__nombre', 'solicitante__username']
    date_hierarchy = 'fecha_reserva'

@admin.register(HistorialAprobacion)
class HistorialAprobacionAdmin(admin.ModelAdmin):
    list_display = ['reserva', 'usuario_admin', 'tipo_accion', 'fecha_accion']
    list_filter = ['tipo_accion', 'fecha_accion']
    search_fields = ['reserva__espacio__nombre', 'usuario_admin__username']

@admin.register(Notificacion)
class NotificacionAdmin(admin.ModelAdmin):
    list_display = ['destinatario', 'tipo', 'titulo', 'leida', 'fecha_creacion']
    list_filter = ['tipo', 'leida']
    search_fields = ['titulo', 'destinatario__username']

@admin.register(Mantenimiento)
class MantenimientoAdmin(admin.ModelAdmin):
    list_display = ['id_espacio', 'tipo_mantenimiento', 'fecha_inicio', 'fecha_fin', 'estado']
    list_filter = ['tipo_mantenimiento', 'estado']
    search_fields = ['id_espacio__nombre']

@admin.register(HorariosDisponibilidad)
class HorariosDisponibilidadAdmin(admin.ModelAdmin):
    list_display = ['id_espacio', 'dia_semana', 'hora_apertura', 'hora_cierre']
    list_filter = ['dia_semana']
    search_fields = ['id_espacio__nombre']

@admin.register(Incidencia)
class IncidenciaAdmin(admin.ModelAdmin):
    list_display = ['id_usuario', 'prioridad', 'estado', 'fecha_reporte']
    list_filter = ['prioridad', 'estado']
    search_fields = ['descripcion', 'id_usuario__username']
============================================================


===== apps.py =====
from django.apps import AppConfig

class ReservasConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'reservas'
    verbose_name = 'Sistema de Reservas'
============================================================


===== backends.py =====
from django.contrib.auth.backends import ModelBackend
from django.contrib.auth import get_user_model
from django.db.models import Q

UserModel = get_user_model()

class EmailBackend(ModelBackend):
    def authenticate(self, request, username=None, password=None, **kwargs):
        try:
            print(f"üîê Intentando autenticar: {username}")
            
            # Buscar por email o username (case insensitive)
            # CORREGIDO: Usar get() para evitar m√∫ltiples resultados
            try:
                user = UserModel.objects.get(
                    Q(email__iexact=username) | 
                    Q(username__iexact=username)
                )
            except UserModel.MultipleObjectsReturned:
                # Si hay m√∫ltiples, tomar el primero que coincida con email exacto
                user = UserModel.objects.filter(email__iexact=username).first()
                if not user:
                    # Si no hay email exacto, tomar el primero
                    user = UserModel.objects.filter(
                        Q(email__iexact=username) | 
                        Q(username__iexact=username)
                    ).first()
                print(f"‚ö†Ô∏è M√∫ltiples usuarios encontrados, usando: {user.username}")
            
            print(f"‚úÖ Usuario encontrado: {user.username}")
            
            # Verificar contrase√±a
            if user and user.check_password(password):
                if not user.is_active:
                    print(f"‚ö†Ô∏è Usuario {user.username} est√° inactivo")
                    return None
                    
                print(f"‚úÖ Contrase√±a correcta para: {user.username}")
                return user
            else:
                print(f"‚ùå Contrase√±a incorrecta para: {username}")
                return None
                
        except UserModel.DoesNotExist:
            print(f"‚ùå Usuario no encontrado: {username}")
            return None
        except Exception as e:
            print(f"‚ùå Error en autenticaci√≥n: {e}")
            return None

    def get_user(self, user_id):
        try:
            return UserModel.objects.get(pk=user_id)
        except UserModel.DoesNotExist:
            return None
============================================================


===== middleware.py =====
from django.conf import settings


class InjectThemeMiddleware:
    """Middleware que inyecta el link al CSS oscuro y el script `theme.js`
    en todas las respuestas HTML si no est√°n presentes. √ötil para asegurar
    cobertura global sin editar cada plantilla.
    """
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        print("üîß [Middleware de Tema] Se est√° ejecutando para:", request.path)  # <-- Agrega esta l√≠nea
        response = self.get_response(request)

        try:
            content_type = response.get('Content-Type', '')
            if response.status_code == 200 and 'text/html' in content_type:
                # decodificar con el charset de la respuesta o utf-8
                charset = getattr(response, 'charset', 'utf-8') or 'utf-8'
                body = response.content.decode(charset)

                modified = False

                # Si es admin, inyecta dark_admin.css, si no, dark.css
                if 'id="darkCss"' not in body:
                    if request.path.startswith('/admin'):
                        insert_link = f'<link id="darkCss" rel="stylesheet" href="{settings.STATIC_URL}css/dark_admin.css">'
                    else:
                        insert_link = f'<link id="darkCss" rel="stylesheet" href="{settings.STATIC_URL}css/dark.css" disabled>'
                    # Inline high-priority overrides inserted after page styles so they win over template CSS
                    insert_style = '''<style id="dark_overrides">html[data-theme="dark"], body.dark-theme { background-color: #071126 !important; color: #e6eef8 !important; } html[data-theme="dark"] .card, body.dark-theme .card, html[data-theme="dark"] .login-container, body.dark-theme .login-container, html[data-theme="dark"] .card-body, body.dark-theme .card-body { background-color: #0f172a !important; color: #e6eef8 !important; border-color: rgba(255,255,255,0.03) !important; } html[data-theme="dark"] table th, body.dark-theme table th, html[data-theme="dark"] table td, body.dark-theme table td { color: #cbd5e1 !important; border-color: rgba(255,255,255,0.03) !important; } </style>'''
                    insert_chunk = insert_link + '\n' + insert_style
                    if '</head>' in body:
                        body = body.replace('</head>', insert_chunk + '\n</head>')
                        modified = True

                # insertar script theme.js antes de </body> si no existe (solo para NO admin)
                if not request.path.startswith('/admin') and 'theme.js' not in body:
                    insert_script = f'<script src="{settings.STATIC_URL}js/theme.js"></script>'
                    if '</body>' in body:
                        body = body.replace('</body>', insert_script + '\n</body>')
                        modified = True

                # Forzar data-theme=dark en admin si el usuario lo seleccion√≥
                if request.path.startswith('/admin'):
                    force_theme_script = '''<script>(function(){try{if(localStorage.getItem('theme')==='dark'){document.documentElement.setAttribute('data-theme','dark');}}catch(e){}})();</script>'''
                    if '</head>' in body and 'data-theme' not in body:
                        body = body.replace('</head>', force_theme_script + '\n</head>')
                        modified = True

                # insertar un bloque de overrides al final del body para ganar sobre estilos inline en body
                if 'id="dark_overrides_body"' not in body:
                    # Este bloque incluye una regla final muy agresiva que fuerza fondos oscuros
                    # en casi todos los elementos (excluye im√°genes y v√≠deos) para convertir
                    # cualquier fondo blanco a oscuro sin tocar el color del texto.
                    body_overrides = '''<style id="dark_overrides_body">html[data-theme="dark"], body.dark-theme { background-color:#071126 !important; color:#e6eef8 !important; } html[data-theme="dark"] [class*="card"], body.dark-theme [class*="card"], html[data-theme="dark"] [class*="panel"], body.dark-theme [class*="panel"], html[data-theme="dark"] [class*="white"], body.dark-theme [class*="white"], html[data-theme="dark"] [style*="#fff"], body.dark-theme [style*="#fff"], html[data-theme="dark"] [style*="background: white"], body.dark-theme [style*="background: white"], html[data-theme="dark"] table td, body.dark-theme table td { background-color: #0f172a !important; color: #e6eef8 !important; border-color: rgba(255,255,255,0.03) !important; }</style>'''
                    if '</body>' in body:
                        body = body.replace('</body>', body_overrides + '\n</body>')
                        modified = True

                if modified:
                    response.content = body.encode(charset)
                    if response.get('Content-Length'):
                        response['Content-Length'] = len(response.content)
        except Exception:
            # no romper la respuesta si ocurre algo; solo loguear si es necesario
            pass

        return response

============================================================


===== models.py =====
from django.db import models
from django.contrib.auth.models import User
from django.utils import timezone
from django.contrib.auth.hashers import make_password, check_password
from datetime import timedelta

class Area(models.Model):
    nombre_area = models.CharField(max_length=100)
    descripcion = models.TextField(blank=True, null=True)
    
    def __str__(self):
        return self.nombre_area

class PerfilUsuario(models.Model):
    ROL_CHOICES = (
        ('SuperAdmin', 'SuperAdmin'),
        ('Usuario', 'Usuario'),
        ('Docente', 'Docente'),
        ('Investigacion', 'Investigaci√≥n'),  # Cambiado
        ('Administrativo', 'Administrativo'),  # Nuevo rol
        ('Aprobador', 'Aprobador')
    )
    
    ESTADO_CHOICES = (
        ('activo', 'Activo'),
        ('inactivo', 'Inactivo'),
        ('suspendido', 'Suspendido')
    )
    
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    rol = models.CharField(max_length=50, choices=ROL_CHOICES, default='Usuario')
    area = models.ForeignKey(Area, on_delete=models.SET_NULL, null=True, blank=True)
    departamento = models.CharField(max_length=100, blank=True, null=True)
    estado = models.CharField(max_length=50, choices=ESTADO_CHOICES, default='activo')
    fecha_registro = models.DateTimeField(auto_now_add=True)
    ultimo_acceso = models.DateTimeField(null=True, blank=True)
    
    def __str__(self):
        return f"{self.user.username} ({self.rol})"

class Espacio(models.Model):
    ESTADO_CHOICES = (
        ('Disponible', 'Disponible'),
        ('Mantenimiento', 'Mantenimiento'),
        ('Fuera de Servicio', 'Fuera de Servicio'),
    )
    
    TIPO_CHOICES = (
        ('Sala de Reuniones', 'Sala de Reuniones'),
        ('Auditorio', 'Auditorio'),
        ('Laboratorio', 'Laboratorio'),
        ('Oficina', 'Oficina'),
        ('Aula', 'Aula'),
    )
    
    nombre = models.CharField(max_length=100)
    tipo = models.CharField(max_length=100, choices=TIPO_CHOICES)
    edificio = models.CharField(max_length=100, blank=True, null=True)
    piso = models.IntegerField(blank=True, null=True)
    capacidad = models.IntegerField()
    descripcion = models.TextField(blank=True, null=True)
    estado = models.CharField(max_length=50, choices=ESTADO_CHOICES, default='Disponible')
    
    def __str__(self):
        return self.nombre
    
class Equipamiento(models.Model):
    TIPO_EQUIPO_CHOICES = (
        ('Proyector', 'Proyector'),
        ('Computador', 'Computador'),
        ('Audio', 'Sistema de Audio'),
        ('Video', 'Sistema de Video'),
        ('Mobiliario', 'Mobiliario'),
    )
    
    id_espacio = models.ForeignKey(Espacio, on_delete=models.CASCADE, related_name='equipamientos')
    nombre_equipo = models.CharField(max_length=100)
    tipo_equipo = models.CharField(max_length=100, choices=TIPO_EQUIPO_CHOICES)
    marca_modelo = models.CharField(max_length=255, blank=True, null=True)
    numero_serie = models.CharField(max_length=100, blank=True, null=True)
    
    def __str__(self):
        return self.nombre_equipo

class Reserva(models.Model):
    ESTADO_CHOICES = (
        ('Pendiente', 'Pendiente'),
        ('Aprobada', 'Aprobada'),
        ('Rechazada', 'Rechazada'),
        ('Cancelada', 'Cancelada'),
    )
    
    espacio = models.ForeignKey(Espacio, on_delete=models.CASCADE)
    solicitante = models.ForeignKey(User, on_delete=models.CASCADE, related_name='reservas_solicitadas')
    fecha_reserva = models.DateField()
    hora_inicio = models.TimeField()
    hora_fin = models.TimeField()
    proposito = models.TextField()
    num_asistentes = models.IntegerField()
    estado = models.CharField(max_length=50, choices=ESTADO_CHOICES, default='Pendiente')
    fecha_solicitud = models.DateTimeField(auto_now_add=True)
    id_aprobador = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, blank=True, related_name='reservas_aprobadas')
    comentario_admin = models.TextField(blank=True, null=True)
    
    def __str__(self):
        return f"Reserva de {self.espacio.nombre} por {self.solicitante.username}"

class HistorialAprobacion(models.Model):
    TIPO_ACCION_CHOICES = (
        ('Aprobada', 'Aprobada'),
        ('Rechazada', 'Rechazada'),
        ('Cancelada', 'Cancelada'),
    )
    
    reserva = models.ForeignKey(Reserva, on_delete=models.CASCADE)
    usuario_admin = models.ForeignKey(User, on_delete=models.CASCADE)
    tipo_accion = models.CharField(max_length=50, choices=TIPO_ACCION_CHOICES)
    fecha_accion = models.DateField(auto_now_add=True)
    hora_accion = models.TimeField(auto_now_add=True)
    motivo = models.TextField(blank=True, null=True)
    
    def __str__(self):
        return f"Aprobaci√≥n {self.tipo_accion} - Reserva {self.reserva.id}"

class Notificacion(models.Model):
    TIPO_CHOICES = (
        ('reserva_aprobada', 'Reserva Aprobada'),
        ('reserva_rechazada', 'Reserva Rechazada'),
        ('reserva_cancelada', 'Reserva Cancelada'),
        ('reserva_pendiente', 'Reserva Pendiente'),
        ('reserva_creada', 'Reserva Creada'),
        ('mantenimiento', 'Mantenimiento'),
        ('incidencia', 'Incidencia'),
        ('sistema', 'Sistema'),
    )
    
    destinatario = models.ForeignKey(User, on_delete=models.CASCADE, related_name='notificaciones')
    tipo = models.CharField(max_length=100, choices=TIPO_CHOICES)
    titulo = models.CharField(max_length=255)
    mensaje = models.TextField()
    leida = models.BooleanField(default=False)
    fecha_creacion = models.DateTimeField(auto_now_add=True)
    fecha_lectura = models.DateTimeField(null=True, blank=True)
    reserva = models.ForeignKey('Reserva', on_delete=models.CASCADE, null=True, blank=True, related_name='notificaciones')  # A√±adido related_name
    
    def __str__(self):
        return self.titulo
    
    def get_fecha_creacion_formateada(self):
        """Retorna la fecha formateada de manera legible"""
        return self.fecha_creacion.strftime('%d/%m/%Y %H:%M')
    
    def marcar_como_leida(self):
        """Marca la notificaci√≥n como le√≠da"""
        self.leida = True
        self.fecha_lectura = timezone.now()
        self.save()
    
    class Meta:
        ordering = ['-fecha_creacion']
        verbose_name = 'Notificaci√≥n'
        verbose_name_plural = 'Notificaciones'
    
    def get_fecha_creacion_formateada(self):
        """Retorna la fecha formateada de manera legible"""
        return self.fecha_creacion.strftime('%d/%m/%Y %H:%M')
    
    def marcar_como_leida(self):
        """Marca la notificaci√≥n como le√≠da"""
        self.leida = True
        self.fecha_lectura = timezone.now()
        self.save()
    
    class Meta:
        ordering = ['-fecha_creacion']
        verbose_name = 'Notificaci√≥n'
        verbose_name_plural = 'Notificaciones'

class NotificacionAdmin(models.Model):
    TIPO_CHOICES = (
        ('reserva_creada', 'Nueva Reserva Creada'),
        ('reserva_aprobada', 'Reserva Aprobada'),
        ('reserva_rechazada', 'Reserva Rechazada'),
        ('reserva_cancelada', 'Reserva Cancelada'),
        ('usuario_registrado', 'Nuevo Usuario Registrado'),
        ('espacio_creado', 'Espacio Creado'),
        ('espacio_editado', 'Espacio Editado'), 
        ('espacio_eliminado', 'Espacio Eliminado'),
        ('incidencia_reportada', 'Incidencia Reportada'),
        ('reporte_generado', 'Reporte Generado'),
        ('sesion_iniciada', 'Sesi√≥n de Admin Iniciada'),
        ('sesion_cerrada', 'Sesi√≥n de Admin Cerrada'),
        ('sistema', 'Evento del Sistema'),
    )
    
    PRIORIDAD_CHOICES = (
        ('baja', 'Baja'),
        ('media', 'Media'),
        ('alta', 'Alta'),
        ('urgente', 'Urgente'),
    )
    
    tipo = models.CharField(max_length=100, choices=TIPO_CHOICES)
    titulo = models.CharField(max_length=255)
    mensaje = models.TextField()
    prioridad = models.CharField(max_length=50, choices=PRIORIDAD_CHOICES, default='media')
    leida = models.BooleanField(default=False)
    fecha_creacion = models.DateTimeField(auto_now_add=True)
    fecha_lectura = models.DateTimeField(null=True, blank=True)
    
    # Campos espec√≠ficos para diferentes tipos de eventos
    usuario_relacionado = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, blank=True, related_name='notificaciones_admin_usuario')
    reserva = models.ForeignKey('Reserva', on_delete=models.SET_NULL, null=True, blank=True, related_name='notificaciones_admin_reserva')
    espacio = models.ForeignKey('Espacio', on_delete=models.SET_NULL, null=True, blank=True, related_name='notificaciones_admin_espacio')
    
    # Metadata adicional
    ip_address = models.GenericIPAddressField(null=True, blank=True)
    user_agent = models.TextField(blank=True, null=True)
    
    def __str__(self):
        return f"Admin Notif: {self.titulo}"
    
    def get_fecha_creacion_formateada(self):
        """Retorna la fecha formateada de manera legible"""
        return self.fecha_creacion.strftime('%d/%m/%Y %H:%M:%S')
    
    def marcar_como_leida(self):
        """Marca la notificaci√≥n como le√≠da"""
        self.leida = True
        self.fecha_lectura = timezone.now()
        self.save()
    
    class Meta:
        ordering = ['-fecha_creacion']
        verbose_name = 'Notificaci√≥n de Administrador'
        verbose_name_plural = 'Notificaciones de Administrador'


class OneTimePassword(models.Model):
    """Token/contrase√±a temporal de un solo uso para recuperaci√≥n.

    Almacena el hash del token temporal y controla expiraci√≥n/uso.
    """
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='one_time_passwords')
    token_hash = models.CharField(max_length=255)
    created_at = models.DateTimeField(auto_now_add=True)
    expires_at = models.DateTimeField()
    used = models.BooleanField(default=False)

    def is_valid(self):
        return (not self.used) and (self.expires_at >= timezone.now())

    def mark_used(self):
        self.used = True
        self.save()

    @classmethod
    def create_for_user(cls, user, raw_token, ttl_minutes=60):
        expires = timezone.now() + timedelta(minutes=ttl_minutes)
        return cls.objects.create(user=user, token_hash=make_password(raw_token), expires_at=expires)

    def check_token(self, raw_token):
        return check_password(raw_token, self.token_hash)

class Mantenimiento(models.Model):
    ESTADO_CHOICES = (
        ('Programado', 'Programado'),
        ('En Proceso', 'En Proceso'),
        ('Completado', 'Completado'),
        ('Cancelado', 'Cancelado'),
    )
    
    TIPO_MANTENIMIENTO_CHOICES = (
        ('Preventivo', 'Preventivo'),
        ('Correctivo', 'Correctivo'),
        ('Urgente', 'Urgente'),
    )
    
    id_espacio = models.ForeignKey(Espacio, on_delete=models.CASCADE)
    tipo_mantenimiento = models.CharField(max_length=100, choices=TIPO_MANTENIMIENTO_CHOICES)
    fecha_inicio = models.DateField()
    fecha_fin = models.DateField()
    estado = models.CharField(max_length=50, choices=ESTADO_CHOICES)
    hora_inicio = models.TimeField()
    hora_fin = models.TimeField()
    
    def __str__(self):
        return f"Mantenimiento {self.tipo_mantenimiento} - {self.id_espacio.nombre}"

class HorariosDisponibilidad(models.Model):
    DIA_SEMANA_CHOICES = (
        ('Lunes', 'Lunes'),
        ('Martes', 'Martes'),
        ('Mi√©rcoles', 'Mi√©rcoles'),
        ('Jueves', 'Jueves'),
        ('Viernes', 'Viernes'),
        ('S√°bado', 'S√°bado'),
        ('Domingo', 'Domingo'),
    )
    
    id_espacio = models.ForeignKey(Espacio, on_delete=models.CASCADE)
    dia_semana = models.CharField(max_length=20, choices=DIA_SEMANA_CHOICES)
    hora_apertura = models.TimeField()
    hora_cierre = models.TimeField()
    fecha_inicio_vigencia = models.DateField()
    bloques_disponibles = models.IntegerField(default=1)
    fecha_registro = models.DateTimeField(auto_now_add=True)
    
    def __str__(self):
        return f"{self.id_espacio.nombre} - {self.dia_semana}"

class Incidencia(models.Model):
    PRIORIDAD_CHOICES = (
        ('Baja', 'Baja'),
        ('Media', 'Media'),
        ('Alta', 'Alta'),
        ('Cr√≠tica', 'Cr√≠tica'),
    )
    
    ESTADO_CHOICES = (
        ('Reportada', 'Reportada'),
        ('En Proceso', 'En Proceso'),
        ('Resuelta', 'Resuelta'),
        ('Cerrada', 'Cerrada'),
    )
    
    id_usuario = models.ForeignKey(User, on_delete=models.CASCADE, related_name='incidencias_reportadas')
    id_espacio = models.ForeignKey(Espacio, on_delete=models.SET_NULL, null=True, blank=True)
    id_equipo = models.ForeignKey(Equipamiento, on_delete=models.SET_NULL, null=True, blank=True)
    descripcion = models.TextField()
    prioridad = models.CharField(max_length=50, choices=PRIORIDAD_CHOICES, default='Media')
    estado = models.CharField(max_length=50, choices=ESTADO_CHOICES, default='Reportada')
    fecha_reporte = models.DateTimeField(auto_now_add=True)
    fecha_resolucion = models.DateTimeField(null=True, blank=True)
    acciones_tomadas = models.TextField(blank=True, null=True)
    responsable = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, blank=True, related_name='incidencias_asignadas')
    observaciones = models.TextField(blank=True, null=True)
    
    def __str__(self):
        return f"Incidencia {self.id} - {self.descripcion[:50]}"
============================================================


===== serializers.py =====
from rest_framework import serializers
from django.contrib.auth.models import User
from .models import Espacio, Reserva, PerfilUsuario, Equipamiento, Area, Notificacion, HistorialAprobacion

class UserSerializer(serializers.ModelSerializer):
    class Meta:
        model = User
        fields = ['id', 'username', 'first_name', 'last_name', 'email']

class PerfilUsuarioSerializer(serializers.ModelSerializer):
    user = UserSerializer(read_only=True)
    area_nombre = serializers.CharField(source='area.nombre_area', read_only=True)
    class Meta:
        model = PerfilUsuario
        fields = ['id', 'user', 'rol', 'area', 'area_nombre']

class EquipamientoSerializer(serializers.ModelSerializer):
    class Meta:
        model = Equipamiento
        fields = '__all__'

class AreaSerializer(serializers.ModelSerializer):
    class Meta:
        model = Area
        fields = '__all__'

class EspacioSerializer(serializers.ModelSerializer):
    equipamiento = EquipamientoSerializer(many=True, read_only=True)
    class Meta:
        model = Espacio
        fields = ['id', 'nombre', 'tipo', 'capacidad', 'descripcion', 'estado', 'equipamiento']

class ReservaSerializer(serializers.ModelSerializer):
    espacio_nombre = serializers.CharField(source='espacio.nombre', read_only=True)
    solicitante_nombre = serializers.CharField(source='solicitante.username', read_only=True)
    class Meta:
        model = Reserva
        fields = [
            'id', 'espacio', 'espacio_nombre', 'solicitante', 'solicitante_nombre',
            'fecha_reserva', 'hora_inicio', 'hora_fin', 'proposito',
            'num_asistentes', 'estado', 'fecha_solicitud'
        ]

class NotificacionSerializer(serializers.ModelSerializer):
    espacio_nombre = serializers.CharField(source='reserva.espacio.nombre', read_only=True, allow_null=True)
    fecha_creacion_formateada = serializers.CharField(source='get_fecha_creacion_formateada', read_only=True)
    
    class Meta:
        model = Notificacion
        fields = [
            'id', 'tipo', 'titulo', 'mensaje', 'leida', 'fecha_creacion', 
            'fecha_creacion_formateada', 'reserva', 'espacio_nombre'
        ]
        read_only_fields = ['fecha_creacion']

class HistorialAprobacionSerializer(serializers.ModelSerializer):
    admin_nombre = serializers.CharField(source='usuario_admin.username', read_only=True)
    class Meta:
        model = HistorialAprobacion
        fields = '__all__'
============================================================


===== services.py =====
from django.utils import timezone
from .models import Notificacion, Reserva, NotificacionAdmin
from django.contrib.auth.models import User


class NotificacionService:
    
    @staticmethod
    def crear_notificacion(destinatario, tipo, titulo, mensaje, reserva=None):
        """
        Crea una notificaci√≥n gen√©rica
        """
        try:
            notificacion = Notificacion.objects.create(
                destinatario=destinatario,
                tipo=tipo,
                titulo=titulo,
                mensaje=mensaje,
                reserva=reserva
            )
            print(f"üìß Notificaci√≥n creada: {titulo} para {destinatario.username}")
            return notificacion
        except Exception as e:
            print(f"‚ùå Error creando notificaci√≥n: {e}")
            return None
    
    @staticmethod
    def crear_notificacion_reserva(reserva, tipo, titulo, mensaje):
        """
        Crea una notificaci√≥n relacionada con una reserva
        """
        try:
            return NotificacionService.crear_notificacion(
                destinatario=reserva.solicitante,
                tipo=tipo,
                titulo=titulo,
                mensaje=mensaje,
                reserva=reserva
            )
        except Exception as e:
            print(f"‚ùå Error en crear_notificacion_reserva: {e}")
            return None
    
    @staticmethod
    def notificar_creacion_reserva(reserva):
        """
        Notifica al usuario que su reserva fue creada exitosamente
        """
        try:
            mensaje = f"Tu solicitud de reserva para {reserva.espacio.nombre} el {reserva.fecha_reserva.strftime('%d/%m/%Y')} de {reserva.hora_inicio.strftime('%H:%M')} a {reserva.hora_fin.strftime('%H:%M')} ha sido recibida y est√° pendiente de aprobaci√≥n."
            
            notificacion = NotificacionService.crear_notificacion_reserva(
                reserva=reserva,
                tipo='reserva_creada',
                titulo='üìã Reserva Creada Exitosamente',
                mensaje=mensaje
            )
            
            if notificacion:
                print(f"‚úÖ Notificaci√≥n de creaci√≥n enviada para reserva {reserva.id}")
            else:
                print(f"‚ùå Fall√≥ notificaci√≥n de creaci√≥n para reserva {reserva.id}")
                
            return notificacion
        except Exception as e:
            print(f"‚ùå Error en notificar_creacion_reserva: {e}")
            return None
    
    @staticmethod
    def notificar_aprobacion_reserva(reserva, comentario_admin=None):
        """
        Notifica al usuario que su reserva fue aprobada - VERSI√ìN CORREGIDA
        """
        try:
            mensaje = f"‚úÖ Tu reserva para {reserva.espacio.nombre} el {reserva.fecha_reserva.strftime('%d/%m/%Y')} ha sido APROBADA."
            if comentario_admin:
                mensaje += f"\n\nComentario del administrador: {comentario_admin}"
            
            # Verificar si ya existe una notificaci√≥n similar
            notificacion_existente = Notificacion.objects.filter(
                destinatario=reserva.solicitante,
                tipo='reserva_aprobada',
                reserva=reserva,
                fecha_creacion__gte=timezone.now() - timezone.timedelta(minutes=5)
            ).exists()
            
            if notificacion_existente:
                print(f"‚ö†Ô∏è Notificaci√≥n de aprobaci√≥n duplicada evitada para reserva {reserva.id}")
                return None
            
            notificacion = NotificacionService.crear_notificacion_reserva(
                reserva=reserva,
                tipo='reserva_aprobada',
                titulo='‚úÖ Reserva Aprobada',
                mensaje=mensaje
            )
            
            if notificacion:
                print(f"‚úÖ Notificaci√≥n de aprobaci√≥n enviada para reserva {reserva.id}")
            else:
                print(f"‚ùå Fall√≥ notificaci√≥n de aprobaci√≥n para reserva {reserva.id}")
                
            return notificacion
        except Exception as e:
            print(f"‚ùå Error en notificar_aprobacion_reserva: {e}")
            return None
        
    @staticmethod
    def notificar_rechazo_reserva(reserva, motivo):
        """
        Notifica al usuario que su reserva fue rechazada - VERSI√ìN CORREGIDA
        """
        try:
            mensaje = f"‚ùå Tu reserva para {reserva.espacio.nombre} el {reserva.fecha_reserva.strftime('%d/%m/%Y')} ha sido RECHAZADA.\n\nMotivo: {motivo}"
            
            notificacion = NotificacionService.crear_notificacion_reserva(
                reserva=reserva,
                tipo='reserva_rechazada',
                titulo='‚ùå Reserva Rechazada',
                mensaje=mensaje
            )
            
            if notificacion:
                print(f"‚úÖ Notificaci√≥n de rechazo enviada para reserva {reserva.id}")
            else:
                print(f"‚ùå Fall√≥ notificaci√≥n de rechazo para reserva {reserva.id}")
                
            return notificacion
        except Exception as e:
            print(f"‚ùå Error en notificar_rechazo_reserva: {e}")
            return None
    
    # Los dem√°s m√©todos permanecen igual...
    @staticmethod
    def notificar_cancelacion_reserva(reserva, motivo=None):
        """Notifica al usuario que su reserva fue cancelada"""
        try:
            mensaje = f"üìù Tu reserva para {reserva.espacio.nombre} el {reserva.fecha_reserva.strftime('%d/%m/%Y')} ha sido CANCELADA."
            if motivo:
                mensaje += f"\n\nMotivo: {motivo}"
            
            return NotificacionService.crear_notificacion_reserva(
                reserva=reserva,
                tipo='reserva_cancelada',
                titulo='üìù Reserva Cancelada',
                mensaje=mensaje
            )
        except Exception as e:
            print(f"‚ùå Error en notificar_cancelacion_reserva: {e}")
            return None

    @staticmethod
    def obtener_notificaciones_usuario(usuario, no_leidas=False, limite=10):
        """Obtiene las notificaciones de un usuario"""
        try:
            notificaciones = Notificacion.objects.filter(destinatario=usuario)
            
            if no_leidas:
                notificaciones = notificaciones.filter(leida=False)
            
            return notificaciones.select_related('reserva', 'reserva__espacio').order_by('-fecha_creacion')[:limite]
        except Exception as e:
            print(f"‚ùå Error en obtener_notificaciones_usuario: {e}")
            return []
    
    @staticmethod
    def marcar_como_leida(notificacion_id):
        """
        Marca una notificaci√≥n espec√≠fica como le√≠da
        """
        try:
            notificacion = Notificacion.objects.get(id=notificacion_id)
            notificacion.marcar_como_leida()
            return True
        except Notificacion.DoesNotExist:
            return False
    
    @staticmethod
    def marcar_todas_como_leidas(usuario):
        """
        Marca todas las notificaciones de un usuario como le√≠das
        """
        notificaciones = Notificacion.objects.filter(
            destinatario=usuario, 
            leida=False
        )
        
        count = notificaciones.count()
        notificaciones.update(leida=True, fecha_lectura=timezone.now())
        
        print(f"üì≠ Marcadas {count} notificaciones como le√≠das para {usuario.username}")
        return count
    
    @staticmethod
    def contar_notificaciones_no_leidas(usuario):
        """
        Cuenta las notificaciones no le√≠das de un usuario
        """
        return Notificacion.objects.filter(
            destinatario=usuario,
            leida=False
        ).count()

class NotificacionAdminService:
    
    @staticmethod
    def crear_notificacion_admin(tipo, titulo, mensaje, prioridad='media', usuario_relacionado=None, 
                               reserva=None, espacio=None, request=None):
        """
        Crea una notificaci√≥n para administradores
        """
        try:
            notificacion = NotificacionAdmin.objects.create(
                tipo=tipo,
                titulo=titulo,
                mensaje=mensaje,
                prioridad=prioridad,
                usuario_relacionado=usuario_relacionado,
                reserva=reserva,
                espacio=espacio
            )
            
            # Agregar informaci√≥n de la solicitud si est√° disponible
            if request:
                notificacion.ip_address = get_client_ip(request)
                notificacion.user_agent = request.META.get('HTTP_USER_AGENT', '')
                notificacion.save()
            
            print(f"üì¢ Notificaci√≥n Admin creada: {titulo}")
            return notificacion
            
        except Exception as e:
            print(f"‚ùå Error creando notificaci√≥n admin: {e}")
            return None
    
    @staticmethod
    def notificar_nueva_reserva(reserva, request=None):
        """Notifica a los admin sobre nueva reserva"""
        mensaje = f"El usuario {reserva.solicitante.username} ha creado una nueva reserva para {reserva.espacio.nombre} el {reserva.fecha_reserva.strftime('%d/%m/%Y')} de {reserva.hora_inicio.strftime('%H:%M')} a {reserva.hora_fin.strftime('%H:%M')}."
        
        return NotificacionAdminService.crear_notificacion_admin(
            tipo='reserva_creada',
            titulo='üìã Nueva Reserva Creada',
            mensaje=mensaje,
            prioridad='alta',
            usuario_relacionado=reserva.solicitante,
            reserva=reserva,
            request=request
        )
    
    @staticmethod
    def notificar_usuario_registrado(usuario, request=None):
        """Notifica a los admin sobre nuevo usuario registrado"""
        mensaje = f"El usuario {usuario.username} ({usuario.first_name} {usuario.last_name}) se ha registrado en el sistema."
        
        return NotificacionAdminService.crear_notificacion_admin(
            tipo='usuario_registrado',
            titulo='üë§ Nuevo Usuario Registrado',
            mensaje=mensaje,
            prioridad='media',
            usuario_relacionado=usuario,
            request=request
        )
    
    @staticmethod
    def notificar_espacio_creado(espacio, usuario_admin, request=None):
        """Notifica a los admin sobre nuevo espacio creado"""
        mensaje = f"El administrador {usuario_admin.username} ha creado el espacio '{espacio.nombre}' ({espacio.tipo})."
        
        return NotificacionAdminService.crear_notificacion_admin(
            tipo='espacio_creado',
            titulo='üè¢ Nuevo Espacio Creado',
            mensaje=mensaje,
            prioridad='media',
            usuario_relacionado=usuario_admin,
            espacio=espacio,
            request=request
        )
    
    @staticmethod
    def notificar_sesion_admin(usuario_admin, accion, request=None):
        """Notifica sobre sesiones de administradores"""
        if accion == 'inicio':
            titulo = 'üîê Sesi√≥n de Admin Iniciada'
            mensaje = f"El administrador {usuario_admin.username} ha iniciado sesi√≥n."
            tipo = 'sesion_iniciada'
        else:  # cierre
            titulo = 'üö™ Sesi√≥n de Admin Cerrada'
            mensaje = f"El administrador {usuario_admin.username} ha cerrado sesi√≥n."
            tipo = 'sesion_cerrada'
        
        return NotificacionAdminService.crear_notificacion_admin(
            tipo=tipo,
            titulo=titulo,
            mensaje=mensaje,
            prioridad='baja',
            usuario_relacionado=usuario_admin,
            request=request
        )
    
    @staticmethod
    def notificar_accion_reserva(reserva, usuario_admin, accion, motivo=None, request=None):
        """Notifica acciones sobre reservas (aprobaci√≥n/rechazo)"""
        if accion == 'aprobada':
            titulo = '‚úÖ Reserva Aprobada'
            mensaje = f"El administrador {usuario_admin.username} ha APROBADO la reserva de {reserva.espacio.nombre} para {reserva.solicitante.username}."
            tipo = 'reserva_aprobada'
        else:  # rechazada
            titulo = '‚ùå Reserva Rechazada'
            mensaje = f"El administrador {usuario_admin.username} ha RECHAZADO la reserva de {reserva.espacio.nombre} para {reserva.solicitante.username}."
            if motivo:
                mensaje += f" Motivo: {motivo}"
            tipo = 'reserva_rechazada'
        
        return NotificacionAdminService.crear_notificacion_admin(
            tipo=tipo,
            titulo=titulo,
            mensaje=mensaje,
            prioridad='alta',
            usuario_relacionado=usuario_admin,
            reserva=reserva,
            request=request
        )

def get_client_ip(request):
    """Obtiene la IP real del cliente"""
    x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
    if x_forwarded_for:
        ip = x_forwarded_for.split(',')[0]
    else:
        ip = request.META.get('REMOTE_ADDR')
    return ip
============================================================


===== urls.py =====
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from . import views

router = DefaultRouter()
router.register(r'users', views.UserViewSet)
router.register(r'perfiles', views.PerfilUsuarioViewSet)
router.register(r'reservas', views.ReservaViewSet)
router.register(r'notificaciones', views.NotificacionViewSet)
router.register(r'historial', views.HistorialAprobacionViewSet)
router.register(r'equipamientos', views.EquipamientoViewSet)
router.register(r'areas', views.AreaViewSet)

urlpatterns = [
    # === P√ÅGINAS PRINCIPALES ===
    path('', views.login_view, name='login'),
    path('login/', views.login_view, name='login'),
    path('dashboard/', views.dashboard_view, name='dashboard'),
    path('logout/', views.logout_view, name='logout'),
    
    # === VISTAS DE USUARIO ===
    path('espacios/', views.espacios_view, name='espacios'),
    path('reservas/', views.reservas_view, name='reservas'),
    path('notificaciones/', views.notificaciones_view, name='notificaciones'),
    path('calendario/', views.calendario_view, name='calendario'),
    path('crear-reserva/', views.crear_reserva_view, name='crear_reserva'),
    path('reserva-exitosa/', views.reserva_exitosa, name='reserva_exitosa'),
    path('detalle-reserva/', views.detalle_reserva_view, name='detalle_reserva'),
    path('cancelar-reserva/', views.cancelar_reserva_view, name='cancelar_reserva'),
    
    # === VISTAS DE ADMINISTRACI√ìN ===
    path('admin-dashboard/', views.admin_dashboard_view, name='admin_dashboard'),
    path('solicitudes-pendientes/', views.solicitudes_pendientes_view, name='solicitudes_pendientes'),
    path('gestion-espacios/', views.gestion_espacios_view, name='gestion_espacios'),
    path('gestion-usuarios/', views.gestion_usuarios_view, name='gestion_usuarios'),
    path('crear-usuario/', views.crear_usuario_view, name='crear_usuario'),
    path('reportes/', views.reportes_view, name='reportes'),
    path('revisar-solicitud/', views.revisar_solicitud_view, name='revisar_solicitud'),
    path('force-logout/', views.force_logout, name='force_logout'),
    
    # === GESTI√ìN DE ESPACIOS ===
    path('crear-espacio/', views.crear_espacio_view, name='crear_espacio'),
    path('editar-espacio/', views.editar_espacio_view, name='editar_espacio'),
    
    # === GESTI√ìN DE USUARIOS ===
    path('editar-usuario/', views.editar_usuario_view, name='editar_usuario'),
    
    # === NOTIFICACIONES ADMIN ===
    path('notificaciones-admin/', views.notificaciones_admin_view, name='notificaciones_admin'),
    
    # === REPORTES ===
    path('reportes/generar-pdf/<str:tipo_reporte>/', views.generar_reporte_pdf, name='generar_reporte_pdf'),
    
    # === API ENDPOINTS ===
    path('api/', include(router.urls)),
    
    # API - Reservas
    path('api/reservas/', views.get_user_reservas, name='get_reservas'),
    path('api/crear-reserva/', views.crear_reserva_api, name='crear_reserva_api'),
    path('api/reservas/<int:reserva_id>/cancelar/', views.cancelar_reserva_api, name='cancelar_reserva_api'),
    path('api/reservas/<int:reserva_id>/aprobar/', views.aprobar_reserva_api, name='aprobar_reserva_api'),
    path('api/reservas/<int:reserva_id>/rechazar/', views.rechazar_reserva_api, name='rechazar_reserva_api'),
    
    # API - Espacios
    path('api/espacios/', views.get_espacios_disponibles, name='get_espacios'),
    path('api/espacios/crear/', views.crear_espacio_api, name='crear_espacio_api'),
    path('api/espacios/<int:espacio_id>/', views.obtener_espacio_api, name='obtener_espacio_api'),
    path('api/espacios/<int:espacio_id>/actualizar/', views.actualizar_espacio_api, name='actualizar_espacio_api'),
    path('api/espacios/<int:espacio_id>/eliminar/', views.eliminar_espacio_api, name='eliminar_espacio_api'),
    
    # API - Usuarios
    path('api/registro/', views.registro_usuario, name='registro_usuario'),
    path('api/crear-usuario/', views.crear_usuario_api, name='crear_usuario_api'),
    path('api/usuarios/filtrar/', views.filtrar_usuarios_api, name='filtrar_usuarios_api'),
    path('api/usuarios/<int:user_id>/', views.obtener_usuario_api, name='obtener_usuario_api'),
    path('api/usuarios/<int:user_id>/actualizar/', views.actualizar_usuario_api, name='actualizar_usuario_api'),
    path('api/usuarios/<int:user_id>/cambiar-estado/', views.cambiar_estado_usuario_api, name='cambiar_estado_usuario_api'),
    path('api/usuarios/<int:user_id>/cambiar-rol/', views.cambiar_rango_admin_api, name='cambiar_rango_admin_api'),
    path('api/perfiles/', views.obtener_perfiles_usuario_api, name='obtener_perfiles_usuario_api'),
    
    # API - Notificaciones
    path('api/notificaciones/', views.get_notificaciones_usuario, name='get_notificaciones'),
    path('api/notificaciones/contar/', views.contar_notificaciones_no_leidas, name='contar_notificaciones'),
    path('api/notificaciones/marcar-todas-leidas/', views.marcar_todas_leidas, name='marcar_todas_leidas'),
    path('api/notificaciones/<int:notificacion_id>/marcar-leida/', views.marcar_notificacion_leida, name='marcar_notificacion_leida'),
    
    # API - Notificaciones Admin
    path('api/notificaciones-admin/', views.get_notificaciones_admin_api, name='get_notificaciones_admin_api'),
    path('api/notificaciones-admin/contar/', views.contar_notificaciones_admin_no_leidas, name='contar_notificaciones_admin_no_leidas'),
    path('api/notificaciones-admin/marcar-todas-leidas/', views.marcar_todas_notificaciones_admin_leidas, name='marcar_todas_notificaciones_admin_leidas'),
    path('api/notificaciones-admin/<int:notificacion_id>/marcar-leida/', views.marcar_notificacion_admin_leida, name='marcar_notificacion_admin_leida'),
    
    # API - Dashboard y otros
    path('api/dashboard/stats/', views.get_dashboard_stats, name='dashboard_stats'),
    path('api/incidencias/reportar/', views.reportar_incidencia, name='reportar_incidencia'),
    
    # API - Testing
    path('api/test-notificaciones-reales/', views.test_notificaciones_reales, name='test_notificaciones_reales'),
    # === Recuperaci√≥n de contrase√±a ===
    path('forgot-password/', views.forgot_password_request_view, name='forgot_password_request'),
    path('forgot-password/sent/', views.forgot_password_sent_view, name='forgot_password_sent'),
    path('reset/<str:uidb64>/<str:token>/', views.reset_password_view, name='reset_password'),
    path('reset-otp/', views.reset_via_otp_view, name='reset_via_otp'),
]
============================================================


===== utils.py =====
from django.db.models import Q
from django.utils import timezone
from .models import Reserva, Mantenimiento, HorariosDisponibilidad
from datetime import datetime, time, date

def validar_disponibilidad_espacio(espacio_id, fecha, hora_inicio, hora_fin, reserva_excluida_id=None):
    """
    Valida que no existan reservas solapadas para el mismo espacio
    
    Args:
        espacio_id: ID del espacio a validar
        fecha: fecha de la reserva
        hora_inicio: hora de inicio
        hora_fin: hora de fin
        reserva_excluida_id: ID de reserva a excluir (para ediciones)
    
    Returns:
        tuple: (disponible, mensaje_error)
    """
    try:
        # Convertir a objetos time si son strings
        if isinstance(hora_inicio, str):
            hora_inicio = datetime.strptime(hora_inicio, '%H:%M:%S').time()
        if isinstance(hora_fin, str):
            hora_fin = datetime.strptime(hora_fin, '%H:%M:%S').time()
        
        # ======== VALIDACIONES NUEVAS ========
        
        # 1. Validar que la hora de fin sea despu√©s de la hora de inicio
        if hora_inicio >= hora_fin:
            return False, "La hora de fin debe ser posterior a la hora de inicio"
        
        # 2. Validar duraci√≥n m√≠nima (30 minutos)
        duracion_minutos = (hora_fin.hour * 60 + hora_fin.minute) - (hora_inicio.hour * 60 + hora_inicio.minute)
        if duracion_minutos < 30:
            return False, "La duraci√≥n m√≠nima de reserva es de 30 minutos"
        
        # 3. Validar duraci√≥n m√°xima (8 horas)
        if duracion_minutos > 480:
            return False, "La duraci√≥n m√°xima de reserva es de 8 horas"
        
        # ======== VALIDACIONES EXISTENTES ========
        
        # Validar reservas existentes
        reservas_query = Reserva.objects.filter(
            espacio_id=espacio_id,
            fecha_reserva=fecha,
            estado__in=['Aprobada', 'Pendiente']  # Solo considerar reservas activas
        )
        
        # Excluir la reserva actual si se est√° editando
        if reserva_excluida_id:
            reservas_query = reservas_query.exclude(id=reserva_excluida_id)
        
        # ======== CORRECCI√ìN CR√çTICA AQU√ç ========
        # Validaci√≥n CORREGIDA de solapamiento
        # Buscar reservas que SE SOLAPEN (no las que NO se solapen)
        reservas_solapadas = reservas_query.filter(
            hora_inicio__lt=hora_fin,    # La reserva existente comienza ANTES de que termine la nueva
            hora_fin__gt=hora_inicio     # La reserva existente termina DESPU√âS de que comience la nueva
        )
        
        if reservas_solapadas.exists():
            # Obtener informaci√≥n de la reserva que causa conflicto
            conflicto = reservas_solapadas.first()
            return False, f"Conflicto con reserva existente de {conflicto.hora_inicio.strftime('%H:%M')} a {conflicto.hora_fin.strftime('%H:%M')}"
        
        # Validar mantenimiento programado
        mantenimiento_activo = Mantenimiento.objects.filter(
            id_espacio_id=espacio_id,
            fecha_inicio__lte=fecha,
            fecha_fin__gte=fecha,
            estado__in=['Programado', 'En Proceso']
        ).exists()
        
        if mantenimiento_activo:
            return False, "El espacio est√° en mantenimiento en la fecha seleccionada"
        
        # Validar horarios de disponibilidad del espacio
        dia_semana = fecha.strftime('%A')
        dias_semana_es = {
            'Monday': 'Lunes',
            'Tuesday': 'Martes',
            'Wednesday': 'Mi√©rcoles',
            'Thursday': 'Jueves',
            'Friday': 'Viernes',
            'Saturday': 'S√°bado',
            'Sunday': 'Domingo'
        }
        
        dia_semana_es = dias_semana_es.get(dia_semana, dia_semana)
        
        horario_disponibilidad = HorariosDisponibilidad.objects.filter(
            id_espacio_id=espacio_id,
            dia_semana=dia_semana_es,
            fecha_inicio_vigencia__lte=fecha
        ).order_by('-fecha_inicio_vigencia').first()
        
        if horario_disponibilidad:
            if hora_inicio < horario_disponibilidad.hora_apertura:
                return False, f"El espacio abre a las {horario_disponibilidad.hora_apertura.strftime('%H:%M')}"
            
            if hora_fin > horario_disponibilidad.hora_cierre:
                return False, f"El espacio cierra a las {horario_disponibilidad.hora_cierre.strftime('%H:%M')}"
        
        return True, "El espacio est√° disponible"
        
    except Exception as e:
        return False, f"Error al validar disponibilidad: {str(e)}"

def calcular_duracion(hora_inicio, hora_fin):
    """
    Calcular la duraci√≥n en formato legible
    """
    try:
        if isinstance(hora_inicio, str):
            hora_inicio = datetime.strptime(hora_inicio, '%H:%M:%S').time()
        if isinstance(hora_fin, str):
            hora_fin = datetime.strptime(hora_fin, '%H:%M:%S').time()
        
        diferencia = datetime.combine(date.today(), hora_fin) - datetime.combine(date.today(), hora_inicio)
        horas = diferencia.seconds // 3600
        minutos = (diferencia.seconds % 3600) // 60
        
        if horas > 0:
            return f"{horas} hora{'s' if horas > 1 else ''} {minutos} minuto{'s' if minutos > 1 else ''}"
        else:
            return f"{minutos} minutos"
    except Exception as e:
        return "Duraci√≥n no disponible"

def obtener_estadisticas_uso_espacio(espacio_id, mes=None, a√±o=None):
    """
    Obtiene estad√≠sticas de uso de un espacio
    """
    if not mes:
        mes = timezone.now().month
    if not a√±o:
        a√±o = timezone.now().year
    
    reservas_mes = Reserva.objects.filter(
        espacio_id=espacio_id,
        fecha_reserva__month=mes,
        fecha_reserva__year=a√±o,
        estado='Aprobada'
    )
    
    return {
        'total_reservas': reservas_mes.count(),
        'dias_ocupados': reservas_mes.dates('fecha_reserva', 'day').count(),
        'horas_totales': sum(
            (reserva.hora_fin.hour - reserva.hora_inicio.hour) + 
            (reserva.hora_fin.minute - reserva.hora_inicio.minute) / 60 
            for reserva in reservas_mes
        )
    }

# ======== FUNCIONES NUEVAS A√ëADIDAS ========

def validar_anticipacion_reserva(fecha_reserva, hora_inicio):
    """
    Valida que la reserva tenga suficiente anticipaci√≥n
    
    Returns:
        tuple: (valido, mensaje_error)
    """
    from datetime import timedelta
    
    try:
        ahora = timezone.now()
        fecha_hora_reserva = datetime.combine(fecha_reserva, hora_inicio)
        
        # Convertir a timezone aware si no lo es
        if timezone.is_naive(fecha_hora_reserva):
            fecha_hora_reserva = timezone.make_aware(fecha_hora_reserva)
        
        # M√≠nimo 2 horas de anticipaci√≥n
        min_anticipacion = timedelta(hours=2)
        
        if fecha_hora_reserva < ahora + min_anticipacion:
            return False, "Se requiere al menos 2 horas de anticipaci√≥n para las reservas"
        
        # M√°ximo 30 d√≠as de anticipaci√≥n
        max_anticipacion = timedelta(days=30)
        if fecha_hora_reserva > ahora + max_anticipacion:
            return False, "No se pueden hacer reservas con m√°s de 30 d√≠as de anticipaci√≥n"
        
        return True, "Horario v√°lido"
        
    except Exception as e:
        return False, f"Error validando anticipaci√≥n: {str(e)}"

def validar_limite_reservas_usuario(usuario, fecha_reserva):
    """
    Valida que el usuario no exceda el l√≠mite de reservas por d√≠a
    
    Returns:
        tuple: (valido, mensaje_error)
    """
    try:
        # M√°ximo 3 reservas por d√≠a
        reservas_del_dia = Reserva.objects.filter(
            solicitante=usuario,
            fecha_reserva=fecha_reserva,
            estado__in=['Aprobada', 'Pendiente']
        ).count()
        
        if reservas_del_dia >= 3:
            return False, "L√≠mite de 3 reservas por d√≠a alcanzado"
        
        return True, "L√≠mite de reservas v√°lido"
        
    except Exception as e:
        return False, f"Error validando l√≠mite de reservas: {str(e)}"
============================================================


===== views.py =====
from rest_framework import viewsets, permissions
from django.contrib.auth.models import User
from .models import Espacio, Reserva, PerfilUsuario, Equipamiento, Area, Notificacion, HistorialAprobacion, Incidencia, NotificacionAdmin
from .serializers import (
    UserSerializer, PerfilUsuarioSerializer, EquipamientoSerializer, 
    AreaSerializer, EspacioSerializer, ReservaSerializer, 
    NotificacionSerializer, HistorialAprobacionSerializer
)
from django.shortcuts import render, redirect
from django.contrib.auth import authenticate, login, logout
from django.contrib.auth.decorators import login_required
from django.http import JsonResponse
from django.views.decorators.http import require_http_methods
from django.views.decorators.csrf import csrf_exempt
from django.utils import timezone
import json
from .models import PerfilUsuario, Reserva, Espacio, Notificacion, Incidencia, Area
from django.contrib.auth.models import User
from django.db import IntegrityError, transaction  # ‚Üê AQU√ç AGREGAR 'transaction'
from django.db.models import Q
import traceback
from .services import NotificacionService
from datetime import datetime, date, time
from django.contrib import messages
from django.contrib.auth.decorators import user_passes_test
from django.core.exceptions import PermissionDenied
from .services import NotificacionAdminService
from django.core.mail import send_mail
from django.template.loader import render_to_string
from django.utils.http import urlsafe_base64_encode, urlsafe_base64_decode
from django.utils.encoding import force_bytes, force_str
from django.contrib.auth.tokens import default_token_generator
from django.urls import reverse
import string, random
from .models import OneTimePassword
from django.contrib.auth.hashers import check_password
from datetime import timedelta

def is_admin_user(user):
    """Verifica si el usuario tiene permisos de administrador - CORREGIDO"""
    try:
        perfil = PerfilUsuario.objects.get(user=user)
        # CORREGIDO: Usar los mismos nombres que en models.py
        return perfil.rol in ['Administrativo', 'Investigaci√≥n', 'Aprobador', 'SuperAdmin']
    except PerfilUsuario.DoesNotExist:
        return False

@csrf_exempt
def crear_notificacion_tiempo_real(request):
    """
    API para crear notificaciones que se muestran inmediatamente
    """
    if request.method == 'POST':
        try:
            data = json.loads(request.body)
            
            # Crear notificaci√≥n en la base de datos
            notificacion = Notificacion.objects.create(
                destinatario=request.user,
                tipo=data['tipo'],
                titulo=data['titulo'],
                mensaje=data['mensaje'],
                leida=False
            )
            
            # En una aplicaci√≥n real, aqu√≠ enviar√≠as por WebSocket
            # Por ahora retornamos los datos para que el frontend muestre la alerta
            return JsonResponse({
                'success': True,
                'notificacion': {
                    'id': notificacion.id,
                    'tipo': notificacion.tipo,
                    'titulo': notificacion.titulo,
                    'mensaje': notificacion.mensaje,
                    'fecha_creacion_formateada': notificacion.get_fecha_creacion_formateada()
                }
            })
            
        except Exception as e:
            return JsonResponse({'success': False, 'error': str(e)})

# === FUNCIONES PARA NOTIFICACIONES DE ADMINISTRADOR ===

def notificar_accion_admin(tipo, titulo, mensaje, usuario_admin=None, usuario_relacionado=None, reserva=None, espacio=None, request=None):
    """
    Funci√≥n MEJORADA para notificaciones administrativas - EVITA DUPLICADOS
    """
    try:
        print(f"üöÄ CREANDO NOTIFICACI√ìN ADMIN: {titulo}")
        
        # Verificar si ya existe una notificaci√≥n similar reciente (evitar duplicados)
        if reserva and tipo in ['reserva_aprobada', 'reserva_rechazada']:
            notificacion_existente = NotificacionAdmin.objects.filter(
                tipo=tipo,
                reserva=reserva,
                fecha_creacion__gte=timezone.now() - timezone.timedelta(minutes=5)
            ).exists()
            
            if notificacion_existente:
                print(f"‚ö†Ô∏è Notificaci√≥n duplicada detectada y evitada: {titulo}")
                return None
        
        # Determinar prioridad seg√∫n el tipo de notificaci√≥n
        prioridad_map = {
            'reserva_creada': 'alta',
            'reserva_aprobada': 'media', 
            'reserva_rechazada': 'media',
            'reserva_cancelada': 'media',
            'usuario_registrado': 'media',
            'usuario_actualizado': 'baja',
            'usuario_eliminado': 'alta',
            'espacio_creado': 'media',
            'espacio_actualizado': 'baja',
            'espacio_eliminado': 'alta',
            'incidencia_reportada': 'alta',
            'mantenimiento_programado': 'media',
            'sesion_iniciada': 'baja',
            'sesion_cerrada': 'baja',
            'reporte_generado': 'media',
            'sistema': 'baja'
        }
        
        prioridad = prioridad_map.get(tipo, 'media')
        
        # CREAR LA NOTIFICACI√ìN REAL EN LA BASE DE DATOS
        notificacion = NotificacionAdmin.objects.create(
            tipo=tipo,
            titulo=titulo,
            mensaje=mensaje,
            prioridad=prioridad,
            usuario_relacionado=usuario_relacionado,
            reserva=reserva,
            espacio=espacio,
            leida=False
        )
        
        # Agregar informaci√≥n de la solicitud si est√° disponible
        if request:
            notificacion.ip_address = get_client_ip(request)
            notificacion.user_agent = request.META.get('HTTP_USER_AGENT', '')
            notificacion.save()
        
        print(f"‚úÖ NOTIFICACI√ìN ADMIN CREADA: ID {notificacion.id} - {titulo}")
        return notificacion
        
    except Exception as e:
        print(f"‚ùå ERROR CREANDO NOTIFICACI√ìN ADMIN: {str(e)}")
        import traceback
        traceback.print_exc()
        return None

def get_client_ip(request):
    """Obtiene la IP real del cliente"""
    x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
    if x_forwarded_for:
        ip = x_forwarded_for.split(',')[0]
    else:
        ip = request.META.get('REMOTE_ADDR')
    return ip


# === RECUPERACI√ìN DE CONTRASE√ëA ===
def _generate_temp_password(length=10):
    chars = string.ascii_letters + string.digits
    return ''.join(random.choice(chars) for _ in range(length))


@csrf_exempt
def forgot_password_request_view(request):
    """Muestra formulario para solicitar recuperaci√≥n y env√≠a contrase√±a temporal + link de restablecimiento."""
    if request.method == 'GET':
        return render(request, 'reservas/forgot_password_request.html')

    if request.method == 'POST':
        is_json = request.content_type and request.content_type.startswith('application/json')
        try:
            if is_json:
                data = json.loads(request.body) if request.body else {}
                email = (data.get('email') or '').strip()
            else:
                email = (request.POST.get('email') or '').strip()

            if not email:
                if is_json:
                    return JsonResponse({'success': False, 'message': 'Email requerido'}, status=400)
                else:
                    return render(request, 'reservas/forgot_password_request.html', {'error': 'Email requerido'})

            try:
                user = User.objects.get(email__iexact=email)

                temp_password = _generate_temp_password(12)
                OneTimePassword.create_for_user(user, temp_password, ttl_minutes=60)

                reset_link = request.build_absolute_uri(reverse('reset_via_otp'))

                subject = 'Recuperaci√≥n de contrase√±a - INACAP Sistema de Reservas'
                context = {
                    'user': user,
                    'temp_password': temp_password,
                    'reset_link': reset_link,
                    'site_name': 'INACAP - Sistema de Reservas'
                }
                message = render_to_string('reservas/email/forgot_password_email.txt', context)
                html_message = render_to_string('reservas/email/forgot_password_email.html', context)

                try:
                    send_mail(subject, message, None, [user.email], html_message=html_message)
                except Exception as e:
                    print(f"‚ö†Ô∏è Error enviando email de recuperaci√≥n: {e}")

            except User.DoesNotExist:
                # No revelar existencia
                pass

            if is_json:
                return JsonResponse({'success': True, 'message': 'Si existe una cuenta con ese correo, recibir√°s instrucciones.'})
            else:
                return redirect('forgot_password_sent')

        except Exception as e:
            print(f"‚ùå Error en forgot_password_request_view: {e}")
            traceback.print_exc()
            if is_json:
                return JsonResponse({'success': False, 'message': 'Error interno'}, status=500)
            else:
                return render(request, 'reservas/forgot_password_request.html', {'error': 'Error interno. Int√©ntalo m√°s tarde.'})


@csrf_exempt
def forgot_password_sent_view(request):
    return render(request, 'reservas/forgot_password_sent.html')


@csrf_exempt
def reset_password_view(request, uidb64, token):
    """Valida token y permite establecer nueva contrase√±a."""
    try:
        uid = force_str(urlsafe_base64_decode(uidb64))
        user = User.objects.get(pk=uid)
    except Exception:
        user = None

    if request.method == 'GET':
        context = {'validlink': user is not None and default_token_generator.check_token(user, token), 'uidb64': uidb64, 'token': token}
        return render(request, 'reservas/reset_password.html', context)

    if request.method == 'POST':
        try:
            data = json.loads(request.body) if request.body else request.POST
            new_password = data.get('new_password') or request.POST.get('new_password')
            new_password2 = data.get('new_password2') or request.POST.get('new_password2')

            if not user or not default_token_generator.check_token(user, token):
                return JsonResponse({'success': False, 'message': 'Enlace inv√°lido o expirado.'}, status=400)

            if not new_password or new_password != new_password2:
                return JsonResponse({'success': False, 'message': 'Las contrase√±as no coinciden.'}, status=400)

            user.set_password(new_password)
            user.save()
            return JsonResponse({'success': True, 'message': 'Contrase√±a actualizada. Ya puedes iniciar sesi√≥n.'})

        except Exception as e:
            print(f"‚ùå Error en reset_password_view: {e}")
            traceback.print_exc()
            return JsonResponse({'success': False, 'message': 'Error interno'}, status=500)


@csrf_exempt
def reset_via_otp_view(request):
    """Permite al usuario restablecer contrase√±a usando el c√≥digo temporal enviado por email.

    Formulario espera: email, temp_password, new_password, new_password2
    """
    if request.method == 'GET':
        return render(request, 'reservas/reset_via_otp.html')

    if request.method == 'POST':
        try:
            data = json.loads(request.body) if request.body else request.POST
            email = (data.get('email') or request.POST.get('email') or '').strip()
            temp = data.get('temp_password') or request.POST.get('temp_password')
            new_password = data.get('new_password') or request.POST.get('new_password')
            new_password2 = data.get('new_password2') or request.POST.get('new_password2')

            if not email or not temp or not new_password or not new_password2:
                return JsonResponse({'success': False, 'message': 'Todos los campos son requeridos.'}, status=400)

            if new_password != new_password2:
                return JsonResponse({'success': False, 'message': 'Las contrase√±as no coinciden.'}, status=400)

            try:
                user = User.objects.get(email__iexact=email)
            except User.DoesNotExist:
                return JsonResponse({'success': False, 'message': 'Datos inv√°lidos.'}, status=400)

            # Buscar OTP activo m√°s reciente
            otp_qs = OneTimePassword.objects.filter(user=user, used=False, expires_at__gte=timezone.now()).order_by('-created_at')
            if not otp_qs.exists():
                return JsonResponse({'success': False, 'message': 'C√≥digo temporal inv√°lido o expirado.'}, status=400)

            valid_otp = None
            for otp in otp_qs:
                if otp.check_token(temp):
                    valid_otp = otp
                    break

            if not valid_otp:
                return JsonResponse({'success': False, 'message': 'C√≥digo temporal inv√°lido o expirado.'}, status=400)

            # Aplicar nueva contrase√±a y marcar OTP como usado
            user.set_password(new_password)
            user.save()
            valid_otp.mark_used()

            return JsonResponse({'success': True, 'message': 'Contrase√±a actualizada. Inicia sesi√≥n con la nueva contrase√±a.'})

        except Exception as e:
            print(f"‚ùå Error en reset_via_otp_view: {e}")
            traceback.print_exc()
            return JsonResponse({'success': False, 'message': 'Error interno'}, status=500)

# --- Vista de Login Modificada ---
@csrf_exempt
def login_view(request):
    if request.method == 'GET':
        if request.user.is_authenticated:
            return redirect('dashboard')
        return render(request, 'reservas/login.html')

    if request.method == 'POST':
        try:
            data = json.loads(request.body)
            email = data.get('email', '').strip()
            password = data.get('password')
            user_type = data.get('user_type', 'usuario')  # 'usuario' o 'administrador'

            print(f"üîê Intento de login: {email} - Tipo: {user_type}")

            if not email or not password:
                return JsonResponse({
                    'success': False,
                    'message': 'Correo electr√≥nico y contrase√±a son requeridos.'
                }, status=400)

            # Autenticaci√≥n
            user = authenticate(request, username=email, password=password)
            
            if user is not None and user.is_active:
                try:
                    perfil = PerfilUsuario.objects.get(user=user)
                    print(f"üë§ Perfil encontrado: {perfil.rol}")
                    
                    # üîë VERIFICACI√ìN CORREGIDA DE ACCESO - ACTUALIZADA
                    is_admin_login = user_type == 'administrador'
                    
                    # Roles que pueden acceder como administradores
                    admin_roles = ['Administrativo', 'Investigacion', 'Aprobador']
                    # Roles que pueden acceder como usuarios normales (todos)
                    user_roles = ['Usuario', 'Docente', 'Investigacion', 'Administrativo', 'Aprobador']
                    
                    print(f"üîÑ Login tipo: {user_type}, Rol usuario: {perfil.rol}")
                    print(f"üéØ Roles admin: {admin_roles}")
                    print(f"üéØ Roles usuario: {user_roles}")
                    
                    if is_admin_login:
                        # Para login de administrador: solo roles espec√≠ficos de admin
                        if perfil.rol not in admin_roles:
                            return JsonResponse({
                                'success': False,
                                'message': f'No tienes permisos de administrador. Tu rol es: {perfil.rol}. Solo Personal Administrativo e Investigaci√≥n pueden acceder aqu√≠.'
                            }, status=403)
                    else:
                        # Para login de usuario: todos los roles pueden acceder
                        if perfil.rol not in user_roles:
                            return JsonResponse({
                                'success': False,
                                'message': f'Rol no autorizado. Tu rol es: {perfil.rol}'
                            }, status=403)

                    # ‚úÖ Login exitoso
                    login(request, user)
                    perfil.ultimo_acceso = timezone.now()
                    perfil.save()

                    print(f"‚úÖ Login exitoso - Redirigiendo a dashboard")

                    # üîî NOTIFICAR LOGIN DE ADMINISTRADOR - SI ES ADMIN
                    if perfil.rol in ['Administrativo', 'Investigacion', 'Aprobador']:
                        try:
                            notificar_accion_admin(
                                tipo='sesion_iniciada',
                                titulo='üîê Sesi√≥n de Admin Iniciada',
                                mensaje=f"El administrador {user.username} ha iniciado sesi√≥n en el sistema",
                                usuario_admin=user,
                                request=request
                            )
                            print(f"üì¢ Notificaci√≥n admin creada para login de {user.username}")
                        except Exception as admin_notif_error:
                            print(f"‚ö†Ô∏è Error en notificaci√≥n admin login: {admin_notif_error}")

                    return JsonResponse({
                        'success': True,
                        'message': 'Login exitoso',
                        'redirect_url': '/dashboard/'
                    })

                except PerfilUsuario.DoesNotExist:
                    return JsonResponse({
                        'success': False,
                        'message': 'Error: Perfil de usuario no configurado.'
                    }, status=500)
            else:
                return JsonResponse({
                    'success': False, 
                    'message': 'Credenciales incorrectas o cuenta desactivada'
                }, status=401)

        except Exception as e:
            print(f"üí• Error en login: {str(e)}")
            return JsonResponse({
                'success': False, 
                'message': 'Error interno del servidor'
            }, status=500)

# --- Funci√≥n de Registro Autom√°tico Modificada ---
def registrar_usuario_automatico(email, password, rol='Usuario'):
    """Registra un usuario autom√°ticamente si no existe (con username basado en nombre)"""
    try:
        # Extraer nombre del email para crear username √∫nico
        username_base = email.split('@')[0]
        first_name = username_base.capitalize()
        
        # Crear username √∫nico
        username = username_base
        counter = 1
        while User.objects.filter(username=username).exists():
            username = f"{username_base}{counter}"
            counter += 1

        if User.objects.filter(Q(email__iexact=email)).exists():
            print(f"‚ö†Ô∏è Intento de registro autom√°tico para usuario existente: {email}")
            return None

        user = User.objects.create_user(
            username=username,  # Username √∫nico, no el email
            email=email,
            password=password,
            first_name=first_name,
            last_name=''
        )
        print(f"‚úÖ Usuario base creado: {username} - {email}")

        area_default, _ = Area.objects.get_or_create(
            nombre_area="General",
            defaults={'descripcion': '√Årea general por defecto'}
        )

        PerfilUsuario.objects.create(
            user=user,
            rol=rol,
            area=area_default,
            departamento='Indefinido',
            estado='activo'
        )
        print(f"‚úÖ PerfilUsuario creado para: {username}")
        return user

    except IntegrityError as e:
         print(f"‚ùå Error de integridad al registrar usuario {email}: {e}")
         return None
    except Exception as e:
        print(f"‚ùå Error inesperado registrando usuario {email}: {e}")
        traceback.print_exc()
        return None
    
# --- Vista del Dashboard Modificada ---
@login_required
def dashboard_view(request):
    try:
        perfil = PerfilUsuario.objects.get(user=request.user)
        print(f"üéØ Usuario {request.user.username} accediendo a dashboard. Rol: {perfil.rol}")
        
        # Obtener datos REALES de la base de datos
        reservas_usuario = Reserva.objects.filter(solicitante=request.user)
        reservas_activas = reservas_usuario.filter(
            estado='Aprobada', 
            fecha_reserva__gte=timezone.now().date()
        ).count()
        reservas_pendientes = reservas_usuario.filter(estado='Pendiente').count()
        
        # Obtener las 5 reservas m√°s recientes
        reservas_recientes = reservas_usuario.select_related('espacio').order_by('-fecha_solicitud')[:5]
        
        print(f"üìä Estad√≠sticas - Activas: {reservas_activas}, Pendientes: {reservas_pendientes}, Total: {reservas_usuario.count()}")
        
        context = {
            'user': request.user,
            'perfil': perfil,
            'reservas_activas': reservas_activas,
            'reservas_pendientes': reservas_pendientes,
            'total_reservas': reservas_usuario.count(),
            'reservas_recientes': reservas_recientes,
        }
        
        # Redirigir seg√∫n el rol - ACTUALIZADO
        if perfil.rol in ['Administrativo', 'Investigacion', 'Aprobador']:
            print("‚û°Ô∏è Redirigiendo a dashboard admin")
            return render(request, 'reservas/dashboard_admin.html', context)
        else:
            print("‚û°Ô∏è Redirigiendo a dashboard usuario")
            return render(request, 'reservas/dashboard_usuario.html', context)
            
    except PerfilUsuario.DoesNotExist:
        print(f"‚ùå Usuario {request.user.username} no tiene perfil")
        logout(request)
        return redirect('login')
    except Exception as e:
        print(f"üí• Error en dashboard: {str(e)}")
        import traceback
        traceback.print_exc()
        logout(request)
        return redirect('login')

@login_required
def reservas_view(request):
    """Vista del historial de reservas con datos REALES"""
    try:
        # Obtener reservas REALES del usuario
        reservas = Reserva.objects.filter(solicitante=request.user).order_by('-fecha_solicitud')
        
        context = {
            'user': request.user,
            'reservas': reservas,
            'reservas_count': reservas.count()
        }
        return render(request, 'reservas/reservas.html', context)
        
    except Exception as e:
        print(f"Error en reservas_view: {e}")
        return render(request, 'reservas/reservas.html', {'reservas': [], 'reservas_count': 0})

@login_required
def calendario_view(request):
    """Vista del calendario con eventos REALES"""
    try:
        # Obtener TODAS las reservas APROBADAS para que todos los usuarios las vean
        reservas_calendario = Reserva.objects.filter(
            estado='Aprobada'
        ).select_related('espacio', 'solicitante')
        
        eventos_calendario = []
        for reserva in reservas_calendario:
            eventos_calendario.append({
                'title': f"{reserva.espacio.nombre}",
                'start': f"{reserva.fecha_reserva}T{reserva.hora_inicio}",
                'end': f"{reserva.fecha_reserva}T{reserva.hora_fin}",
                'color': '#10b981',
                'extendedProps': {
                    'estado': reserva.estado,
                    'espacio_id': reserva.espacio.id,
                    'espacio_nombre': reserva.espacio.nombre,
                    'solicitante': reserva.solicitante.username,
                    'proposito': reserva.proposito,
                    'hora_inicio': reserva.hora_inicio.strftime('%H:%M'),
                    'hora_fin': reserva.hora_fin.strftime('%H:%M')
                }
            })
        
        # Obtener espacios para el filtro
        espacios = Espacio.objects.filter(estado='Disponible')
        
        # Obtener mes actual para el filtro
        current_month = timezone.now().strftime('%Y-%m')
        
        context = {
            'user': request.user,
            'eventos': eventos_calendario,
            'espacios': espacios,
            'current_month': current_month
        }
        return render(request, 'reservas/calendario.html', context)
        
    except Exception as e:
        print(f"Error en calendario_view: {e}")
        return render(request, 'reservas/calendario.html', {
            'eventos': [],
            'espacios': [],
            'current_month': timezone.now().strftime('%Y-%m')
        })

# --- Vistas de API ---
@login_required
def get_user_reservas(request):
    try:
        reservas = Reserva.objects.filter(solicitante=request.user).order_by('-fecha_solicitud')
        data = []
        for reserva in reservas:
            data.append({
                'id': reserva.id,
                'espacio': reserva.espacio.nombre,
                'fecha': reserva.fecha_reserva.strftime('%d/%m/%Y'),
                'hora_inicio': reserva.hora_inicio.strftime('%H:%M'),
                'hora_fin': reserva.hora_fin.strftime('%H:%M'),
                'estado': reserva.estado,
                'proposito': reserva.proposito,
                'num_asistentes': reserva.num_asistentes,
                'fecha_solicitud': reserva.fecha_solicitud.strftime('%d/%m/%Y %H:%M')
            })
        return JsonResponse({'success': True, 'reservas': data})
    except Exception as e:
        print(f"‚ùå Error en get_user_reservas: {e}")
        traceback.print_exc()
        return JsonResponse({'success': False, 'error': str(e)})

@login_required
def get_espacios_disponibles(request):
    try:
        espacios = Espacio.objects.filter(estado='Disponible')
        data = []
        for espacio in espacios:
            data.append({
                'id': espacio.id,
                'nombre': espacio.nombre,
                'tipo': espacio.tipo,
                'edificio': espacio.edificio,
                'piso': espacio.piso,
                'capacidad': espacio.capacidad,
                'descripcion': espacio.descripcion,
                'estado': espacio.estado
            })
        return JsonResponse({'success': True, 'espacios': data})
    except Exception as e:
        print(f"‚ùå Error en get_espacios_disponibles: {e}")
        traceback.print_exc()
        return JsonResponse({'success': False, 'error': str(e)})

@login_required
def get_notificaciones(request):
    try:
        notificaciones = Notificacion.objects.filter(
            destinatario=request.user,
            leida=False
        ).order_by('-fecha_creacion')[:10]

        data = []
        for notif in notificaciones:
            data.append({
                'id': notif.id,
                'tipo': notif.tipo,
                'titulo': notif.titulo,
                'mensaje': notif.mensaje,
                'fecha': notif.fecha_creacion.strftime('%d/%m/%Y %H:%M'),
                'leida': notif.leida
            })
        return JsonResponse({'success': True, 'notificaciones': data})
    except Exception as e:
        print(f"‚ùå Error en get_notificaciones: {e}")
        traceback.print_exc()
        return JsonResponse({'success': False, 'error': str(e)})

@login_required
@csrf_exempt
def reportar_incidencia(request):
    if request.method == 'POST':
        try:
            data = json.loads(request.body)
            incidencia = Incidencia.objects.create(
                id_usuario=request.user,
                descripcion=data.get('descripcion'),
                prioridad=data.get('prioridad', 'Media'),
                id_espacio_id=data.get('id_espacio'),
                id_equipo_id=data.get('id_equipo')
            )
            
            # üîî NOTIFICAR INCIDENCIA REPORTADA
            try:
                notificar_accion_admin(
                    tipo='incidencia_reportada',
                    titulo='üö® Incidencia Reportada',
                    mensaje=f"El usuario {request.user.username} ha reportado una incidencia: {data.get('descripcion', '')[:100]}...",
                    usuario_relacionado=request.user,
                    request=request
                )
                print(f"üì¢ Notificaci√≥n admin creada para incidencia {incidencia.id}")
            except Exception as admin_notif_error:
                print(f"‚ö†Ô∏è Error en notificaci√≥n admin incidencia: {admin_notif_error}")
                
            return JsonResponse({'success': True, 'incidencia_id': incidencia.id})
        except Exception as e:
            print(f"‚ùå Error en reportar_incidencia: {e}")
            traceback.print_exc()
            return JsonResponse({'success': False, 'error': str(e)}, status=500)
    return JsonResponse({'success': False, 'error': 'M√©todo no permitido'}, status=405)

@csrf_exempt
def registro_usuario(request):
    """
    Vista para registrar nuevos usuarios desde el formulario de registro
    """
    if request.method == 'POST':
        try:
            print("üéØ REGISTRO_USUARIO: Iniciando registro...")
            data = json.loads(request.body)
            email = data.get('email', '').strip().lower()
            password = data.get('password')
            first_name = data.get('first_name', '').strip()
            last_name = data.get('last_name', '').strip()
            department = data.get('department', 'Indefinido')
            rol = 'Usuario'  # Rol por defecto para registros p√∫blicos

            print(f"üéØ REGISTRO_USUARIO: Datos recibidos - email: {email}")
            
            # Validaciones b√°sicas
            if not all([email, password, first_name, last_name]):
                return JsonResponse({
                    'success': False,
                    'message': 'Todos los campos son requeridos'
                }, status=400)

            # Verificar si el email ya existe
            if User.objects.filter(email__iexact=email).exists():
                return JsonResponse({
                    'success': False,
                    'message': 'Ya existe un usuario con este correo electr√≥nico'
                }, status=400)

            # Crear username √∫nico basado en el nombre
            username_base = f"{first_name.lower()}{last_name.lower()}"
            username = username_base
            counter = 1
            while User.objects.filter(username=username).exists():
                username = f"{username_base}{counter}"
                counter += 1

            # Crear el usuario
            user = User.objects.create_user(
                username=username,
                email=email,
                password=password,
                first_name=first_name,
                last_name=last_name
            )
            
            print(f"üéØ REGISTRO_USUARIO: Usuario creado - {username} ({email})")
              
            # Obtener o crear √°rea por defecto
            area, _ = Area.objects.get_or_create(
                nombre_area="General",
                defaults={'descripcion': '√Årea general por defecto'}
            )

            # Crear perfil de usuario
            PerfilUsuario.objects.create(
                user=user,
                rol=rol,
                area=area,
                departamento=department,
                estado='activo'
            )

            print(f"üéØ REGISTRO_USUARIO: Perfil creado para {username}")

            # üîî NOTIFICAR NUEVO USUARIO REGISTRADO
            print("üéØ REGISTRO_USUARIO: Intentando crear notificaci√≥n admin...")
            try:
                notificar_accion_admin(
                    tipo='usuario_registrado',
                    titulo='üë§ Nuevo Usuario Registrado',
                    mensaje=f"El usuario {username} ({first_name} {last_name}) se ha registrado en el sistema con rol: {rol}",
                    usuario_relacionado=user,
                    request=request
                )
                print(f"üéØ REGISTRO_USUARIO: Notificaci√≥n admin CREADA para {username}")
            except Exception as admin_notif_error:
                print(f"‚ùå REGISTRO_USUARIO: Error en notificaci√≥n admin: {admin_notif_error}")

            return JsonResponse({
                'success': True,
                'message': 'Usuario registrado exitosamente. Ahora puedes iniciar sesi√≥n.'
            })

        except json.JSONDecodeError:
            return JsonResponse({
                'success': False,
                'message': 'Error en el formato JSON'
            }, status=400)
        except Exception as e:
            print(f"‚ùå REGISTRO_USUARIO: Error general: {e}")
            return JsonResponse({
                'success': False,
                'message': 'Error interno del servidor al crear la cuenta'
            }, status=500)

    return JsonResponse({
        'success': False,
        'message': 'M√©todo no permitido'
    }, status=405)
    
@login_required
def editar_usuario_view(request):
    """Vista para editar usuario (template)"""
    try:
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
            return redirect('dashboard')
        
        return render(request, 'reservas/editar_usuario.html')
    except PerfilUsuario.DoesNotExist:
        return redirect('login')
    
@login_required
def get_dashboard_stats(request):
    try:
        perfil = PerfilUsuario.objects.get(user=request.user)
        stats = {}

        # ACTUALIZADO: Roles de administraci√≥n
        if perfil.rol in ['Administrativo', 'Investigacion', 'Aprobador']:
            stats['reservas_pendientes_aprobacion'] = Reserva.objects.filter(
                estado='Pendiente'
            ).count()
            stats['total_espacios'] = Espacio.objects.count()
            stats['espacios_disponibles'] = Espacio.objects.filter(estado='Disponible').count()
        else:
            # Usuario normal
            stats['reservas_activas'] = Reserva.objects.filter(
                solicitante=request.user,
                estado='Aprobada',
                fecha_reserva__gte=timezone.now().date()
            ).count()
            stats['reservas_pendientes'] = Reserva.objects.filter(
                solicitante=request.user,
                estado='Pendiente'
            ).count()
            stats['total_reservas'] = Reserva.objects.filter(
                solicitante=request.user
            ).count()

        stats['notificaciones_sin_leer'] = Notificacion.objects.filter(
            destinatario=request.user,
            leida=False
        ).count()

        return JsonResponse({'success': True, 'stats': stats})

    except PerfilUsuario.DoesNotExist:
         print(f"‚ö†Ô∏è Error en get_dashboard_stats: Usuario {request.user.username} sin PerfilUsuario.")
         return JsonResponse({'success': False, 'error': 'Perfil no encontrado'}, status=404)
    except Exception as e:
        print(f"‚ùå Error en get_dashboard_stats: {e}")
        traceback.print_exc()
        return JsonResponse({'success': False, 'error': str(e)}, status=500)

# --- Vista de Logout ---
def logout_view(request):
    # üîî NOTIFICAR LOGOUT DE ADMINISTRADOR
    if request.user.is_authenticated:
        try:
            perfil = PerfilUsuario.objects.get(user=request.user)
            if perfil.rol in ['Administrativo', 'Investigacion', 'Aprobador']:
                notificar_accion_admin(
                    tipo='sesion_cerrada',
                    titulo='üö™ Sesi√≥n de Admin Cerrada',
                    mensaje=f"El administrador {request.user.username} ha cerrado sesi√≥n",
                    usuario_admin=request.user,
                    request=request
                )
                print(f"üì¢ Notificaci√≥n admin creada para logout de {request.user.username}")
        except Exception as admin_notif_error:
            print(f"‚ö†Ô∏è Error en notificaci√≥n admin logout: {admin_notif_error}")
        except PerfilUsuario.DoesNotExist:
            pass
    
    logout(request)
    return redirect('login')

# --- VISTAS PARA SERVIR TEMPLATES HTML ---
@login_required
def notificaciones_view(request):
    return render(request, 'reservas/notificaciones.html')

@login_required
def crear_reserva_view(request):
    """Vista para crear reserva con espacios disponibles"""
    try:
        # Obtener espacios disponibles
        espacios = Espacio.objects.filter(estado='Disponible').prefetch_related('equipamientos')
        
        # Obtener fecha actual para el formulario
        today = timezone.now().date()
        
        print(f"üè¢ Espacios disponibles encontrados: {espacios.count()}")
        
        context = {
            'user': request.user,
            'espacios': espacios,
            'today': today.isoformat()  # Para el campo date min
        }
        return render(request, 'reservas/crear_reserva.html', context)
        
    except Exception as e:
        print(f"‚ùå Error en crear_reserva_view: {e}")
        import traceback
        traceback.print_exc()
        # Si hay error, pasar lista vac√≠a
        context = {
            'user': request.user,
            'espacios': [],
            'today': timezone.now().date().isoformat()
        }
        return render(request, 'reservas/crear_reserva.html', context)

@login_required
def reserva_exitosa(request):
    """Vista de confirmaci√≥n de reserva exitosa con datos REALES"""
    reserva_id = request.GET.get('reserva_id')
    print(f"üîç ID de reserva recibido: {reserva_id}")
    
    try:
        if reserva_id:
            # Obtener la reserva espec√≠fica
            reserva = Reserva.objects.select_related('espacio').get(id=reserva_id, solicitante=request.user)
            print(f"‚úÖ Reserva encontrada: {reserva.id} - {reserva.espacio.nombre}")
        else:
            # Obtener la √∫ltima reserva del usuario
            reserva = Reserva.objects.select_related('espacio').filter(
                solicitante=request.user
            ).order_by('-fecha_solicitud').first()
            print(f"üìã √öltima reserva encontrada: {reserva.id if reserva else 'None'}")
        
        context = {
            'user': request.user,
            'reserva': reserva
        }
        return render(request, 'reservas/reserva_exitosa.html', context)
        
    except Reserva.DoesNotExist:
        print(f"‚ùå Reserva no encontrada: ID {reserva_id}")
        # Si no hay reserva, mostrar p√°gina gen√©rica
        context = {
            'user': request.user,
            'reserva': None
        }
        return render(request, 'reservas/reserva_exitosa.html', context)
    except Exception as e:
        print(f"üí• Error en reserva_exitosa: {e}")
        import traceback
        traceback.print_exc()
        context = {
            'user': request.user,
            'reserva': None
        }
        return render(request, 'reservas/reserva_exitosa.html', context)

@login_required
def detalle_reserva_view(request):
    """Vista de detalle de reserva con datos REALES de la BD"""
    reserva_id = request.GET.get('id')
    
    try:
        # Obtener la reserva espec√≠fica del usuario
        reserva = Reserva.objects.select_related('espacio', 'solicitante').get(
            id=reserva_id, 
            solicitante=request.user
        )
        
        # Formatear datos para el template
        context = {
            'user': request.user,
            'reserva': reserva,
            'reserva_data': {
                'id': reserva.id,
                'estado': reserva.estado.lower(),
                'espacio': {
                    'id': reserva.espacio.id,
                    'nombre': reserva.espacio.nombre,
                    'ubicacion': f"{reserva.espacio.edificio or 'Edificio Principal'}, Piso {reserva.espacio.piso or 'N/A'}",
                    'capacidad': f"{reserva.espacio.capacidad} personas",
                    'equipamiento': ', '.join([eq.nombre_equipo for eq in reserva.espacio.equipamientos.all()]) or "Equipamiento b√°sico",
                    'descripcion': reserva.espacio.descripcion or "Espacio disponible para reuniones y eventos."
                },
                'fecha': reserva.fecha_reserva.strftime('%A, %d de %B %Y'),
                'horario': f"{reserva.hora_inicio.strftime('%H:%M')} - {reserva.hora_fin.strftime('%H:%M')}",
                'duracion': calcular_duracion(reserva.hora_inicio, reserva.hora_fin),
                'proposito': reserva.proposito,
                'asistentes': f"{reserva.num_asistentes} personas",
                'usuario': {
                    'nombre': f"{reserva.solicitante.first_name} {reserva.solicitante.last_name}",
                    'email': reserva.solicitante.email,
                    'telefono': 'N/A'
                },
                'fechaSolicitud': reserva.fecha_solicitud.strftime('%d de %B, %H:%M'),
                'comentariosAdmin': reserva.comentario_admin or "Sin comentarios adicionales."
            }
        }
        return render(request, 'reservas/detalle_reserva.html', context)
        
    except Reserva.DoesNotExist:
        messages.error(request, 'Reserva no encontrada.')
        return redirect('reservas')
    except Exception as e:
        print(f"Error en detalle_reserva_view: {e}")
        messages.error(request, 'Error al cargar los detalles de la reserva.')
        return redirect('reservas')

def calcular_duracion(hora_inicio, hora_fin):
    """Calcular la duraci√≥n en formato legible"""
    if isinstance(hora_inicio, str):
        hora_inicio = datetime.strptime(hora_inicio, '%H:%M:%S').time()
    if isinstance(hora_fin, str):
        hora_fin = datetime.strptime(hora_fin, '%H:%M:%S').time()
    
    diferencia = datetime.combine(date.today(), hora_fin) - datetime.combine(date.today(), hora_inicio)
    horas = diferencia.seconds // 3600
    minutos = (diferencia.seconds % 3600) // 60
    
    if horas > 0:
        return f"{horas} hora{'s' if horas > 1 else ''} {minutos} minuto{'s' if minutos > 1 else ''}"
    else:
        return f"{minutos} minutos"

@login_required
def cancelar_reserva_view(request):
    return render(request, 'reservas/cancelar_reserva.html')

# --- Vistas de Administraci√≥n - ACTUALIZADAS ---
@login_required
def admin_dashboard_view(request):
    """Dashboard para administradores - CON DATOS REALES"""
    try:
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
            return redirect('dashboard')
        
        # Datos REALES de la base de datos
        total_reservas = Reserva.objects.count()
        reservas_pendientes = Reserva.objects.filter(estado='Pendiente').count()
        total_espacios = Espacio.objects.count()
        usuarios_activos = User.objects.filter(is_active=True).count()
        
        # Reservas recientes (√∫ltimas 5)
        reservas_recientes = Reserva.objects.select_related('solicitante', 'espacio').order_by('-fecha_solicitud')[:5]
        
        # Notificaciones sin leer
        notificaciones_sin_leer = Notificacion.objects.filter(
            destinatario=request.user,
            leida=False
        ).count()
        
        context = {
            'user': request.user,
            'perfil': perfil,
            'total_reservas': total_reservas,
            'reservas_pendientes': reservas_pendientes,
            'total_espacios': total_espacios,
            'usuarios_activos': usuarios_activos,
            'reservas_recientes': reservas_recientes,
            'notificaciones_sin_leer': notificaciones_sin_leer,
        }
        return render(request, 'reservas/dashboard_admin.html', context)
    except PerfilUsuario.DoesNotExist:
        return redirect('login')

@login_required
def solicitudes_pendientes_view(request):
    """Vista de solicitudes pendientes para administradores - CON DATOS REALES"""
    try:
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
            return redirect('dashboard')
        
        # Obtener solicitudes REALES pendientes
        solicitudes = Reserva.objects.filter(estado='Pendiente').select_related('solicitante', 'espacio')
        
        context = {
            'user': request.user,
            'solicitudes': solicitudes
        }
        return render(request, 'reservas/solicitudes_pendientes.html', context)
    except PerfilUsuario.DoesNotExist:
        return redirect('login')

@login_required
def gestion_espacios_view(request):
    """Vista de gesti√≥n de espacios para administradores - CON DATOS REALES"""
    try:
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
            return redirect('dashboard')
        
        # Obtener todos los espacios
        espacios = Espacio.objects.all().order_by('nombre')
        
        context = {
            'user': request.user,
            'espacios': espacios
        }
        return render(request, 'reservas/gestion_espacios.html', context)
    except PerfilUsuario.DoesNotExist:
        return redirect('login')

@login_required
def gestion_usuarios_view(request):
    """Vista de gesti√≥n de usuarios para administradores - CON DATOS REALES"""
    try:
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
            return redirect('dashboard')
        
        # Obtener TODOS los usuarios (activos e inactivos) con sus perfiles
        usuarios = User.objects.all().select_related('perfilusuario').order_by('-date_joined')
        
        context = {
            'user': request.user,
            'usuarios': usuarios
        }
        return render(request, 'reservas/gestion_usuarios.html', context)
    except PerfilUsuario.DoesNotExist:
        return redirect('login')


@login_required
def crear_usuario_view(request):
    """Vista para que administradores creen usuarios desde una interfaz separada"""
    try:
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador', 'SuperAdmin']:
            return redirect('dashboard')

        return render(request, 'reservas/crear_usuario.html')
    except PerfilUsuario.DoesNotExist:
        return redirect('login')


@login_required
@csrf_exempt
@require_http_methods(["POST"])
@transaction.atomic  # NUEVO: Transacci√≥n at√≥mica
def crear_reserva_api(request):
    """API para crear reservas REALES en la base de datos - VERSI√ìN MEJORADA Y CORREGIDA"""
    if request.method == 'POST':
        try:
            print("üéØ CREAR_RESERVA_API: Iniciando creaci√≥n de reserva...")
            data = json.loads(request.body)
            print(f"üéØ CREAR_RESERVA_API: Datos recibidos - {data}")
            
            # ======== VALIDACIONES COMPLETAS ========
            
            # Validar datos requeridos
            required_fields = ['espacio_id', 'fecha_reserva', 'hora_inicio', 'hora_fin', 'proposito', 'num_asistentes']
            for field in required_fields:
                if not data.get(field):
                    return JsonResponse({
                        'success': False, 
                        'message': f'El campo {field} es requerido'
                    }, status=400)

            # Verificar que el espacio existe
            try:
                espacio = Espacio.objects.get(id=data['espacio_id'])
                print(f"üè¢ Espacio encontrado: {espacio.nombre}")
            except Espacio.DoesNotExist:
                print(f"‚ùå Espacio no encontrado: ID {data['espacio_id']}")
                return JsonResponse({
                    'success': False,
                    'message': 'El espacio seleccionado no existe'
                }, status=400)

            # ======== VALIDACIONES DE FECHA Y HORA ========
            
            # Convertir fecha string a objeto date
            try:
                fecha_reserva = datetime.strptime(data['fecha_reserva'], '%Y-%m-%d').date()
            except ValueError:
                return JsonResponse({
                    'success': False,
                    'message': 'Formato de fecha inv√°lido. Use YYYY-MM-DD'
                }, status=400)
            
            # Validar que la fecha no sea en el pasado
            if fecha_reserva < timezone.now().date():
                return JsonResponse({
                    'success': False,
                    'message': 'No se pueden hacer reservas para fechas pasadas'
                }, status=400)
            
            # Convertir horas string a objetos time
            try:
                hora_inicio = datetime.strptime(data['hora_inicio'], '%H:%M').time()
                hora_fin = datetime.strptime(data['hora_fin'], '%H:%M').time()
            except ValueError:
                return JsonResponse({
                    'success': False,
                    'message': 'Formato de hora inv√°lido. Use HH:MM (24 horas)'
                }, status=400)
            
            # Validar hora si es el d√≠a actual
            if fecha_reserva == timezone.now().date():
                hora_actual = timezone.now().time()
                if hora_inicio < hora_actual:
                    return JsonResponse({
                        'success': False,
                        'message': 'No se pueden hacer reservas para horas pasadas'
                    }, status=400)
            
            # ======== VALIDACIONES DE CAPACIDAD ========
            
            # Validar n√∫mero de asistentes vs capacidad
            if int(data['num_asistentes']) <= 0:
                return JsonResponse({
                    'success': False,
                    'message': 'El n√∫mero de asistentes debe ser mayor a 0'
                }, status=400)
            
            if int(data['num_asistentes']) > espacio.capacidad:
                return JsonResponse({
                    'success': False,
                    'message': f'El espacio "{espacio.nombre}" solo tiene capacidad para {espacio.capacidad} personas'
                }, status=400)
            
            # ======== VALIDACIONES USANDO UTILS ========
            
            # Validar disponibilidad usando la funci√≥n CORREGIDA
            disponible, mensaje = validar_disponibilidad_espacio(
                espacio_id=data['espacio_id'],
                fecha=fecha_reserva,
                hora_inicio=hora_inicio,
                hora_fin=hora_fin
            )
            
            if not disponible:
                return JsonResponse({
                    'success': False,
                    'message': mensaje
                }, status=400)
            
            # Validar anticipaci√≥n (m√≠nimo 2 horas)
            valido_anticipacion, msg_anticipacion = validar_anticipacion_reserva(fecha_reserva, hora_inicio)
            if not valido_anticipacion:
                return JsonResponse({
                    'success': False,
                    'message': msg_anticipacion
                }, status=400)
            
            # Validar l√≠mite de reservas por usuario por d√≠a
            valido_limite, msg_limite = validar_limite_reservas_usuario(request.user, fecha_reserva)
            if not valido_limite:
                return JsonResponse({
                    'success': False,
                    'message': msg_limite
                }, status=400)
            
            # ======== CREACI√ìN DE LA RESERVA ========
            
            # Crear la reserva REAL
            reserva = Reserva.objects.create(
                espacio=espacio,
                solicitante=request.user,
                fecha_reserva=fecha_reserva,
                hora_inicio=hora_inicio,
                hora_fin=hora_fin,
                proposito=data['proposito'],
                num_asistentes=int(data['num_asistentes']),
                estado='Pendiente'
            )
            
            print(f"üéØ CREAR_RESERVA_API: Reserva REAL creada - ID {reserva.id}")

            # üîî NOTIFICAR A ADMINISTRADORES - ESTA PARTE DEBE EJECUTARSE
            print("üéØ CREAR_RESERVA_API: Intentando crear notificaci√≥n admin...")
            try:
                notificar_accion_admin(
                    tipo='reserva_creada',
                    titulo='üìã Nueva Reserva Creada',
                    mensaje=f"El usuario {request.user.username} ha creado una nueva reserva para {reserva.espacio.nombre} el {reserva.fecha_reserva} de {reserva.hora_inicio.strftime('%H:%M')} a {reserva.hora_fin.strftime('%H:%M')}. Prop√≥sito: {reserva.proposito}",
                    usuario_relacionado=request.user,
                    reserva=reserva,
                    request=request
                )
                print(f"üéØ CREAR_RESERVA_API: Notificaci√≥n admin CREADA para reserva {reserva.id}")
            except Exception as admin_notif_error:
                print(f"‚ùå CREAR_RESERVA_API: Error en notificaci√≥n admin: {admin_notif_error}")
                # No fallar la reserva por error en notificaci√≥n
            
            # NOTIFICAR AL USUARIO
            try:
                notificacion = NotificacionService.notificar_creacion_reserva(reserva)
                if notificacion:
                    print(f"üìß Notificaci√≥n de creaci√≥n enviada exitosamente: {notificacion.id}")
                else:
                    print("‚ö†Ô∏è No se pudo crear la notificaci√≥n de creaci√≥n")
            except Exception as notif_error:
                print(f"‚ö†Ô∏è Error en notificaci√≥n: {notif_error}")
                # No fallar la reserva por error en notificaci√≥n
            
            return JsonResponse({
                'success': True,
                'message': 'Reserva creada exitosamente',
                'reserva_id': reserva.id,
                'notificacion_creada': True,
                'redirect_url': f'/reserva-exitosa/?reserva_id={reserva.id}'
            })

        except json.JSONDecodeError:
            return JsonResponse({
                'success': False,
                'message': 'Error en el formato JSON de la solicitud'
            }, status=400)
            
        except Exception as e:
            print(f"‚ùå Error creando reserva: {e}")
            import traceback
            traceback.print_exc()
            return JsonResponse({
                'success': False,
                'message': f'Error interno del servidor: {str(e)}'
            }, status=500)

    return JsonResponse({
        'success': False,
        'message': 'M√©todo no permitido'
    }, status=405)

@login_required
@csrf_exempt
@require_http_methods(["POST"])
def cambiar_rango_admin_api(request, user_id):
    """Permite a SuperAdmin cambiar el rol de un admin (cambiar rango)."""
    try:
        perfil_admin = PerfilUsuario.objects.get(user=request.user)
        if perfil_admin.rol != 'SuperAdmin':
            return JsonResponse({'success': False, 'error': 'No autorizado'}, status=403)

        data = json.loads(request.body)
        nuevo_rol = data.get('rol')
        if not nuevo_rol:
            return JsonResponse({'success': False, 'error': 'rol es requerido'}, status=400)

        usuario = User.objects.get(id=user_id)
        perfil_obj = PerfilUsuario.objects.get(user=usuario)

        perfil_obj.rol = nuevo_rol
        perfil_obj.save()

        notificar_accion_admin(
            tipo='usuario_actualizado',
            titulo='üîß Cambio de Rango',
            mensaje=f'El SuperAdmin {request.user.username} cambi√≥ el rol de {usuario.username} a {nuevo_rol}',
            usuario_admin=request.user,
            usuario_relacionado=usuario,
            request=request
        )

        return JsonResponse({'success': True, 'message': 'Rol actualizado exitosamente'})

    except User.DoesNotExist:
        return JsonResponse({'success': False, 'error': 'Usuario no encontrado'}, status=404)
    except PerfilUsuario.DoesNotExist:
        return JsonResponse({'success': False, 'error': 'Perfil no encontrado'}, status=404)
    except Exception as e:
        print(f"‚ùå Error en cambiar_rango_admin_api: {e}")
        return JsonResponse({'success': False, 'error': str(e)}, status=500)

@login_required
@csrf_exempt
@require_http_methods(["POST"])
def crear_usuario_api(request):
    """API para que administradores creen usuarios desde el frontend"""
    try:
        # Verificar permisos de administrador
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigaci√≥n', 'Aprobador', 'SuperAdmin']:
            return JsonResponse({'success': False, 'error': 'No tienes permisos'}, status=403)

        data = json.loads(request.body)
        email = data.get('email', '').strip().lower()
        password = data.get('password')
        first_name = data.get('first_name', '').strip()
        last_name = data.get('last_name', '').strip()
        department = data.get('department', 'Indefinido')
        requested_role = data.get('rol', 'Usuario')

        # Validaciones b√°sicas
        if not all([email, password, first_name]):
            return JsonResponse({'success': False, 'message': 'Faltan campos requeridos'}, status=400)

        # Si el admin que crea NO es SuperAdmin, impedir crear usuarios con rol administrador
        admin_roles = ['Administrativo', 'Investigaci√≥n', 'Aprobador', 'SuperAdmin']
        if perfil.rol != 'SuperAdmin' and requested_role in admin_roles and requested_role != 'Usuario':
            return JsonResponse({'success': False, 'message': 'No puedes asignar roles administrativos'}, status=403)

        # Si llega rol nulo o vac√≠o, usar Usuario
        rol_final = requested_role if requested_role else 'Usuario'

        # Crear username √∫nico
        username_base = f"{first_name.lower()}{last_name.lower()}" if last_name else first_name.lower()
        username = username_base or email.split('@')[0]
        counter = 1
        while User.objects.filter(username=username).exists():
            username = f"{username_base}{counter}"
            counter += 1

        if User.objects.filter(email__iexact=email).exists():
            return JsonResponse({'success': False, 'message': 'Ya existe un usuario con este correo'}, status=400)

        user = User.objects.create_user(
            username=username,
            email=email,
            password=password,
            first_name=first_name,
            last_name=last_name or ''
        )

        area_default, _ = Area.objects.get_or_create(
            nombre_area="General",
            defaults={'descripcion': '√Årea general por defecto'}
        )

        PerfilUsuario.objects.create(
            user=user,
            rol=rol_final,
            area=area_default,
            departamento=department,
            estado='activo'
        )

        # Notificar creaci√≥n
        try:
            notificar_accion_admin(
                tipo='usuario_registrado',
                titulo='üë§ Usuario Creado por Admin',
                mensaje=f'El administrador {request.user.username} ha creado el usuario {user.username} con rol {rol_final}',
                usuario_admin=request.user,
                usuario_relacionado=user,
                request=request
            )
        except Exception as e:
            print(f"‚ö†Ô∏è Error en notificaci√≥n admin: {e}")

        return JsonResponse({
            'success': True, 
            'message': 'Usuario creado exitosamente', 
            'user_id': user.id
        })

    except json.JSONDecodeError:
        return JsonResponse({'success': False, 'error': 'Formato JSON inv√°lido'}, status=400)
    except Exception as e:
        print(f"‚ùå Error en crear_usuario_api: {e}")
        return JsonResponse({'success': False, 'error': str(e)}, status=500)

@login_required
def reportes_view(request):
    """Vista de reportes para administradores - CON DATOS REALES"""
    try:
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
            return redirect('dashboard')
        
        # Datos REALES para reportes
        total_reservas = Reserva.objects.count()
        usuarios_activos = User.objects.filter(is_active=True).count()
        total_espacios = Espacio.objects.count()
        
        # Calcular tasa de aprobaci√≥n
        reservas_aprobadas = Reserva.objects.filter(estado='Aprobada').count()
        tasa_aprobacion = round((reservas_aprobadas / total_reservas * 100) if total_reservas > 0 else 0)
        
        # Estad√≠sticas de uso de espacios (TOP 5)
        espacios_mas_usados = Espacio.objects.annotate(
            num_reservas=models.Count('reserva')
        ).order_by('-num_reservas')[:5]
        
        # Reservas por estado
        reservas_pendientes = Reserva.objects.filter(estado='Pendiente').count()
        reservas_rechazadas = Reserva.objects.filter(estado='Rechazada').count()
        reservas_canceladas = Reserva.objects.filter(estado='Cancelada').count()
        
        # Usuarios m√°s activos (TOP 5)
        usuarios_activos_top = User.objects.annotate(
            num_reservas=models.Count('reservas_solicitadas')
        ).order_by('-num_reservas')[:5]
        
        # Reservas del mes actual
        mes_actual = timezone.now().month
        a√±o_actual = timezone.now().year
        reservas_mes_actual = Reserva.objects.filter(
            fecha_solicitud__month=mes_actual,
            fecha_solicitud__year=a√±o_actual
        ).count()
        
        context = {
            'user': request.user,
            'total_reservas': total_reservas,
            'usuarios_activos': usuarios_activos,
            'total_espacios': total_espacios,
            'tasa_aprobacion': tasa_aprobacion,
            'reservas_aprobadas': reservas_aprobadas,
            'reservas_pendientes': reservas_pendientes,
            'reservas_rechazadas': reservas_rechazadas,
            'reservas_canceladas': reservas_canceladas,
            'reservas_mes_actual': reservas_mes_actual,
            'espacios_mas_usados': espacios_mas_usados,
            'usuarios_activos_top': usuarios_activos_top,
        }
        return render(request, 'reservas/reportes.html', context)
    except PerfilUsuario.DoesNotExist:
        return redirect('login')

@login_required
def revisar_solicitud_view(request):
    """Vista para revisar una solicitud espec√≠fica"""
    try:
        perfil = PerfilUsuario.objects.get(user=request.user)
        # ACTUALIZADO: Roles que pueden acceder
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
            return redirect('dashboard')
        
        solicitud_id = request.GET.get('id')
        if solicitud_id:
            solicitud = Reserva.objects.get(id=solicitud_id)
            context = {
                'user': request.user,
                'solicitud': solicitud
            }
            return render(request, 'reservas/revisar_solicitud.html', context)
        else:
            return redirect('solicitudes_pendientes')
    except Reserva.DoesNotExist:
        return redirect('solicitudes_pendientes')
    except PerfilUsuario.DoesNotExist:
        return redirect('login')

@login_required
@csrf_exempt
def cancelar_reserva_api(request, reserva_id):
    if request.method == 'POST':
        try:
            reserva = Reserva.objects.get(id=reserva_id, solicitante=request.user)
            
            if reserva.estado in ['Pendiente', 'Aprobada']:
                estado_anterior = reserva.estado
                reserva.estado = 'Cancelada'
                reserva.save()
                
                # Crear notificaci√≥n al usuario
                Notificacion.objects.create(
                    destinatario=request.user,
                    tipo='reserva_cancelada',
                    titulo='Reserva Cancelada',
                    mensaje=f'Tu reserva para {reserva.espacio.nombre} ha sido cancelada.',
                    leida=False
                )
                
                # üîî NOTIFICAR A ADMINISTRADORES SOBRE CANCELACI√ìN
                try:
                    notificar_accion_admin(
                        tipo='reserva_cancelada',
                        titulo='üìù Reserva Cancelada por Usuario',
                        mensaje=f"El usuario {request.user.username} ha cancelado la reserva #{reserva.id} para {reserva.espacio.nombre} (estado anterior: {estado_anterior})",
                        usuario_relacionado=request.user,
                        reserva=reserva,
                        request=request
                    )
                    print(f"üì¢ Notificaci√≥n admin creada para cancelaci√≥n de reserva {reserva.id}")
                except Exception as admin_notif_error:
                    print(f"‚ö†Ô∏è Error en notificaci√≥n admin cancelaci√≥n: {admin_notif_error}")
                
                return JsonResponse({'success': True, 'message': 'Reserva cancelada exitosamente'})
            else:
                return JsonResponse({'success': False, 'error': 'No se puede cancelar esta reserva'})
                
        except Reserva.DoesNotExist:
            return JsonResponse({'success': False, 'error': 'Reserva no encontrada'})
        except Exception as e:
            return JsonResponse({'success': False, 'error': str(e)})
    
    return JsonResponse({'success': False, 'error': 'M√©todo no permitido'})

@login_required
@csrf_exempt
def crear_reserva_api(request):
    """API para crear reservas REALES en la base de datos - VERSI√ìN MEJORADA"""
    if request.method == 'POST':
        try:
            print("üéØ CREAR_RESERVA_API: Iniciando creaci√≥n de reserva...")
            data = json.loads(request.body)
            print(f"üéØ CREAR_RESERVA_API: Datos recibidos - {data}")
            
            # Validar datos requeridos
            required_fields = ['espacio_id', 'fecha_reserva', 'hora_inicio', 'hora_fin', 'proposito', 'num_asistentes']
            for field in required_fields:
                if not data.get(field):
                    return JsonResponse({
                        'success': False, 
                        'message': f'El campo {field} es requerido'
                    }, status=400)

            # Verificar que el espacio existe
            try:
                espacio = Espacio.objects.get(id=data['espacio_id'])
                print(f"üè¢ Espacio encontrado: {espacio.nombre}")
            except Espacio.DoesNotExist:
                print(f"‚ùå Espacio no encontrado: ID {data['espacio_id']}")
                return JsonResponse({
                    'success': False,
                    'message': 'El espacio seleccionado no existe'
                }, status=400)

            # Crear la reserva REAL
            reserva = Reserva.objects.create(
                espacio=espacio,
                solicitante=request.user,
                fecha_reserva=data['fecha_reserva'],
                hora_inicio=data['hora_inicio'],
                hora_fin=data['hora_fin'],
                proposito=data['proposito'],
                num_asistentes=data['num_asistentes'],
                estado='Pendiente'
            )
            
            print(f"üéØ CREAR_RESERVA_API: Reserva REAL creada - ID {reserva.id}")

           # üîî NOTIFICAR A ADMINISTRADORES - ESTA PARTE DEBE EJECUTARSE
            print("üéØ CREAR_RESERVA_API: Intentando crear notificaci√≥n admin...")
            try:
                notificar_accion_admin(
                    tipo='reserva_creada',
                    titulo='üìã Nueva Reserva Creada',
                    mensaje=f"El usuario {request.user.username} ha creado una nueva reserva para {reserva.espacio.nombre} el {reserva.fecha_reserva} de {reserva.hora_inicio} a {reserva.hora_fin}. Prop√≥sito: {reserva.proposito}",
                    usuario_relacionado=request.user,
                    reserva=reserva,
                    request=request
                )
                print(f"üéØ CREAR_RESERVA_API: Notificaci√≥n admin CREADA para reserva {reserva.id}")
            except Exception as admin_notif_error:
                print(f"‚ùå CREAR_RESERVA_API: Error en notificaci√≥n admin: {admin_notif_error}")
            
            # NOTIFICAR AL USUARIO
            try:
                notificacion = NotificacionService.notificar_creacion_reserva(reserva)
                if notificacion:
                    print(f"üìß Notificaci√≥n de creaci√≥n enviada exitosamente: {notificacion.id}")
                else:
                    print("‚ö†Ô∏è No se pudo crear la notificaci√≥n de creaci√≥n")
            except Exception as notif_error:
                print(f"‚ö†Ô∏è Error en notificaci√≥n: {notif_error}")
                # No fallar la reserva por error en notificaci√≥n
            
            return JsonResponse({
                'success': True,
                'message': 'Reserva creada exitosamente',
                'reserva_id': reserva.id,
                'notificacion_creada': True,
                'redirect_url': f'/reserva-exitosa/?reserva_id={reserva.id}'
            })

        except Exception as e:
            print(f"‚ùå Error creando reserva: {e}")
            import traceback
            traceback.print_exc()
            return JsonResponse({
                'success': False,
                'message': f'Error interno del servidor: {str(e)}'
            }, status=500)

    return JsonResponse({
        'success': False,
        'message': 'M√©todo no permitido'
    }, status=405)

@login_required
def espacios_view(request):
    """Vista para mostrar los espacios disponibles"""
    try:
        espacios = Espacio.objects.filter(estado='Disponible').prefetch_related('equipamientos')
        print(f"üè¢ Espacios encontrados: {espacios.count()}")
        
        context = {
            'user': request.user,
            'espacios': espacios
        }
        return render(request, 'reservas/espacios.html', context)
    except Exception as e:
        print(f"‚ùå Error en espacios_view: {e}")
        return render(request, 'reservas/espacios.html', {'espacios': []})

@login_required
def notificaciones_view(request):
    """Vista para mostrar notificaciones"""
    try:
        notificaciones = Notificacion.objects.filter(
            destinatario=request.user
        ).order_by('-fecha_creacion')[:10]
        
        context = {
            'user': request.user,
            'notificaciones': notificaciones
        }
        return render(request, 'reservas/notificaciones.html', context)
    except Exception as e:
        print(f"Error en notificaciones_view: {e}")
        return render(request, 'reservas/notificaciones.html', {'notificaciones': []})

@login_required
@csrf_exempt
def aprobar_reserva_api(request, reserva_id):
    """API para que administradores aprueben reservas - VERSI√ìN CORREGIDA"""
    if request.method == 'POST':
        try:
            # Verificar que el usuario es administrador - ACTUALIZADO
            perfil = PerfilUsuario.objects.get(user=request.user)
            if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
                return JsonResponse({
                    'success': False, 
                    'error': 'No tienes permisos para aprobar reservas'
                }, status=403)
            
            # Obtener datos del cuerpo de la solicitud
            data = json.loads(request.body) if request.body else {}
            comentario_admin = data.get('comentario', '')
            
            reserva = Reserva.objects.get(id=reserva_id)
            estado_anterior = reserva.estado
            reserva.estado = 'Aprobada'
            reserva.id_aprobador = request.user
            reserva.comentario_admin = comentario_admin
            reserva.save()
            
            print(f"‚úÖ Reserva {reserva_id} aprobada por {request.user.username}")
            
            # NOTIFICAR AL USUARIO
            notificacion = NotificacionService.notificar_aprobacion_reserva(
                reserva, 
                comentario_admin
            )
            
            # üîî NOTIFICAR A ADMINISTRADORES SOBRE APROBACI√ìN
            try:
                notificar_accion_admin(
                    tipo='reserva_aprobada',
                    titulo='‚úÖ Reserva Aprobada',
                    mensaje=f"El administrador {request.user.username} ha aprobado la reserva #{reserva.id} de {reserva.solicitante.username} para {reserva.espacio.nombre}",
                    usuario_admin=request.user,
                    usuario_relacionado=reserva.solicitante,
                    reserva=reserva,
                    request=request
                )
                print(f"üì¢ Notificaci√≥n admin creada para aprobaci√≥n de reserva {reserva.id}")
            except Exception as admin_notif_error:
                print(f"‚ö†Ô∏è Error en notificaci√≥n admin aprobaci√≥n: {admin_notif_error}")
            
            # Crear historial
            HistorialAprobacion.objects.create(
                reserva=reserva,
                usuario_admin=request.user,
                tipo_accion='Aprobada',
                motivo=comentario_admin
            )
            
            return JsonResponse({
                'success': True, 
                'message': 'Reserva aprobada exitosamente',
                'notificacion_creada': notificacion is not None
            })
            
        except Reserva.DoesNotExist:
            return JsonResponse({'success': False, 'error': 'Reserva no encontrada'})
        except Exception as e:
            print(f"‚ùå Error en aprobar_reserva_api: {e}")
            return JsonResponse({'success': False, 'error': str(e)})

@login_required
@csrf_exempt
def rechazar_reserva_api(request, reserva_id):
    """API para que administradores rechacen reservas - VERSI√ìN CORREGIDA"""
    if request.method == 'POST':
        try:
            # Verificar que el usuario es administrador - ACTUALIZADO
            perfil = PerfilUsuario.objects.get(user=request.user)
            if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
                return JsonResponse({
                    'success': False, 
                    'error': 'No tienes permisos para rechazar reservas'
                }, status=403)
            
            # Obtener datos del cuerpo de la solicitud
            data = json.loads(request.body) if request.body else {}
            motivo = data.get('motivo', 'Sin motivo especificado')
            
            reserva = Reserva.objects.get(id=reserva_id)
            estado_anterior = reserva.estado
            reserva.estado = 'Rechazada'
            reserva.id_aprobador = request.user
            reserva.comentario_admin = motivo
            reserva.save()
            
            print(f"‚ùå Reserva {reserva_id} rechazada por {request.user.username}")
            
            # NOTIFICAR AL USUARIO
            notificacion = NotificacionService.notificar_rechazo_reserva(
                reserva, 
                motivo
            )
            
            # üîî NOTIFICAR A ADMINISTRADORES SOBRE RECHAZO
            try:
                notificar_accion_admin(
                    tipo='reserva_rechazada',
                    titulo='‚ùå Reserva Rechazada',
                    mensaje=f"El administrador {request.user.username} ha rechazado la reserva #{reserva.id} de {reserva.solicitante.username} para {reserva.espacio.nombre}. Motivo: {motivo}",
                    usuario_admin=request.user,
                    usuario_relacionado=reserva.solicitante,
                    reserva=reserva,
                    request=request
                )
                print(f"üì¢ Notificaci√≥n admin creada para rechazo de reserva {reserva.id}")
            except Exception as admin_notif_error:
                print(f"‚ö†Ô∏è Error en notificaci√≥n admin rechazo: {admin_notif_error}")
            
            # Crear historial
            HistorialAprobacion.objects.create(
                reserva=reserva,
                usuario_admin=request.user,
                tipo_accion='Rechazada',
                motivo=motivo
            )
            
            return JsonResponse({
                'success': True, 
                'message': 'Reserva rechazada exitosamente',
                'notificacion_creada': notificacion is not None
            })
            
        except Reserva.DoesNotExist:
            return JsonResponse({'success': False, 'error': 'Reserva no encontrada'})
        except Exception as e:
            print(f"‚ùå Error en rechazar_reserva_api: {e}")
            return JsonResponse({'success': False, 'error': str(e)})

def force_logout(request):
    from django.contrib.auth import logout
    logout(request)
    return redirect('login')

# Agregar estas vistas al final del views.py existente

@login_required
@require_http_methods(["GET"])
def get_notificaciones_usuario(request):
    """
    API para obtener las notificaciones del usuario - VERSI√ìN MEJORADA
    """
    try:
        # Obtener par√°metros de la solicitud
        no_leidas = request.GET.get('no_leidas', 'false').lower() == 'true'
        limite = int(request.GET.get('limite', 20))
        
        # Obtener notificaciones usando el servicio
        notificaciones = NotificacionService.obtener_notificaciones_usuario(
            usuario=request.user,
            no_leidas=no_leidas,
            limite=limite
        )
        
        # Formatear respuesta con m√°s informaci√≥n
        data = []
        for notif in notificaciones:
            notif_data = {
                'id': notif.id,
                'tipo': notif.tipo,
                'titulo': notif.titulo,
                'mensaje': notif.mensaje,
                'leida': notif.leida,
                'fecha_creacion': notif.fecha_creacion.strftime('%d/%m/%Y %H:%M'),
                'fecha_creacion_formateada': notif.get_fecha_creacion_formateada(),
            }
            
            # Incluir informaci√≥n de la reserva si existe
            if notif.reserva:
                notif_data.update({
                    'reserva_id': notif.reserva.id,
                    'espacio_nombre': notif.reserva.espacio.nombre,
                    'fecha_reserva': notif.reserva.fecha_reserva.strftime('%d/%m/%Y') if notif.reserva.fecha_reserva else None,
                    'estado_reserva': notif.reserva.estado
                })
            
            data.append(notif_data)
        
        # Contar notificaciones no le√≠das
        total_no_leidas = NotificacionService.contar_notificaciones_no_leidas(request.user)
        
        return JsonResponse({
            'success': True,
            'notificaciones': data,
            'total_no_leidas': total_no_leidas,
            'total': len(data)
        })
        
    except Exception as e:
        print(f"‚ùå Error en get_notificaciones_usuario: {e}")
        return JsonResponse({
            'success': False,
            'error': 'Error al obtener notificaciones',
            'notificaciones': [],
            'total_no_leidas': 0,
            'total': 0
        })

@login_required
@csrf_exempt
@require_http_methods(["POST"])
def marcar_notificacion_leida(request, notificacion_id):
    """
    API para marcar una notificaci√≥n como le√≠da
    """
    try:
        # Verificar que la notificaci√≥n pertenece al usuario
        notificacion = Notificacion.objects.get(
            id=notificacion_id,
            destinatario=request.user
        )
        
        # Marcar como le√≠da usando el servicio
        NotificacionService.marcar_como_leida(notificacion_id)
        
        return JsonResponse({
            'success': True,
            'message': 'Notificaci√≥n marcada como le√≠da'
        })
        
    except Notificacion.DoesNotExist:
        return JsonResponse({
            'success': False,
            'error': 'Notificaci√≥n no encontrada'
        }, status=404)
    except Exception as e:
        print(f"‚ùå Error en marcar_notificacion_leida: {e}")
        return JsonResponse({
            'success': False,
            'error': 'Error al marcar notificaci√≥n como le√≠da'
        }, status=500)

@login_required
@csrf_exempt
@require_http_methods(["POST"])
def marcar_todas_leidas(request):
    """
    API para marcar todas las notificaciones como le√≠das
    """
    try:
        count = NotificacionService.marcar_todas_como_leidas(request.user)
        
        return JsonResponse({
            'success': True,
            'message': f'{count} notificaciones marcadas como le√≠das',
            'count': count
        })
        
    except Exception as e:
        print(f"‚ùå Error en marcar_todas_leidas: {e}")
        return JsonResponse({
            'success': False,
            'error': 'Error al marcar notificaciones como le√≠das'
        }, status=500)

@login_required
@require_http_methods(["GET"])
def contar_notificaciones_no_leidas(request):
    """
    API para contar notificaciones no le√≠das
    """
    try:
        count = NotificacionService.contar_notificaciones_no_leidas(request.user)
        
        return JsonResponse({
            'success': True,
            'count': count
        })
        
    except Exception as e:
        print(f"‚ùå Error en contar_notificaciones_no_leidas: {e}")
        return JsonResponse({
            'success': False,
            'error': 'Error al contar notificaciones'
        }, status=500)

# === VISTAS PARA GESTI√ìN DE ESPACIOS ===

@login_required
def crear_espacio_view(request):
    """Vista para crear espacio (template)"""
    try:
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
            return redirect('dashboard')
        
        return render(request, 'reservas/crear_espacio.html')
    except PerfilUsuario.DoesNotExist:
        return redirect('login')

@login_required
def editar_espacio_view(request):
    """Vista para editar espacio (template)"""
    try:
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
            return redirect('dashboard')
        
        espacio_id = request.GET.get('id')
        if not espacio_id:
            return redirect('gestion_espacios')
            
        # Verificar que el espacio existe
        espacio = Espacio.objects.get(id=espacio_id)
        
        context = {
            'user': request.user,
            'espacio_id': espacio_id,
            'espacio': espacio
        }
        return render(request, 'reservas/editar_espacio.html', context)
        
    except Espacio.DoesNotExist:
        messages.error(request, 'Espacio no encontrado')
        return redirect('gestion_espacios')
    except PerfilUsuario.DoesNotExist:
        return redirect('login')

# APIs para gesti√≥n de espacios
@login_required
@csrf_exempt
@require_http_methods(["POST"])
def crear_espacio_api(request):
    """API para crear espacios - VERSI√ìN MEJORADA CON DATOS REALES"""
    print("üéØ CREAR_ESPACIO_API: Iniciando creaci√≥n de espacio...")
    
    try:
        # Verificar permisos de administrador
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
            print("‚ùå Usuario sin permisos de administrador")
            return JsonResponse({
                'success': False, 
                'error': 'No tienes permisos para crear espacios'
            }, status=403)
        
        # Parsear datos
        data = json.loads(request.body)
        print(f"üéØ CREAR_ESPACIO_API: Datos recibidos: {data}")
        
        # Validaciones
        required_fields = ['nombre', 'tipo', 'capacidad']
        for field in required_fields:
            if not data.get(field):
                return JsonResponse({
                    'success': False, 
                    'error': f'El campo {field} es requerido'
                }, status=400)
        
        # Validar capacidad
        try:
            capacidad = int(data['capacidad'])
            if capacidad <= 0:
                return JsonResponse({
                    'success': False, 
                    'error': 'La capacidad debe ser mayor a 0'
                }, status=400)
        except (ValueError, TypeError):
            return JsonResponse({
                'success': False, 
                'error': 'La capacidad debe ser un n√∫mero v√°lido'
            }, status=400)
        
        # Crear espacio REAL
        espacio = Espacio.objects.create(
            nombre=data['nombre'].strip(),
            tipo=data['tipo'],
            capacidad=capacidad,
            edificio=data.get('edificio', '').strip() or None,
            piso=data.get('piso'),
            descripcion=data.get('descripcion', '').strip() or None,
            estado=data.get('estado', 'Disponible')
        )
        
        print(f"üéØ CREAR_ESPACIO_API: Espacio REAL creado: ID {espacio.id} - {espacio.nombre}")
        
        # üîî NOTIFICAR A ADMINISTRADORES SOBRE NUEVO ESPACIO REAL
        print("üéØ CREAR_ESPACIO_API: Intentando crear notificaci√≥n admin...")
        try:
            notificar_accion_admin(
                tipo='espacio_creado',
                titulo='üè¢ Nuevo Espacio Creado',
                mensaje=f"El administrador {request.user.username} ha creado el espacio '{espacio.nombre}' ({espacio.tipo}) con capacidad para {espacio.capacidad} personas. Estado: {espacio.estado}",
                usuario_admin=request.user,
                espacio=espacio,
                request=request
            )
            print(f"üéØ CREAR_ESPACIO_API: Notificaci√≥n admin REAL creada para nuevo espacio {espacio.id}")
        except Exception as admin_notif_error:
            print(f"‚ùå CREAR_ESPACIO_API: Error en notificaci√≥n admin espacio: {admin_notif_error}")
        
        return JsonResponse({
            'success': True, 
            'message': 'Espacio creado exitosamente',
            'espacio_id': espacio.id
        })
        
    except Exception as e:
        print(f"‚ùå CREAR_ESPACIO_API: Error inesperado: {str(e)}")
        import traceback
        traceback.print_exc()
        return JsonResponse({
            'success': False, 
            'error': f'Error interno del servidor: {str(e)}'
        }, status=500)

@login_required
@require_http_methods(["GET"])
def obtener_espacio_api(request, espacio_id):
    """API para obtener datos de un espacio espec√≠fico - VERSI√ìN CORREGIDA"""
    try:
        print(f"üîç Buscando espacio ID: {espacio_id}")
        
        # Verificar permisos
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
            return JsonResponse({
                'success': False, 
                'error': 'No tienes permisos para editar espacios'
            }, status=403)
        
        espacio = Espacio.objects.get(id=espacio_id)
        print(f"‚úÖ Espacio encontrado: {espacio.nombre}")
        
        return JsonResponse({
            'success': True,
            'espacio': {
                'id': espacio.id,
                'nombre': espacio.nombre,
                'tipo': espacio.tipo,
                'edificio': espacio.edificio or '',
                'piso': espacio.piso,
                'capacidad': espacio.capacidad,
                'descripcion': espacio.descripcion or '',
                'estado': espacio.estado
            }
        })
    except Espacio.DoesNotExist:
        print(f"‚ùå Espacio {espacio_id} no encontrado")
        return JsonResponse({
            'success': False, 
            'error': 'Espacio no encontrado'
        }, status=404)
    except Exception as e:
        print(f"üí• Error al obtener espacio: {str(e)}")
        return JsonResponse({
            'success': False, 
            'error': f'Error al cargar espacio: {str(e)}'
        }, status=500)
        
@login_required
@csrf_exempt
@require_http_methods(["POST"])  
def actualizar_espacio_api(request, espacio_id):
    """API para actualizar espacios"""
    print(f"üéØ ACTUALIZAR_ESPACIO_API: Actualizando espacio ID: {espacio_id}")
    
    if request.method != 'POST':
        return JsonResponse({'success': False, 'error': 'M√©todo no permitido'})
    
    try:
        # Verificar permisos
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
            return JsonResponse({'success': False, 'error': 'No tienes permisos de administrador'})
        
        # Obtener espacio
        espacio = Espacio.objects.get(id=espacio_id)
        
        # Parsear datos
        data = json.loads(request.body)
        print(f"üéØ ACTUALIZAR_ESPACIO_API: Datos para actualizar: {data}")
        
        # Actualizar campos
        if 'nombre' in data:
            espacio.nombre = data['nombre'].strip()
        if 'tipo' in data:
            espacio.tipo = data['tipo']
        if 'capacidad' in data:
            espacio.capacidad = int(data['capacidad'])
        if 'edificio' in data:
            espacio.edificio = data['edificio'].strip() or None
        if 'piso' in data:
            piso = data['piso']
            espacio.piso = int(piso) if piso and str(piso).strip() else None
        if 'descripcion' in data:
            espacio.descripcion = data['descripcion'].strip() or None
        if 'estado' in data:
            espacio.estado = data['estado']
        
        # Guardar cambios
        espacio.save()
        
        print(f"üéØ ACTUALIZAR_ESPACIO_API: Espacio actualizado: {espacio.id} - {espacio.nombre}")
        
        # üîî NOTIFICAR ACTUALIZACI√ìN DE ESPACIO
        print("üéØ ACTUALIZAR_ESPACIO_API: Intentando crear notificaci√≥n admin...")
        try:
            notificar_accion_admin(
                tipo='espacio_actualizado',
                titulo='‚úèÔ∏è Espacio Actualizado',
                mensaje=f"El administrador {request.user.username} ha actualizado el espacio '{espacio.nombre}'",
                usuario_admin=request.user,
                espacio=espacio,
                request=request
            )
            print(f"üéØ ACTUALIZAR_ESPACIO_API: Notificaci√≥n admin CREADA para actualizaci√≥n de espacio {espacio.id}")
        except Exception as admin_notif_error:
            print(f"‚ùå ACTUALIZAR_ESPACIO_API: Error en notificaci√≥n admin actualizaci√≥n espacio: {admin_notif_error}")
        
        return JsonResponse({
            'success': True, 
            'message': 'Espacio actualizado exitosamente'
        })
        
    except Espacio.DoesNotExist:
        return JsonResponse({'success': False, 'error': 'Espacio no encontrado'})
    except json.JSONDecodeError:
        return JsonResponse({'success': False, 'error': 'Error en el formato de datos JSON'})
    except Exception as e:
        print(f"‚ùå ACTUALIZAR_ESPACIO_API: Error al actualizar: {str(e)}")
        import traceback
        traceback.print_exc()
        return JsonResponse({'success': False, 'error': f'Error interno del servidor: {str(e)}'})

@login_required
@csrf_exempt
@require_http_methods(["POST"])
def eliminar_espacio_api(request, espacio_id):
    """API para eliminar un espacio"""
    try:
        # Verificar permisos de administrador
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
            return JsonResponse({'success': False, 'error': 'No tienes permisos'}, status=403)
        
        espacio = Espacio.objects.get(id=espacio_id)
        espacio_nombre = espacio.nombre
        espacio.delete()
        
        # üîî NOTIFICAR A ADMINISTRADORES SOBRE ELIMINACI√ìN DE ESPACIO
        try:
            notificar_accion_admin(
                tipo='espacio_eliminado',
                titulo='üóëÔ∏è Espacio Eliminado',
                mensaje=f"El administrador {request.user.username} ha eliminado el espacio '{espacio_nombre}'",
                usuario_admin=request.user,
                request=request
            )
            print(f"üì¢ Notificaci√≥n admin creada para eliminaci√≥n de espacio {espacio_id}")
        except Exception as admin_notif_error:
            print(f"‚ö†Ô∏è Error en notificaci√≥n admin eliminaci√≥n espacio: {admin_notif_error}")
        
        return JsonResponse({
            'success': True, 
            'message': f'Espacio "{espacio_nombre}" eliminado exitosamente'
        })
        
    except Espacio.DoesNotExist:
        return JsonResponse({'success': False, 'error': 'Espacio no encontrado'}, status=404)
    except Exception as e:
        return JsonResponse({'success': False, 'error': str(e)}, status=500)

# === VISTAS FALTANTES PARA GESTI√ìN DE USUARIOS ===

@login_required
@require_http_methods(["GET"])
def filtrar_usuarios_api(request):
    """API para filtrar usuarios con m√∫ltiples criterios"""
    try:
        # Verificar permisos de administrador
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
            return JsonResponse({'success': False, 'error': 'No tienes permisos'}, status=403)
        
        # Obtener par√°metros de filtrado
        search_term = request.GET.get('search', '').strip()
        rol_filter = request.GET.get('rol', '')
        estado_filter = request.GET.get('estado', '')
        
        # Consulta base
        usuarios = User.objects.all().select_related('perfilusuario')
        
        # Aplicar filtros
        if search_term:
            usuarios = usuarios.filter(
                Q(username__icontains=search_term) |
                Q(first_name__icontains=search_term) |
                Q(last_name__icontains=search_term) |
                Q(email__icontains=search_term)
            )
        
        if rol_filter:
            usuarios = usuarios.filter(perfilusuario__rol=rol_filter)
        
        if estado_filter:
            if estado_filter == 'activo':
                usuarios = usuarios.filter(is_active=True)
            elif estado_filter == 'inactivo':
                usuarios = usuarios.filter(is_active=False)
        
        # Ordenar por fecha de registro
        usuarios = usuarios.order_by('-date_joined')
        
        # Formatear respuesta
        data = []
        for usuario in usuarios:
            try:
                perfil_usuario = usuario.perfilusuario
                data.append({
                    'id': usuario.id,
                    'username': usuario.username,
                    'email': usuario.email,
                    'first_name': usuario.first_name,
                    'last_name': usuario.last_name,
                    'is_active': usuario.is_active,
                    'date_joined': usuario.date_joined.strftime('%d/%m/%Y %H:%M'),
                    'rol': perfil_usuario.rol,
                    'estado_perfil': perfil_usuario.estado,
                    'departamento': perfil_usuario.departamento
                })
            except PerfilUsuario.DoesNotExist:
                # Si no tiene perfil, incluir igual con valores por defecto
                data.append({
                    'id': usuario.id,
                    'username': usuario.username,
                    'email': usuario.email,
                    'first_name': usuario.first_name,
                    'last_name': usuario.last_name,
                    'is_active': usuario.is_active,
                    'date_joined': usuario.date_joined.strftime('%d/%m/%Y %H:%M'),
                    'rol': 'No asignado',
                    'estado_perfil': 'activo',
                    'departamento': 'No asignado'
                })
        
        return JsonResponse({
            'success': True,
            'usuarios': data,
            'total': len(data)
        })
        
    except Exception as e:
        print(f"‚ùå Error en filtrar_usuarios_api: {e}")
        return JsonResponse({
            'success': False,
            'error': 'Error al filtrar usuarios'
        }, status=500)

@login_required
@require_http_methods(["GET"])
def obtener_usuario_api(request, user_id):
    """API para obtener datos de un usuario espec√≠fico - MEJORADA"""
    try:
        # Verificar permisos de administrador
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
            return JsonResponse({'success': False, 'error': 'No tienes permisos'}, status=403)
        
        usuario = User.objects.get(id=user_id)
        perfil_usuario = PerfilUsuario.objects.get(user=usuario)
        
        return JsonResponse({
            'success': True,
            'usuario': {
                'id': usuario.id,
                'username': usuario.username,  # Incluir username
                'first_name': usuario.first_name,
                'last_name': usuario.last_name,
                'email': usuario.email,
                'is_active': usuario.is_active,
                'date_joined': usuario.date_joined.strftime('%d/%m/%Y %H:%M'),
                'rol': perfil_usuario.rol,
                'departamento': perfil_usuario.departamento,
                'estado': perfil_usuario.estado
            }
        })
    except User.DoesNotExist:
        return JsonResponse({'success': False, 'error': 'Usuario no encontrado'}, status=404)
    except PerfilUsuario.DoesNotExist:
        return JsonResponse({'success': False, 'error': 'Perfil de usuario no encontrado'}, status=404)
    except Exception as e:
        return JsonResponse({'success': False, 'error': str(e)}, status=500)

@login_required
@csrf_exempt
@require_http_methods(["POST"])
def actualizar_usuario_api(request, user_id):
    """API para actualizar datos de usuario - MEJORADA CON USERNAME SEPARADO"""
    print(f"üéØ ACTUALIZAR_USUARIO_API: Actualizando usuario ID: {user_id}")
    
    try:
        # Verificar permisos de administrador
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
            return JsonResponse({'success': False, 'error': 'No tienes permisos para editar usuarios'}, status=403)
        
        # Verificar que existe cuerpo de la solicitud
        if not request.body:
            return JsonResponse({'success': False, 'error': 'No se recibieron datos'}, status=400)
        
        # Parsear datos JSON
        try:
            data = json.loads(request.body)
            print(f"üì• Datos recibidos: {data}")
        except json.JSONDecodeError as e:
            return JsonResponse({'success': False, 'error': 'Formato JSON inv√°lido'}, status=400)
        
        # Obtener usuario a actualizar
        try:
            usuario = User.objects.get(id=user_id)
            print(f"‚úÖ Usuario encontrado: {usuario.username}")
        except User.DoesNotExist:
            return JsonResponse({'success': False, 'error': 'Usuario no encontrado'}, status=404)
        
        # VERIFICAR DUPLICADOS DE USERNAME
        if 'username' in data and data['username']:
            nuevo_username = data['username'].strip()
            username_existente = User.objects.filter(username=nuevo_username).exclude(id=user_id).exists()
            
            if username_existente:
                return JsonResponse({
                    'success': False, 
                    'error': f'Ya existe un usuario con el nombre: {nuevo_username}'
                }, status=400)
        
        # VERIFICAR DUPLICADOS DE EMAIL
        if 'email' in data and data['email']:
            nuevo_email = data['email'].strip().lower()
            email_existente = User.objects.filter(email=nuevo_email).exclude(id=user_id).exists()
            
            if email_existente:
                return JsonResponse({
                    'success': False, 
                    'error': f'Ya existe un usuario con el email: {nuevo_email}'
                }, status=400)
        
        # Actualizar datos b√°sicos del usuario
        campos_actualizados = []
        if 'username' in data:
            usuario.username = data['username']
            campos_actualizados.append('username')
        if 'first_name' in data:
            usuario.first_name = data['first_name']
            campos_actualizados.append('nombre')
        if 'last_name' in data:
            usuario.last_name = data['last_name']
            campos_actualizados.append('apellido')
        if 'email' in data:
            usuario.email = data['email']
            campos_actualizados.append('email')
        
        if campos_actualizados:
            usuario.save()
            print(f"‚úÖ Datos b√°sicos actualizados: {', '.join(campos_actualizados)}")
        
        # Actualizar perfil de usuario
        try:
            perfil_usuario = PerfilUsuario.objects.get(user=usuario)
            print(f"‚úÖ Perfil encontrado para {usuario.username}")
            
            if 'rol' in data:
                perfil_usuario.rol = data['rol']
                campos_actualizados.append('rol')
            if 'departamento' in data:
                perfil_usuario.departamento = data['departamento']
                campos_actualizados.append('departamento')
            
            if campos_actualizados:
                perfil_usuario.save()
                print(f"‚úÖ Perfil actualizado: {', '.join(campos_actualizados)}")
                
        except PerfilUsuario.DoesNotExist:
            print(f"‚ö†Ô∏è No existe perfil para {usuario.username}, creando uno...")
            try:
                area_default = Area.objects.get_or_create(
                    nombre_area="General",
                    defaults={'descripcion': '√Årea general por defecto'}
                )[0]
                
                PerfilUsuario.objects.create(
                    user=usuario,
                    rol=data.get('rol', 'Usuario'),
                    area=area_default,
                    departamento=data.get('departamento', 'Indefinido'),
                    estado='activo'
                )
                campos_actualizados.append('perfil_creado')
            except Exception as area_error:
                print(f"‚ùå Error creando √°rea por defecto: {area_error}")
                # Crear perfil sin √°rea si hay error
                PerfilUsuario.objects.create(
                    user=usuario,
                    rol=data.get('rol', 'Usuario'),
                    departamento=data.get('departamento', 'Indefinido'),
                    estado='activo'
                )
                campos_actualizados.append('perfil_creado_sin_area')
        
        # üîî NOTIFICAR ACTUALIZACI√ìN DE USUARIO
        try:
            notificar_accion_admin(
                tipo='usuario_actualizado',
                titulo='‚úèÔ∏è Usuario Actualizado',
                mensaje=f"El administrador {request.user.username} ha actualizado los datos del usuario {usuario.username}. Campos actualizados: {', '.join(campos_actualizados) if campos_actualizados else 'ninguno'}",
                usuario_admin=request.user,
                usuario_relacionado=usuario,
                request=request
            )
            print(f"üì¢ Notificaci√≥n admin creada para actualizaci√≥n de usuario {usuario.id}")
        except Exception as admin_notif_error:
            print(f"‚ö†Ô∏è Error en notificaci√≥n admin actualizaci√≥n usuario: {admin_notif_error}")
        
        return JsonResponse({
            'success': True, 
            'message': 'Usuario actualizado exitosamente',
            'campos_actualizados': campos_actualizados
        })
        
    except Exception as e:
        print(f"‚ùå ERROR CR√çTICO en actualizar_usuario_api: {str(e)}")
        import traceback
        traceback.print_exc()
        return JsonResponse({
            'success': False, 
            'error': f'Error interno del servidor: {str(e)}'
        }, status=500)

@login_required
@csrf_exempt
@require_http_methods(["POST"])
def cambiar_estado_usuario_api(request, user_id):
    """API para activar/desactivar usuario"""
    try:
        # Verificar permisos de administrador
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
            return JsonResponse({'success': False, 'error': 'No tienes permisos'}, status=403)
        
        data = json.loads(request.body)
        activo = data.get('activo', True)
        
        usuario = User.objects.get(id=user_id)
        estado_anterior = usuario.is_active
        usuario.is_active = activo
        usuario.save()
        
        # Actualizar estado en el perfil tambi√©n
        try:
            perfil_usuario = PerfilUsuario.objects.get(user=usuario)
            perfil_usuario.estado = 'activo' if activo else 'inactivo'
            perfil_usuario.save()
        except PerfilUsuario.DoesNotExist:
            pass
        
        # üîî NOTIFICAR CAMBIO DE ESTADO DE USUARIO
        try:
            accion = "activado" if activo else "desactivado"
            notificar_accion_admin(
                tipo='usuario_actualizado',
                titulo=f'üë§ Usuario {accion.capitalize()}',
                mensaje=f"El administrador {request.user.username} ha {accion} al usuario {usuario.username}",
                usuario_admin=request.user,
                usuario_relacionado=usuario,
                request=request
            )
            print(f"üì¢ Notificaci√≥n admin creada para {accion} de usuario {usuario.id}")
        except Exception as admin_notif_error:
            print(f"‚ö†Ô∏è Error en notificaci√≥n admin estado usuario: {admin_notif_error}")
        
        accion = "activado" if activo else "desactivado"
        return JsonResponse({'success': True, 'message': f'Usuario {accion} exitosamente'})
        
    except User.DoesNotExist:
        return JsonResponse({'success': False, 'error': 'Usuario no encontrado'}, status=404)
    except Exception as e:
        return JsonResponse({'success': False, 'error': str(e)}, status=500)

@login_required
@require_http_methods(["GET"])
def obtener_perfiles_usuario_api(request):
    """API para obtener perfiles de usuario"""
    try:
        # Verificar permisos de administrador
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
            return JsonResponse({'success': False, 'error': 'No tienes permisos'}, status=403)
        
        user_id = request.GET.get('user_id')
        if user_id:
            perfiles = PerfilUsuario.objects.filter(user_id=user_id)
        else:
            perfiles = PerfilUsuario.objects.all()
        
        data = []
        for perfil in perfiles:
            data.append({
                'id': perfil.id,
                'user_id': perfil.user.id,
                'username': perfil.user.username,
                'email': perfil.user.email,
                'first_name': perfil.user.first_name,
                'last_name': perfil.user.last_name,
                'rol': perfil.rol,
                'estado': perfil.estado,
                'departamento': perfil.departamento,
                'fecha_registro': perfil.fecha_registro.strftime('%d/%m/%Y %H:%M')
            })
        
        return JsonResponse({'success': True, 'perfiles': data})
    except Exception as e:
        return JsonResponse({'success': False, 'error': str(e)}, status=500)
    
@login_required
def notificaciones_admin_view(request):
    """Vista de notificaciones para administradores"""
    try:
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
            return redirect('dashboard')
        
        return render(request, 'reservas/notificaciones_admin.html')
    except PerfilUsuario.DoesNotExist:
        return redirect('login')

@login_required
def get_notificaciones_admin_api(request):
    """API para obtener notificaciones de administradores"""
    try:
        # Verificar que el usuario es administrador
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
            return JsonResponse({'success': False, 'error': 'No autorizado'}, status=403)
        
        # Obtener par√°metros
        no_leidas = request.GET.get('no_leidas', 'false').lower() == 'true'
        limite = int(request.GET.get('limite', 50))
        tipo_filtro = request.GET.get('tipo', '')
        
        # Consulta base
        notificaciones = NotificacionAdmin.objects.all()
        
        # Aplicar filtros
        if no_leidas:
            notificaciones = notificaciones.filter(leida=False)
        
        if tipo_filtro:
            notificaciones = notificaciones.filter(tipo=tipo_filtro)
        
        # Ordenar y limitar
        notificaciones = notificaciones.select_related(
            'usuario_relacionado', 'reserva', 'reserva__espacio', 'espacio'
        ).order_by('-fecha_creacion')[:limite]
        
        # Formatear respuesta
        data = []
        for notif in notificaciones:
            notif_data = {
                'id': notif.id,
                'tipo': notif.tipo,
                'titulo': notif.titulo,
                'mensaje': notif.mensaje,
                'prioridad': notif.prioridad,
                'leida': notif.leida,
                'fecha_creacion': notif.fecha_creacion.strftime('%d/%m/%Y %H:%M:%S'),
                'fecha_creacion_timestamp': notif.fecha_creacion.timestamp(),
                'usuario_relacionado': None,
                'reserva_info': None,
                'espacio_info': None
            }
            
            # Informaci√≥n del usuario relacionado
            if notif.usuario_relacionado:
                notif_data['usuario_relacionado'] = {
                    'username': notif.usuario_relacionado.username,
                    'nombre_completo': f"{notif.usuario_relacionado.first_name} {notif.usuario_relacionado.last_name}"
                }
            
            # Informaci√≥n de la reserva
            if notif.reserva:
                notif_data['reserva_info'] = {
                    'id': notif.reserva.id,
                    'espacio_nombre': notif.reserva.espacio.nombre,
                    'fecha': notif.reserva.fecha_reserva.strftime('%d/%m/%Y'),
                    'estado': notif.reserva.estado
                }
            
            # Informaci√≥n del espacio
            if notif.espacio:
                notif_data['espacio_info'] = {
                    'id': notif.espacio.id,
                    'nombre': notif.espacio.nombre,
                    'tipo': notif.espacio.tipo
                }
            
            data.append(notif_data)
        
        # Contar no le√≠das
        total_no_leidas = NotificacionAdmin.objects.filter(leida=False).count()
        
        return JsonResponse({
            'success': True,
            'notificaciones': data,
            'total_no_leidas': total_no_leidas,
            'total': len(data)
        })
        
    except Exception as e:
        print(f"‚ùå Error en get_notificaciones_admin_api: {e}")
        return JsonResponse({
            'success': False,
            'error': 'Error al obtener notificaciones'
        })

# === VISTAS PARA NOTIFICACIONES DE ADMINISTRADOR ===

@login_required
@require_http_methods(["GET"])
def contar_notificaciones_admin_no_leidas(request):
    """API para contar notificaciones de admin no le√≠das"""
    try:
        # Verificar que el usuario es administrador
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
            return JsonResponse({'success': False, 'error': 'No autorizado'}, status=403)
        
        count = NotificacionAdmin.objects.filter(leida=False).count()
        
        return JsonResponse({
            'success': True,
            'count': count
        })
        
    except Exception as e:
        print(f"‚ùå Error en contar_notificaciones_admin_no_leidas: {e}")
        return JsonResponse({
            'success': False,
            'error': 'Error al contar notificaciones'
        }, status=500)

@login_required
@csrf_exempt
@require_http_methods(["POST"])
def marcar_todas_notificaciones_admin_leidas(request):
    """API para marcar todas las notificaciones de admin como le√≠das"""
    try:
        # Verificar que el usuario es administrador
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
            return JsonResponse({'success': False, 'error': 'No autorizado'}, status=403)
        
        notificaciones = NotificacionAdmin.objects.filter(leida=False)
        count = notificaciones.count()
        notificaciones.update(leida=True, fecha_lectura=timezone.now())
        
        print(f"üì≠ Marcadas {count} notificaciones admin como le√≠das")
        
        return JsonResponse({
            'success': True,
            'message': f'{count} notificaciones marcadas como le√≠das',
            'count': count
        })
        
    except Exception as e:
        print(f"‚ùå Error en marcar_todas_notificaciones_admin_leidas: {e}")
        return JsonResponse({
            'success': False,
            'error': 'Error al marcar notificaciones como le√≠das'
        }, status=500)

@login_required
@csrf_exempt
@require_http_methods(["POST"])
def marcar_notificacion_admin_leida(request, notificacion_id):
    """API para marcar una notificaci√≥n de admin como le√≠da"""
    try:
        # Verificar que el usuario es administrador
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
            return JsonResponse({'success': False, 'error': 'No autorizado'}, status=403)
        
        notificacion = NotificacionAdmin.objects.get(id=notificacion_id)
        notificacion.marcar_como_leida()
        
        return JsonResponse({
            'success': True,
            'message': 'Notificaci√≥n marcada como le√≠da'
        })
        
    except NotificacionAdmin.DoesNotExist:
        return JsonResponse({
            'success': False,
            'error': 'Notificaci√≥n no encontrada'
        }, status=404)
    except Exception as e:
        print(f"‚ùå Error en marcar_notificacion_admin_leida: {e}")
        return JsonResponse({
            'success': False,
            'error': 'Error al marcar notificaci√≥n como le√≠da'
        }, status=500)

# ViewSets para tu API
class UserViewSet(viewsets.ModelViewSet):
    queryset = User.objects.all()
    serializer_class = UserSerializer
    permission_classes = [permissions.IsAuthenticated]

class PerfilUsuarioViewSet(viewsets.ModelViewSet):
    queryset = PerfilUsuario.objects.all()
    serializer_class = PerfilUsuarioSerializer
    permission_classes = [permissions.IsAuthenticated]

class EspacioViewSet(viewsets.ModelViewSet):
    queryset = Espacio.objects.all()
    serializer_class = EspacioSerializer
    permission_classes = [permissions.IsAuthenticated]

class ReservaViewSet(viewsets.ModelViewSet):
    queryset = Reserva.objects.all()
    serializer_class = ReservaSerializer
    permission_classes = [permissions.IsAuthenticated]

    def get_queryset(self):
        # Filtrar reservas por usuario (solo sus propias reservas)
        user = self.request.user
        if user.is_authenticated:
            return Reserva.objects.filter(solicitante=user)
        return Reserva.objects.none()

class NotificacionViewSet(viewsets.ModelViewSet):
    queryset = Notificacion.objects.all()
    serializer_class = NotificacionSerializer
    permission_classes = [permissions.IsAuthenticated]

    def get_queryset(self):
        # Filtrar notificaciones por usuario
        user = self.request.user
        if user.is_authenticated:
            return Notificacion.objects.filter(destinatario=user)
        return Notificacion.objects.none()

class HistorialAprobacionViewSet(viewsets.ModelViewSet):
    queryset = HistorialAprobacion.objects.all()
    serializer_class = HistorialAprobacionSerializer
    permission_classes = [permissions.IsAuthenticated]

class EquipamientoViewSet(viewsets.ModelViewSet):
    queryset = Equipamiento.objects.all()
    serializer_class = EquipamientoSerializer
    permission_classes = [permissions.IsAuthenticated]

class AreaViewSet(viewsets.ModelViewSet):
    queryset = Area.objects.all()
    serializer_class = AreaSerializer
    permission_classes = [permissions.IsAuthenticated]
    
from django.http import HttpResponse
from reportlab.pdfgen import canvas
from reportlab.lib.pagesizes import letter, A4
from reportlab.lib import colors
from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.units import inch
import io
from datetime import datetime
from django.db import models

@login_required
def generar_reporte_pdf(request, tipo_reporte):
    """Genera reportes en PDF basados en datos reales de la BD"""
    try:
        perfil = PerfilUsuario.objects.get(user=request.user)
        if perfil.rol not in ['Administrativo', 'Investigacion', 'Aprobador']:
            return JsonResponse({'success': False, 'error': 'No autorizado'})
        
        # üîî NOTIFICAR GENERACI√ìN DE REPORTE REAL
        try:
            notificar_accion_admin(
                tipo='reporte_generado',
                titulo='üìä Reporte PDF Generado',
                mensaje=f"El administrador {request.user.username} ha generado un reporte PDF: {tipo_reporte}. Fecha: {datetime.now().strftime('%d/%m/%Y %H:%M')}",
                usuario_admin=request.user,
                request=request
            )
            print(f"üì¢ Notificaci√≥n admin REAL creada para reporte {tipo_reporte}")
        except Exception as admin_notif_error:
            print(f"‚ö†Ô∏è Error en notificaci√≥n admin reporte: {admin_notif_error}")
        
        # Crear el objeto PDF
        buffer = io.BytesIO()
        doc = SimpleDocTemplate(buffer, pagesize=A4, topMargin=30)
        elements = []
        styles = getSampleStyleSheet()
        
        # Estilo para el t√≠tulo
        title_style = ParagraphStyle(
            'CustomTitle',
            parent=styles['Heading1'],
            fontSize=16,
            spaceAfter=30,
            alignment=1,  # Centrado
            textColor=colors.HexColor('#2c5530')
        )
        
        # Estilo para subt√≠tulos
        subtitle_style = ParagraphStyle(
            'CustomSubtitle',
            parent=styles['Heading2'],
            fontSize=12,
            spaceAfter=12,
            textColor=colors.HexColor('#4a5568')
        )
        
        # Obtener fecha actual
        fecha_actual = datetime.now().strftime("%d/%m/%Y %H:%M")
        
        if tipo_reporte == 'uso_espacios':
            # Reporte de Uso de Espacios
            title = Paragraph("REPORTE DE USO DE ESPACIOS", title_style)
            elements.append(title)
            
            # Informaci√≥n del reporte
            info_text = f"Generado el: {fecha_actual}<br/>Generado por: {request.user.get_full_name() or request.user.username}"
            elements.append(Paragraph(info_text, styles['Normal']))
            elements.append(Spacer(1, 20))
            
            # Estad√≠sticas generales
            elements.append(Paragraph("ESTAD√çSTICAS GENERALES", subtitle_style))
            
            total_espacios = Espacio.objects.count()
            total_reservas = Reserva.objects.count()
            espacios_disponibles = Espacio.objects.filter(estado='Disponible').count()
            
            stats_data = [
                ['Total de Espacios', str(total_espacios)],
                ['Espacios Disponibles', str(espacios_disponibles)],
                ['Total de Reservas', str(total_reservas)],
                ['Reservas Aprobadas', str(Reserva.objects.filter(estado='Aprobada').count())],
                ['Reservas Rechazadas', str(Reserva.objects.filter(estado='Rechazada').count())],
            ]
            
            stats_table = Table(stats_data, colWidths=[3*inch, 2*inch])
            stats_table.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#e2e8f0')),
                ('TEXTCOLOR', (0, 0), (-1, 0), colors.HexColor('#2d3748')),
                ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
                ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                ('FONTSIZE', (0, 0), (-1, -1), 10),
                ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
                ('BACKGROUND', (0, 1), (-1, -1), colors.HexColor('#f7fafc')),
                ('GRID', (0, 0), (-1, -1), 1, colors.HexColor('#cbd5e0'))
            ]))
            elements.append(stats_table)
            elements.append(Spacer(1, 20))
            
            # Espacios m√°s utilizados
            elements.append(Paragraph("ESPACIOS M√ÅS UTILIZADOS", subtitle_style))
            
            espacios_mas_usados = Espacio.objects.annotate(
                num_reservas=models.Count('reserva')
            ).order_by('-num_reservas')[:10]
            
            if espacios_mas_usados:
                # Espacio m√°s solicitado
                espacio_top = espacios_mas_usados[0]
                elements.append(Spacer(1, 12))
                elements.append(Paragraph(f"ESPACIO M√ÅS SOLICITADO: {espacio_top.nombre} ({espacio_top.num_reservas} reservas)", subtitle_style))
                elements.append(Spacer(1, 8))
                espacios_data = [['Espacio', 'Tipo', 'Capacidad', 'N¬∞ Reservas']]
                for espacio in espacios_mas_usados:
                    espacios_data.append([
                        espacio.nombre,
                        espacio.tipo,
                        str(espacio.capacidad),
                        str(espacio.num_reservas)
                    ])
                
                espacios_table = Table(espacios_data, colWidths=[2*inch, 1.5*inch, 1*inch, 1*inch])
                espacios_table.setStyle(TableStyle([
                    ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#2c5530')),
                    ('TEXTCOLOR', (0, 0), (-1, 0), colors.white),
                    ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
                    ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                    ('FONTSIZE', (0, 0), (-1, -1), 9),
                    ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
                    ('BACKGROUND', (0, 1), (-1, -1), colors.HexColor('#f0fff4')),
                    ('GRID', (0, 0), (-1, -1), 1, colors.HexColor('#9ae6b4'))
                ]))
                elements.append(espacios_table)
            else:
                elements.append(Paragraph("No hay datos de uso de espacios disponibles.", styles['Normal']))
                
        elif tipo_reporte == 'usuarios':
            # Reporte de Usuarios
            title = Paragraph("REPORTE DE USUARIOS", title_style)
            elements.append(title)
            
            info_text = f"Generado el: {fecha_actual}<br/>Generado por: {request.user.get_full_name() or request.user.username}"
            elements.append(Paragraph(info_text, styles['Normal']))
            elements.append(Spacer(1, 20))
            
            # Estad√≠sticas de usuarios
            elements.append(Paragraph("ESTAD√çSTICAS DE USUARIOS", subtitle_style))
            
            total_usuarios = User.objects.count()
            usuarios_activos = User.objects.filter(is_active=True).count()
            usuarios_inactivos = User.objects.filter(is_active=False).count()
            
            stats_data = [
                ['Total de Usuarios', str(total_usuarios)],
                ['Usuarios Activos', str(usuarios_activos)],
                ['Usuarios Inactivos', str(usuarios_inactivos)],
            ]
            
            stats_table = Table(stats_data, colWidths=[3*inch, 2*inch])
            stats_table.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#e2e8f0')),
                ('TEXTCOLOR', (0, 0), (-1, 0), colors.HexColor('#2d3748')),
                ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
                ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                ('FONTSIZE', (0, 0), (-1, -1), 10),
                ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
                ('BACKGROUND', (0, 1), (-1, -1), colors.HexColor('#f7fafc')),
                ('GRID', (0, 0), (-1, -1), 1, colors.HexColor('#cbd5e0'))
            ]))
            elements.append(stats_table)
            elements.append(Spacer(1, 20))
            
            # Usuarios m√°s activos
            elements.append(Paragraph("USUARIOS M√ÅS ACTIVOS", subtitle_style))
            
            usuarios_activos_top = User.objects.annotate(
                num_reservas=models.Count('reservas_solicitadas')
            ).filter(num_reservas__gt=0).order_by('-num_reservas')[:10]
            
            if usuarios_activos_top:
                usuarios_data = [['Usuario', 'Nombre', 'Email', 'N¬∞ Reservas']]
                for usuario in usuarios_activos_top:
                    usuarios_data.append([
                        usuario.username,
                        f"{usuario.first_name} {usuario.last_name}".strip() or 'No especificado',
                        usuario.email,
                        str(usuario.num_reservas)
                    ])
                
                usuarios_table = Table(usuarios_data, colWidths=[1.5*inch, 2*inch, 2*inch, 1*inch])
                usuarios_table.setStyle(TableStyle([
                    ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#2b6cb0')),
                    ('TEXTCOLOR', (0, 0), (-1, 0), colors.white),
                    ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
                    ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                    ('FONTSIZE', (0, 0), (-1, -1), 8),
                    ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
                    ('BACKGROUND', (0, 1), (-1, -1), colors.HexColor('#ebf8ff')),
                    ('GRID', (0, 0), (-1, -1), 1, colors.HexColor('#90cdf4'))
                ]))
                elements.append(usuarios_table)
            else:
                elements.append(Paragraph("No hay datos de usuarios disponibles.", styles['Normal']))
                
        elif tipo_reporte == 'mensual':
            # Reporte Mensual
            title = Paragraph("REPORTE MENSUAL", title_style)
            elements.append(title)
            
            info_text = f"Generado el: {fecha_actual}<br/>Generado por: {request.user.get_full_name() or request.user.username}"
            elements.append(Paragraph(info_text, styles['Normal']))
            elements.append(Spacer(1, 20))
            
            # Estad√≠sticas del mes actual
            elements.append(Paragraph("ESTAD√çSTICAS DEL MES ACTUAL", subtitle_style))
            
            mes_actual = timezone.now().month
            a√±o_actual = timezone.now().year
            
            reservas_mes = Reserva.objects.filter(
                fecha_solicitud__month=mes_actual,
                fecha_solicitud__year=a√±o_actual
            )
            
            reservas_mes_count = reservas_mes.count()
            reservas_aprobadas_mes = reservas_mes.filter(estado='Aprobada').count()
            reservas_pendientes_mes = reservas_mes.filter(estado='Pendiente').count()
            reservas_rechazadas_mes = reservas_mes.filter(estado='Rechazada').count()
            
            stats_data = [
                ['Total de Reservas', str(reservas_mes_count)],
                ['Reservas Aprobadas', str(reservas_aprobadas_mes)],
                ['Reservas Pendientes', str(reservas_pendientes_mes)],
                ['Reservas Rechazadas', str(reservas_rechazadas_mes)],
                ['Tasa de Aprobaci√≥n', f"{round((reservas_aprobadas_mes / reservas_mes_count * 100) if reservas_mes_count > 0 else 0)}%"],
            ]
            
            stats_table = Table(stats_data, colWidths=[3*inch, 2*inch])
            stats_table.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#e2e8f0')),
                ('TEXTCOLOR', (0, 0), (-1, 0), colors.HexColor('#2d3748')),
                ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
                ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                ('FONTSIZE', (0, 0), (-1, -1), 10),
                ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
                ('BACKGROUND', (0, 1), (-1, -1), colors.HexColor('#f7fafc')),
                ('GRID', (0, 0), (-1, -1), 1, colors.HexColor('#cbd5e0'))
            ]))
            elements.append(stats_table)
            elements.append(Spacer(1, 20))
            
            # Distribuci√≥n por estado
            elements.append(Paragraph("DISTRIBUCI√ìN DE RESERVAS POR ESTADO", subtitle_style))
            
            estados_data = [['Estado', 'Cantidad', 'Porcentaje']]
            total_reservas = reservas_mes_count
            
            for estado in ['Aprobada', 'Pendiente', 'Rechazada', 'Cancelada']:
                count = reservas_mes.filter(estado=estado).count()
                porcentaje = round((count / total_reservas * 100) if total_reservas > 0 else 0)
                estados_data.append([estado, str(count), f"{porcentaje}%"])

            # Espacio m√°s solicitado en el mes
            from django.db.models import Count
            top_esp = reservas_mes.values('espacio__nombre').annotate(c=Count('id')).order_by('-c').first()
            if top_esp:
                elements.append(Spacer(1, 12))
                elements.append(Paragraph(f"ESPACIO M√ÅS SOLICITADO EN EL MES: {top_esp['espacio__nombre']} ({top_esp['c']} reservas)", subtitle_style))
            
            estados_table = Table(estados_data, colWidths=[2*inch, 1.5*inch, 1.5*inch])
            estados_table.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#744210')),
                ('TEXTCOLOR', (0, 0), (-1, 0), colors.white),
                ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
                ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                ('FONTSIZE', (0, 0), (-1, -1), 9),
                ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
                ('BACKGROUND', (0, 1), (-1, -1), colors.HexColor('#fefcbf')),
                ('GRID', (0, 0), (-1, -1), 1, colors.HexColor('#d69e2e'))
            ]))
            elements.append(estados_table)
            
        else:
            return JsonResponse({'success': False, 'error': 'Tipo de reporte no v√°lido'})
        
        # Construir el PDF
        doc.build(elements)
        
        # Preparar la respuesta
        buffer.seek(0)
        response = HttpResponse(buffer, content_type='application/pdf')
        
        # Nombre del archivo seg√∫n el tipo de reporte
        nombres_archivos = {
            'uso_espacios': 'reporte_uso_espacios',
            'usuarios': 'reporte_usuarios', 
            'mensual': 'reporte_mensual'
        }
        
        filename = f"{nombres_archivos.get(tipo_reporte, 'reporte')}_{datetime.now().strftime('%Y%m%d_%H%M')}.pdf"
        response['Content-Disposition'] = f'attachment; filename="{filename}"'
        
        return response
        
    except Exception as e:
        print(f"‚ùå Error generando PDF: {e}")
        return JsonResponse({'success': False, 'error': 'Error al generar el reporte PDF'})


@login_required
@user_passes_test(is_admin_user)
def limpiar_notificaciones_prueba(request):
    """Limpia las notificaciones de prueba"""
    try:
        # Eliminar notificaciones que contengan "Prueba" o "prueba"
        notificaciones_prueba = NotificacionAdmin.objects.filter(
            models.Q(titulo__icontains='prueba') | 
            models.Q(mensaje__icontains='prueba') |
            models.Q(titulo__icontains='Prueba')
        )
        
        count = notificaciones_prueba.count()
        notificaciones_prueba.delete()
        
        return JsonResponse({
            'success': True,
            'message': f'Se eliminaron {count} notificaciones de prueba'
        })
        
    except Exception as e:
        return JsonResponse({'success': False, 'error': str(e)})
    
@login_required
@user_passes_test(is_admin_user)
def test_notificaciones_reales(request):
    """Endpoint de prueba para notificaciones admin con datos reales"""
    try:
        print("üß™ INICIANDO PRUEBA DE NOTIFICACIONES REALES")
        
        # Probar con datos reales del sistema
        espacios = Espacio.objects.all()[:2]
        usuarios = User.objects.all()[:2]
        reservas = Reserva.objects.all()[:2]
        
        test_cases = []
        
        if espacios:
            test_cases.append({
                'tipo': 'espacio_creado',
                'titulo': 'üè¢ Espacio Real Creado',
                'mensaje': f'Se ha creado el espacio {espacios[0].nombre}',
                'espacio': espacios[0],
                'usuario_admin': request.user
            })
        
        if usuarios:
            test_cases.append({
                'tipo': 'usuario_registrado',
                'titulo': 'üë§ Usuario Real Registrado',
                'mensaje': f'El usuario {usuarios[0].username} se registr√≥ en el sistema',
                'usuario_relacionado': usuarios[0]
            })
        
        if reservas:
            test_cases.append({
                'tipo': 'reserva_creada',
                'titulo': 'üìã Reserva Real Creada',
                'mensaje': f'Reserva creada para {reservas[0].espacio.nombre}',
                'reserva': reservas[0],
                'usuario_relacionado': reservas[0].solicitante
            })
        
        resultados = []
        for test_case in test_cases:
            notif = notificar_accion_admin(
                tipo=test_case['tipo'],
                titulo=test_case['titulo'],
                mensaje=test_case['mensaje'],
                usuario_admin=test_case.get('usuario_admin'),
                usuario_relacionado=test_case.get('usuario_relacionado'),
                reserva=test_case.get('reserva'),
                espacio=test_case.get('espacio'),
                request=request
            )
            resultados.append({
                'tipo': test_case['tipo'],
                'creada': notif is not None,
                'id': notif.id if notif else None,
                'titulo': test_case['titulo']
            })
        
        # Contar notificaciones totales
        total_notificaciones = NotificacionAdmin.objects.count()
        no_leidas = NotificacionAdmin.objects.filter(leida=False).count()
        
        return JsonResponse({
            'success': True,
            'message': f'Prueba completada. Total notificaciones: {total_notificaciones}, No le√≠das: {no_leidas}',
            'resultados': resultados,
            'estadisticas': {
                'total': total_notificaciones,
                'no_leidas': no_leidas
            }
        })
        
    except Exception as e:
        print(f"‚ùå ERROR EN PRUEBA REAL: {e}")
        return JsonResponse({'success': False, 'error': str(e)})
============================================================


===== __init__.py =====

============================================================


################################################################################
üìÅ Carpeta: D:\todo\Universidad\4_semestre\proyecto_integrado\Backend\Reservadeaula\Inacap_reserva\project_core
################################################################################


===== asgi.py =====
"""
ASGI config for project_core project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'project_core.settings')

application = get_asgi_application()

============================================================


===== settings.py =====
"""
Django settings for project_core project.

Generated by 'django-admin startproject' using Django 5.2.7.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/5.2/ref/settings/
"""
import os
from pathlib import Path

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/5.2/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure-tu-clave-secreta-aqui'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'rest_framework',
    'drf_yasg',
    'reservas.apps.ReservasConfig',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'reservas.middleware.InjectThemeMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'project_core.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [os.path.join(BASE_DIR, 'reservas/templates')],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'project_core.wsgi.application'


# Database
# https://docs.djangoproject.com/en/5.2/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'inacap_reservas_db',  # Nombre de tu BD
        'USER': 'postgres',           # Tu usuario de PostgreSQL
        'PASSWORD': '123456',         # Tu contrase√±a (reemplaza por variable de entorno en producci√≥n)
        'HOST': 'localhost',
        'PORT': '5432',
    }
}   


# Password validation
# https://docs.djangoproject.com/en/5.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/5.2/topics/i18n/

LANGUAGE_CODE = 'es-cl'

TIME_ZONE = 'America/Santiago'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/5.2/howto/static-files/
STATIC_URL = '/static/'
STATICFILES_DIRS = [
    os.path.join(BASE_DIR, 'reservas/static'),
    os.path.join(BASE_DIR, 'static'),
]
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')
# Default primary key field type
# https://docs.djangoproject.com/en/5.2/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

REST_FRAMEWORK = {
    'DEFAULT_SCHEMA_CLASS': 'rest_framework.schemas.coreapi.AutoSchema',
}


# Configuraci√≥n de autenticaci√≥n
AUTHENTICATION_BACKENDS = [
    'reservas.backends.EmailBackend',
    'django.contrib.auth.backends.ModelBackend',
]

# URLs de redirecci√≥n
LOGIN_URL = '/login/'
LOGIN_REDIRECT_URL = '/dashboard/'
LOGOUT_REDIRECT_URL = '/login/'

# Configuraci√≥n de sesi√≥n
SESSION_COOKIE_AGE = 1209600  # 2 semanas en segundos
SESSION_SAVE_EVERY_REQUEST = True
============================================================


===== urls.py =====
"""
URL configuration for project_core project.

The `urlpatterns` list routes URLs to views. For more information please see:
    https://docs.djangoproject.com/en/5.2/topics/http/urls/
Examples:
Function views
    1. Add an import:  from my_app import views
    2. Add a URL to urlpatterns:  path('', views.home, name='home')
Class-based views
    1. Add an import:  from other_app.views import Home
    2. Add a URL to urlpatterns:  path('', Home.as_view(), name='home')
Including another URLconf
    1. Import the include() function: from django.urls import include, path
    2. Add a URL to urlpatterns:  path('blog/', include('blog.urls'))
"""
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('reservas.urls')),
]
============================================================


===== wsgi.py =====
"""
WSGI config for project_core project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'project_core.settings')

application = get_wsgi_application()

============================================================


===== __init__.py =====

============================================================


################################################################################
üìÅ Carpeta: D:\todo\Universidad\4_semestre\proyecto_integrado\Backend\Reservadeaula\Inacap_reserva\reservas\templates\reservas
################################################################################


===== calendario.html =====
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario - Sistema de Reservas</title>
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- FullCalendar -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
    
    <style>
        /* Variables CSS para temas */
        :root {
            /* Tema Claro (default) */
            --bg-primary: #f9fafb;
            --bg-secondary: white;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border-color: #e5e7eb;
            --accent-color: #2563eb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #dc2626;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .theme-dark {
            /* Tema Oscuro */
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-tertiary: #9ca3af;
            --border-color: #4b5563;
            --accent-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Header Actualizado con Bootstrap Icons */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: var(--accent-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .nav-menu {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .nav-item {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .nav-item i {
            font-size: 16px;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--accent-color);
            color: white;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--success-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        /* Bot√≥n de tema */
        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            background: var(--bg-tertiary);
            color: var(--accent-color);
        }

        /* Main Content */
        .main-content {
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Breadcrumb */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .breadcrumb a {
            color: var(--accent-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .breadcrumb-separator {
            color: var(--text-tertiary);
        }

        /* Page Header */
        .page-header {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title i {
            color: var(--accent-color);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .new-reservation-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
            font-size: 14px;
        }

        .new-reservation-btn:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: var(--shadow-hover);
        }

        /* Filters */
        .filters-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-select, .filter-input {
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: border-color 0.3s ease;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .view-toggles {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 4px;
        }

        .view-toggle {
            padding: 8px 16px;
            border: none;
            background: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
        }

        .view-toggle.active {
            background: var(--bg-secondary);
            color: var(--accent-color);
            box-shadow: var(--shadow);
        }

        /* Calendar Section */
        .calendar-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        #calendar {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            height: 600px;
        }

        .fc {
            height: 100%;
            color: var(--text-primary);
        }

        .fc-header-toolbar {
            margin-bottom: 1em;
        }

        .fc-toolbar-title {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--text-primary);
        }

        .fc-button {
            background: var(--bg-tertiary) !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }

        .fc-button:hover {
            background: var(--border-color) !important;
        }

        .fc-button-primary:not(:disabled).fc-button-active {
            background: var(--accent-color) !important;
            border-color: var(--accent-color) !important;
        }

        .fc-daygrid-day {
            background: var(--bg-secondary);
            border-color: var(--border-color) !important;
        }

        .fc-event {
            cursor: pointer;
            border: none;
            font-size: 0.85em;
            font-weight: 500;
        }

        .fc-day-today {
            background-color: rgba(59, 130, 246, 0.1) !important;
        }

        /* Legend */
        .calendar-legend {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 20px;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .legend-color.available {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
        }

        .legend-color.occupied {
            background: #fee2e2;
            border: 2px solid var(--danger-color);
        }

        .legend-color.partial {
            background: #fef3c7;
            border: 2px solid var(--warning-color);
        }

        .legend-color.today {
            background: var(--bg-secondary);
            border: 2px solid var(--accent-color);
        }

        /* Sidebar */
        .content-with-sidebar {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 24px;
        }

        .sidebar {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            height: fit-content;
        }

        .sidebar-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .selected-date {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            text-align: center;
        }

        .selected-date-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent-color);
        }

        .reservation-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .reservation-item {
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border-left: 4px solid;
        }

        .reservation-item.approved {
            border-left-color: var(--success-color);
        }

        .reservation-item.pending {
            border-left-color: var(--warning-color);
        }

        .reservation-time {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .reservation-space {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-top: 2px;
        }

        /* Keyboard Help */
        .keyboard-help {
            margin-top: 20px;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            font-size: 12px;
            border: 1px solid var(--border-color);
        }

        .keyboard-help-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .keyboard-shortcuts {
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .keyboard-tip {
            margin-top: 8px;
            color: var(--text-tertiary);
            font-size: 11px;
            font-style: italic;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .content-with-sidebar {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 16px;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .calendar-legend {
                flex-wrap: wrap;
                gap: 12px;
            }

            .nav-menu {
                display: none;
            }

            .header {
                padding: 0 16px;
            }
        }

        /* Animaci√≥n de notificaci√≥n */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
    </style>
</head>
<body class="theme-light">
    <!-- Header -->
    <header class="header">
        <div class="logo-section">
            <div class="logo">
                <i class="bi bi-calendar-check"></i>
            </div>
            <div style="font-weight: 600; color: var(--text-primary);">Sistema de Reservas</div>
        </div>
        
        <nav class="nav-menu">
            <a href="{% url 'dashboard' %}" class="nav-item">
                <i class="bi bi-speedometer2"></i>
                Dashboard
            </a>
            <a href="{% url 'crear_reserva' %}" class="nav-item">
                <i class="bi bi-plus-circle"></i>
                Reservar
            </a>
            <a href="{% url 'reservas' %}" class="nav-item">
                <i class="bi bi-clock-history"></i>
                Historial
            </a>
            <a href="{% url 'calendario' %}" class="nav-item active">
                <i class="bi bi-calendar-week"></i>
                Calendario
            </a>
            <a href="{% url 'espacios' %}" class="nav-item">
                <i class="bi bi-building"></i>
                Espacios
            </a>
            <a href="{% url 'notificaciones' %}" class="nav-item">
                <i class="bi bi-bell"></i>
                Notificaciones
            </a>
        </nav>
        
        <div class="user-menu">
            <!-- Bot√≥n de cambio de tema -->
            <button class="theme-toggle" id="themeToggle" title="Cambiar tema">
                <i class="bi bi-moon" id="themeIcon"></i>
            </button>
            
            <div class="user-avatar">
                {% if user.first_name and user.last_name %}
                    {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                {% else %}
                    {{ user.username|first|upper }}
                {% endif %}
            </div>
            <span style="color: var(--text-primary);">
                {% if user.first_name %}
                    {{ user.first_name }} {{ user.last_name }}
                {% else %}
                    {{ user.username }}
                {% endif %}
            </span>
            <a href="{% url 'logout' %}" class="theme-toggle" title="Cerrar sesi√≥n">
                <i class="bi bi-box-arrow-right"></i>
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Breadcrumb -->
        <nav class="breadcrumb">
            <a href="{% url 'dashboard' %}">
                <i class="bi bi-house"></i>
                Dashboard
            </a>
            <span class="breadcrumb-separator">
                <i class="bi bi-chevron-right"></i>
            </span>
            <span>Calendario</span>
        </nav>

        <!-- Page Header -->
        <div class="page-header">
            <div class="header-content">
                <h1 class="page-title">
                    <i class="bi bi-calendar-week"></i>
                    Calendario de Disponibilidad
                </h1>
                <div class="header-actions">
                    <a href="{% url 'crear_reserva' %}" class="new-reservation-btn">
                        <i class="bi bi-plus-lg"></i>
                        Nueva Reserva
                    </a>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">
                        <i class="bi bi-building"></i>
                        Seleccionar Espacio
                    </label>
                    <select class="filter-select" id="spaceFilter">
                        <option value="">Todos los espacios</option>
                        {% for espacio in espacios %}
                            <option value="{{ espacio.id }}">{{ espacio.nombre }}</option>
                        {% empty %}
                            <option value="">No hay espacios disponibles</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">
                        <i class="bi bi-calendar-month"></i>
                        Mes/A√±o
                    </label>
                    <input type="month" class="filter-input" id="monthFilter" value="{{ current_month }}">
                </div>

                <div class="filter-group">
                    <label class="filter-label">
                        <i class="bi bi-eye"></i>
                        Vista
                    </label>
                    <div class="view-toggles">
                        <button class="view-toggle active" data-view="dayGridMonth">
                            <i class="bi bi-calendar-month"></i>
                            Mes
                        </button>
                        <button class="view-toggle" data-view="timeGridWeek">
                            <i class="bi bi-calendar-week"></i>
                            Semana
                        </button>
                        <button class="view-toggle" data-view="timeGridDay">
                            <i class="bi bi-calendar-day"></i>
                            D√≠a
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content with Sidebar -->
        <div class="content-with-sidebar">
            <!-- Calendar Section -->
            <div class="calendar-section">
                <div id="calendar"></div>

                <!-- Legend -->
                <div class="calendar-legend">
                    <div class="legend-item">
                        <div class="legend-color available"></div>
                        <span>Disponible</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color partial"></div>
                        <span>Parcialmente ocupado</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color occupied"></div>
                        <span>Ocupado</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color today"></div>
                        <span>D√≠a actual</span>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <h3 class="sidebar-title">
                    <i class="bi bi-calendar-date"></i>
                    D√≠a Seleccionado
                </h3>
                <div class="selected-date">
                    <div class="selected-date-text" id="selectedDate">Hoy</div>
                </div>

                <h4 class="sidebar-title">
                    <i class="bi bi-list-check"></i>
                    Reservas del D√≠a
                </h4>
                <div class="reservation-list" id="dayReservations">
                    <div class="empty-state">
                        <p>Selecciona un d√≠a para ver las reservas</p>
                    </div>
                </div>

                <!-- Keyboard Help Section -->
                <div class="keyboard-help">
                    <div class="keyboard-help-title">
                        <i class="bi bi-keyboard"></i>
                        Atajos de Teclado
                    </div>
                    <div class="keyboard-shortcuts">
                        Presiona letras para navegar: 
                        <strong>E</strong>=Ene, <strong>F</strong>=Feb, <strong>M</strong>=Mar, 
                        <strong>A</strong>=Abr, <strong>Y</strong>=May, <strong>J</strong>=Jun, 
                        <strong>U</strong>=Jul, <strong>G</strong>=Ago, <strong>S</strong>=Sep, 
                        <strong>O</strong>=Oct, <strong>N</strong>=Nov, <strong>D</strong>=Dic
                    </div>
                    <div class="keyboard-tip">
                        <i class="bi bi-info-circle"></i>
                        Presiona F1 para ayuda completa
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales/es.global.min.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // ========== SISTEMA DE TEMA CLARO/OSCURO ==========
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const body = document.body;
        
        // Verificar tema guardado en localStorage
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            body.classList.add('theme-dark');
            themeIcon.classList.remove('bi-moon');
            themeIcon.classList.add('bi-sun');
        }
        
        // Funci√≥n para cambiar tema
        themeToggle.addEventListener('click', () => {
            const isDark = body.classList.contains('theme-dark');
            
            if (isDark) {
                body.classList.remove('theme-dark');
                themeIcon.classList.remove('bi-sun');
                themeIcon.classList.add('bi-moon');
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.add('theme-dark');
                themeIcon.classList.remove('bi-moon');
                themeIcon.classList.add('bi-sun');
                localStorage.setItem('theme', 'dark');
            }
        });
        
        var calendarEl = document.getElementById('calendar');
        
        // Obtener eventos desde el contexto de Django
        var eventos = {{ eventos|safe }};
        console.log('Eventos cargados:', eventos);
        
        // Configurar calendario
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'es',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            buttonText: {
                today: 'Hoy',
                month: 'Mes',
                week: 'Semana',
                day: 'D√≠a'
            },
            events: eventos,
            eventClick: function(info) {
                const extendedProps = info.event.extendedProps;
                const mensaje = `üè¢ ${extendedProps.espacio_nombre}\n‚è∞ ${extendedProps.hora_inicio} - ${extendedProps.hora_fin}\nüë§ ${extendedProps.solicitante}\nüìù ${extendedProps.proposito}`;
                alert(mensaje);
            },
            dateClick: function(info) {
                updateSelectedDate(info.dateStr);
                updateDayReservations(info.dateStr);
            },
            eventDisplay: 'block',
            eventColor: '#10b981',
            eventTextColor: '#ffffff'
        });
        
        calendar.render();
        
        // === ATAJOS DE TECLADO PARA MESES ===
        document.addEventListener('keydown', function(e) {
            // Solo activar si no hay campos de texto enfocados
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                return;
            }
            
            const key = e.key.toLowerCase();
            const currentDate = calendar.getDate();
            const currentYear = currentDate.getFullYear();
            
            let targetMonth;
            
            // Mapeo de teclas a meses
            switch(key) {
                case 'e': targetMonth = 0; break;  // Enero
                case 'f': targetMonth = 1; break;  // Febrero
                case 'm': targetMonth = 2; break;  // Marzo
                case 'a': targetMonth = 3; break;  // Abril
                case 'y': targetMonth = 4; break;  // Mayo (Y por "May")
                case 'j': targetMonth = 5; break;  // Junio
                case 'u': targetMonth = 6; break;  // Julio
                case 'g': targetMonth = 7; break;  // Agosto
                case 's': targetMonth = 8; break;  // Septiembre
                case 'o': targetMonth = 9; break;  // Octubre
                case 'n': targetMonth = 10; break; // Noviembre
                case 'd': targetMonth = 11; break; // Diciembre
                default: return; // Si no es una tecla de mes, salir
            }
            
            // Prevenir el comportamiento por defecto
            e.preventDefault();
            
            // Navegar al mes correspondiente
            const targetDate = new Date(currentYear, targetMonth, 1);
            calendar.gotoDate(targetDate);
            
            // Mostrar notificaci√≥n temporal
            showMonthNotification(targetMonth);
        });
        
        // Funci√≥n para mostrar notificaci√≥n del mes
        function showMonthNotification(monthIndex) {
            const monthNames = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-weight: 600;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: fadeInOut 2s ease-in-out;
            `;
            
            notification.textContent = `Navegando a ${monthNames[monthIndex]}`;
            document.body.appendChild(notification);
            
            // Remover despu√©s de 2 segundos
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 2000);
        }
        
        // === AYUDA DE TECLADO (F1) ===
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F1') {
                e.preventDefault();
                showKeyboardHelp();
            }
        });

        function showKeyboardHelp() {
            const helpModal = document.createElement('div');
            helpModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
            `;

            const helpContent = document.createElement('div');
            helpContent.style.cssText = `
                background: var(--bg-secondary);
                padding: 30px;
                border-radius: 12px;
                max-width: 500px;
                max-height: 80vh;
                overflow-y: auto;
                color: var(--text-primary);
                border: 1px solid var(--border-color);
            `;

            helpContent.innerHTML = `
                <h2 style="margin-bottom: 20px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                    <i class="bi bi-keyboard"></i>
                    Atajos de Teclado del Calendario
                </h2>
                <div style="display: grid; gap: 12px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span><strong>E</strong> - Enero</span>
                        <span><strong>J</strong> - Junio</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span><strong>F</strong> - Febrero</span>
                        <span><strong>U</strong> - Julio</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span><strong>M</strong> - Marzo</span>
                        <span><strong>G</strong> - Agosto</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span><strong>A</strong> - Abril</span>
                        <span><strong>S</strong> - Septiembre</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span><strong>Y</strong> - Mayo</span>
                        <span><strong>O</strong> - Octubre</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span><strong>N</strong> - Noviembre</span>
                        <span><strong>D</strong> - Diciembre</span>
                    </div>
                </div>
                <div style="padding: 15px; background: var(--bg-tertiary); border-radius: 8px; border-left: 4px solid var(--accent-color);">
                    <strong><i class="bi bi-lightbulb"></i> Consejo:</strong> Presiona cualquier letra arriba mencionada para navegar instant√°neamente al mes correspondiente.
                </div>
                <button onclick="this.parentElement.parentElement.remove()" 
                        style="margin-top: 20px; padding: 10px 20px; background: var(--accent-color); color: white; border: none; border-radius: 6px; cursor: pointer; width: 100%;">
                    Cerrar Ayuda
                </button>
            `;

            helpModal.appendChild(helpContent);
            document.body.appendChild(helpModal);

            // Cerrar al hacer clic fuera
            helpModal.addEventListener('click', function(e) {
                if (e.target === helpModal) {
                    helpModal.remove();
                }
            });
        }

        // === FUNCIONES EXISTENTES ===
        // Actualizar fecha seleccionada
        function updateSelectedDate(dateStr) {
            const date = new Date(dateStr);
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = date.toLocaleDateString('es-ES', options);
            document.getElementById('selectedDate').textContent = formattedDate;
        }
        
        // Actualizar reservas del d√≠a
        function updateDayReservations(dateStr) {
            const dayReservationsEl = document.getElementById('dayReservations');
            const events = calendar.getEvents();
            const dayEvents = events.filter(event => {
                const eventDate = event.start.toISOString().split('T')[0];
                return eventDate === dateStr;
            });
            
            if (dayEvents.length === 0) {
                dayReservationsEl.innerHTML = '<div class="empty-state"><p>No hay reservas aprobadas para este d√≠a</p></div>';
            } else {
                let html = '';
                dayEvents.forEach(event => {
                    const extendedProps = event.extendedProps;
                    const startTime = event.start.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                    const endTime = event.end.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                    
                    html += `
                        <div class="reservation-item approved">
                            <div class="reservation-time">${startTime} - ${endTime}</div>
                            <div class="reservation-space">${extendedProps.espacio_nombre}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                <i class="bi bi-person"></i> ${extendedProps.solicitante}
                            </div>
                        </div>
                    `;
                });
                dayReservationsEl.innerHTML = html;
            }
        }
        
        // Botones de vista
        const viewToggles = document.querySelectorAll('.view-toggle');
        viewToggles.forEach(toggle => {
            toggle.addEventListener('click', function() {
                const view = this.dataset.view;
                
                // Actualizar botones activos
                viewToggles.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Cambiar vista del calendario
                calendar.changeView(view);
            });
        });
        
        // Filtro de espacio
        const spaceFilter = document.getElementById('spaceFilter');
        spaceFilter.addEventListener('change', function() {
            const selectedSpace = this.value;
            console.log('üîÑ Filtro cambiado. Espacio seleccionado:', selectedSpace);
            
            // Obtener todos los eventos
            const allEvents = {{ eventos|safe }};
            console.log('üìä Total de eventos:', allEvents.length);
            
            if (!selectedSpace) {
                // Mostrar todos los eventos
                console.log('‚úÖ Mostrando todos los eventos');
                calendar.removeAllEvents();
                calendar.addEventSource(allEvents);
            } else {
                // Filtrar eventos por espacio
                const filteredEvents = allEvents.filter(event => {
                    const espacioId = event.extendedProps?.espacio_id;
                    console.log(`üîç Comparando: ${espacioId} == ${selectedSpace} (${espacioId == selectedSpace})`);
                    return espacioId == selectedSpace;
                });
                
                console.log('üéØ Eventos filtrados encontrados:', filteredEvents.length);
                console.log('üìã Eventos filtrados:', filteredEvents);
                
                // Limpiar y agregar eventos filtrados
                calendar.removeAllEvents();
                if (filteredEvents.length > 0) {
                    calendar.addEventSource(filteredEvents);
                } else {
                    console.log('‚ÑπÔ∏è No hay eventos para este espacio');
                }
            }
            
            // Forzar rerender del calendario
            calendar.render();
        });
        
        // Filtro de mes
        const monthFilter = document.getElementById('monthFilter');
        monthFilter.addEventListener('change', function() {
            const selectedDate = new Date(this.value + '-01');
            calendar.gotoDate(selectedDate);
        });
        
        // Sincronizar el filtro de mes con la vista actual del calendario
        calendar.on('datesSet', function(info) {
            const currentDate = info.view.currentStart;
            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const monthYear = `${year}-${month}`;
            
            console.log('üîÑ Calendario cambi√≥ a:', monthYear);
            
            // Actualizar el valor del filtro de mes
            monthFilter.value = monthYear;
        });
            
        // Inicializar con la fecha de hoy
        updateSelectedDate(new Date().toISOString().split('T')[0]);
        updateDayReservations(new Date().toISOString().split('T')[0]);
    });
    </script>
</body>
</html>
============================================================


===== cancelar_reserva.html =====
<!DOCTYPE html>
<html lang="es">
<head>
    {% include 'reservas/_theme_snippet.html' %}
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cancelar Reserva</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: rgba(0, 0, 0, 0.5);
            color: #111827;
            line-height: 1.6;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Modal */
        .modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            margin: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .modal-header {
            padding: 24px 24px 0 24px;
            text-align: center;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 8px;
        }
        
        .modal-subtitle {
            color: #6B7280;
            font-size: 14px;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        /* Reservation Summary */
        .reservation-summary {
            background: #F3F4F6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .summary-title {
            font-weight: 600;
            margin-bottom: 16px;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .summary-label {
            color: #6B7280;
            font-weight: 500;
        }
        
        .summary-value {
            color: #111827;
            font-weight: 600;
        }
        
        /* Warning */
        .warning {
            background: #FEF3C7;
            border: 1px solid #F59E0B;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .warning-icon {
            color: #F59E0B;
            font-size: 20px;
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .warning-content {
            flex: 1;
        }
        
        .warning-title {
            font-weight: 600;
            color: #92400E;
            margin-bottom: 4px;
        }
        
        .warning-text {
            color: #78350F;
            font-size: 14px;
            line-height: 1.5;
        }
        
        /* Form */
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }
        
        .required {
            color: #DC2626;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.2s;
            resize: vertical;
            min-height: 100px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #2563EB;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .form-help {
            font-size: 12px;
            color: #6B7280;
            margin-top: 4px;
        }
        
        /* Buttons */
        .modal-footer {
            padding: 0 24px 24px 24px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 12px 24px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            font-size: 14px;
            font-family: inherit;
        }
        
        .btn-secondary {
            background: white;
            color: #6B7280;
            border-color: #E5E7EB;
        }
        
        .btn-secondary:hover {
            background: #F9FAFB;
            border-color: #D1D5DB;
        }
        
        .btn-danger {
            background: #DC2626;
            color: white;
        }
        
        .btn-danger:hover {
            background: #B91C1C;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        /* Success State */
        .success-modal {
            text-align: center;
            padding: 40px 24px;
        }
        
        .success-icon {
            font-size: 64px;
            margin-bottom: 16px;
            display: block;
        }
        
        .success-title {
            font-size: 24px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 12px;
        }
        
        .success-message {
            color: #6B7280;
            margin-bottom: 16px;
            line-height: 1.6;
        }
        
        .success-details {
            background: #F0FDF4;
            border: 1px solid #BBF7D0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
            text-align: left;
        }
        
        .success-details h4 {
            color: #15803D;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .success-details p {
            color: #166534;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .hidden {
            display: none;
        }
    </style>
    <link id="darkCss" rel="stylesheet" href="{% static 'css/dark.css' %}" disabled>
</head>
<body>
    <!-- Modal de Cancelaci√≥n -->
    <div class="modal" id="cancelModal">
        <div class="modal-header">
            <h2 class="modal-title">‚ùå Cancelar Reserva</h2>
            <p class="modal-subtitle">Esta acci√≥n no se puede deshacer</p>
        </div>
        
        <div class="modal-body">
            <!-- Resumen de la Reserva -->
            <div class="reservation-summary">
                <div class="summary-title">
                    üìã Informaci√≥n de la Reserva
                </div>
                
                <div class="summary-item">
                    <span class="summary-label">Espacio:</span>
                    <span class="summary-value">Sala de Conferencias A1</span>
                </div>
                
                <div class="summary-item">
                    <span class="summary-label">Fecha:</span>
                    <span class="summary-value">Viernes, 15 de Marzo 2025</span>
                </div>
                
                <div class="summary-item">
                    <span class="summary-label">Hora:</span>
                    <span class="summary-value">09:00 - 11:30</span>
                </div>
                
                <div class="summary-item">
                    <span class="summary-label">Duraci√≥n:</span>
                    <span class="summary-value">2 horas 30 minutos</span>
                </div>
            </div>
            
            <!-- Advertencia -->
            <div class="warning">
                <div class="warning-icon">‚ö†Ô∏è</div>
                <div class="warning-content">
                    <div class="warning-title">Pol√≠tica de Cancelaci√≥n</div>
                    <div class="warning-text">
                        ‚Ä¢ Las cancelaciones deben realizarse con al menos 24 horas de anticipaci√≥n<br>
                        ‚Ä¢ Esta acci√≥n no se puede deshacer<br>
                        ‚Ä¢ Se enviar√° una notificaci√≥n autom√°tica a todos los participantes
                    </div>
                </div>
            </div>
            
            <!-- Formulario -->
            <div class="form-group">
                <label for="cancelReason" class="form-label">
                    Motivo de cancelaci√≥n <span class="required">*</span>
                </label>
                <textarea 
                    id="cancelReason" 
                    class="form-control" 
                    placeholder="Por favor, proporciona el motivo de la cancelaci√≥n..."
                    required
                ></textarea>
                <div class="form-help">
                    Este motivo ser√° incluido en la notificaci√≥n enviada a los participantes
                </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">
                ‚Ü©Ô∏è No, mantener reserva
            </button>
            <button type="button" class="btn btn-danger" onclick="confirmCancel()" disabled id="confirmBtn">
                ‚ùå S√≠, cancelar reserva
            </button>
        </div>
    </div>
    
    <!-- Modal de Confirmaci√≥n de √âxito -->
    <div class="modal hidden" id="successModal">
        <div class="success-modal">
            <span class="success-icon">‚úÖ</span>
            <h2 class="success-title">Reserva Cancelada Exitosamente</h2>
            <p class="success-message">
                Tu reserva ha sido cancelada y se han enviado las notificaciones correspondientes.
            </p>
            
            <div class="success-details">
                <h4>üìß Informaci√≥n sobre Pol√≠ticas</h4>
                <p>
                    Como la cancelaci√≥n se realiz√≥ con m√°s de 24 horas de anticipaci√≥n, 
                    no se aplicar√°n penalizaciones. Los participantes han sido notificados 
                    autom√°ticamente sobre la cancelaci√≥n.
                </p>
            </div>
            
            <button type="button" class="btn btn-secondary" onclick="goToHistory()">
                üìã Volver al historial
            </button>
        </div>
    </div>

    <script>
        // Habilitar bot√≥n de confirmaci√≥n cuando se escriba el motivo
        document.getElementById('cancelReason').addEventListener('input', function() {
            const confirmBtn = document.getElementById('confirmBtn');
            const hasText = this.value.trim().length > 10;
            confirmBtn.disabled = !hasText;
            
            if (hasText) {
                confirmBtn.style.opacity = '1';
            } else {
                confirmBtn.style.opacity = '0.5';
            }
        });
        
        function closeModal() {
            // En una aplicaci√≥n real, esto cerrar√≠a el modal
            alert('Modal cerrado - La reserva se mantiene activa');
        }
        
        function confirmCancel() {
            const reason = document.getElementById('cancelReason').value.trim();
            
            if (reason.length < 10) {
                alert('Por favor, proporciona un motivo m√°s detallado (m√≠nimo 10 caracteres)');
                return;
            }
            
            // Simular proceso de cancelaci√≥n
            document.getElementById('confirmBtn').innerHTML = '‚è≥ Cancelando...';
            document.getElementById('confirmBtn').disabled = true;
            
            setTimeout(() => {
                // Ocultar modal de cancelaci√≥n y mostrar confirmaci√≥n
                document.getElementById('cancelModal').classList.add('hidden');
                document.getElementById('successModal').classList.remove('hidden');
            }, 1500);
        }
        
        function goToHistory() {
            // En una aplicaci√≥n real, esto navegar√≠a al historial
            alert('Navegando al historial de reservas...');
        }
        
        // Cerrar modal con Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
    <script src="{% static 'js/theme.js' %}"></script>
</body>
</html>
============================================================


===== crear_espacio.html =====
<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Espacio - Sistema de Reservas</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        :root {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
        }

        [data-bs-theme="dark"] {
            --bg-primary: #212529;
            --bg-secondary: #343a40;
            --text-primary: #f8f9fa;
            --text-secondary: #adb5bd;
            --border-color: #495057;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #0d6efd;
            text-decoration: none;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .form-control, .form-select, .form-textarea {
            background-color: var(--bg-secondary);
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        .form-control:focus, .form-select:focus, .form-textarea:focus {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        h1 {
            text-align: center;
            margin-bottom: 24px;
            color: var(--text-primary);
        }

        [data-bs-theme="dark"] .alert-success {
            background: #0f5132;
            color: #75b798;
            border-color: #146c43;
        }

        [data-bs-theme="dark"] .alert-error {
            background: #842029;
            color: #ea868f;
            border-color: #58151c;
        }

        [data-bs-theme="dark"] .back-link {
            color: #6ea8fe;
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <div class="theme-toggle" id="themeToggle">
        <i class="bi bi-sun" id="themeIcon"></i>
    </div>

    <a href="{% url 'gestion_espacios' %}" class="back-link">
        <i class="bi bi-arrow-left"></i> Volver a Gesti√≥n de Espacios
    </a>

    <div class="container">
        <h1><i class="bi bi-plus-circle me-2"></i> Crear Nuevo Espacio</h1>

        <div id="alertMessage" class="alert"></div>

        <form id="createSpaceForm">
            <div class="mb-3">
                <label for="nombre" class="form-label">
                    <i class="bi bi-building me-1"></i> Nombre del Espacio *
                </label>
                <input type="text" class="form-control" id="nombre" name="nombre" required>
            </div>
            
            <div class="mb-3">
                <label for="tipo" class="form-label">
                    <i class="bi bi-tags me-1"></i> Tipo de Espacio *
                </label>
                <select class="form-select" id="tipo" name="tipo" required>
                    <option value="">Seleccionar tipo...</option>
                    <option value="Sala de Reuniones"><i class="bi bi-building"></i> Sala de Reuniones</option>
                    <option value="Auditorio"><i class="bi bi-person-video3"></i> Auditorio</option>
                    <option value="Laboratorio"><i class="bi bi-cpu"></i> Laboratorio</option>
                    <option value="Oficina"><i class="bi bi-briefcase"></i> Oficina</option>
                    <option value="Aula"><i class="bi bi-easel"></i> Aula</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label for="capacidad" class="form-label">
                    <i class="bi bi-people me-1"></i> Capacidad *
                </label>
                <input type="number" class="form-control" id="capacidad" name="capacidad" min="1" required>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="edificio" class="form-label">
                        <i class="bi bi-house me-1"></i> Edificio
                    </label>
                    <input type="text" class="form-control" id="edificio" name="edificio">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="piso" class="form-label">
                        <i class="bi bi-stairs me-1"></i> Piso
                    </label>
                    <input type="number" class="form-control" id="piso" name="piso" min="0">
                </div>
            </div>
            
            <div class="mb-3">
                <label for="descripcion" class="form-label">
                    <i class="bi bi-card-text me-1"></i> Descripci√≥n
                </label>
                <textarea class="form-control" id="descripcion" name="descripcion" rows="3"></textarea>
            </div>
            
            <div class="mb-4">
                <label for="estado" class="form-label">
                    <i class="bi bi-circle-fill me-1"></i> Estado
                </label>
                <select class="form-select" id="estado" name="estado">
                    <option value="Disponible"><i class="bi bi-check-circle text-success"></i> Disponible</option>
                    <option value="Mantenimiento"><i class="bi bi-tools text-warning"></i> Mantenimiento</option>
                    <option value="Fuera de Servicio"><i class="bi bi-x-circle text-danger"></i> Fuera de Servicio</option>
                </select>
            </div>
            
            <div class="d-flex gap-2 justify-content-end">
                <a href="{% url 'gestion_espacios' %}" class="btn btn-secondary">
                    <i class="bi bi-x-circle me-1"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-check-circle me-1"></i> Crear Espacio
                </button>
            </div>
        </form>
    </div>

    <script>
        // Theme Toggle
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            const html = document.documentElement;
            
            // Check saved theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            html.setAttribute('data-bs-theme', savedTheme);
            updateThemeIcon(savedTheme);
            
            themeToggle.addEventListener('click', function() {
                const currentTheme = html.getAttribute('data-bs-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                
                html.setAttribute('data-bs-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
            });
            
            function updateThemeIcon(theme) {
                if (theme === 'dark') {
                    themeIcon.className = 'bi bi-moon';
                } else {
                    themeIcon.className = 'bi bi-sun';
                }
            }
        });

        // Resto del c√≥digo JavaScript existente (sin cambios)
        function showAlert(message, type) {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            setTimeout(() => { alertDiv.style.display = 'none'; }, 5000);
        }

        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Form submission
        document.getElementById('createSpaceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Creando...';
            submitBtn.disabled = true;
            
            const formData = {
                nombre: document.getElementById('nombre').value,
                tipo: document.getElementById('tipo').value,
                capacidad: document.getElementById('capacidad').value,
                edificio: document.getElementById('edificio').value,
                piso: document.getElementById('piso').value,
                descripcion: document.getElementById('descripcion').value,
                estado: document.getElementById('estado').value
            };

            console.log('üì§ Enviando datos:', formData);

            try {
                const response = await fetch('/api/espacios/crear/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                console.log('üì• Respuesta recibida:', data);

                if (data.success) {
                    showAlert('<i class="bi bi-check-circle me-1"></i> ' + data.message, 'success');
                    setTimeout(() => {
                        window.location.href = "{% url 'gestion_espacios' %}";
                    }, 1500);
                } else {
                    const errorMsg = data.error || 'Error desconocido al crear el espacio';
                    showAlert('<i class="bi bi-exclamation-triangle me-1"></i> Error: ' + errorMsg, 'error');
                    console.error('Error detallado:', data);
                }
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n:', error);
                showAlert('<i class="bi bi-exclamation-triangle me-1"></i> Error de conexi√≥n: ' + error.message, 'error');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
============================================================


===== crear_reserva.html =====
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Reserva - Sistema de Reservas</title>
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        /* Variables CSS para temas */
        :root {
            /* Tema Claro (default) */
            --bg-primary: #f9fafb;
            --bg-secondary: white;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border-color: #e5e7eb;
            --accent-color: #2563eb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #dc2626;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .theme-dark {
            /* Tema Oscuro */
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-tertiary: #9ca3af;
            --border-color: #4b5563;
            --accent-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: var(--accent-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .nav-menu {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .nav-item {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .nav-item i {
            font-size: 16px;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--accent-color);
            color: white;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--success-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        /* Bot√≥n de tema */
        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            background: var(--bg-tertiary);
            color: var(--accent-color);
        }

        /* Main Content */
        .main-content {
            max-width: 1000px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Breadcrumb */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .breadcrumb a {
            color: var(--accent-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        /* Step Wizard */
        .step-wizard {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .wizard-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .wizard-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .wizard-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .steps-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 32px;
            margin: 32px 0;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .step.active .step-number {
            background: var(--accent-color);
            color: white;
        }

        .step.completed .step-number {
            background: var(--success-color);
            color: white;
        }

        .step.pending .step-number {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .step-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .step.active .step-label {
            color: var(--accent-color);
        }

        .step-connector {
            width: 40px;
            height: 2px;
            background: var(--border-color);
        }

        .step-connector.completed {
            background: var(--success-color);
        }

        /* Form Container */
        .form-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .form-step {
            padding: 32px;
            display: none;
        }

        .form-step.active {
            display: block;
        }

        .step-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Step 1 - Space Selection */
        .filters-section {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-select, .filter-input {
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: border-color 0.3s ease;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .spaces-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            align-items: stretch;
        }

        .space-card {
            border: 2px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 400px;
            transform-origin: center;
        }

        .space-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .space-card.selected {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2), 0 8px 16px rgba(37, 99, 235, 0.1);
            transform: translateY(-2px);
        }

        .space-image {
            width: 100%;
            height: 160px;
            background: linear-gradient(135deg, var(--accent-color), #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
            position: relative;
        }

        .space-status {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.9);
            color: var(--success-color);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .space-content {
            padding: 16px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .space-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .space-location {
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .space-details {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 12px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .space-detail {
            display: flex;
            align-items: center;
            gap: 6px;
            min-height: 24px;
        }

        .space-detail i, .space-location i {
            width: 16px;
            text-align: center;
        }

        .space-content p {
            flex-grow: 1;
            margin-bottom: 12px;
            line-height: 1.4;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .space-equipment {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .equipment-tag {
            background: var(--bg-tertiary);
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
            color: var(--text-secondary);
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .space-actions {
            display: flex;
            gap: 8px;
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .action-btn {
            flex: 1;
            padding: 10px 16px;
            border: 2px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-width: 120px;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
            transform: translateY(-1px);
        }

        .action-btn.primary {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .action-btn.primary:hover {
            background: #1d4ed8;
            transform: translateY(-1px) scale(1.05);
        }

        /* Step 2 - Date and Time */
        .datetime-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .form-input {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .availability-check {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            border: 1px solid var(--border-color);
        }

        .availability-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .availability-status.available {
            color: var(--success-color);
        }

        .availability-status.unavailable {
            color: var(--danger-color);
        }

        .recurring-options {
            margin-top: 20px;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        /* Step 3 - Details */
        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .special-equipment {
            margin-top: 16px;
            display: none;
        }

        .special-equipment.visible {
            display: block;
        }

        /* Step 4 - Confirmation */
        .reservation-summary {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
        }

        .summary-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .summary-item {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .summary-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .summary-value {
            font-size: 16px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .terms-section {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
            background: var(--bg-tertiary);
        }

        .terms-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 12px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .terms-text {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Form Navigation */
        .form-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 32px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border-color);
        }

        .nav-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn.secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .nav-btn.secondary:hover {
            background: var(--border-color);
        }

        .nav-btn.primary {
            background: var(--accent-color);
            color: white;
        }

        .nav-btn.primary:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: var(--shadow-hover);
        }

        .nav-btn.success {
            background: var(--success-color);
            color: white;
        }

        .nav-btn.success:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: var(--shadow-hover);
        }

        .nav-btn:disabled {
            background: var(--bg-tertiary);
            color: var(--text-tertiary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Error Message */
        .error-message {
            background: rgba(220, 38, 38, 0.1);
            color: var(--danger-color);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
            border: 1px solid rgba(220, 38, 38, 0.2);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
            color: var(--text-tertiary);
        }

        .empty-state-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-state-text {
            font-size: 14px;
            margin-bottom: 20px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 16px;
            }

            .steps-indicator {
                gap: 16px;
            }

            .step-label {
                display: none;
            }

            .step-connector {
                width: 20px;
            }

            .datetime-grid {
                grid-template-columns: 1fr;
            }

            .spaces-grid {
                grid-template-columns: 1fr;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .form-navigation {
                padding: 16px;
            }

            .nav-btn {
                padding: 10px 16px;
                font-size: 13px;
            }

            .header {
                padding: 0 16px;
            }

            .nav-menu {
                display: none;
            }
        }
    </style>
</head>
<body class="theme-light">
    <!-- Header -->
    <header class="header">
        <div class="logo-section">
            <div class="logo">
                <i class="bi bi-calendar-check"></i>
            </div>
            <div style="font-weight: 600; color: var(--text-primary);">Sistema de Reservas</div>
        </div>
        
        <nav class="nav-menu">
            <a href="{% url 'dashboard' %}" class="nav-item">
                <i class="bi bi-speedometer2"></i>
                Dashboard
            </a>
            <a href="{% url 'crear_reserva' %}" class="nav-item active">
                <i class="bi bi-plus-circle"></i>
                Reservar
            </a>
            <a href="{% url 'reservas' %}" class="nav-item">
                <i class="bi bi-clock-history"></i>
                Historial
            </a>
            <a href="{% url 'calendario' %}" class="nav-item">
                <i class="bi bi-calendar-week"></i>
                Calendario
            </a>
            <a href="{% url 'espacios' %}" class="nav-item">
                <i class="bi bi-building"></i>
                Espacios
            </a>
            <a href="{% url 'notificaciones' %}" class="nav-item">
                <i class="bi bi-bell"></i>
                Notificaciones
            </a>
        </nav>
        
        <div class="user-menu">
            <!-- Bot√≥n de cambio de tema -->
            <button class="theme-toggle" id="themeToggle" title="Cambiar tema">
                <i class="bi bi-moon" id="themeIcon"></i>
            </button>
            
            <div class="user-avatar">
                {% if user.first_name and user.last_name %}
                    {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                {% else %}
                    {{ user.username|first|upper }}
                {% endif %}
            </div>
            <span style="color: var(--text-primary);">
                {% if user.first_name %}
                    {{ user.first_name }} {{ user.last_name }}
                {% else %}
                    {{ user.username }}
                {% endif %}
            </span>
            <a href="{% url 'logout' %}" class="theme-toggle" title="Cerrar sesi√≥n">
                <i class="bi bi-box-arrow-right"></i>
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Breadcrumb -->
        <nav class="breadcrumb">
            <a href="{% url 'dashboard' %}">
                <i class="bi bi-house"></i>
                Dashboard
            </a>
            <span style="color: var(--text-tertiary);">‚Ä∫</span>
            <a href="{% url 'crear_reserva' %}">
                <i class="bi bi-plus-circle"></i>
                Reservar
            </a>
            <span style="color: var(--text-tertiary);">‚Ä∫</span>
            <span>Nueva Reserva</span>
        </nav>

        <!-- Step Wizard -->
        <div class="step-wizard">
            <div class="wizard-header">
                <h1 class="wizard-title">
                    <i class="bi bi-plus-circle"></i>
                    Nueva Reserva
                </h1>
                <p class="wizard-subtitle">Completa los siguientes pasos para solicitar tu reserva</p>
            </div>

            <div class="steps-indicator">
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Espacio</div>
                </div>
                <div class="step-connector"></div>
                <div class="step pending" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Fecha/Hora</div>
                </div>
                <div class="step-connector"></div>
                <div class="step pending" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Detalles</div>
                </div>
                <div class="step-connector"></div>
                <div class="step pending" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Confirmar</div>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div class="error-message" id="errorMessage"></div>

        <!-- Form Container -->
        <div class="form-container">
            <!-- Step 1: Space Selection -->
            <div id="step1" class="form-step active">
                <h2 class="step-title">
                    <i class="bi bi-building"></i>
                    Selecciona un Espacio
                </h2>

                <!-- Filters -->
                <div class="filters-section">
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="bi bi-people"></i>
                                Capacidad
                            </label>
                            <select class="filter-select" id="capacityFilter">
                                <option value="">Cualquier capacidad</option>
                                <option value="1-10">1-10 personas</option>
                                <option value="11-25">11-25 personas</option>
                                <option value="26-50">26-50 personas</option>
                                <option value="50+">M√°s de 50</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="bi bi-building"></i>
                                Edificio
                            </label>
                            <select class="filter-select" id="buildingFilter">
                                <option value="">Todos los edificios</option>
                                <option value="a">Edificio A</option>
                                <option value="b">Edificio B</option>
                                <option value="c">Edificio C</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="bi bi-tools"></i>
                                Equipamiento
                            </label>
                            <select class="filter-select" id="equipmentFilter">
                                <option value="">Sin filtro</option>
                                <option value="projector">Proyector</option>
                                <option value="wifi">WiFi</option>
                                <option value="ac">Aire Acondicionado</option>
                                <option value="whiteboard">Pizarra</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Spaces Grid -->
                <div class="spaces-grid" id="spacesGrid">
                    {% for espacio in espacios %}
                    <div class="space-card" data-space-id="{{ espacio.id }}">
                        <div class="space-image">
                            {% if espacio.tipo == 'Sala de Reuniones' %}
                                <i class="bi bi-buildings" style="font-size: 48px;"></i>
                            {% elif espacio.tipo == 'Auditorio' %}
                                <i class="bi bi-mic" style="font-size: 48px;"></i>
                            {% elif espacio.tipo == 'Laboratorio' %}
                                <i class="bi bi-thermometer" style="font-size: 48px;"></i>
                            {% elif espacio.tipo == 'Oficina' %}
                                <i class="bi bi-briefcase" style="font-size: 48px;"></i>
                            {% elif espacio.tipo == 'Aula' %}
                                <i class="bi bi-mortarboard" style="font-size: 48px;"></i>
                            {% else %}
                                <i class="bi bi-building" style="font-size: 48px;"></i>
                            {% endif %}
                            <div class="space-status">
                                <i class="bi bi-check-circle"></i> Disponible
                            </div>
                        </div>
                        <div class="space-content">
                            <h3 class="space-name">{{ espacio.nombre }}</h3>
                            <div class="space-location">
                                <i class="bi bi-geo-alt"></i>
                                <span>
                                    {% if espacio.edificio and espacio.piso %}
                                        {{ espacio.edificio }}, Piso {{ espacio.piso }}
                                    {% elif espacio.edificio %}
                                        {{ espacio.edificio }}
                                    {% else %}
                                        Ubicaci√≥n no especificada
                                    {% endif %}
                                </span>
                            </div>
                            
                            <div class="space-details">
                                <div class="space-detail">
                                    <i class="bi bi-people"></i>
                                    <span>{{ espacio.capacidad }} personas</span>
                                </div>
                                <div class="space-detail">
                                    <i class="bi bi-tag"></i>
                                    <span>{{ espacio.tipo }}</span>
                                </div>
                            </div>

                            {% if espacio.descripcion %}
                            <p>
                                {{ espacio.descripcion }}
                            </p>
                            {% endif %}

                            <div class="space-equipment">
                                {% for equipamiento in espacio.equipamientos.all %}
                                <span class="equipment-tag">
                                    <i class="bi bi-tools"></i> {{ equipamiento.nombre_equipo }}
                                </span>
                                {% empty %}
                                <span class="equipment-tag">
                                    <i class="bi bi-wrench"></i> Equipamiento b√°sico
                                </span>
                                {% endfor %}
                            </div>

                            <div class="space-actions">
                                <button class="action-btn primary select-space-btn" 
                                        data-space-id="{{ espacio.id }}" 
                                        data-space-name="{{ espacio.nombre }}">
                                    <i class="bi bi-check-circle"></i>
                                    Seleccionar
                                </button>
                                <button class="action-btn view-details-btn" 
                                        data-space-id="{{ espacio.id }}">
                                    <i class="bi bi-info-circle"></i>
                                    Ver Detalles
                                </button>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="bi bi-building"></i>
                        </div>
                        <h3 class="empty-state-title">No hay espacios disponibles</h3>
                        <p class="empty-state-text">
                            Todos los espacios est√°n ocupados o en mantenimiento.
                        </p>
                        <a href="{% url 'dashboard' %}" class="action-btn primary" style="margin-top: 16px;">
                            <i class="bi bi-arrow-left"></i>
                            Volver al Dashboard
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Step 2: Date and Time -->
            <div id="step2" class="form-step">
                <h2 class="step-title">
                    <i class="bi bi-calendar-date"></i>
                    Selecciona Fecha y Hora
                </h2>

                <div class="datetime-grid">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="bi bi-calendar"></i>
                            Fecha de la Reserva
                        </label>
                        <input type="date" class="form-input" id="reservationDate" min="{{ today }}">
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="bi bi-clock"></i>
                            Hora de Inicio
                        </label>
                        <select class="form-input" id="startTime">
                            <option value="">Selecciona hora</option>
                            <option value="08:00">08:00</option>
                            <option value="08:30">08:30</option>
                            <option value="09:00">09:00</option>
                            <option value="09:30">09:30</option>
                            <option value="10:00">10:00</option>
                            <option value="10:30">10:30</option>
                            <option value="11:00">11:00</option>
                            <option value="11:30">11:30</option>
                            <option value="12:00">12:00</option>
                            <option value="12:30">12:30</option>
                            <option value="13:00">13:00</option>
                            <option value="13:30">13:30</option>
                            <option value="14:00">14:00</option>
                            <option value="14:30">14:30</option>
                            <option value="15:00">15:00</option>
                            <option value="15:30">15:30</option>
                            <option value="16:00">16:00</option>
                            <option value="16:30">16:30</option>
                            <option value="17:00">17:00</option>
                            <option value="17:30">17:30</option>
                            <option value="18:00">18:00</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="bi bi-clock"></i>
                            Hora de Fin
                        </label>
                        <select class="form-input" id="endTime">
                            <option value="">Selecciona hora</option>
                            <option value="09:00">09:00</option>
                            <option value="09:30">09:30</option>
                            <option value="10:00">10:00</option>
                            <option value="10:30">10:30</option>
                            <option value="11:00">11:00</option>
                            <option value="11:30">11:30</option>
                            <option value="12:00">12:00</option>
                            <option value="12:30">12:30</option>
                            <option value="13:00">13:00</option>
                            <option value="13:30">13:30</option>
                            <option value="14:00">14:00</option>
                            <option value="14:30">14:30</option>
                            <option value="15:00">15:00</option>
                            <option value="15:30">15:30</option>
                            <option value="16:00">16:00</option>
                            <option value="16:30">16:30</option>
                            <option value="17:00">17:00</option>
                            <option value="17:30">17:30</option>
                            <option value="18:00">18:00</option>
                            <option value="18:30">18:30</option>
                            <option value="19:00">19:00</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="bi bi-stopwatch"></i>
                            Duraci√≥n
                        </label>
                        <input type="text" class="form-input" id="duration" readonly placeholder="Selecciona horas para calcular">
                    </div>
                </div>

                <div class="availability-check">
                    <div class="availability-status available">
                        <i class="bi bi-check-circle"></i>
                        Horario disponible para el espacio seleccionado
                    </div>
                </div>

                <div class="recurring-options">
                    <div class="checkbox-group">
                        <input type="checkbox" id="recurring">
                        <label for="recurring" style="color: var(--text-primary);">
                            <i class="bi bi-arrow-repeat"></i>
                            Reserva recurrente
                        </label>
                    </div>
                    <div id="recurringDetails" style="display: none;">
                        <div class="form-group" style="margin-top: 12px;">
                            <label class="form-label">
                                <i class="bi bi-calendar-event"></i>
                                Repetir cada:
                            </label>
                            <select class="form-input">
                                <option value="weekly">Semanal</option>
                                <option value="biweekly">Cada 2 semanas</option>
                                <option value="monthly">Mensual</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Details -->
            <div id="step3" class="form-step">
                <h2 class="step-title">
                    <i class="bi bi-card-text"></i>
                    Detalles de la Reserva
                </h2>

                <div class="form-group">
                    <label class="form-label">
                        <i class="bi bi-pencil"></i>
                        Prop√≥sito de la Reserva *
                    </label>
                    <textarea class="form-input form-textarea" id="purpose" placeholder="Describe brevemente el prop√≥sito de tu reserva..." required></textarea>
                </div>

                <div class="datetime-grid">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="bi bi-people"></i>
                            N√∫mero de Asistentes *
                        </label>
                        <input type="number" class="form-input" id="attendees" placeholder="0" min="1" max="200" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="bi bi-telephone"></i>
                            Contacto Responsable
                        </label>
                        <input type="tel" class="form-input" id="contact" placeholder="+56 9 1234 5678">
                    </div>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="specialEquipment">
                    <label for="specialEquipment" style="color: var(--text-primary);">
                        <i class="bi bi-tools"></i>
                        Requiere equipos especiales
                    </label>
                </div>

                <div class="special-equipment" id="specialEquipmentDetails">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="bi bi-gear"></i>
                            Detalles del equipamiento especial
                        </label>
                        <textarea class="form-input" placeholder="Especifica qu√© equipos adicionales necesitas..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Step 4: Confirmation -->
            <div id="step4" class="form-step">
                <h2 class="step-title">
                    <i class="bi bi-check-circle"></i>
                    Confirmar Reserva
                </h2>

                <div class="reservation-summary">
                    <h3 class="summary-title">
                        <i class="bi bi-file-text"></i>
                        Resumen de la Reserva
                    </h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">Espacio</div>
                            <div class="summary-value" id="summarySpace">-</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Fecha</div>
                            <div class="summary-value" id="summaryDate">-</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Horario</div>
                            <div class="summary-value" id="summaryTime">-</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Duraci√≥n</div>
                            <div class="summary-value" id="summaryDuration">-</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Asistentes</div>
                            <div class="summary-value" id="summaryAttendees">-</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Prop√≥sito</div>
                            <div class="summary-value" id="summaryPurpose">-</div>
                        </div>
                    </div>
                </div>

                <div class="terms-section">
                    <h4 class="terms-title">
                        <i class="bi bi-file-earmark-text"></i>
                        T√©rminos y Condiciones
                    </h4>
                    <div class="terms-text">
                        <p>Al enviar esta solicitud de reserva, acepto los siguientes t√©rminos:</p>
                        <ul style="margin: 12px 0 12px 20px; line-height: 1.6; color: var(--text-secondary);">
                            <li>La reserva est√° sujeta a aprobaci√≥n por parte del administrador</li>
                            <li>Debo llegar puntualmente y utilizar el espacio responsablemente</li>
                            <li>Cualquier da√±o ser√° responsabilidad del solicitante</li>
                            <li>Las cancelaciones deben realizarse con al menos 24 horas de anticipaci√≥n</li>
                            <li>El uso del espacio debe cumplir con las pol√≠ticas institucionales</li>
                        </ul>
                    </div>
                    
                    <div class="checkbox-group" style="margin-top: 16px;">
                        <input type="checkbox" id="acceptTerms" required>
                        <label for="acceptTerms" style="color: var(--text-primary);">
                            <i class="bi bi-check-circle"></i>
                            Acepto los t√©rminos y condiciones *
                        </label>
                    </div>
                </div>
            </div>

            <!-- Form Navigation -->
            <div class="form-navigation">
                <button type="button" class="nav-btn secondary" id="prevBtn" style="visibility: hidden;">
                    <i class="bi bi-arrow-left"></i>
                    Anterior
                </button>
                <button type="button" class="nav-btn primary" id="nextBtn">
                    Siguiente
                    <i class="bi bi-arrow-right"></i>
                </button>
            </div>
        </div>
    </main>

    <script>
        // ========== SISTEMA DE TEMA ==========
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            const body = document.body;
            
            // Verificar tema guardado
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                body.classList.add('theme-dark');
                themeIcon.classList.remove('bi-moon');
                themeIcon.classList.add('bi-sun');
            }
            
            // Funci√≥n para cambiar tema
            themeToggle.addEventListener('click', () => {
                const isDark = body.classList.contains('theme-dark');
                
                if (isDark) {
                    body.classList.remove('theme-dark');
                    themeIcon.classList.remove('bi-sun');
                    themeIcon.classList.add('bi-moon');
                    localStorage.setItem('theme', 'light');
                } else {
                    body.classList.add('theme-dark');
                    themeIcon.classList.remove('bi-moon');
                    themeIcon.classList.add('bi-sun');
                    localStorage.setItem('theme', 'dark');
                }
            });
            
            // ========== FORM WIZARD FUNCTIONALITY ==========
            let currentStep = 1;
            let selectedSpace = {
                id: null,
                name: null
            };

            const steps = document.querySelectorAll('.step');
            const formSteps = document.querySelectorAll('.form-step');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const errorMessage = document.getElementById('errorMessage');

            // ========== FUNCIONES PARA ESPACIOS ==========
            function selectSpace(element) {
                const spaceId = element.dataset.spaceId;
                const spaceName = element.dataset.spaceName;
                
                // Remover selecci√≥n anterior
                document.querySelectorAll('.space-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                // Agregar selecci√≥n actual
                const spaceCard = element.closest('.space-card');
                spaceCard.classList.add('selected');
                
                // Guardar datos del espacio seleccionado
                selectedSpace.id = spaceId;
                selectedSpace.name = spaceName;
                
                console.log(`Espacio seleccionado: ${spaceName} (ID: ${spaceId})`);
                hideError();
            }

            function verDetallesEspacio(spaceId) {
                // Aqu√≠ puedes implementar un modal o redirecci√≥n para ver detalles
                // Por ahora, mostraremos un modal simple
                const espacio = document.querySelector(`.space-card[data-space-id="${spaceId}"]`);
                const nombre = espacio.querySelector('.space-name').textContent;
                const ubicacion = espacio.querySelector('.space-location span').textContent;
                const capacidad = espacio.querySelector('.space-detail:first-child span').textContent;
                const tipo = espacio.querySelector('.space-detail:last-child span').textContent;
                
                const detalles = `
                    Detalles del espacio:
                    
                    Nombre: ${nombre}
                    Ubicaci√≥n: ${ubicacion}
                    Capacidad: ${capacidad}
                    Tipo: ${tipo}
                    
                    ID: ${spaceId}
                    
                    Para m√°s informaci√≥n, contacta al administrador o revisa los detalles completos en la secci√≥n de Espacios.
                `;
                
                alert(detalles);
            }

            // Event delegation para manejar clics en botones
            document.addEventListener('click', function(e) {
                // Manejar clic en bot√≥n "Seleccionar"
                if (e.target.closest('.select-space-btn')) {
                    const btn = e.target.closest('.select-space-btn');
                    selectSpace(btn);
                }
                
                // Manejar clic en bot√≥n "Ver Detalles"
                if (e.target.closest('.view-details-btn')) {
                    const btn = e.target.closest('.view-details-btn');
                    const spaceId = btn.dataset.spaceId;
                    verDetallesEspacio(spaceId);
                }
            });

            // ========== FUNCIONES PARA FILTRAR HORAS ==========
            const startTimeSelect = document.getElementById('startTime');
            const endTimeSelect = document.getElementById('endTime');
            const durationInput = document.getElementById('duration');

            function updateEndTimeOptions() {
                const startTime = startTimeSelect.value;
                const endTimeOptions = endTimeSelect.querySelectorAll('option');
                
                // Resetear todas las opciones
                endTimeOptions.forEach(option => {
                    if (option.value === '') {
                        option.disabled = false;
                        option.style.display = '';
                    } else {
                        option.disabled = false;
                        option.style.display = '';
                    }
                });
                
                // Si hay una hora de inicio seleccionada, deshabilitar horas anteriores o iguales
                if (startTime) {
                    endTimeOptions.forEach(option => {
                        if (option.value !== '' && option.value <= startTime) {
                            option.disabled = true;
                            option.style.display = 'none';
                        }
                    });
                    
                    // Si la hora de t√©rmino actual es menor o igual a la de inicio, limpiarla
                    if (endTimeSelect.value && endTimeSelect.value <= startTime) {
                        endTimeSelect.value = '';
                        durationInput.value = '';
                    }
                }
                
                calculateDuration();
            }

            function calculateDuration() {
                const startTime = startTimeSelect.value;
                const endTime = endTimeSelect.value;

                if (startTime && endTime) {
                    const start = new Date(`2024-01-01T${startTime}`);
                    const end = new Date(`2024-01-01T${endTime}`);
                    const diff = (end - start) / (1000 * 60); // minutes

                    if (diff > 0) {
                        const hours = Math.floor(diff / 60);
                        const minutes = diff % 60;
                        durationInput.value = `${hours}h ${minutes > 0 ? minutes + 'm' : ''}`;
                    } else {
                        durationInput.value = 'Horario inv√°lido';
                    }
                } else {
                    durationInput.value = '';
                }
            }

            // Event listeners para las horas
            startTimeSelect.addEventListener('change', function() {
                updateEndTimeOptions();
                hideError();
            });

            endTimeSelect.addEventListener('change', function() {
                calculateDuration();
                hideError();
            });

            // Inicializar las opciones de hora de t√©rmino
            updateEndTimeOptions();

            // Recurring checkbox
            const recurringCheckbox = document.getElementById('recurring');
            const recurringDetails = document.getElementById('recurringDetails');

            recurringCheckbox.addEventListener('change', function() {
                recurringDetails.style.display = this.checked ? 'block' : 'none';
            });

            // Special equipment checkbox
            const specialEquipmentCheckbox = document.getElementById('specialEquipment');
            const specialEquipmentDetails = document.getElementById('specialEquipmentDetails');

            specialEquipmentCheckbox.addEventListener('change', function() {
                specialEquipmentDetails.classList.toggle('visible', this.checked);
            });

            // Navigation functions
            function showStep(step) {
                // Hide all steps
                formSteps.forEach(s => s.classList.remove('active'));
                
                // Show current step
                document.getElementById(`step${step}`).classList.add('active');

                // Update step indicators
                steps.forEach((s, index) => {
                    const stepNumber = parseInt(s.dataset.step);
                    s.classList.remove('active', 'completed');
                    
                    if (stepNumber < step) {
                        s.classList.add('completed');
                    } else if (stepNumber === step) {
                        s.classList.add('active');
                    }
                });

                // Update step connectors
                const connectors = document.querySelectorAll('.step-connector');
                connectors.forEach((connector, index) => {
                    connector.classList.toggle('completed', index + 1 < step);
                });

                // Update navigation buttons
                prevBtn.style.visibility = step === 1 ? 'hidden' : 'visible';
                
                if (step === 4) {
                    nextBtn.innerHTML = '<i class="bi bi-check-circle"></i> Enviar Solicitud';
                    nextBtn.classList.remove('primary');
                    nextBtn.classList.add('success');
                    updateSummary();
                } else {
                    nextBtn.innerHTML = 'Siguiente <i class="bi bi-arrow-right"></i>';
                    nextBtn.classList.remove('success');
                    nextBtn.classList.add('primary');
                }

                currentStep = step;
            }

            function validateStep(step) {
                hideError();
                
                switch(step) {
                    case 1:
                        if (!selectedSpace.id) {
                            showError('Por favor, selecciona un espacio disponible haciendo clic en el bot√≥n "Seleccionar" de la tarjeta del espacio que deseas reservar.');
                            return false;
                        }
                        return true;
                        
                    case 2:
                        const date = document.getElementById('reservationDate').value;
                        const startTime = document.getElementById('startTime').value;
                        const endTime = document.getElementById('endTime').value;
                        
                        if (!date) {
                            showError('Por favor, selecciona una fecha para la reserva.');
                            return false;
                        }
                        if (!startTime) {
                            showError('Por favor, selecciona una hora de inicio.');
                            return false;
                        }
                        if (!endTime) {
                            showError('Por favor, selecciona una hora de fin.');
                            return false;
                        }
                        
                        if (startTime >= endTime) {
                            showError('La hora de fin debe ser posterior a la hora de inicio.');
                            return false;
                        }
                        return true;
                        
                    case 3:
                        const purpose = document.getElementById('purpose').value.trim();
                        const attendees = document.getElementById('attendees').value;
                        
                        if (!purpose) {
                            showError('Por favor, describe el prop√≥sito de la reserva.');
                            return false;
                        }
                        if (purpose.length < 10) {
                            showError('El prop√≥sito debe tener al menos 10 caracteres.');
                            return false;
                        }
                        if (!attendees || parseInt(attendees) < 1) {
                            showError('Por favor, ingresa un n√∫mero v√°lido de asistentes.');
                            return false;
                        }
                        return true;
                        
                    default:
                        return true;
                }
            }

            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
            }

            function hideError() {
                errorMessage.style.display = 'none';
            }

            function updateSummary() {
                document.getElementById('summarySpace').textContent = selectedSpace.name || '-';
                document.getElementById('summaryDate').textContent = document.getElementById('reservationDate').value || '-';
                document.getElementById('summaryTime').textContent = 
                    `${document.getElementById('startTime').value} - ${document.getElementById('endTime').value}`;
                document.getElementById('summaryDuration').textContent = document.getElementById('duration').value || '-';
                document.getElementById('summaryAttendees').textContent = document.getElementById('attendees').value || '-';
                document.getElementById('summaryPurpose').textContent = document.getElementById('purpose').value || '-';
            }

            // CSRF Token function
            function getCSRFToken() {
                const name = 'csrftoken';
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // Main reservation function
            async function crearReservaReal() {
                // Validar t√©rminos
                if (!document.getElementById('acceptTerms').checked) {
                    showError('Por favor, acepta los t√©rminos y condiciones para continuar.');
                    return false;
                }

                // Validar que hay un espacio seleccionado
                if (!selectedSpace.id) {
                    showError('Por favor, selecciona un espacio.');
                    return false;
                }

                // Recopilar datos del formulario
                const reservaData = {
                    espacio_id: selectedSpace.id,
                    fecha_reserva: document.getElementById('reservationDate').value,
                    hora_inicio: document.getElementById('startTime').value,
                    hora_fin: document.getElementById('endTime').value,
                    proposito: document.getElementById('purpose').value,
                    num_asistentes: parseInt(document.getElementById('attendees').value)
                };

                // Validaciones finales
                if (!reservaData.fecha_reserva || !reservaData.hora_inicio || !reservaData.hora_fin) {
                    showError('Por favor, completa la fecha y hora de la reserva.');
                    return false;
                }

                if (!reservaData.proposito || reservaData.proposito.length < 10) {
                    showError('Por favor, proporciona un prop√≥sito m√°s detallado (m√≠nimo 10 caracteres).');
                    return false;
                }

                // Mostrar loading
                nextBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Creando reserva...';
                nextBtn.disabled = true;

                try {
                    const response = await fetch('/api/crear-reserva/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()
                        },
                        body: JSON.stringify(reservaData)
                    });

                    const data = await response.json();

                    if (data.success) {
                        window.location.href = data.redirect_url || `/reserva-exitosa/?reserva_id=${data.reserva_id}`;
                    } else {
                        showError('Error al crear la reserva: ' + (data.message || data.error || 'Error desconocido'));
                        nextBtn.innerHTML = '<i class="bi bi-check-circle"></i> Enviar Solicitud';
                        nextBtn.disabled = false;
                    }

                } catch (error) {
                    showError('Error de conexi√≥n. Intenta nuevamente.');
                    nextBtn.innerHTML = '<i class="bi bi-check-circle"></i> Enviar Solicitud';
                    nextBtn.disabled = false;
                }
            }

            // Event listeners
            nextBtn.addEventListener('click', function() {
                if (currentStep === 4) {
                    crearReservaReal();
                } else {
                    if (validateStep(currentStep)) {
                        currentStep++;
                        showStep(currentStep);
                    }
                }
            });

            prevBtn.addEventListener('click', function() {
                if (currentStep > 1) {
                    currentStep--;
                    showStep(currentStep);
                }
            });

            // Initialize
            showStep(1);

            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('reservationDate');
            if (dateInput) {
                dateInput.min = today;
                // Establecer fecha m√≠nima visual
                if (!dateInput.value) {
                    dateInput.value = today;
                }
            }
            
            console.log('Formulario de reserva cargado correctamente');
        });
    </script>
</body>
</html>
============================================================


===== crear_usuario.html =====
<html>
<head>
  {% include 'reservas/_theme_snippet.html' %}
  {% load static %}
  <meta charset="utf-8" />
  <title>Crear Usuario</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link id="darkCss" rel="stylesheet" href="{% static 'css/dark.css' %}" disabled>
</head>
<body class="p-4 bg-light">
<div class="container">
  <div class="card mx-auto" style="max-width:720px;">
    <div class="card-body">
      <h4 class="card-title">Crear Usuario</h4>
      <form id="crearUsuarioForm">
        <div class="mb-2">
          <label class="form-label">Nombre</label>
          <input type="text" id="first_name" class="form-control" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Apellido</label>
          <input type="text" id="last_name" class="form-control">
        </div>
        <div class="mb-2">
          <label class="form-label">Email</label>
          <input type="email" id="email" class="form-control" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Contrase√±a</label>
          <input type="password" id="password" class="form-control" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Departamento</label>
          <input type="text" id="department" class="form-control">
        </div>
        {% if user.perfilusuario.rol == 'SuperAdmin' %}
        <div class="mb-2">
          <label class="form-label">Rol</label>
          <select id="rol" class="form-control">
            <option value="Usuario">Usuario</option>
            <option value="Docente">Docente</option>
            <option value="Investigacion">Investigaci√≥n</option>
            <option value="Administrativo">Administrativo</option>
            <option value="Aprobador">Aprobador</option>
            <option value="SuperAdmin">SuperAdmin</option>
          </select>
        </div>
        {% endif %}
        <div class="d-grid gap-2">
          <button class="btn btn-primary" type="submit">Crear usuario</button>
          <a href="/gestion-usuarios/" class="btn btn-link">Volver a gesti√≥n de usuarios</a>
        </div>
      </form>
      <div id="msg" class="mt-3"></div>
    </div>
  </div>
</div>

<script>
document.getElementById('crearUsuarioForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const payload = {
    first_name: document.getElementById('first_name').value,
    last_name: document.getElementById('last_name').value,
    email: document.getElementById('email').value,
    password: document.getElementById('password').value,
    department: document.getElementById('department').value
  };
  // Si existe el selector de rol (solo visible a SuperAdmin), incluirlo
  const rolEl = document.getElementById('rol');
  if (rolEl) payload.rol = rolEl.value;

  const resp = await fetch('/api/crear-usuario/', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const data = await resp.json();
  const msg = document.getElementById('msg');
  if(data.success){
    msg.innerHTML = '<div class="alert alert-success">Usuario creado correctamente.</div>';
    this.reset();
  } else {
    msg.innerHTML = `<div class="alert alert-danger">${data.message || data.error}</div>`;
  }
});
</script>
  <script src="{% static 'js/theme.js' %}"></script>
</body>
</html>

============================================================


===== dashboard.html =====
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema de Reservas</title>
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        /* Variables CSS para temas */
        :root {
            /* Tema Claro (default) */
            --bg-primary: #f9fafb;
            --bg-secondary: white;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border-color: #e5e7eb;
            --accent-color: #2563eb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #dc2626;
            --purple-color: #8b5cf6;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .theme-dark {
            /* Tema Oscuro */
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-tertiary: #9ca3af;
            --border-color: #4b5563;
            --accent-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --purple-color: #8b5cf6;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: var(--accent-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .nav-menu {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .nav-item {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .nav-item i {
            font-size: 16px;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--accent-color);
            color: white;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--success-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        /* Bot√≥n de tema */
        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            background: var(--bg-tertiary);
            color: var(--accent-color);
        }

        /* Main Content */
        .main-content {
            padding: 24px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title i {
            color: var(--accent-color);
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
            border-left: 4px solid;
            transition: transform 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .stat-card.green {
            border-left-color: var(--success-color);
        }

        .stat-card.orange {
            border-left-color: var(--warning-color);
        }

        .stat-card.blue {
            border-left-color: var(--accent-color);
        }

        .stat-card.purple {
            border-left-color: var(--purple-color);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .stat-title {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-card.green .stat-icon {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .stat-card.orange .stat-icon {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .stat-card.blue .stat-icon {
            background: rgba(37, 99, 235, 0.1);
            color: var(--accent-color);
        }

        .stat-card.purple .stat-icon {
            background: rgba(139, 92, 246, 0.1);
            color: var(--purple-color);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1;
        }

        .stat-change {
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-change.positive {
            color: var(--success-color);
        }

        .stat-change.negative {
            color: var(--danger-color);
        }

        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        .main-section, .sidebar-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .view-all-btn {
            color: var(--accent-color);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .view-all-btn:hover {
            text-decoration: underline;
        }

        /* Reservations Table */
        .reservations-table {
            width: 100%;
            border-collapse: collapse;
        }

        .reservations-table th,
        .reservations-table td {
            text-align: left;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .reservations-table th {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .reservations-table td {
            color: var(--text-primary);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.approved {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .status-badge.pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .status-badge.rejected {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .action-btn {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
        }

        .action-btn.primary {
            background: var(--success-color);
            color: white;
            border: 1px solid var(--success-color);
        }

        .action-btn.primary:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: var(--shadow-hover);
        }

        .action-btn.secondary {
            background: var(--accent-color);
            color: white;
            border: 1px solid var(--accent-color);
        }

        .action-btn.secondary:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: var(--shadow-hover);
        }

        /* Recent Activity */
        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
            color: var(--text-secondary);
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .activity-time {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-state-text {
            font-size: 14px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 0 16px;
            }

            .nav-menu {
                display: none;
            }

            .main-content {
                padding: 16px;
            }

            .content-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .quick-actions {
                flex-direction: row;
            }

            .action-btn {
                flex: 1;
            }
        }
    </style>
</head>
<body class="theme-light">
    <!-- Header -->
    <header class="header">
        <div class="logo-section">
            <div class="logo">
                <i class="bi bi-calendar-check"></i>
            </div>
            <div style="font-weight: 600; color: var(--text-primary);">Sistema de Reservas</div>
        </div>
        
        <nav class="nav-menu">
            <a href="{% url 'dashboard' %}" class="nav-item active">
                <i class="bi bi-speedometer2"></i>
                Dashboard
            </a>
            <a href="{% url 'crear_reserva' %}" class="nav-item">
                <i class="bi bi-plus-circle"></i>
                Reservar
            </a>
            <a href="{% url 'reservas' %}" class="nav-item">
                <i class="bi bi-clock-history"></i>
                Historial
            </a>
            <a href="{% url 'calendario' %}" class="nav-item">
                <i class="bi bi-calendar-week"></i>
                Calendario
            </a>
            <a href="{% url 'espacios' %}" class="nav-item">
                <i class="bi bi-building"></i>
                Espacios
            </a>
            <a href="{% url 'notificaciones' %}" class="nav-item">
                <i class="bi bi-bell"></i>
                Notificaciones
            </a>
        </nav>
        
        <div class="user-menu">
            <!-- Bot√≥n de cambio de tema -->
            <button class="theme-toggle" id="themeToggle" title="Cambiar tema">
                <i class="bi bi-moon" id="themeIcon"></i>
            </button>
            
            <div class="user-avatar">
                {% if user.first_name and user.last_name %}
                    {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                {% else %}
                    {{ user.username|first|upper }}
                {% endif %}
            </div>
            <span style="color: var(--text-primary);">
                {% if user.first_name %}
                    {{ user.first_name }} {{ user.last_name }}
                {% else %}
                    {{ user.username }}
                {% endif %}
            </span>
            <a href="{% url 'logout' %}" class="theme-toggle" title="Cerrar sesi√≥n">
                <i class="bi bi-box-arrow-right"></i>
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title">
                <i class="bi bi-speedometer2"></i>
                Dashboard
            </h1>
            <p class="page-subtitle">
                Bienvenido de vuelta, 
                {% if user.first_name %}
                    {{ user.first_name }}
                {% else %}
                    {{ user.username }}
                {% endif %}. 
                Aqu√≠ tienes un resumen de tus reservas.
            </p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card green">
                <div class="stat-header">
                    <div class="stat-title">Reservas Activas</div>
                    <div class="stat-icon">
                        <i class="bi bi-calendar-check"></i>
                    </div>
                </div>
                <div class="stat-value">{{ reservas_activas }}</div>
                <div class="stat-change positive">
                    <i class="bi bi-check-circle"></i>
                    Activas este mes
                </div>
            </div>

            <div class="stat-card orange">
                <div class="stat-header">
                    <div class="stat-title">Reservas Pendientes</div>
                    <div class="stat-icon">
                        <i class="bi bi-clock"></i>
                    </div>
                </div>
                <div class="stat-value">{{ reservas_pendientes }}</div>
                <div class="stat-change positive">
                    <i class="bi bi-arrow-repeat"></i>
                    En espera de aprobaci√≥n
                </div>
            </div>

            <div class="stat-card blue">
                <div class="stat-header">
                    <div class="stat-title">Reservas Totales</div>
                    <div class="stat-icon">
                        <i class="bi bi-bar-chart"></i>
                    </div>
                </div>
                <div class="stat-value">{{ total_reservas }}</div>
                <div class="stat-change positive">
                    <i class="bi bi-graph-up"></i>
                    Historial completo
                </div>
            </div>

            <div class="stat-card purple">
                <div class="stat-header">
                    <div class="stat-title">Espacios Favoritos</div>
                    <div class="stat-icon">
                        <i class="bi bi-heart"></i>
                    </div>
                </div>
                <div class="stat-value">3</div>
                <div class="stat-change positive">
                    <i class="bi bi-star"></i>
                    M√°s utilizados
                </div>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="content-grid">
            <!-- Main Section - Pr√≥ximas Reservas -->
            <div class="main-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="bi bi-calendar3"></i>
                        Pr√≥ximas Reservas
                    </h2>
                    <a href="{% url 'reservas' %}" class="view-all-btn">
                        Ver todas
                        <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
                
                {% if reservas_recientes %}
                <table class="reservations-table">
                    <thead>
                        <tr>
                            <th>Espacio</th>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for reserva in reservas_recientes %}
                        <tr>
                            <td>{{ reserva.espacio.nombre }}</td>
                            <td>{{ reserva.fecha_reserva|date:"d M Y" }}</td>
                            <td>{{ reserva.hora_inicio|time:"H:i" }} - {{ reserva.hora_fin|time:"H:i" }}</td>
                            <td>
                                <span class="status-badge {{ reserva.estado|lower }}">
                                    {{ reserva.estado }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="bi bi-clipboard"></i>
                    </div>
                    <h3 class="empty-state-title">No hay reservas recientes</h3>
                    <p class="empty-state-text">Crea tu primera reserva para comenzar</p>
                    <a href="{% url 'crear_reserva' %}" class="action-btn primary" style="margin-top: 16px;">
                        <i class="bi bi-plus-lg"></i>
                        Crear Reserva
                    </a>
                </div>
                {% endif %}
            </div>

            <!-- Sidebar -->
            <div class="sidebar-section">
                <!-- Quick Actions -->
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="bi bi-lightning"></i>
                        Acciones R√°pidas
                    </h2>
                </div>
                <div class="quick-actions">
                    <a href="{% url 'crear_reserva' %}" class="action-btn primary">
                        <i class="bi bi-plus-lg"></i>
                        Nueva Reserva
                    </a>
                    <a href="{% url 'calendario' %}" class="action-btn secondary">
                        <i class="bi bi-calendar-week"></i>
                        Ver Calendario
                    </a>
                </div>

                <!-- Recent Activity -->
                <div style="margin-top: 24px;">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="bi bi-clock-history"></i>
                            Actividad Reciente
                        </h2>
                    </div>
                    <div class="activity-list">
                        {% if reservas_recientes %}
                            {% for reserva in reservas_recientes|slice:":3" %}
                            <div class="activity-item">
                                <div class="activity-icon">
                                    {% if reserva.estado == 'Aprobada' %}
                                        <i class="bi bi-check-circle"></i>
                                    {% elif reserva.estado == 'Pendiente' %}
                                        <i class="bi bi-clock"></i>
                                    {% else %}
                                        <i class="bi bi-clipboard"></i>
                                    {% endif %}
                                </div>
                                <div class="activity-content">
                                    <div class="activity-text">
                                        Reserva {{ reserva.estado|lower }} para {{ reserva.espacio.nombre }}
                                    </div>
                                    <div class="activity-time">
                                        {{ reserva.fecha_solicitud|timesince }} ago
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <i class="bi bi-hand-wave"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-text">
                                        Bienvenido al sistema de reservas
                                    </div>
                                    <div class="activity-time">
                                        Comienza creando tu primera reserva
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Sistema de tema claro/oscuro
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            const body = document.body;
            
            // Verificar tema guardado en localStorage
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                body.classList.add('theme-dark');
                themeIcon.classList.remove('bi-moon');
                themeIcon.classList.add('bi-sun');
            }
            
            // Funci√≥n para cambiar tema
            themeToggle.addEventListener('click', () => {
                const isDark = body.classList.contains('theme-dark');
                
                if (isDark) {
                    body.classList.remove('theme-dark');
                    themeIcon.classList.remove('bi-sun');
                    themeIcon.classList.add('bi-moon');
                    localStorage.setItem('theme', 'light');
                } else {
                    body.classList.add('theme-dark');
                    themeIcon.classList.remove('bi-moon');
                    themeIcon.classList.add('bi-sun');
                    localStorage.setItem('theme', 'dark');
                }
            });
            
            // Animaciones para las tarjetas de estad√≠sticas
            const statCards = document.querySelectorAll('.stat-card');
            statCards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                });
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });
            });
            
            // Actualizar contadores en tiempo real (simulado)
            setTimeout(() => {
                console.log('Dashboard cargado correctamente');
            }, 100);
        });
    </script>
</body>
</html>
============================================================


===== dashboard_admin.html =====
<!DOCTYPE html>
<html lang="es">
<head>
        {% include 'reservas/_icons.html' %}
    {% include 'reservas/_theme_snippet.html' %}
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Administrador - Sistema de Reservas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #F9FAFB;
            color: #111827;
            line-height: 1.6;
        }
        
        /* Header */
        .header {
            width: 100%;
            background: #23272f;
            color: #fff;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            height: 70px;
        }
        .header-content {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 32px;
        }
        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 22px;
            font-weight: 700;
        }
        .logo {
            color: #facc15;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .nav-menu {
            display: flex;
            gap: 28px;
        }
        .nav-item {
            color: #e5e7eb;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .nav-item:hover, .nav-item.active {
            color: #2563eb;
            background: #23272f;
        }
        .user-menu {
            display: flex;
            align-items: center;
            gap: 16px;
            position: relative;
        }
        .user-avatar {
            font-size: 22px;
            color: #facc15;
        }
        .user-name {
            font-size: 15px;
            color: #fff;
            font-weight: 500;
        }
        .logout-btn {
            background: none;
            border: none;
            color: #e5e7eb;
            font-size: 20px;
            cursor: pointer;
            margin-left: 8px;
        }
        .logout-panel {
            display: none;
            position: absolute;
            top: 48px;
            right: 0;
            background: #23272f;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            min-width: 160px;
            z-index: 200;
        }
        .logout-panel.active {
            display: block;
        }
        .panel-item {
            padding: 12px 20px;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid #23272f;
        }
        .panel-item:last-child {
            border-bottom: none;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .notification-badge {
            position: relative;
            background: #F3F4F6;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .notification-badge:hover {
            background: #E5E7EB;
        }
        
        .badge-count {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #DC2626;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .admin-avatar {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .admin-avatar:hover {
            background: #F3F4F6;
        }
        
        .avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .page-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #111827;
        }
        
        .page-subtitle {
            color: #6B7280;
            margin-bottom: 32px;
        }
        
        /* Metrics Cards */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .metric-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .metric-icon.pending { background: #FEF3C7; color: #F59E0B; }
        .metric-icon.success { background: #D1FAE5; color: #10B981; }
        .metric-icon.info { background: #DBEAFE; color: #2563EB; }
        .metric-icon.purple { background: #EDE9FE; color: #7C3AED; }
        
        .metric-value {
            font-size: 36px;
            font-weight: 700;
            color: #111827;
            line-height: 1;
        }
        
        .metric-label {
            color: #6B7280;
            font-size: 14px;
            font-weight: 500;
        }
        
        .metric-change {
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
        }
        
        .metric-change.positive { color: #10B981; }
        .metric-change.negative { color: #DC2626; }
        
        /* Activity Section */
        .activity-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        
        .activity-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .activity-header {
            padding: 20px;
            border-bottom: 1px solid #E5E7EB;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .activity-title {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
        }
        
        .view-all {
            color: #2563EB;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
        }
        
        .activity-content {
            padding: 20px;
        }
        
        /* Quick Actions */
        .quick-action {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            text-decoration: none;
            color: #374151;
            transition: all 0.2s;
            margin-bottom: 8px;
        }
        
        .quick-action:hover {
            background: #F3F4F6;
            color: #2563EB;
        }
        
        .action-icon {
            width: 32px;
            height: 32px;
            background: #EFF6FF;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2563EB;
        }
        
        .action-text {
            font-weight: 500;
        }
        
        /* Recent Activity */
        .activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #F3F4F6;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-avatar {
            width: 32px;
            height: 32px;
            background: #E5E7EB;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .activity-details {
            flex: 1;
        }
        
        .activity-description {
            font-size: 14px;
            color: #374151;
            margin-bottom: 2px;
        }
        
        .activity-time {
            font-size: 12px;
            color: #9CA3AF;
        }
    </style>
    <link id="darkCss" rel="stylesheet" href="{% static 'css/dark.css' %}" disabled>
</head>
<body>
    <!-- Header Moderno con Bootstrap Icons y men√∫ usuario -->
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo"><i class="bi bi-building"></i></div>
                <div style="font-weight: 600; color: #fff;">Panel Administrativo</div>
            </div>
            <nav class="nav-menu">
                <a href="{% url 'admin_dashboard' %}" class="nav-item active"><i class="bi bi-speedometer2"></i> Dashboard</a>
                <a href="{% url 'solicitudes_pendientes' %}" class="nav-item"><i class="bi bi-inbox"></i> Solicitudes</a>
                <a href="{% url 'gestion_espacios' %}" class="nav-item"><i class="bi bi-door-open"></i> Espacios</a>
                <a href="{% url 'gestion_usuarios' %}" class="nav-item"><i class="bi bi-people"></i> Usuarios</a>
                <a href="{% url 'reportes' %}" class="nav-item"><i class="bi bi-bar-chart"></i> Reportes</a>
            </nav>
            <div class="user-menu" id="userMenu">
                <button class="notification-btn" id="notificationBtn" style="background:none;border:none;position:relative;font-size:22px;cursor:pointer;color:#facc15;">
                    <i class="bi bi-bell"></i>
                    <span id="notifBadge" style="display:none;position:absolute;top:0;right:0;background:#ef4444;color:#fff;font-size:11px;padding:2px 6px;border-radius:10px;">0</span>
                </button>
                <div class="user-avatar" id="userAvatar" style="cursor:pointer;">
                    <i class="bi bi-person-circle"></i>
                </div>
                <span class="user-name">{% if user.first_name %}{{ user.first_name }} {{ user.last_name }}{% else %}{{ user.username }}{% endif %}</span>
                <button class="logout-btn" id="logoutBtn" title="Cerrar sesi√≥n">
                    <i class="bi bi-box-arrow-right"></i>
                </button>
                <div class="logout-panel" id="logoutPanel">
                    <div class="panel-item" onclick="window.location.href='{% url 'logout' %}'">
                        <i class="bi bi-box-arrow-right"></i> Cerrar sesi√≥n
                    </div>
                </div>
            </div>
        </div>
        <script>
        // Badge de notificaciones (ejemplo, reemplazar por AJAX real)
        function updateNotifBadge(count) {
            const badge = document.getElementById('notifBadge');
            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'inline-block' : 'none';
            }
        }
        updateNotifBadge(0); // Cambia a la cantidad real
        // Men√∫ flotante de logout
        const logoutBtn = document.getElementById('logoutBtn');
        const logoutPanel = document.getElementById('logoutPanel');
        const userAvatar = document.getElementById('userAvatar');
        if (logoutBtn && logoutPanel) {
            logoutBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                logoutPanel.classList.toggle('active');
            });
            userAvatar.addEventListener('click', function(e) {
                e.stopPropagation();
                logoutPanel.classList.toggle('active');
            });
            document.addEventListener('click', function(e) {
                if (!logoutPanel.contains(e.target) && !logoutBtn.contains(e.target) && !userAvatar.contains(e.target)) {
                    logoutPanel.classList.remove('active');
                }
            });
        }
        </script>
    </header>
    <script>
    // Badge de notificaciones (ejemplo, reemplazar por AJAX real)
    function updateNotifBadge(count) {
        const badge = document.getElementById('notifBadge');
        if (badge) {
            badge.textContent = count;
            badge.style.display = count > 0 ? 'inline-block' : 'none';
        }
    }
    updateNotifBadge(0); // Cambia a la cantidad real
    // Men√∫ flotante de logout
    const logoutBtn = document.getElementById('logoutBtn');
    const logoutPanel = document.getElementById('logoutPanel');
    const userAvatar = document.getElementById('userAvatar');
    if (logoutBtn && logoutPanel) {
        logoutBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            logoutPanel.classList.toggle('active');
        });
        userAvatar.addEventListener('click', function(e) {
            e.stopPropagation();
            logoutPanel.classList.toggle('active');
        });
        document.addEventListener('click', function(e) {
            if (!logoutPanel.contains(e.target) && !logoutBtn.contains(e.target) && !userAvatar.contains(e.target)) {
                logoutPanel.classList.remove('active');
            }
        });
    }
    </script>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-title">üìä Dashboard Administrativo</div>
        <div class="page-subtitle">
            Bienvenido, 
            {% if user.first_name %}
                {{ user.first_name }} {{ user.last_name }}
            {% else %}
                {{ user.username }}
            {% endif %}
            - Vista general del sistema de reservas
        </div>

        <!-- Metrics Cards -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header">
                    <div>
                        <div class="metric-value">{{ total_reservas }}</div>
                        <div class="metric-label">Total Reservas</div>
                        <div class="metric-change positive">
                            ‚¨ÜÔ∏è Total del sistema
                        </div>
                    </div>
                    <div class="metric-icon info">üìä</div>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <div>
                        <div class="metric-value">{{ reservas_pendientes }}</div>
                        <div class="metric-label">Solicitudes Pendientes</div>
                        <div class="metric-change positive">
                            ‚¨ÜÔ∏è Esperando aprobaci√≥n
                        </div>
                    </div>
                    <div class="metric-icon pending">‚è∞</div>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <div>
                        <div class="metric-value">{{ total_espacios }}</div>
                        <div class="metric-label">Espacios Totales</div>
                        <div class="metric-change positive">
                            ‚¨ÜÔ∏è Disponibles
                        </div>
                    </div>
                    <div class="metric-icon success">üè¢</div>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <div>
                        <div class="metric-value">{{ usuarios_activos }}</div>
                        <div class="metric-label">Usuarios Activos</div>
                        <div class="metric-change positive">
                            ‚¨ÜÔ∏è En el sistema
                        </div>
                    </div>
                    <div class="metric-icon purple">üë•</div>
                </div>
            </div>
        </div>

        <!-- Activity Section -->
        <div class="activity-section">
            <!-- Quick Actions -->
            <div class="activity-card">
                <div class="activity-header">
                    <div class="activity-title">‚ö° Acciones R√°pidas</div>
                </div>
                <div class="activity-content">
                    <a href="{% url 'solicitudes_pendientes' %}" class="quick-action">
                        <div class="action-icon">üìã</div>
                        <div class="action-text">Revisar solicitudes pendientes</div>
                    </a>
                    
                    <a href="{% url 'gestion_espacios' %}" class="quick-action">
                        <div class="action-icon">üè¢</div>
                        <div class="action-text">Gestionar espacios</div>
                    </a>
                    
                    <a href="{% url 'gestion_usuarios' %}" class="quick-action">
                        <div class="action-icon">üë•</div>
                        <div class="action-text">Gestionar usuarios</div>
                    </a>
                    
                    <a href="{% url 'reportes' %}" class="quick-action">
                        <div class="action-icon">üìä</div>
                        <div class="action-text">Ver reportes</div>
                    </a>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="activity-card">
                <div class="activity-header">
                    <div class="activity-title">‚è±Ô∏è Reservas Recientes</div>
                    <a href="{% url 'solicitudes_pendientes' %}" class="view-all">Ver todas</a>
                </div>
                <div class="activity-content">
                    {% for reserva in reservas_recientes %}
                    <div class="activity-item">
                        <div class="activity-avatar">
                            {{ reserva.solicitante.first_name|first|upper }}{{ reserva.solicitante.last_name|first|upper }}
                        </div>
                        <div class="activity-details">
                            <div class="activity-description">
                                {{ reserva.solicitante.first_name }} reserv√≥ {{ reserva.espacio.nombre }}
                            </div>
                            <div class="activity-time">
                                {{ reserva.fecha_reserva }} - {{ reserva.estado }}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="activity-item">
                        <div class="activity-avatar">-</div>
                        <div class="activity-details">
                            <div class="activity-description">No hay reservas recientes</div>
                            <div class="activity-time">-</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </main>
    <script>
        // Funci√≥n para cargar y actualizar notificaciones del admin
        function loadAdminNotifications() {
            fetch('/api/notificaciones-admin/contar/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const badge = document.getElementById('adminNotificationsCount');
                        if (data.count > 0) {
                            badge.textContent = data.count > 99 ? '99+' : data.count;
                            badge.style.display = 'flex';
                            
                            // Agregar animaci√≥n de parpadeo para nuevas notificaciones
                            badge.style.animation = 'pulse 2s infinite';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                })
                .catch(error => console.error('Error cargando notificaciones admin:', error));
        }

        // Estilos para la animaci√≥n
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.1); }
                100% { transform: scale(1); }
            }
            
            .notifications-badge:hover {
                background: #f3f4f6;
            }
        `;
        document.head.appendChild(style);

        // Cargar cada 30 segundos y al iniciar
        setInterval(loadAdminNotifications, 30000);
        loadAdminNotifications();
    </script>
    <script src="{% static 'js/theme.js' %}"></script>
</body>
</html>


============================================================


===== dashboard_usuario.html =====
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema de Reservas</title>
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        /* Variables CSS para temas */
        :root {
            /* Tema Claro (default) */
            --bg-primary: #f9fafb;
            --bg-secondary: white;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border-color: #e5e7eb;
            --accent-color: #2563eb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #dc2626;
            --purple-color: #8b5cf6;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .theme-dark {
            /* Tema Oscuro */
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-tertiary: #9ca3af;
            --border-color: #4b5563;
            --accent-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --purple-color: #8b5cf6;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: var(--accent-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .nav-menu {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .nav-item {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .nav-item i {
            font-size: 16px;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--accent-color);
            color: white;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--success-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        /* Bot√≥n de tema */
        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            background: var(--bg-tertiary);
            color: var(--accent-color);
        }

        /* Main Content */
        .main-content {
            padding: 24px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title i {
            color: var(--accent-color);
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
            border-left: 4px solid;
            transition: transform 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .stat-card.green {
            border-left-color: var(--success-color);
        }

        .stat-card.orange {
            border-left-color: var(--warning-color);
        }

        .stat-card.blue {
            border-left-color: var(--accent-color);
        }

        .stat-card.purple {
            border-left-color: var(--purple-color);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .stat-title {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-card.green .stat-icon {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .stat-card.orange .stat-icon {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .stat-card.blue .stat-icon {
            background: rgba(37, 99, 235, 0.1);
            color: var(--accent-color);
        }

        .stat-card.purple .stat-icon {
            background: rgba(139, 92, 246, 0.1);
            color: var(--purple-color);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1;
        }

        .stat-change {
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-change.positive {
            color: var(--success-color);
        }

        .stat-change.negative {
            color: var(--danger-color);
        }

        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        .main-section, .sidebar-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .view-all-btn {
            color: var(--accent-color);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .view-all-btn:hover {
            text-decoration: underline;
        }

        /* Reservations Table */
        .reservations-table {
            width: 100%;
            border-collapse: collapse;
        }

        .reservations-table th,
        .reservations-table td {
            text-align: left;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .reservations-table th {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .reservations-table td {
            color: var(--text-primary);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.approved {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .status-badge.pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .status-badge.rejected {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .action-btn {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
        }

        .action-btn.primary {
            background: var(--success-color);
            color: white;
            border: 1px solid var(--success-color);
        }

        .action-btn.primary:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: var(--shadow-hover);
        }

        .action-btn.secondary {
            background: var(--accent-color);
            color: white;
            border: 1px solid var(--accent-color);
        }

        .action-btn.secondary:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: var(--shadow-hover);
        }

        /* Recent Activity */
        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
            color: var(--text-secondary);
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .activity-time {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-state-text {
            font-size: 14px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 0 16px;
            }

            .nav-menu {
                display: none;
            }

            .main-content {
                padding: 16px;
            }

            .content-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .quick-actions {
                flex-direction: row;
            }

            .action-btn {
                flex: 1;
            }
        }
    </style>
</head>
<body class="theme-light">
    <!-- Header -->
    <header class="header">
        <div class="logo-section">
            <div class="logo">
                <i class="bi bi-calendar-check"></i>
            </div>
            <div style="font-weight: 600; color: var(--text-primary);">Sistema de Reservas</div>
        </div>
        
        <nav class="nav-menu">
            <a href="{% url 'dashboard' %}" class="nav-item active">
                <i class="bi bi-speedometer2"></i>
                Dashboard
            </a>
            <a href="{% url 'crear_reserva' %}" class="nav-item">
                <i class="bi bi-plus-circle"></i>
                Reservar
            </a>
            <a href="{% url 'reservas' %}" class="nav-item">
                <i class="bi bi-clock-history"></i>
                Historial
            </a>
            <a href="{% url 'calendario' %}" class="nav-item">
                <i class="bi bi-calendar-week"></i>
                Calendario
            </a>
            <a href="{% url 'espacios' %}" class="nav-item">
                <i class="bi bi-building"></i>
                Espacios
            </a>
            <a href="{% url 'notificaciones' %}" class="nav-item">
                <i class="bi bi-bell"></i>
                Notificaciones
            </a>
        </nav>
        
        <div class="user-menu">
            <!-- Bot√≥n de cambio de tema -->
            <button class="theme-toggle" id="themeToggle" title="Cambiar tema">
                <i class="bi bi-moon" id="themeIcon"></i>
            </button>
            
            <div class="user-avatar">
                {% if user.first_name and user.last_name %}
                    {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                {% else %}
                    {{ user.username|first|upper }}
                {% endif %}
            </div>
            <span style="color: var(--text-primary);">
                {% if user.first_name %}
                    {{ user.first_name }} {{ user.last_name }}
                {% else %}
                    {{ user.username }}
                {% endif %}
            </span>
            <a href="{% url 'logout' %}" class="theme-toggle" title="Cerrar sesi√≥n">
                <i class="bi bi-box-arrow-right"></i>
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title">
                <i class="bi bi-speedometer2"></i>
                Dashboard
            </h1>
            <p class="page-subtitle">
                Bienvenido de vuelta, 
                {% if user.first_name %}
                    {{ user.first_name }}
                {% else %}
                    {{ user.username }}
                {% endif %}. 
                Aqu√≠ tienes un resumen de tus reservas.
            </p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card green">
                <div class="stat-header">
                    <div class="stat-title">Reservas Activas</div>
                    <div class="stat-icon">
                        <i class="bi bi-calendar-check"></i>
                    </div>
                </div>
                <div class="stat-value">{{ reservas_activas }}</div>
                <div class="stat-change positive">
                    <i class="bi bi-check-circle"></i>
                    Activas este mes
                </div>
            </div>

            <div class="stat-card orange">
                <div class="stat-header">
                    <div class="stat-title">Reservas Pendientes</div>
                    <div class="stat-icon">
                        <i class="bi bi-clock"></i>
                    </div>
                </div>
                <div class="stat-value">{{ reservas_pendientes }}</div>
                <div class="stat-change positive">
                    <i class="bi bi-arrow-repeat"></i>
                    En espera de aprobaci√≥n
                </div>
            </div>

            <div class="stat-card blue">
                <div class="stat-header">
                    <div class="stat-title">Reservas Totales</div>
                    <div class="stat-icon">
                        <i class="bi bi-bar-chart"></i>
                    </div>
                </div>
                <div class="stat-value">{{ total_reservas }}</div>
                <div class="stat-change positive">
                    <i class="bi bi-graph-up"></i>
                    Historial completo
                </div>
            </div>

            <div class="stat-card purple">
                <div class="stat-header">
                    <div class="stat-title">Espacios Favoritos</div>
                    <div class="stat-icon">
                        <i class="bi bi-heart"></i>
                    </div>
                </div>
                <div class="stat-value">3</div>
                <div class="stat-change positive">
                    <i class="bi bi-star"></i>
                    M√°s utilizados
                </div>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="content-grid">
            <!-- Main Section - Pr√≥ximas Reservas -->
            <div class="main-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="bi bi-calendar3"></i>
                        Pr√≥ximas Reservas
                    </h2>
                    <a href="{% url 'reservas' %}" class="view-all-btn">
                        Ver todas
                        <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
                
                {% if reservas_recientes %}
                <table class="reservations-table">
                    <thead>
                        <tr>
                            <th>Espacio</th>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for reserva in reservas_recientes %}
                        <tr>
                            <td>{{ reserva.espacio.nombre }}</td>
                            <td>{{ reserva.fecha_reserva|date:"d M Y" }}</td>
                            <td>{{ reserva.hora_inicio|time:"H:i" }} - {{ reserva.hora_fin|time:"H:i" }}</td>
                            <td>
                                <span class="status-badge {{ reserva.estado|lower }}">
                                    {{ reserva.estado }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="bi bi-clipboard"></i>
                    </div>
                    <h3 class="empty-state-title">No hay reservas recientes</h3>
                    <p class="empty-state-text">Crea tu primera reserva para comenzar</p>
                    <a href="{% url 'crear_reserva' %}" class="action-btn primary" style="margin-top: 16px;">
                        <i class="bi bi-plus-lg"></i>
                        Crear Reserva
                    </a>
                </div>
                {% endif %}
            </div>

            <!-- Sidebar -->
            <div class="sidebar-section">
                <!-- Quick Actions -->
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="bi bi-lightning"></i>
                        Acciones R√°pidas
                    </h2>
                </div>
                <div class="quick-actions">
                    <a href="{% url 'crear_reserva' %}" class="action-btn primary">
                        <i class="bi bi-plus-lg"></i>
                        Nueva Reserva
                    </a>
                    <a href="{% url 'calendario' %}" class="action-btn secondary">
                        <i class="bi bi-calendar-week"></i>
                        Ver Calendario
                    </a>
                </div>

                <!-- Recent Activity -->
                <div style="margin-top: 24px;">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="bi bi-clock-history"></i>
                            Actividad Reciente
                        </h2>
                    </div>
                    <div class="activity-list">
                        {% if reservas_recientes %}
                            {% for reserva in reservas_recientes|slice:":3" %}
                            <div class="activity-item">
                                <div class="activity-icon">
                                    {% if reserva.estado == 'Aprobada' %}
                                        <i class="bi bi-check-circle"></i>
                                    {% elif reserva.estado == 'Pendiente' %}
                                        <i class="bi bi-clock"></i>
                                    {% else %}
                                        <i class="bi bi-clipboard"></i>
                                    {% endif %}
                                </div>
                                <div class="activity-content">
                                    <div class="activity-text">
                                        Reserva {{ reserva.estado|lower }} para {{ reserva.espacio.nombre }}
                                    </div>
                                    <div class="activity-time">
                                        {{ reserva.fecha_solicitud|timesince }} ago
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <i class="bi bi-hand-wave"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-text">
                                        Bienvenido al sistema de reservas
                                    </div>
                                    <div class="activity-time">
                                        Comienza creando tu primera reserva
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Sistema de tema claro/oscuro
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            const body = document.body;
            
            // Verificar tema guardado en localStorage
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                body.classList.add('theme-dark');
                themeIcon.classList.remove('bi-moon');
                themeIcon.classList.add('bi-sun');
            }
            
            // Funci√≥n para cambiar tema
            themeToggle.addEventListener('click', () => {
                const isDark = body.classList.contains('theme-dark');
                
                if (isDark) {
                    body.classList.remove('theme-dark');
                    themeIcon.classList.remove('bi-sun');
                    themeIcon.classList.add('bi-moon');
                    localStorage.setItem('theme', 'light');
                } else {
                    body.classList.add('theme-dark');
                    themeIcon.classList.remove('bi-moon');
                    themeIcon.classList.add('bi-sun');
                    localStorage.setItem('theme', 'dark');
                }
            });
            
            // Animaciones para las tarjetas de estad√≠sticas
            const statCards = document.querySelectorAll('.stat-card');
            statCards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                });
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });
            });
            
            // Actualizar contadores en tiempo real (simulado)
            setTimeout(() => {
                console.log('Dashboard cargado correctamente');
            }, 100);
        });
    </script>
</body>
</html>
============================================================


===== demo_tema_bootstrap.html =====
<!--
Este archivo contiene un ejemplo de c√≥mo implementar el cambio de tema (oscuro/claro) y el uso de iconos de Bootstrap en un HTML puro.
Incluye un bot√≥n para alternar el tema y ejemplos de iconos en botones y men√∫s.
-->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo Tema Oscuro/Claro + Bootstrap Icons</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body[data-theme="dark"] {
            background-color: #181c23 !important;
            color: #f3f4f6 !important;
        }
        body[data-theme="dark"] .card {
            background-color: #23272f;
            color: #f3f4f6;
        }
        body[data-theme="dark"] .btn-primary {
            background-color: #2563eb;
            border-color: #2563eb;
        }
        body[data-theme="dark"] .btn-secondary {
            background-color: #374151;
            border-color: #374151;
        }
        /* Puedes agregar m√°s reglas para otros componentes */
    </style>
</head>
<body data-theme="light">
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Demo Tema y Bootstrap Icons</h1>
            <button id="toggleThemeBtn" class="btn btn-secondary">
                <i class="bi bi-moon"></i> Cambiar tema
            </button>
        </div>
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">Acciones con iconos</h5>
                <button class="btn btn-primary me-2"><i class="bi bi-plus-circle"></i> Nuevo</button>
                <button class="btn btn-success me-2"><i class="bi bi-pencil"></i> Editar</button>
                <button class="btn btn-danger"><i class="bi bi-trash"></i> Eliminar</button>
            </div>
        </div>
        <nav class="nav mb-3">
            <a class="nav-link active" href="#"><i class="bi bi-house"></i> Inicio</a>
            <a class="nav-link" href="#"><i class="bi bi-people"></i> Usuarios</a>
            <a class="nav-link" href="#"><i class="bi bi-gear"></i> Configuraci√≥n</a>
        </nav>
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Este es un ejemplo de alerta con icono.
        </div>
    </div>
    <script>
        const btn = document.getElementById('toggleThemeBtn');
        btn.addEventListener('click', function() {
            const body = document.body;
            const isDark = body.getAttribute('data-theme') === 'dark';
            body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            btn.innerHTML = isDark
                ? '<i class="bi bi-moon"></i> Cambiar tema'
                : '<i class="bi bi-sun"></i> Cambiar tema';
        });
    </script>
</body>
</html>

============================================================


===== detalle_reserva.html =====
<!DOCTYPE html>
<html lang="es" data-bs-theme="auto">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Reserva - Sistema de Reservas</title>
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        :root {
            --primary-color: #2563eb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --purple-color: #8b5cf6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-card: #ffffff;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        [data-bs-theme="dark"] {
            --primary-color: #3b82f6;
            --success-color: #34d399;
            --warning-color: #fbbf24;
            --danger-color: #f87171;
            --purple-color: #a78bfa;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-card: #1f2937;
            --border-color: #374151;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: absolute;
            top: 24px;
            right: 24px;
            z-index: 100;
        }

        .theme-toggle-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .theme-toggle-btn:hover {
            transform: scale(1.1);
            border-color: var(--primary-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        /* Header */
        .header {
            background: var(--bg-card);
            padding: 28px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            border: 1px solid var(--border-color);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
            flex: 1;
        }

        .status-badge {
            padding: 14px 28px;
            border-radius: 30px;
            font-weight: 700;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 2px solid;
        }

        .status-approved { 
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.2));
            color: var(--success-color);
            border-color: var(--success-color);
        }

        .status-pending { 
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.2));
            color: var(--warning-color);
            border-color: var(--warning-color);
        }

        .status-rejected { 
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.2));
            color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .status-cancelled { 
            background: linear-gradient(135deg, rgba(107, 114, 128, 0.1), rgba(107, 114, 128, 0.2));
            color: var(--text-secondary);
            border-color: var(--text-secondary);
        }

        .reservation-id {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-secondary);
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid var(--border-color);
        }

        .action-buttons {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            font-size: 15px;
            min-width: 160px;
            justify-content: center;
        }

        .btn-danger { 
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.2);
        }

        .btn-primary { 
            background: linear-gradient(135deg, var(--primary-color), #1d4ed8);
            color: white;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2);
        }

        .btn-secondary { 
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-success { 
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-4px);
        }

        .card h3 {
            font-size: 20px;
            margin-bottom: 24px;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .space-image {
            width: 100%;
            height: 220px;
            background: linear-gradient(135deg, var(--primary-color), var(--purple-color));
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 64px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .space-info h4 {
            font-size: 22px;
            margin-bottom: 12px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .space-description {
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.7;
            font-size: 15px;
        }

        .info-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 16px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-icon {
            width: 24px;
            height: 24px;
            margin-right: 16px;
            color: var(--primary-color);
            font-size: 18px;
            flex-shrink: 0;
        }

        .info-label {
            font-weight: 600;
            color: var(--text-primary);
            min-width: 140px;
            font-size: 15px;
        }

        .info-value {
            color: var(--text-secondary);
            flex: 1;
            text-align: right;
            font-size: 15px;
        }

        /* Timeline */
        .timeline-card {
            grid-column: 1 / -1;
        }

        .timeline {
            position: relative;
            padding-left: 40px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 16px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, var(--primary-color), var(--success-color));
            border-radius: 3px;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 32px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -36px;
            top: 8px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 4px solid var(--primary-color);
            z-index: 2;
        }

        .timeline-item.completed::before {
            background: var(--success-color);
            border-color: var(--success-color);
        }

        .timeline-content {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .timeline-content.completed {
            border-left-color: var(--success-color);
        }

        .timeline-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .timeline-date {
            color: var(--text-secondary);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Observaciones */
        .observations {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
            padding: 24px;
            border-radius: 12px;
            border-left: 4px solid var(--warning-color);
            margin-top: 24px;
        }

        .observations h4 {
            color: var(--warning-color);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 17px;
        }

        .observations p {
            color: var(--text-primary);
            line-height: 1.7;
            font-size: 15px;
        }

        /* Notes Section */
        .notes-section {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 2px solid var(--border-color);
        }

        .notes-section h4 {
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 17px;
        }

        .notes-section textarea {
            width: 100%;
            min-height: 120px;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-family: inherit;
            resize: vertical;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 15px;
            transition: border-color 0.3s ease;
        }

        .notes-section textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .save-notes {
            margin-top: 16px;
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 14px;
            min-width: auto;
        }

        /* Modal de confirmaci√≥n */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--bg-card);
            padding: 40px;
            border-radius: 18px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid var(--border-color);
            animation: modalSlideIn 0.4s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-content h3 {
            font-size: 24px;
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .modal-content p {
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 16px;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 24px;
        }

        /* Loading */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Alertas */
        .alert {
            padding: 18px 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: none;
            border: 2px solid transparent;
            font-weight: 500;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-success {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border-color: #10b981;
        }

        .alert-error {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #dc2626;
            border-color: #ef4444;
        }

        /* Detail Highlight */
        .detail-highlight {
            background: linear-gradient(135deg, var(--primary-color), var(--purple-color));
            color: white;
            padding: 6px 14px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .header {
                flex-direction: column;
                align-items: stretch;
                padding: 20px;
            }
            
            .header-left {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            
            .action-buttons {
                justify-content: stretch;
            }
            
            .btn {
                min-width: 100%;
            }
            
            .card {
                padding: 20px;
            }
            
            .modal-content {
                padding: 24px;
            }
        }

        @media (max-width: 480px) {
            .theme-toggle {
                top: 16px;
                right: 16px;
            }
            
            .theme-toggle-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            .status-badge {
                padding: 12px 20px;
                font-size: 14px;
            }
            
            .info-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .info-label {
                min-width: auto;
            }
            
            .info-value {
                text-align: left;
            }
        }

        /* Equipment Tags */
        .equipment-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 12px;
        }

        .equipment-tag {
            background: var(--bg-secondary);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Fecha de revisi√≥n */
        .revision-info {
            margin-top: 20px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 10px;
            border-left: 4px solid var(--primary-color);
        }

        .revision-info p {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* No se puede cancelar mensaje */
        .cannot-cancel {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 10px;
            text-align: center;
            margin-top: 16px;
            border: 2px solid var(--border-color);
        }

        .cannot-cancel p {
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <div class="theme-toggle">
        <button class="theme-toggle-btn" id="themeToggle">
            <i class="bi bi-moon-stars"></i>
        </button>
    </div>

    <div class="container">
        <!-- Alertas -->
        <div class="alert alert-success" id="successAlert"></div>
        <div class="alert alert-error" id="errorAlert"></div>

        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="status-badge" id="statusBadge">
                    <i class="bi bi-clock"></i>
                    <span id="statusText">{{ reserva.estado|upper }}</span>
                </div>
                <div class="reservation-id">
                    <i class="bi bi-tag"></i>
                    ID: <span id="reservationId">RES-{{ reserva.id }}</span>
                </div>
            </div>
            <div class="action-buttons">
                {% if reserva.estado == 'Pendiente' or reserva.estado == 'Aprobada' %}
                <button class="btn btn-danger" onclick="cancelarReserva()" id="cancelBtn">
                    <i class="bi bi-x-circle"></i>
                    Cancelar Reserva
                </button>
                {% else %}
                <div class="cannot-cancel">
                    <p>
                        <i class="bi bi-info-circle"></i>
                        Esta reserva no se puede cancelar
                    </p>
                </div>
                {% endif %}
                <button class="btn btn-success" onclick="duplicarReserva()" id="duplicateBtn" 
                        {% if reserva.estado == 'Cancelada' %}disabled{% endif %}>
                    <i class="bi bi-files"></i>
                    Duplicar
                </button>
                <button class="btn btn-secondary" onclick="imprimirReserva()" id="printBtn">
                    <i class="bi bi-printer"></i>
                    Imprimir
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Informaci√≥n del Espacio -->
            <div class="card">
                <h3>
                    <i class="bi bi-building"></i>
                    Informaci√≥n del Espacio
                </h3>
                <div class="space-image">
                    {% if reserva.espacio.tipo == 'Sala de Reuniones' %}
                        <i class="bi bi-building"></i>
                    {% elif reserva.espacio.tipo == 'Auditorio' %}
                        <i class="bi bi-cast"></i>
                    {% elif reserva.espacio.tipo == 'Laboratorio' %}
                        <i class="bi bi-flask"></i>
                    {% elif reserva.espacio.tipo == 'Oficina' %}
                        <i class="bi bi-briefcase"></i>
                    {% elif reserva.espacio.tipo == 'Aula' %}
                        <i class="bi bi-mortarboard"></i>
                    {% else %}
                        <i class="bi bi-building"></i>
                    {% endif %}
                </div>
                <div class="space-info">
                    <h4>
                        <i class="bi bi-building-fill"></i>
                        <span id="spaceName">{{ reserva.espacio.nombre }}</span>
                    </h4>
                    <p class="space-description" id="spaceDescription">
                        {% if reserva.espacio.descripcion %}
                            {{ reserva.espacio.descripcion }}
                        {% else %}
                            Espacio disponible para reuniones y eventos.
                        {% endif %}
                    </p>
                    
                    <div class="info-item">
                        <div class="info-icon">
                            <i class="bi bi-geo-alt"></i>
                        </div>
                        <div class="info-label">Ubicaci√≥n:</div>
                        <div class="info-value" id="spaceLocation">
                            {% if reserva.espacio.edificio and reserva.espacio.piso %}
                                <i class="bi bi-building"></i>
                                {{ reserva.espacio.edificio }}, Piso {{ reserva.espacio.piso }}
                            {% elif reserva.espacio.edificio %}
                                <i class="bi bi-building"></i>
                                {{ reserva.espacio.edificio }}
                            {% else %}
                                <i class="bi bi-building"></i>
                                Edificio Principal
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-icon">
                            <i class="bi bi-people"></i>
                        </div>
                        <div class="info-label">Capacidad:</div>
                        <div class="info-value detail-highlight" id="spaceCapacity">
                            <i class="bi bi-person-fill"></i>
                            {{ reserva.espacio.capacidad }} personas
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-icon">
                            <i class="bi bi-tools"></i>
                        </div>
                        <div class="info-label">Equipamiento:</div>
                        <div class="info-value" id="spaceEquipment">
                            {% if reserva.espacio.equipamientos.all %}
                                <div class="equipment-tags">
                                    {% for equipamiento in reserva.espacio.equipamientos.all %}
                                        <span class="equipment-tag">
                                            <i class="bi bi-check-circle"></i>
                                            {{ equipamiento.nombre_equipo }}
                                        </span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <i class="bi bi-tools"></i>
                                Equipamiento b√°sico
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informaci√≥n Temporal y Detalles -->
            <div class="card">
                <h3>
                    <i class="bi bi-calendar-event"></i>
                    Detalles de la Reserva
                </h3>
                
                <div style="margin-bottom: 24px;">
                    <h4 style="color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
                        <i class="bi bi-clock-history"></i>
                        Informaci√≥n Temporal
                    </h4>
                    <div class="info-item">
                        <div class="info-icon">
                            <i class="bi bi-calendar-date"></i>
                        </div>
                        <div class="info-label">Fecha:</div>
                        <div class="info-value detail-highlight" id="reservationDate">
                            <i class="bi bi-calendar3"></i>
                            {{ reserva.fecha_reserva|date:"l, d F Y" }}
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-icon">
                            <i class="bi bi-clock"></i>
                        </div>
                        <div class="info-label">Hora:</div>
                        <div class="info-value detail-highlight" id="reservationTime">
                            <i class="bi bi-clock-history"></i>
                            {{ reserva.hora_inicio|time:"H:i" }} - {{ reserva.hora_fin|time:"H:i" }}
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-icon">
                            <i class="bi bi-hourglass-split"></i>
                        </div>
                        <div class="info-label">Duraci√≥n:</div>
                        <div class="info-value" id="reservationDuration">
                            <i class="bi bi-hourglass-top"></i>
                            {{ duracion_horas }} horas
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 style="color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
                        <i class="bi bi-info-circle"></i>
                        Detalles Adicionales
                    </h4>
                    <div class="info-item">
                        <div class="info-icon">
                            <i class="bi bi-bullseye"></i>
                        </div>
                        <div class="info-label">Prop√≥sito:</div>
                        <div class="info-value" id="reservationPurpose">
                            <i class="bi bi-chat-left-text"></i>
                            {{ reserva.proposito }}
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-icon">
                            <i class="bi bi-people-fill"></i>
                        </div>
                        <div class="info-label">Asistentes:</div>
                        <div class="info-value" id="reservationAttendees">
                            <i class="bi bi-person-arms-up"></i>
                            {{ reserva.num_asistentes }} personas
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-icon">
                            <i class="bi bi-person-circle"></i>
                        </div>
                        <div class="info-label">Solicitante:</div>
                        <div class="info-value" id="reservationUser">
                            <div>
                                <strong>
                                    <i class="bi bi-person-badge"></i>
                                    {% if user.first_name and user.last_name %}
                                        {{ user.first_name }} {{ user.last_name }}
                                    {% else %}
                                        {{ user.username }}
                                    {% endif %}
                                </strong><br>
                                <small style="color: var(--text-secondary);">
                                    <i class="bi bi-envelope"></i> {{ user.email }}<br>
                                    <i class="bi bi-person-check"></i> {{ user.rol|default:"Usuario" }}
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-icon">
                            <i class="bi bi-calendar-plus"></i>
                        </div>
                        <div class="info-label">Solicitado:</div>
                        <div class="info-value" id="requestDate">
                            <i class="bi bi-clock-history"></i>
                            {{ reserva.fecha_solicitud|date:"d F, H:i" }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timeline de Estados -->
        <div class="card timeline-card">
            <h3>
                <i class="bi bi-timeline"></i>
                Timeline de Estados
            </h3>
            <div class="timeline">
                <div class="timeline-item completed">
                    <div class="timeline-content completed">
                        <div class="timeline-title">
                            <i class="bi bi-check-circle-fill"></i>
                            Solicitud Enviada
                        </div>
                        <div class="timeline-date">
                            <i class="bi bi-clock"></i>
                            {{ reserva.fecha_solicitud|date:"d F, H:i" }}
                        </div>
                    </div>
                </div>
                
                {% if reserva.estado != 'Pendiente' %}
                <div class="timeline-item completed">
                    <div class="timeline-content completed">
                        <div class="timeline-title">
                            {% if reserva.estado == 'Aprobada' %}
                                <i class="bi bi-check-circle-fill"></i>
                                Aprobada
                            {% elif reserva.estado == 'Rechazada' %}
                                <i class="bi bi-x-circle-fill"></i>
                                Rechazada
                            {% elif reserva.estado == 'Cancelada' %}
                                <i class="bi bi-slash-circle-fill"></i>
                                Cancelada
                            {% endif %}
                        </div>
                        <div class="timeline-date">
                            <i class="bi bi-person-check"></i>
                            {% if reserva.id_aprobador %}
                                Por: 
                                {% if reserva.id_aprobador.first_name and reserva.id_aprobador.last_name %}
                                    {{ reserva.id_aprobador.first_name }} {{ reserva.id_aprobador.last_name }}
                                {% else %}
                                    {{ reserva.id_aprobador.username }}
                                {% endif %}
                            {% else %}
                                Procesada por el sistema
                            {% endif %}
                            <br>
                            <small>
                                <i class="bi bi-clock"></i>
                                {% if reserva.fecha_revision %}
                                    {{ reserva.fecha_revision|date:"d F, H:i" }}
                                {% else %}
                                    Fecha no disponible
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
                
                {% if reserva.comentario_admin %}
                <div class="revision-info">
                    <p>
                        <i class="bi bi-chat-left-quote"></i>
                        <strong>Comentario:</strong> {{ reserva.comentario_admin }}
                    </p>
                </div>
                {% endif %}
                
                {% endif %}
            </div>
            
            <!-- Observaciones -->
            {% if reserva.observaciones %}
            <div class="observations">
                <h4>
                    <i class="bi bi-chat-left-quote"></i>
                    Observaciones del Usuario
                </h4>
                <p id="adminComments">
                    <i class="bi bi-quote" style="float: left; margin-right: 10px; font-size: 24px; color: var(--warning-color);"></i>
                    {{ reserva.observaciones }}
                </p>
            </div>
            {% endif %}
            
            <div class="notes-section">
                <h4>
                    <i class="bi bi-journal-text"></i>
                    Notas del Usuario
                </h4>
                <textarea placeholder="Agregar notas personales sobre esta reserva..." id="userNotes"></textarea>
                <div class="save-notes">
                    <button class="btn btn-primary btn-small" onclick="guardarNotas()">
                        <i class="bi bi-save"></i>
                        Guardar Notas
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n -->
    <div class="modal" id="confirmationModal">
        <div class="modal-content">
            <h3 id="modalTitle">
                <i class="bi bi-question-circle"></i>
                Confirmar Acci√≥n
            </h3>
            <p id="modalMessage">¬øEst√°s seguro de que deseas realizar esta acci√≥n?</p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="cerrarModal()">
                    <i class="bi bi-x-circle"></i>
                    Cancelar
                </button>
                <button class="btn btn-primary" id="confirmActionBtn">
                    <i class="bi bi-check-circle"></i>
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Theme Toggle Functionality
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = themeToggle.querySelector('i');
        
        function setTheme(theme) {
            document.documentElement.setAttribute('data-bs-theme', theme);
            localStorage.setItem('theme', theme);
            updateThemeIcon(theme);
        }
        
        function updateThemeIcon(theme) {
            if (theme === 'dark') {
                themeIcon.className = 'bi bi-sun';
            } else {
                themeIcon.className = 'bi bi-moon-stars';
            }
        }
        
        // Load saved theme or detect system preference
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme) {
                setTheme(savedTheme);
            } else if (prefersDark) {
                setTheme('dark');
            } else {
                setTheme('light');
            }
        }
        
        // Initialize theme on page load
        document.addEventListener('DOMContentLoaded', initTheme);
        
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        });

        // Datos de la reserva desde Django - USANDO JSON SCRIPT
        // Primero, actualizar el estado visualmente
        document.addEventListener('DOMContentLoaded', function() {
            actualizarEstadoBotones();
            cargarNotasGuardadas();
        });

        function actualizarEstadoBotones() {
            const statusBadge = document.getElementById('statusBadge');
            const statusText = document.getElementById('statusText');
            
            if (!statusBadge || !statusText) return;
            
            const estado = "{{ reserva.estado }}".toLowerCase();
            
            // Actualizar badge de estado
            statusBadge.className = 'status-badge ';
            let badgeIcon = 'bi bi-clock';
            
            switch(estado) {
                case 'aprobada':
                    statusBadge.classList.add('status-approved');
                    badgeIcon = 'bi bi-check-circle';
                    statusText.textContent = 'APROBADA';
                    break;
                case 'pendiente':
                    statusBadge.classList.add('status-pending');
                    badgeIcon = 'bi bi-clock-history';
                    statusText.textContent = 'PENDIENTE';
                    break;
                case 'rechazada':
                    statusBadge.classList.add('status-rejected');
                    badgeIcon = 'bi bi-x-circle';
                    statusText.textContent = 'RECHAZADA';
                    break;
                case 'cancelada':
                    statusBadge.classList.add('status-cancelled');
                    badgeIcon = 'bi bi-slash-circle';
                    statusText.textContent = 'CANCELADA';
                    break;
                default:
                    statusText.textContent = "{{ reserva.estado|upper }}";
            }

            // Actualizar icono
            const existingIcon = statusBadge.querySelector('i');
            if (existingIcon) {
                existingIcon.className = badgeIcon;
            }
        }

        // Funci√≥n para obtener el token CSRF
        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Funci√≥n para mostrar alertas
        function mostrarAlerta(mensaje, tipo = 'success') {
            const alert = document.getElementById(tipo === 'success' ? 'successAlert' : 'errorAlert');
            const icon = tipo === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-triangle-fill';
            
            alert.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i class="bi ${icon}" style="font-size: 20px;"></i>
                    <span>${mensaje}</span>
                </div>
            `;
            alert.className = `alert alert-${tipo}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        // Funci√≥n para mostrar modal de confirmaci√≥n
        function mostrarModal(titulo, mensaje, callback) {
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const confirmBtn = document.getElementById('confirmActionBtn');
            
            if (modalTitle && modalMessage && confirmBtn) {
                modalTitle.innerHTML = `
                    <i class="bi bi-exclamation-triangle"></i>
                    ${titulo}
                `;
                modalMessage.textContent = mensaje;
                confirmBtn.onclick = callback;
                
                document.getElementById('confirmationModal').style.display = 'flex';
            }
        }

        function cerrarModal() {
            const modal = document.getElementById('confirmationModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Funci√≥n para cancelar reserva
        function cancelarReserva() {
            const estado = "{{ reserva.estado }}".toLowerCase();
            
            if (estado === 'cancelada') {
                mostrarAlerta('Esta reserva ya est√° cancelada.', 'error');
                return;
            }

            if (estado === 'rechazada') {
                mostrarAlerta('No se puede cancelar una reserva rechazada.', 'error');
                return;
            }

            mostrarModal(
                'Cancelar Reserva',
                '¬øEst√°s seguro de que deseas cancelar esta reserva? Esta acci√≥n no se puede deshacer.',
                function() {
                    realizarCancelacion();
                }
            );
        }

        async function realizarCancelacion() {
            try {
                const reservaId = {{ reserva.id }};
                const cancelBtn = document.getElementById('cancelBtn');
                
                if (!cancelBtn) return;
                
                // Mostrar loading
                document.body.classList.add('loading');
                const originalContent = cancelBtn.innerHTML;
                cancelBtn.innerHTML = '<div class="spinner"></div> Cancelando...';
                cancelBtn.disabled = true;

                // Llamar a la API de cancelaci√≥n
                const response = await fetch(`/api/reservas/${reservaId}/cancelar/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    }
                });

                const data = await response.json();

                if (data.success) {
                    mostrarAlerta('‚úÖ Reserva cancelada exitosamente');
                    cerrarModal();
                    
                    // Recargar la p√°gina despu√©s de 2 segundos para mostrar cambios
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    throw new Error(data.error || data.detail || 'Error al cancelar la reserva');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta(`‚ùå Error al cancelar la reserva: ${error.message}`, 'error');
                
                // Restaurar bot√≥n
                const cancelBtn = document.getElementById('cancelBtn');
                if (cancelBtn) {
                    cancelBtn.innerHTML = originalContent;
                    cancelBtn.disabled = false;
                }
            } finally {
                document.body.classList.remove('loading');
                cerrarModal();
            }
        }

        // Funci√≥n para duplicar reserva
        function duplicarReserva() {
            const estado = "{{ reserva.estado }}".toLowerCase();
            
            if (estado === 'cancelada') {
                mostrarAlerta('No se puede duplicar una reserva cancelada.', 'error');
                return;
            }

            const espacioId = {{ reserva.espacio.id }};
            const reservaId = {{ reserva.id }};
            
            // Redirigir a la p√°gina de crear reserva con los datos prellenados
            const params = new URLSearchParams({
                espacio_id: espacioId,
                duplicar: reservaId
            });
            
            window.location.href = `/crear-reserva/?${params}`;
        }

        // Funci√≥n para imprimir reserva - SIMPLIFICADA
        function imprimirReserva() {
            // Usar una funci√≥n simple de impresi√≥n
            window.print();
        }

        // Funci√≥n para guardar notas
        function guardarNotas() {
            const notas = document.getElementById('userNotes').value;
            const reservaId = {{ reserva.id }};
            
            // Guardar en localStorage
            localStorage.setItem(`notas_reserva_${reservaId}`, notas);
            mostrarAlerta('‚úÖ Notas guardadas correctamente');
        }

        // Cargar notas guardadas
        function cargarNotasGuardadas() {
            const reservaId = {{ reserva.id }};
            const notasGuardadas = localStorage.getItem(`notas_reserva_${reservaId}`);
            const userNotes = document.getElementById('userNotes');
            
            if (notasGuardadas && userNotes) {
                userNotes.value = notasGuardadas;
            }
        }

        // Cerrar modal al hacer clic fuera
        const confirmationModal = document.getElementById('confirmationModal');
        if (confirmationModal) {
            confirmationModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    cerrarModal();
                }
            });
        }

        // Cerrar modal con ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                cerrarModal();
            }
        });
    </script>
</body>
</html>
============================================================


===== editar_espacio.html =====
<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Espacio - Sistema de Reservas</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        :root {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
        }

        [data-bs-theme="dark"] {
            --bg-primary: #212529;
            --bg-secondary: #343a40;
            --text-primary: #f8f9fa;
            --text-secondary: #adb5bd;
            --border-color: #495057;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #0d6efd;
            text-decoration: none;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .form-control, .form-select, .form-textarea {
            background-color: var(--bg-secondary);
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        .form-control:focus, .form-select:focus, .form-textarea:focus {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        h1 {
            text-align: center;
            margin-bottom: 24px;
            color: var(--text-primary);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        [data-bs-theme="dark"] .alert-success {
            background: #0f5132;
            color: #75b798;
            border-color: #146c43;
        }

        [data-bs-theme="dark"] .alert-error {
            background: #842029;
            color: #ea868f;
            border-color: #58151c;
        }

        [data-bs-theme="dark"] .back-link {
            color: #6ea8fe;
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <div class="theme-toggle" id="themeToggle">
        <i class="bi bi-sun" id="themeIcon"></i>
    </div>

    <a href="{% url 'gestion_espacios' %}" class="back-link">
        <i class="bi bi-arrow-left"></i> Volver a Gesti√≥n de Espacios
    </a>

    <div class="container">
        <h1><i class="bi bi-pencil-square me-2"></i> Editar Espacio</h1>

        <div id="alertMessage" class="alert"></div>
        <div id="loadingMessage" class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3">Cargando datos del espacio...</p>
        </div>

        <form id="editSpaceForm" style="display: none;">
            <input type="hidden" id="espacio_id" name="espacio_id">
            
            <div class="mb-3">
                <label for="nombre" class="form-label">
                    <i class="bi bi-building me-1"></i> Nombre del Espacio *
                </label>
                <input type="text" class="form-control" id="nombre" name="nombre" required>
            </div>
            
            <div class="mb-3">
                <label for="tipo" class="form-label">
                    <i class="bi bi-tags me-1"></i> Tipo de Espacio *
                </label>
                <select class="form-select" id="tipo" name="tipo" required>
                    <option value="">Seleccionar tipo...</option>
                    <option value="Sala de Reuniones">Sala de Reuniones</option>
                    <option value="Auditorio">Auditorio</option>
                    <option value="Laboratorio">Laboratorio</option>
                    <option value="Oficina">Oficina</option>
                    <option value="Aula">Aula</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label for="capacidad" class="form-label">
                    <i class="bi bi-people me-1"></i> Capacidad *
                </label>
                <input type="number" class="form-control" id="capacidad" name="capacidad" min="1" required>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="edificio" class="form-label">
                        <i class="bi bi-house me-1"></i> Edificio
                    </label>
                    <input type="text" class="form-control" id="edificio" name="edificio">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="piso" class="form-label">
                        <i class="bi bi-stairs me-1"></i> Piso
                    </label>
                    <input type="number" class="form-control" id="piso" name="piso" min="0">
                </div>
            </div>
            
            <div class="mb-3">
                <label for="descripcion" class="form-label">
                    <i class="bi bi-card-text me-1"></i> Descripci√≥n
                </label>
                <textarea class="form-control" id="descripcion" name="descripcion" rows="3"></textarea>
            </div>
            
            <div class="mb-4">
                <label for="estado" class="form-label">
                    <i class="bi bi-circle-fill me-1"></i> Estado
                </label>
                <select class="form-select" id="estado" name="estado">
                    <option value="Disponible">Disponible</option>
                    <option value="Mantenimiento">Mantenimiento</option>
                    <option value="Fuera de Servicio">Fuera de Servicio</option>
                </select>
            </div>
            
            <div class="d-flex gap-2 justify-content-end">
                <a href="{% url 'gestion_espacios' %}" class="btn btn-secondary">
                    <i class="bi bi-x-circle me-1"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle me-1"></i> Actualizar Espacio
                </button>
            </div>
        </form>
    </div>

    <script>
        // Theme Toggle
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            const html = document.documentElement;
            
            // Check saved theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            html.setAttribute('data-bs-theme', savedTheme);
            updateThemeIcon(savedTheme);
            
            themeToggle.addEventListener('click', function() {
                const currentTheme = html.getAttribute('data-bs-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                
                html.setAttribute('data-bs-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
            });
            
            function updateThemeIcon(theme) {
                if (theme === 'dark') {
                    themeIcon.className = 'bi bi-moon';
                } else {
                    themeIcon.className = 'bi bi-sun';
                }
            }
        });

        // Resto del c√≥digo JavaScript existente (sin cambios)
        function showAlert(message, type) {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.innerHTML = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            setTimeout(() => { alertDiv.style.display = 'none'; }, 5000);
        }

        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Cargar datos del espacio al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const espacioId = urlParams.get('id');
            
            console.log('üîç ID del espacio:', espacioId);
            
            if (!espacioId) {
                showAlert('<i class="bi bi-exclamation-triangle me-1"></i> ID de espacio no especificado', 'error');
                return;
            }

            try {
                console.log('üì§ Solicitando datos del espacio...');
                const response = await fetch(`/api/espacios/${espacioId}/`);
                const data = await response.json();
                
                console.log('üì• Respuesta recibida:', data);

                if (data.success) {
                    document.getElementById('espacio_id').value = data.espacio.id;
                    document.getElementById('nombre').value = data.espacio.nombre;
                    document.getElementById('tipo').value = data.espacio.tipo;
                    document.getElementById('capacidad').value = data.espacio.capacidad;
                    document.getElementById('edificio').value = data.espacio.edificio || '';
                    document.getElementById('piso').value = data.espacio.piso || '';
                    document.getElementById('descripcion').value = data.espacio.descripcion || '';
                    document.getElementById('estado').value = data.espacio.estado;
                    
                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('editSpaceForm').style.display = 'block';
                    console.log('‚úÖ Formulario cargado correctamente');
                } else {
                    const errorMsg = data.error || 'Error desconocido';
                    showAlert('<i class="bi bi-exclamation-triangle me-1"></i> Error al cargar el espacio: ' + errorMsg, 'error');
                    console.error('Error detallado:', data);
                }
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n:', error);
                showAlert('<i class="bi bi-exclamation-triangle me-1"></i> Error de conexi√≥n al cargar el espacio: ' + error.message, 'error');
            }
        });

        // Form submission para editar
        document.getElementById('editSpaceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Actualizando...';
            submitBtn.disabled = true;
            
            const espacioId = document.getElementById('espacio_id').value;
            const formData = {
                nombre: document.getElementById('nombre').value,
                tipo: document.getElementById('tipo').value,
                capacidad: document.getElementById('capacidad').value,
                edificio: document.getElementById('edificio').value,
                piso: document.getElementById('piso').value,
                descripcion: document.getElementById('descripcion').value,
                estado: document.getElementById('estado').value
            };

            console.log('üì§ Actualizando espacio ID:', espacioId);
            console.log('üì§ Datos a enviar:', formData);

            try {
                const response = await fetch(`/api/espacios/${espacioId}/actualizar/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                console.log('üì• Respuesta recibida:', data);

                if (data.success) {
                    showAlert('<i class="bi bi-check-circle me-1"></i> ' + data.message, 'success');
                    setTimeout(() => {
                        window.location.href = "{% url 'gestion_espacios' %}";
                    }, 1500);
                } else {
                    const errorMsg = data.error || 'Error desconocido';
                    showAlert('<i class="bi bi-exclamation-triangle me-1"></i> Error: ' + errorMsg, 'error');
                    console.error('Error detallado:', data);
                }
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n:', error);
                showAlert('<i class="bi bi-exclamation-triangle me-1"></i> Error de conexi√≥n: ' + error.message, 'error');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
============================================================


===== editar_usuario.html =====
<!DOCTYPE html>
<html lang="es" data-bs-theme="auto">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Usuario - Sistema de Reservas</title>
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        :root {
            --primary-color: #2563eb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-card: #ffffff;
            --border-color: #e5e7eb;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        [data-bs-theme="dark"] {
            --primary-color: #3b82f6;
            --success-color: #34d399;
            --warning-color: #fbbf24;
            --danger-color: #f87171;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-card: #1f2937;
            --border-color: #374151;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .theme-toggle-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .theme-toggle-btn:hover {
            transform: scale(1.1);
            border-color: var(--primary-color);
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            background: var(--bg-card);
            padding: 40px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        h1 {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 30px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--primary-color);
            text-decoration: none;
            margin-bottom: 24px;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: var(--bg-secondary);
            text-decoration: none;
            transform: translateX(-4px);
        }

        .form-group {
            margin-bottom: 24px;
            position: relative;
        }

        .form-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 15px;
        }

        .form-label i {
            color: var(--primary-color);
            font-size: 16px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            padding-left: 44px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-input:read-only {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .input-icon {
            position: absolute;
            left: 16px;
            top: 42px;
            color: var(--text-secondary);
            font-size: 18px;
        }

        .form-input:focus + .input-icon {
            color: var(--primary-color);
        }

        .user-info-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            position: relative;
            overflow: hidden;
        }

        .user-info-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary-color), var(--success-color));
        }

        .user-info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .user-info-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .info-label {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-value {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 15px;
            background: var(--bg-primary);
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .form-actions {
            display: flex;
            gap: 16px;
            justify-content: flex-end;
            margin-top: 40px;
            padding-top: 24px;
            border-top: 2px solid var(--border-color);
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 15px;
            min-width: 140px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
            transform: translateY(-2px);
        }

        .alert {
            padding: 16px 20px;
            border-radius: 10px;
            margin-bottom: 24px;
            display: none;
            border: 2px solid transparent;
            font-weight: 500;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-success {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border-color: #10b981;
        }

        .alert-error {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #dc2626;
            border-color: #ef4444;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            border-color: #f59e0b;
        }

        /* Estilos para select personalizado */
        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-chevron-down' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 16px;
            padding-right: 48px;
        }

        /* Badge para estado */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border: 2px solid #10b981;
        }

        .status-inactive {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #dc2626;
            border: 2px solid #ef4444;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 24px;
                margin-top: 40px;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                min-width: auto;
            }
            
            h1 {
                font-size: 28px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 12px;
            }
            
            .container {
                padding: 20px;
            }
            
            .user-info-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .info-value {
                align-self: stretch;
                text-align: center;
            }
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Card header */
        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        .card-header i {
            font-size: 24px;
            color: var(--primary-color);
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 12px;
        }
    </style>
</head>
<body>
    <!-- Theme Toggle Button -->
    <div class="theme-toggle">
        <button class="theme-toggle-btn" id="themeToggle">
            <i class="bi bi-moon-stars"></i>
        </button>
    </div>

    <a href="{% url 'gestion_usuarios' %}" class="back-link">
        <i class="bi bi-arrow-left"></i>
        Volver a Gesti√≥n de Usuarios
    </a>

    <div class="container">
        <div class="card-header">
            <i class="bi bi-person-gear"></i>
            <h1>Editar Usuario</h1>
        </div>

        <div id="alertMessage" class="alert"></div>

        <!-- Informaci√≥n del usuario (solo lectura) -->
        <div class="user-info-card">
            <div class="user-info-item">
                <span class="info-label">
                    <i class="bi bi-person-badge"></i>
                    Usuario ID:
                </span>
                <span class="info-value" id="userId">Cargando...</span>
            </div>
            <div class="user-info-item">
                <span class="info-label">
                    <i class="bi bi-person-circle"></i>
                    Username:
                </span>
                <span class="info-value" id="userUsername">Cargando...</span>
            </div>
            <div class="user-info-item">
                <span class="info-label">
                    <i class="bi bi-calendar-check"></i>
                    Fecha de registro:
                </span>
                <span class="info-value" id="userDateJoined">Cargando...</span>
            </div>
            <div class="user-info-item">
                <span class="info-label">
                    <i class="bi bi-info-circle"></i>
                    Estado actual:
                </span>
                <span class="info-value">
                    <span id="currentStatus" class="status-badge status-active">Activo</span>
                </span>
            </div>
        </div>

        <form id="editUserForm">
            <!-- Campos editables -->
            <div class="form-group">
                <label class="form-label">
                    <i class="bi bi-person"></i>
                    Nombre *
                </label>
                <div class="input-icon">
                    <i class="bi bi-person"></i>
                </div>
                <input type="text" class="form-input" id="first_name" name="first_name" required 
                       placeholder="Ingresa el nombre del usuario">
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <i class="bi bi-person"></i>
                    Apellido *
                </label>
                <div class="input-icon">
                    <i class="bi bi-person"></i>
                </div>
                <input type="text" class="form-input" id="last_name" name="last_name" required 
                       placeholder="Ingresa el apellido del usuario">
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <i class="bi bi-envelope"></i>
                    Email *
                </label>
                <div class="input-icon">
                    <i class="bi bi-envelope"></i>
                </div>
                <input type="email" class="form-input" id="email" name="email" required 
                       placeholder="usuario@ejemplo.com">
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <i class="bi bi-person-badge"></i>
                    Rol *
                </label>
                <div class="input-icon">
                    <i class="bi bi-person-badge"></i>
                </div>
                <select class="form-select" id="rol" name="rol" required>
                    <option value="">Seleccionar rol...</option>
                    <option value="Usuario">Usuario</option>
                    <option value="Docente">Docente</option>
                    <option value="Investigacion">Investigaci√≥n</option>
                    <option value="Administrativo">Administrativo</option>
                    <option value="Aprobador">Aprobador</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <i class="bi bi-building"></i>
                    Departamento
                </label>
                <div class="input-icon">
                    <i class="bi bi-building"></i>
                </div>
                <input type="text" class="form-input" id="departamento" name="departamento" 
                       placeholder="Ingresa el departamento">
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <i class="bi bi-toggle-on"></i>
                    Estado
                </label>
                <div class="input-icon">
                    <i class="bi bi-toggle-on"></i>
                </div>
                <select class="form-select" id="is_active" name="is_active">
                    <option value="true">Activo</option>
                    <option value="false">Inactivo</option>
                </select>
            </div>
            
            <div class="form-actions">
                <a href="{% url 'gestion_usuarios' %}" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i>
                    Cancelar
                </a>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <i class="bi bi-check-circle"></i>
                    Guardar Cambios
                </button>
            </div>
        </form>
    </div>

    <script>
        // Theme Toggle Functionality
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = themeToggle.querySelector('i');
        
        function setTheme(theme) {
            document.documentElement.setAttribute('data-bs-theme', theme);
            localStorage.setItem('theme', theme);
            updateThemeIcon(theme);
        }
        
        function updateThemeIcon(theme) {
            if (theme === 'dark') {
                themeIcon.className = 'bi bi-sun';
            } else {
                themeIcon.className = 'bi bi-moon-stars';
            }
        }
        
        // Load saved theme or detect system preference
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            setTheme(savedTheme);
        } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            setTheme('dark');
        }
        
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-bs-theme');
            setTheme(currentTheme === 'dark' ? 'light' : 'dark');
        });

        // Obtener ID del usuario de la URL
        function getUserIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        function showAlert(message, type) {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            setTimeout(() => { 
                alertDiv.style.display = 'none'; 
            }, 5000);
        }

        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Cargar datos del usuario
        async function loadUserData() {
            const userId = getUserIdFromUrl();
            if (!userId) {
                showAlert('‚ùå No se especific√≥ ID de usuario', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/usuarios/${userId}/`);
                const data = await response.json();

                if (data.success) {
                    const user = data.usuario;
                    
                    // Formatear fecha
                    const formatDate = (dateString) => {
                        const date = new Date(dateString);
                        return date.toLocaleDateString('es-ES', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    };
                    
                    // Llenar campos de informaci√≥n (solo lectura)
                    document.getElementById('userId').textContent = user.id;
                    document.getElementById('userUsername').textContent = user.username;
                    document.getElementById('userDateJoined').textContent = formatDate(user.date_joined);
                    
                    // Actualizar badge de estado
                    const statusBadge = document.getElementById('currentStatus');
                    statusBadge.textContent = user.is_active ? 'Activo' : 'Inactivo';
                    statusBadge.className = `status-badge ${user.is_active ? 'status-active' : 'status-inactive'}`;
                    
                    // Llenar campos editables
                    document.getElementById('first_name').value = user.first_name || '';
                    document.getElementById('last_name').value = user.last_name || '';
                    document.getElementById('email').value = user.email || '';
                    document.getElementById('rol').value = user.rol || 'Usuario';
                    document.getElementById('departamento').value = user.departamento || '';
                    document.getElementById('is_active').value = user.is_active.toString();
                    
                    // Marcar campos como tocados para validaci√≥n visual
                    document.querySelectorAll('.form-input, .form-select').forEach(input => {
                        if (input.value) {
                            input.style.borderColor = 'var(--success-color)';
                        }
                    });
                    
                } else {
                    showAlert(`‚ùå ${data.error || 'Error al cargar datos del usuario'}`, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('‚ùå Error de conexi√≥n al cargar datos', 'error');
            }
        }

        // Validar email
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        // Form submission
        document.getElementById('editUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const userId = getUserIdFromUrl();
            if (!userId) {
                showAlert('‚ùå ID de usuario no v√°lido', 'error');
                return;
            }
            
            // Validar email
            const email = document.getElementById('email').value;
            if (!validateEmail(email)) {
                showAlert('‚ùå Por favor, ingresa un email v√°lido', 'error');
                document.getElementById('email').focus();
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const originalContent = submitBtn.innerHTML;
            submitBtn.innerHTML = '<div class="loading"></div> Guardando...';
            submitBtn.disabled = true;
            
            const formData = {
                first_name: document.getElementById('first_name').value.trim(),
                last_name: document.getElementById('last_name').value.trim(),
                email: email,
                rol: document.getElementById('rol').value,
                departamento: document.getElementById('departamento').value.trim(),
                is_active: document.getElementById('is_active').value === 'true'
            };

            // Validar campos requeridos
            if (!formData.first_name || !formData.last_name || !formData.email || !formData.rol) {
                showAlert('‚ùå Por favor, completa todos los campos requeridos', 'error');
                submitBtn.innerHTML = originalContent;
                submitBtn.disabled = false;
                return;
            }

            try {
                const response = await fetch(`/api/usuarios/${userId}/actualizar/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(`‚úÖ ${data.message || 'Usuario actualizado correctamente'}`, 'success');
                    
                    // Actualizar el badge de estado en tiempo real
                    const statusBadge = document.getElementById('currentStatus');
                    statusBadge.textContent = formData.is_active ? 'Activo' : 'Inactivo';
                    statusBadge.className = `status-badge ${formData.is_active ? 'status-active' : 'status-inactive'}`;
                    
                    // Redirigir despu√©s de 1.5 segundos
                    setTimeout(() => {
                        window.location.href = "{% url 'gestion_usuarios' %}";
                    }, 1500);
                } else {
                    const errorMsg = data.error || data.detail || 'Error desconocido al actualizar el usuario';
                    showAlert(`‚ùå ${errorMsg}`, 'error');
                }
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n:', error);
                showAlert(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            } finally {
                submitBtn.innerHTML = originalContent;
                submitBtn.disabled = false;
            }
        });

        // Validaci√≥n en tiempo real
        document.querySelectorAll('.form-input, .form-select').forEach(input => {
            input.addEventListener('blur', function() {
                if (this.value.trim()) {
                    this.style.borderColor = 'var(--success-color)';
                } else if (this.required) {
                    this.style.borderColor = 'var(--danger-color)';
                } else {
                    this.style.borderColor = 'var(--border-color)';
                }
            });

            input.addEventListener('input', function() {
                if (this.type === 'email' && this.value) {
                    if (validateEmail(this.value)) {
                        this.style.borderColor = 'var(--success-color)';
                    } else {
                        this.style.borderColor = 'var(--warning-color)';
                    }
                }
            });
        });

        // Cargar datos cuando la p√°gina est√© lista
        document.addEventListener('DOMContentLoaded', loadUserData);

        // Prevenir cierre con cambios no guardados
        let hasUnsavedChanges = false;

        document.querySelectorAll('#editUserForm input, #editUserForm select').forEach(element => {
            element.addEventListener('change', () => {
                hasUnsavedChanges = true;
            });
        });

        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Resetear hasUnsavedChanges al enviar el formulario
        document.getElementById('editUserForm').addEventListener('submit', () => {
            hasUnsavedChanges = false;
        });
    </script>
</body>
</html>
============================================================


===== espacios.html =====
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espacios Disponibles - Sistema de Reservas</title>
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        /* Variables CSS para temas */
        :root {
            --bg-primary: #f9fafb;
            --bg-secondary: white;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border-color: #e5e7eb;
            --accent-color: #2563eb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #dc2626;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .theme-dark {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-tertiary: #9ca3af;
            --border-color: #4b5563;
            --accent-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: var(--accent-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .nav-menu {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .nav-item {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .nav-item i {
            font-size: 16px;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--accent-color);
            color: white;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--success-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        /* Bot√≥n de tema */
        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            background: var(--bg-tertiary);
            color: var(--accent-color);
        }

        /* Main Content */
        .main-content {
            padding: 24px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title i {
            color: var(--accent-color);
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
        }

        /* Spaces Grid */
        .spaces-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 24px;
        }

        .space-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .space-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .space-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, var(--accent-color), #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
            position: relative;
        }

        .space-status {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.9);
        }

        .space-status.available {
            color: var(--success-color);
        }

        .space-status.maintenance {
            color: var(--warning-color);
        }

        .space-status.unavailable {
            color: var(--danger-color);
        }

        .space-content {
            padding: 20px;
        }

        .space-name {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .space-location {
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .space-details {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .space-detail {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .space-equipment {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .equipment-tag {
            background: var(--bg-tertiary);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .space-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            flex: 1;
            padding: 10px 16px;
            border: 2px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .action-btn:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .action-btn.primary {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .action-btn.primary:hover {
            background: #1d4ed8;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
            color: var(--text-tertiary);
        }

        .empty-state-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .empty-state-text {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 16px;
            }

            .spaces-grid {
                grid-template-columns: 1fr;
            }

            .space-details {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .space-actions {
                flex-direction: column;
            }

            .nav-menu {
                display: none;
            }
        }
    </style>
</head>
<body class="theme-light">
    <!-- Header -->
    <header class="header">
        <div class="logo-section">
            <div class="logo">
                <i class="bi bi-calendar-check"></i>
            </div>
            <div style="font-weight: 600; color: var(--text-primary);">Sistema de Reservas</div>
        </div>
        
        <nav class="nav-menu">
            <a href="{% url 'dashboard' %}" class="nav-item">
                <i class="bi bi-speedometer2"></i>
                Dashboard
            </a>
            <a href="{% url 'crear_reserva' %}" class="nav-item">
                <i class="bi bi-plus-circle"></i>
                Reservar
            </a>
            <a href="{% url 'reservas' %}" class="nav-item">
                <i class="bi bi-clock-history"></i>
                Historial
            </a>
            <a href="{% url 'calendario' %}" class="nav-item">
                <i class="bi bi-calendar-week"></i>
                Calendario
            </a>
            <a href="{% url 'espacios' %}" class="nav-item active">
                <i class="bi bi-building"></i>
                Espacios
            </a>
            <a href="{% url 'notificaciones' %}" class="nav-item">
                <i class="bi bi-bell"></i>
                Notificaciones
            </a>
        </nav>

        <div class="user-menu">
            <!-- Bot√≥n de cambio de tema -->
            <button class="theme-toggle" id="themeToggle" title="Cambiar tema">
                <i class="bi bi-moon" id="themeIcon"></i>
            </button>
            
            <div class="user-avatar">
                {% if user.first_name and user.last_name %}
                    {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                {% else %}
                    {{ user.username|first|upper }}
                {% endif %}
            </div>
            <span style="color: var(--text-primary);">
                {% if user.first_name %}
                    {{ user.first_name }}
                {% else %}
                    {{ user.username }}
                {% endif %}
            </span>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title">
                <i class="bi bi-building"></i>
                Espacios Disponibles
            </h1>
            <p class="page-subtitle">Explora y conoce todos los espacios disponibles para reservar</p>
        </div>

        <!-- Spaces Grid -->
        <div class="spaces-grid">
            {% for espacio in espacios %}
            <div class="space-card">
                <div class="space-image">
                    {% if espacio.tipo == 'Sala de Reuniones' %}
                        <i class="bi bi-buildings" style="font-size: 48px;"></i>
                    {% elif espacio.tipo == 'Auditorio' %}
                        <i class="bi bi-mic" style="font-size: 48px;"></i>
                    {% elif espacio.tipo == 'Laboratorio' %}
                        <i class="bi bi-thermometer" style="font-size: 48px;"></i>
                    {% elif espacio.tipo == 'Oficina' %}
                        <i class="bi bi-briefcase" style="font-size: 48px;"></i>
                    {% elif espacio.tipo == 'Aula' %}
                        <i class="bi bi-mortarboard" style="font-size: 48px;"></i>
                    {% else %}
                        <i class="bi bi-building" style="font-size: 48px;"></i>
                    {% endif %}
                    <div class="space-status available">
                        <i class="bi bi-check-circle"></i> Disponible
                    </div>
                </div>
                <div class="space-content">
                    <h3 class="space-name">{{ espacio.nombre }}</h3>
                    <div class="space-location">
                        <i class="bi bi-geo-alt"></i>
                        <span>
                            {% if espacio.edificio and espacio.piso %}
                                {{ espacio.edificio }}, Piso {{ espacio.piso }}
                            {% elif espacio.edificio %}
                                {{ espacio.edificio }}
                            {% else %}
                                Ubicaci√≥n no especificada
                            {% endif %}
                        </span>
                    </div>
                    
                    <div class="space-details">
                        <div class="space-detail">
                            <i class="bi bi-people"></i>
                            <span>{{ espacio.capacidad }} personas</span>
                        </div>
                        <div class="space-detail">
                            <i class="bi bi-tag"></i>
                            <span>{{ espacio.tipo }}</span>
                        </div>
                    </div>

                    {% if espacio.descripcion %}
                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 12px; line-height: 1.4;">
                        {{ espacio.descripcion }}
                    </p>
                    {% endif %}

                    <div class="space-equipment">
                        {% for equipamiento in espacio.equipamientos.all %}
                        <span class="equipment-tag">
                            <i class="bi bi-tools"></i> {{ equipamiento.nombre_equipo }}
                        </span>
                        {% empty %}
                        <span class="equipment-tag">
                            <i class="bi bi-wrench"></i> Equipamiento b√°sico
                        </span>
                        {% endfor %}
                    </div>

                    <div class="space-actions">
                        <a href="{% url 'crear_reserva' %}?espacio_id={{ espacio.id }}" class="action-btn primary">
                            <i class="bi bi-calendar-plus"></i>
                            Reservar
                        </a>
                        <button class="action-btn" onclick="verDetallesEspacio({{ espacio.id }})">
                            <i class="bi bi-info-circle"></i>
                            Ver Detalles
                        </button>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="bi bi-building"></i>
                </div>
                <h2 class="empty-state-title">No hay espacios disponibles</h2>
                <p class="empty-state-text">
                    Actualmente no hay espacios disponibles para reservar.
                </p>
                <a href="{% url 'dashboard' %}" class="action-btn primary">
                    <i class="bi bi-arrow-left"></i>
                    Volver al Dashboard
                </a>
            </div>
            {% endfor %}
        </div>
    </main>

    <script>
        // Sistema de tema claro/oscuro
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            const body = document.body;
            
            // Verificar tema guardado
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                body.classList.add('theme-dark');
                themeIcon.classList.remove('bi-moon');
                themeIcon.classList.add('bi-sun');
            }
            
            // Funci√≥n para cambiar tema
            themeToggle.addEventListener('click', () => {
                const isDark = body.classList.contains('theme-dark');
                
                if (isDark) {
                    body.classList.remove('theme-dark');
                    themeIcon.classList.remove('bi-sun');
                    themeIcon.classList.add('bi-moon');
                    localStorage.setItem('theme', 'light');
                } else {
                    body.classList.add('theme-dark');
                    themeIcon.classList.remove('bi-moon');
                    themeIcon.classList.add('bi-sun');
                    localStorage.setItem('theme', 'dark');
                }
            });
            
            function verDetallesEspacio(espacioId) {
                alert(`Mostrando detalles del espacio ID: ${espacioId}`);
                // En una implementaci√≥n real, esto abrir√≠a un modal o redirigir√≠a a una p√°gina de detalles
            }

            console.log('P√°gina de espacios cargada correctamente');
        });
    </script>
</body>
</html>
============================================================


===== forgot_password_request.html =====
{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    {% include 'reservas/_theme_snippet.html' %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperar contrase√±a - INACAP</title>
    <link rel="stylesheet" href="/static/css/global.css" />
    <style>
        .card-center{display:flex;align-items:center;justify-content:center;min-height:60vh;padding:20px}
        .card{background:white;padding:28px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.08);width:460px;max-width:96%}
        .form-input{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:8px}
        .action-button{width:100%;padding:12px;background:#2563eb;color:white;border:none;border-radius:8px;cursor:pointer}
        .hint{font-size:13px;color:#374151;margin-top:10px}
        .logo{display:flex;align-items:center;gap:12px;margin-bottom:10px}
        .logo-icon{width:40px;height:40px;background:#dc2626;color:white;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700}
        .logo-text{font-weight:700;font-size:18px}
        .message {margin:10px 0;padding:10px;border-radius:8px}
        .error {background:#fee2e2;color:#dc2626}
        .success {background:#d1fae5;color:#065f46}
    </style>
    <link id="darkCss" rel="stylesheet" href="{% static 'css/dark.css' %}" disabled>
</head>
<body>
    <div class="card-center">
        <div class="card">
            <div class="logo">
                <div class="logo-icon">IN</div>
                <div class="logo-text">INACAP - Sistema de Reservas</div>
            </div>

            <h2>Recuperar contrase√±a</h2>
            <p class="hint">Ingresa tu correo. Si existe una cuenta, recibir√°s una contrase√±a temporal y un enlace para restablecerla.</p>

            {% if error %}
                <div class="message error">{{ error }}</div>
            {% endif %}

            <form method="post" action="/forgot-password/">
                {% csrf_token %}
                <input name="email" id="email" class="form-input" type="email" placeholder="correo@institucion.cl" required />
                <button type="submit" class="action-button" style="margin-top:12px">Enviar instrucciones</button>
            </form>

            <p style="margin-top:12px"><a href="/login/">Volver al inicio de sesi√≥n</a></p>
        </div>
    </div>
</body>
    <script src="{% static 'js/theme.js' %}"></script>
</html>
============================================================


===== forgot_password_sent.html =====
<!DOCTYPE html>
<html lang="es">
<head>
    {% include 'reservas/_theme_snippet.html' %}
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Correo enviado - INACAP</title>
    <style>body{font-family:Segoe UI, Tahoma, sans-serif;background:#f3f4f6;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}.card{background:white;padding:28px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.08);width:420px}</style>
    <link id="darkCss" rel="stylesheet" href="{% static 'css/dark.css' %}" disabled>
</head>
<body>
    <div class="card">
        <h2>Instrucciones enviadas</h2>
        <p>Si existe una cuenta asociada al correo proporcionado, recibir√°s un email con una contrase√±a temporal y un enlace para restablecer tu contrase√±a.</p>
        <p><a href="/login/">Volver al inicio de sesi√≥n</a></p>
    </div>
    <script src="{% static 'js/theme.js' %}"></script>
</body>
</html>
============================================================


===== gestion_espacios.html =====
<!DOCTYPE html>
<html lang="es">
<head>
    {% include 'reservas/_icons.html' %}
    {% include 'reservas/_theme_snippet.html' %}
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Espacios - Sistema de Reservas</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ENjdO4Dr2bkBIFxQpeoA6DQD5N2Q6F0n6U8U6p6YkE9j6M9g6t5F5F5F5F5F5F5F5" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        /* Variables CSS para temas */
        :root {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border-color: #e5e7eb;
            --primary-color: #2563eb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #dc3545;
            --admin-color: #7c3aed;
            --card-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #18191a;
            --bg-secondary: #23272f;
            --bg-tertiary: #2d3748;
            --text-primary: #ffffff;
            --text-secondary: #e5e7eb;
            --text-tertiary: #9ca3af;
            --border-color: #4b5563;
            --primary-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --admin-color: #8b5cf6;
            --card-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--card-shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: var(--admin-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }

        .nav-menu {
            display: flex;
            gap: 24px;
        }

        .nav-item {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--admin-color);
            color: white;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: var(--success-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        /* Main Content */
        .main-content {
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Breadcrumb */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .breadcrumb a {
            color: var(--admin-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .breadcrumb-separator {
            color: var(--text-tertiary);
        }

        /* Page Header */
        .page-header {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--success-color);
            color: white;
        }

        .btn-primary:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--admin-color);
            color: white;
            border-color: var(--admin-color);
        }

        /* Filters */
        .filters-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-select, .filter-input {
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: border-color 0.3s ease;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--admin-color);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        /* Table */
        .table-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: var(--bg-tertiary);
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        .table td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .table tr:last-child td {
            border-bottom: none;
        }

        .table tr:hover {
            background: var(--bg-tertiary);
        }

        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .status-available {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-maintenance {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .status-out-of-service {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            gap: 4px;
        }

        .btn-edit {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary-color);
            border: 1px solid rgba(37, 99, 235, 0.2);
        }

        .btn-edit:hover {
            background: rgba(37, 99, 235, 0.2);
            transform: translateY(-1px);
        }

        .btn-delete {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .btn-delete:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: translateY(-1px);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-tertiary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-state-text {
            margin-bottom: 24px;
            color: var(--text-secondary);
        }

        /* Clear Filters Button */
        .clear-filters-btn {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            margin-top: 8px;
        }

        .clear-filters-btn:hover {
            background: var(--admin-color);
            color: white;
            border-color: var(--admin-color);
        }

        /* Space Info */
        .space-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .space-description {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
            line-height: 1.4;
        }

        /* Capacity Badge */
        .capacity-badge {
            background: var(--bg-tertiary);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-secondary);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 16px;
            }
            
            .header {
                padding: 0 16px;
                height: 60px;
            }
            
            .nav-menu {
                display: none;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .header-actions {
                width: 100%;
                justify-content: flex-end;
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            .table {
                min-width: 800px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }

        /* Animation for alerts */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
    </style>
    <link id="darkCss" rel="stylesheet" href="{% static 'css/dark.css' %}" disabled>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo-section">
            <div class="logo"><i class="bi bi-shield-check"></i></div>
            <div style="font-weight: 600; color: var(--text-primary);">Panel Administrativo</div>
        </div>
        
        <nav class="nav-menu">
            <a href="{% url 'admin_dashboard' %}" class="nav-item">
                <i class="bi bi-speedometer2"></i> Dashboard
            </a>
            <a href="{% url 'solicitudes_pendientes' %}" class="nav-item">
                <i class="bi bi-clock"></i> Solicitudes
            </a>
            <a href="{% url 'gestion_espacios' %}" class="nav-item active">
                <i class="bi bi-door-open-fill"></i> Espacios
            </a>
            <a href="{% url 'gestion_usuarios' %}" class="nav-item">
                <i class="bi bi-people"></i> Usuarios
            </a>
            <a href="{% url 'reportes' %}" class="nav-item">
                <i class="bi bi-bar-chart"></i> Reportes
            </a>
            <a href="{% url 'notificaciones_admin' %}" class="nav-item">
                <i class="bi bi-bell"></i> Notificaciones
            </a>
        </nav>
        
        <div class="user-menu" id="userMenu">
            <button class="notification-btn" id="notificationBtn" style="background:none;border:none;position:relative;font-size:22px;cursor:pointer;color:var(--admin-color);">
                <i class="bi bi-bell"></i>
                <span id="notifBadge" style="display:none;position:absolute;top:-5px;right:-5px;background:var(--danger-color);color:#fff;font-size:11px;padding:2px 6px;border-radius:10px;min-width:18px;height:18px;display:flex;align-items:center;justify-content:center;">0</span>
            </button>
            <div class="user-avatar">
                {% if user.first_name and user.last_name %}
                    {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                {% else %}
                    {{ user.username|first|upper }}
                {% endif %}
            </div>
            <span style="color: var(--text-primary);">
                {% if user.first_name %}
                    {{ user.first_name }} {{ user.last_name }}
                {% else %}
                    {{ user.username }}
                {% endif %}
            </span>
            <a href="{% url 'logout' %}" style="margin-left: 10px; color: var(--text-secondary); text-decoration: none;" title="Cerrar sesi√≥n">
                <i class="bi bi-box-arrow-right"></i>
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Breadcrumb -->
        <nav class="breadcrumb">
            <a href="{% url 'admin_dashboard' %}">
                <i class="bi bi-house"></i> Dashboard
            </a>
            <span class="breadcrumb-separator">‚Ä∫</span>
            <span style="color: var(--text-primary);">Gesti√≥n de Espacios</span>
        </nav>

        <!-- Page Header -->
        <div class="page-header">
            <div class="header-content">
                <h1 class="page-title">
                    <i class="bi bi-door-open-fill"></i> Gesti√≥n de Espacios
                </h1>
                <div class="header-actions">
                    <a href="{% url 'crear_espacio' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Nuevo Espacio
                    </a>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">
                        <i class="bi bi-circle-fill"></i> Estado
                    </label>
                    <select class="filter-select" id="statusFilter">
                        <option value="">Todos los estados</option>
                        <option value="Disponible">Disponible</option>
                        <option value="Mantenimiento">Mantenimiento</option>
                        <option value="Fuera de Servicio">Fuera de Servicio</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">
                        <i class="bi bi-tags"></i> Tipo
                    </label>
                    <select class="filter-select" id="typeFilter">
                        <option value="">Todos los tipos</option>
                        <option value="Sala de Reuniones">Sala de Reuniones</option>
                        <option value="Auditorio">Auditorio</option>
                        <option value="Laboratorio">Laboratorio</option>
                        <option value="Oficina">Oficina</option>
                        <option value="Aula">Aula</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">
                        <i class="bi bi-building"></i> Edificio
                    </label>
                    <input type="text" class="filter-input" id="buildingFilter" placeholder="Filtrar por edificio">
                </div>

                <div class="filter-group">
                    <label class="filter-label">
                        <i class="bi bi-search"></i> B√∫squeda
                    </label>
                    <input type="text" class="filter-input" id="searchFilter" placeholder="Buscar espacios...">
                </div>

                <div class="filter-group">
                    <button class="clear-filters-btn" onclick="clearFilters()">
                        <i class="bi bi-x-circle"></i> Limpiar filtros
                    </button>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th><i class="bi bi-card-heading"></i> Nombre</th>
                        <th><i class="bi bi-tag"></i> Tipo</th>
                        <th><i class="bi bi-building"></i> Edificio</th>
                        <th><i class="bi bi-stairs"></i> Piso</th>
                        <th><i class="bi bi-people"></i> Capacidad</th>
                        <th><i class="bi bi-circle-fill"></i> Estado</th>
                        <th><i class="bi bi-gear"></i> Acciones</th>
                    </tr>
                </thead>
                <tbody id="spacesTableBody">
                    {% for espacio in espacios %}
                    <tr>
                        <td>
                            <div class="space-name">
                                <i class="bi bi-door-closed" style="margin-right: 8px; color: var(--text-secondary);"></i>
                                {{ espacio.nombre }}
                            </div>
                            {% if espacio.descripcion %}
                            <div class="space-description">
                                {{ espacio.descripcion|truncatewords:10 }}
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            <span class="capacity-badge">
                                {{ espacio.tipo }}
                            </span>
                        </td>
                        <td>{{ espacio.edificio|default:"-" }}</td>
                        <td>{{ espacio.piso|default:"-" }}</td>
                        <td>
                            <span class="capacity-badge">
                                <i class="bi bi-people"></i>
                                {{ espacio.capacidad }} personas
                            </span>
                        </td>
                        <td>
                            {% if espacio.estado == 'Disponible' %}
                                <span class="status-badge status-available">
                                    <i class="bi bi-check-circle"></i> Disponible
                                </span>
                            {% elif espacio.estado == 'Mantenimiento' %}
                                <span class="status-badge status-maintenance">
                                    <i class="bi bi-tools"></i> Mantenimiento
                                </span>
                            {% elif espacio.estado == 'Fuera de Servicio' %}
                                <span class="status-badge status-out-of-service">
                                    <i class="bi bi-exclamation-triangle"></i> Fuera de Servicio
                                </span>
                            {% else %}
                                <span class="status-badge">{{ espacio.estado }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a href="{% url 'editar_espacio' %}?id={{ espacio.id }}" class="btn-icon btn-edit" title="Editar espacio">
                                    <i class="bi bi-pencil"></i> Editar
                                </a>
                                <button class="btn-icon btn-delete" onclick="eliminarEspacio({{ espacio.id }})" title="Eliminar espacio">
                                    <i class="bi bi-trash"></i> Eliminar
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <div class="empty-state-icon">
                                    <i class="bi bi-door-open"></i>
                                </div>
                                <h3 class="empty-state-title">No hay espacios registrados</h3>
                                <p class="empty-state-text">
                                    Comienza agregando el primer espacio al sistema.
                                </p>
                                <a href="{% url 'crear_espacio' %}" class="btn btn-primary">
                                    <i class="bi bi-plus-circle"></i> Crear Primer Espacio
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </main>

    <!-- Modal de confirmaci√≥n -->
    <div id="confirmationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: var(--bg-secondary); padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.2); border: 1px solid var(--border-color);">
            <h3 style="color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                <i class="bi bi-exclamation-triangle" style="color: var(--danger-color);"></i> Confirmar eliminaci√≥n
            </h3>
            <p style="color: var(--text-secondary); margin-bottom: 24px; line-height: 1.5;">
                ¬øEst√°s seguro de que deseas eliminar este espacio? Esta acci√≥n no se puede deshacer.
            </p>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="closeConfirmationModal()" style="padding: 10px 20px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;">
                    <i class="bi bi-x"></i> Cancelar
                </button>
                <button onclick="confirmDelete()" style="padding: 10px 20px; background: var(--danger-color); color: white; border: none; border-radius: 8px; cursor: pointer;">
                    <i class="bi bi-trash"></i> Eliminar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let spaceToDelete = null;

        // Filtros de tabla
        document.addEventListener('DOMContentLoaded', function() {
            const statusFilter = document.getElementById('statusFilter');
            const typeFilter = document.getElementById('typeFilter');
            const buildingFilter = document.getElementById('buildingFilter');
            const searchFilter = document.getElementById('searchFilter');
            const tableBody = document.getElementById('spacesTableBody');
            const rows = tableBody.getElementsByTagName('tr');

            function applyFilters() {
                const statusValue = statusFilter.value.toLowerCase();
                const typeValue = typeFilter.value.toLowerCase();
                const buildingValue = buildingFilter.value.toLowerCase();
                const searchValue = searchFilter.value.toLowerCase();

                for (let row of rows) {
                    if (row.cells.length < 7) continue; // Skip empty state row
                    
                    const statusCell = row.cells[5];
                    const typeCell = row.cells[1];
                    const buildingCell = row.cells[2];
                    const nameCell = row.cells[0];
                    
                    if (!statusCell || !typeCell || !buildingCell || !nameCell) continue;
                    
                    const status = statusCell.textContent.toLowerCase();
                    const type = typeCell.textContent.toLowerCase();
                    const building = buildingCell.textContent.toLowerCase();
                    const name = nameCell.textContent.toLowerCase();
                    const description = nameCell.querySelector('.space-description')?.textContent.toLowerCase() || '';

                    const statusMatch = !statusValue || status.includes(statusValue);
                    const typeMatch = !typeValue || type.includes(typeValue);
                    const buildingMatch = !buildingValue || building.includes(buildingValue);
                    const searchMatch = !searchValue || 
                                       name.includes(searchValue) || 
                                       description.includes(searchValue);

                    row.style.display = statusMatch && typeMatch && buildingMatch && searchMatch ? '' : 'none';
                }
            }

            statusFilter.addEventListener('change', applyFilters);
            typeFilter.addEventListener('change', applyFilters);
            buildingFilter.addEventListener('input', applyFilters);
            searchFilter.addEventListener('input', applyFilters);
        });

        // Funci√≥n para abrir modal de eliminaci√≥n
        function eliminarEspacio(espacioId) {
            spaceToDelete = espacioId;
            document.getElementById('confirmationModal').style.display = 'flex';
        }

        // Funci√≥n para cerrar modal
        function closeConfirmationModal() {
            document.getElementById('confirmationModal').style.display = 'none';
            spaceToDelete = null;
        }

        // Funci√≥n para confirmar eliminaci√≥n
        async function confirmDelete() {
            if (!spaceToDelete) return;

            try {
                const response = await fetch(`/api/espacios/${spaceToDelete}/eliminar/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('‚úÖ Espacio eliminado exitosamente', 'success');
                    setTimeout(() => {
                        location.reload(); // Recargar la p√°gina para actualizar la lista
                    }, 1500);
                } else {
                    showAlert(`‚ùå Error al eliminar el espacio: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('‚ùå Error de conexi√≥n al eliminar el espacio', 'error');
            } finally {
                closeConfirmationModal();
            }
        }

        // Funci√≥n para limpiar filtros
        function clearFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('buildingFilter').value = '';
            document.getElementById('searchFilter').value = '';
            
            const rows = document.querySelectorAll('#spacesTableBody tr');
            rows.forEach(row => {
                row.style.display = '';
            });
            
            showAlert('üßπ Filtros limpiados', 'info');
        }

        // Funci√≥n para obtener token CSRF
        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Funci√≥n para mostrar alertas
        function showAlert(message, type = 'info') {
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6'
            };
            
            const icon = {
                success: 'bi-check-circle',
                error: 'bi-exclamation-triangle',
                warning: 'bi-exclamation-circle',
                info: 'bi-info-circle'
            }[type];
            
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type]}20;
                color: ${colors[type]};
                padding: 16px 20px;
                border-radius: 12px;
                border: 1px solid ${colors[type]}40;
                display: flex;
                align-items: center;
                gap: 10px;
                z-index: 9999;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                animation: slideInRight 0.3s ease-out;
            `;
            
            alertDiv.innerHTML = `
                <i class="bi ${icon}" style="font-size: 20px;"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.style.animation = 'slideOutRight 0.3s ease-in forwards';
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.parentNode.removeChild(alertDiv);
                    }
                }, 300);
            }, 3000);
        }

        // Cerrar modal al hacer clic fuera
        document.getElementById('confirmationModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeConfirmationModal();
            }
        });

        // Cerrar modal con ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeConfirmationModal();
            }
        });

        // Actualizar badge de notificaciones
        function updateNotifBadge(count) {
            const badge = document.getElementById('notifBadge');
            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'flex' : 'none';
            }
        }

        // Inicializar badge
        updateNotifBadge(0);
    </script>
    <script src="{% static 'js/theme.js' %}"></script>
</body>
</html>
============================================================


===== gestion_usuarios.html =====
<!DOCTYPE html>
<html lang="es">
<head>
    {% include 'reservas/_icons.html' %}
    {% include 'reservas/_theme_snippet.html' %}
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Usuarios - Sistema de Reservas</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ENjdO4Dr2bkBIFxQpeoA6DQD5N2Q6F0n6U8U6p6YkE9j6M9g6t5F5F5F5F5F5F5F5" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        /* Variables CSS para temas */
        :root {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border-color: #e5e7eb;
            --primary-color: #2563eb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #dc3545;
            --admin-color: #7c3aed;
            --card-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #18191a;
            --bg-secondary: #23272f;
            --bg-tertiary: #2d3748;
            --text-primary: #ffffff;
            --text-secondary: #e5e7eb;
            --text-tertiary: #9ca3af;
            --border-color: #4b5563;
            --primary-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --admin-color: #8b5cf6;
            --card-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--card-shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: var(--admin-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }

        .nav-menu {
            display: flex;
            gap: 24px;
        }

        .nav-item {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--admin-color);
            color: white;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: var(--success-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        /* Main Content */
        .main-content {
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Breadcrumb */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .breadcrumb a {
            color: var(--admin-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .breadcrumb-separator {
            color: var(--text-tertiary);
        }

        /* Page Header */
        .page-header {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Filters */
        .filters-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-select, .filter-input {
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: border-color 0.3s ease;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--admin-color);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .clear-filters-btn {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }

        .clear-filters-btn:hover {
            background: var(--admin-color);
            color: white;
            border-color: var(--admin-color);
        }

        /* Table Section */
        .table-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
        }

        .table-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .table-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-count {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .table-container {
            overflow-x: auto;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .users-table th {
            background: var(--bg-tertiary);
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-color);
            white-space: nowrap;
        }

        .users-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            color: var(--text-primary);
        }

        .users-table tr:hover {
            background: var(--bg-tertiary);
        }

        /* User info */
        .user-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .user-email {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .user-department {
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* Badges */
        .role-badge {
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .role-usuario { background: rgba(37, 99, 235, 0.1); color: #2563eb; }
        .role-docente { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
        .role-investigacion { background: rgba(139, 92, 246, 0.1); color: #8b5cf6; }
        .role-administrativo { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .role-aprobador { background: rgba(236, 72, 153, 0.1); color: #ec4899; }
        .role-superadmin { background: rgba(220, 38, 38, 0.1); color: #dc2626; }

        .status-badge {
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .status-active { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .status-inactive { background: rgba(239, 68, 68, 0.1); color: #ef4444; }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-action {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .btn-edit {
            background: rgba(37, 99, 235, 0.1);
            color: #2563eb;
        }

        .btn-edit:hover {
            background: rgba(37, 99, 235, 0.2);
        }

        .btn-deactivate {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .btn-deactivate:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .btn-activate {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .btn-activate:hover {
            background: rgba(16, 185, 129, 0.2);
        }

        .btn-change-role {
            background: rgba(139, 92, 246, 0.1);
            color: #8b5cf6;
        }

        .btn-change-role:hover {
            background: rgba(139, 92, 246, 0.2);
        }

        /* Loading */
        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: var(--text-tertiary);
            font-style: italic;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-tertiary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 16px;
            }
            
            .header {
                padding: 0 16px;
                height: 60px;
            }
            
            .nav-menu {
                display: none;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .users-table {
                font-size: 12px;
            }
            
            .table-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
    <link id="darkCss" rel="stylesheet" href="{% static 'css/dark.css' %}" disabled>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo-section">
            <div class="logo"><i class="bi bi-shield-check"></i></div>
            <div style="font-weight: 600; color: var(--text-primary);">Panel Administrativo</div>
        </div>
        
        <nav class="nav-menu">
            <a href="{% url 'admin_dashboard' %}" class="nav-item">
                <i class="bi bi-speedometer2"></i> Dashboard
            </a>
            <a href="{% url 'solicitudes_pendientes' %}" class="nav-item">
                <i class="bi bi-clock"></i> Solicitudes
            </a>
            <a href="{% url 'gestion_espacios' %}" class="nav-item">
                <i class="bi bi-door-open"></i> Espacios
            </a>
            <a href="{% url 'gestion_usuarios' %}" class="nav-item active">
                <i class="bi bi-people-fill"></i> Usuarios
            </a>
            <a href="{% url 'reportes' %}" class="nav-item">
                <i class="bi bi-bar-chart"></i> Reportes
            </a>
            <a href="{% url 'notificaciones_admin' %}" class="nav-item">
                <i class="bi bi-bell"></i> Notificaciones
            </a>
        </nav>
        
        <div class="user-menu" id="userMenu">
            <button class="notification-btn" id="notificationBtn" style="background:none;border:none;position:relative;font-size:22px;cursor:pointer;color:var(--admin-color);">
                <i class="bi bi-bell"></i>
                <span id="notifBadge" style="display:none;position:absolute;top:-5px;right:-5px;background:var(--danger-color);color:#fff;font-size:11px;padding:2px 6px;border-radius:10px;min-width:18px;height:18px;display:flex;align-items:center;justify-content:center;">0</span>
            </button>
            <div class="user-avatar">
                {% if user.first_name and user.last_name %}
                    {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                {% else %}
                    {{ user.username|first|upper }}
                {% endif %}
            </div>
            <span style="color: var(--text-primary);">
                {% if user.first_name %}
                    {{ user.first_name }} {{ user.last_name }}
                {% else %}
                    {{ user.username }}
                {% endif %}
            </span>
            <a href="{% url 'logout' %}" style="margin-left: 10px; color: var(--text-secondary); text-decoration: none;" title="Cerrar sesi√≥n">
                <i class="bi bi-box-arrow-right"></i>
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Breadcrumb -->
        <nav class="breadcrumb">
            <a href="{% url 'admin_dashboard' %}">
                <i class="bi bi-house"></i> Dashboard
            </a>
            <span class="breadcrumb-separator">‚Ä∫</span>
            <span style="color: var(--text-primary);">Gesti√≥n de Usuarios</span>
        </nav>

        <!-- Page Header -->
        <div class="page-header">
            <div class="header-content">
                <h1 class="page-title">
                    <i class="bi bi-people-fill"></i> Gesti√≥n de Usuarios
                </h1>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">
                        <i class="bi bi-search"></i> Buscar
                    </label>
                    <input type="text" class="filter-input" id="searchInput" placeholder="Nombre, email...">
                </div>

                <div class="filter-group">
                    <label class="filter-label">
                        <i class="bi bi-person-badge"></i> Rol
                    </label>
                    <select class="filter-select" id="roleFilter">
                        <option value="">Todos los roles</option>
                        <option value="Usuario">Usuario</option>
                        <option value="Docente">Docente</option>
                        <option value="Investigacion">Investigaci√≥n</option>
                        <option value="Administrativo">Administrativo</option>
                        <option value="Aprobador">Aprobador</option>
                        <option value="SuperAdmin">SuperAdmin</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">
                        <i class="bi bi-toggle-on"></i> Estado
                    </label>
                    <select class="filter-select" id="statusFilter">
                        <option value="">Todos los estados</option>
                        <option value="true">Activo</option>
                        <option value="false">Inactivo</option>
                    </select>
                </div>

                <div class="filter-group">
                    <button class="clear-filters-btn" onclick="clearFilters()">
                        <i class="bi bi-x-circle"></i> Limpiar filtros
                    </button>
                </div>
            </div>
        </div>

        <!-- Table Section -->
        <div class="table-section">
            <div class="table-header">
                <h2 class="table-title">
                    <i class="bi bi-list-ul"></i> Lista de Usuarios
                </h2>
                <div class="user-count" id="userCount">
                    <span id="userCountText">Cargando...</span>
                </div>
            </div>

            <div class="table-container">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th><i class="bi bi-hash"></i> ID</th>
                            <th><i class="bi bi-person"></i> Nombre Completo</th>
                            <th><i class="bi bi-envelope"></i> Email</th>
                            <th><i class="bi bi-building"></i> Departamento</th>
                            <th><i class="bi bi-person-badge"></i> Rol</th>
                            <th><i class="bi bi-toggle-on"></i> Estado</th>
                            <th><i class="bi bi-calendar"></i> Fecha Registro</th>
                            <th><i class="bi bi-gear"></i> Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <div class="loading-spinner">
                                    <i class="bi bi-hourglass-split"></i> Cargando usuarios...
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal para cambiar rol (oculto hasta que se necesite) -->
    <div id="changeRoleModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: var(--bg-secondary); padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
            <h3 style="color: var(--text-primary); margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                <i class="bi bi-person-badge"></i> Cambiar Rol de Usuario
            </h3>
            <div id="modalContent">
                <!-- Contenido din√°mico del modal -->
            </div>
            <div style="display: flex; gap: 12px; margin-top: 24px; justify-content: flex-end;">
                <button onclick="closeChangeRoleModal()" style="padding: 10px 20px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;">
                    <i class="bi bi-x"></i> Cancelar
                </button>
                <button onclick="confirmChangeRole()" style="padding: 10px 20px; background: var(--admin-color); color: white; border: none; border-radius: 8px; cursor: pointer;">
                    <i class="bi bi-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentUserId = null;
        let currentUserRole = null;

        // Indicar desde servidor si el usuario actual es SuperAdmin
        window.__IS_SUPERADMIN = {% if user.perfilusuario.rol == 'SuperAdmin' %}true{% else %}false{% endif %};

        // Funci√≥n para cargar usuarios
        async function loadUsers() {
            try {
                const search = document.getElementById('searchInput').value;
                const role = document.getElementById('roleFilter').value;
                const status = document.getElementById('statusFilter').value;

                let url = '/api/usuarios/filtrar/';
                const params = new URLSearchParams();
                
                if (search) params.append('search', search);
                if (role) params.append('rol', role);
                if (status) params.append('estado', status);

                if (params.toString()) {
                    url += '?' + params.toString();
                }

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    renderUsersTable(data.usuarios);
                    document.getElementById('userCountText').textContent = `${data.total} usuarios encontrados`;
                } else {
                    console.error('Error:', data.error);
                    document.getElementById('usersTableBody').innerHTML = 
                        `<tr><td colspan="8" style="text-align: center; color: var(--danger-color);">
                            <i class="bi bi-exclamation-triangle"></i> Error al cargar usuarios
                        </td></tr>`;
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('usersTableBody').innerHTML = 
                    `<tr><td colspan="8" style="text-align: center; color: var(--danger-color);">
                        <i class="bi bi-wifi-off"></i> Error de conexi√≥n
                    </td></tr>`;
            }
        }

        // Funci√≥n para renderizar la tabla de usuarios
        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                            <div class="empty-state">
                                <div class="empty-state-icon"><i class="bi bi-people"></i></div>
                                <div>No se encontraron usuarios</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>
                        <strong style="color: var(--text-tertiary);">#${user.id}</strong>
                    </td>
                    <td>
                        <div class="user-name">
                            <i class="bi bi-person" style="margin-right: 6px; color: var(--text-secondary);"></i>
                            ${user.first_name || 'No especificado'} ${user.last_name || ''}
                        </div>
                    </td>
                    <td>
                        <div class="user-email">
                            <i class="bi bi-envelope" style="margin-right: 6px; color: var(--text-secondary);"></i>
                            ${user.email}
                        </div>
                    </td>
                    <td>
                        <div class="user-department">
                            <i class="bi bi-building" style="margin-right: 6px; color: var(--text-secondary);"></i>
                            ${user.departamento || 'No asignado'}
                        </div>
                    </td>
                    <td>
                        <span class="role-badge role-${user.rol.toLowerCase().replace(' ', '')}">
                            ${getRoleIcon(user.rol)} ${user.rol}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge status-${user.is_active ? 'active' : 'inactive'}">
                            ${user.is_active ? '<i class="bi bi-check-circle"></i> Activo' : '<i class="bi bi-x-circle"></i> Inactivo'}
                        </span>
                    </td>
                    <td>
                        <i class="bi bi-calendar" style="margin-right: 6px; color: var(--text-secondary);"></i>
                        ${formatDate(user.date_joined)}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-edit" onclick="editUser(${user.id})" title="Editar usuario">
                                <i class="bi bi-pencil"></i> Editar
                            </button>
                            <button class="btn-action ${user.is_active ? 'btn-deactivate' : 'btn-activate'}" 
                                    onclick="toggleUserStatus(${user.id}, ${!user.is_active})"
                                    title="${user.is_active ? 'Desactivar usuario' : 'Activar usuario'}">
                                ${user.is_active ? '<i class="bi bi-person-x"></i> Desactivar' : '<i class="bi bi-person-check"></i> Activar'}
                            </button>
                            ${isSuperAdmin() ? `
                                <button class="btn-action btn-change-role" 
                                        onclick="openChangeRoleModal(${user.id}, '${user.rol.replace("'","\'")}')"
                                        title="Cambiar rol">
                                    <i class="bi bi-person-badge"></i> Rol
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Funci√≥n para obtener √≠cono del rol
        function getRoleIcon(role) {
            const icons = {
                'Usuario': '<i class="bi bi-person"></i>',
                'Docente': '<i class="bi bi-mortarboard"></i>',
                'Investigacion': '<i class="bi bi-search"></i>',
                'Administrativo': '<i class="bi bi-briefcase"></i>',
                'Aprobador': '<i class="bi bi-check-circle"></i>',
                'SuperAdmin': '<i class="bi bi-shield-check"></i>'
            };
            return icons[role] || '<i class="bi bi-person"></i>';
        }

        // Funci√≥n para formatear fecha
        function formatDate(dateString) {
            if (!dateString) return 'No disponible';
            
            try {
                let date;
                
                if (dateString.includes('T')) {
                    date = new Date(dateString);
                } else if (dateString.includes('/')) {
                    const parts = dateString.split('/');
                    if (parts.length === 3) {
                        date = new Date(parts[2], parts[1] - 1, parts[0]);
                    }
                } else if (dateString.includes('-')) {
                    date = new Date(dateString);
                } else {
                    date = new Date(dateString);
                }
                
                if (isNaN(date.getTime())) {
                    console.warn('Fecha no parseable:', dateString);
                    return dateString || 'No disponible';
                }
                
                return date.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (error) {
                console.error('Error formateando fecha:', error, 'Fecha original:', dateString);
                return dateString || 'Error fecha';
            }
        }
        
        // Funci√≥n para editar usuario
        function editUser(userId) {
            window.location.href = `/editar-usuario/?id=${userId}`;
        }

        // Funci√≥n para cambiar estado del usuario
        async function toggleUserStatus(userId, activate) {
            const action = activate ? 'activar' : 'desactivar';
            const actionText = activate ? 'activado' : 'desactivado';
            
            if (!confirm(`¬øEst√°s seguro de que quieres ${action} este usuario?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/usuarios/${userId}/cambiar-estado/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ activo: activate })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(`‚úÖ Usuario ${actionText} exitosamente`, 'success');
                    loadUsers();
                } else {
                    showAlert(`‚ùå Error al ${action} usuario: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('‚ùå Error de conexi√≥n', 'error');
            }
        }

        // Funci√≥n para abrir modal de cambio de rol
        function openChangeRoleModal(userId, currentRole) {
            currentUserId = userId;
            currentUserRole = currentRole;
            
            const roles = [
                { value: 'Usuario', label: 'Usuario', icon: 'person' },
                { value: 'Docente', label: 'Docente', icon: 'mortarboard' },
                { value: 'Investigacion', label: 'Investigaci√≥n', icon: 'search' },
                { value: 'Administrativo', label: 'Administrativo', icon: 'briefcase' },
                { value: 'Aprobador', label: 'Aprobador', icon: 'check-circle' },
                { value: 'SuperAdmin', label: 'Super Admin', icon: 'shield-check' }
            ];
            
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Selecciona el nuevo rol para el usuario <strong style="color: var(--text-primary);">ID: ${userId}</strong>
                </p>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    ${roles.map(role => `
                        <label style="display: flex; align-items: center; gap: 12px; padding: 10px; background: ${role.value === currentRole ? 'rgba(139, 92, 246, 0.1)' : 'var(--bg-tertiary)'}; border-radius: 8px; cursor: pointer; border: 1px solid ${role.value === currentRole ? 'var(--admin-color)' : 'var(--border-color)'};">
                            <input type="radio" name="userRole" value="${role.value}" ${role.value === currentRole ? 'checked' : ''} style="accent-color: var(--admin-color);">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="bi bi-${role.icon}" style="color: ${role.value === currentRole ? 'var(--admin-color)' : 'var(--text-secondary)'};"></i>
                                <span style="color: var(--text-primary);">${role.label}</span>
                                ${role.value === currentRole ? '<span style="margin-left: auto; color: var(--admin-color); font-size: 12px;">(actual)</span>' : ''}
                            </div>
                        </label>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('changeRoleModal').style.display = 'flex';
        }

        // Funci√≥n para cerrar modal
        function closeChangeRoleModal() {
            document.getElementById('changeRoleModal').style.display = 'none';
            currentUserId = null;
            currentUserRole = null;
        }

        // Funci√≥n para confirmar cambio de rol
        async function confirmChangeRole() {
            const selectedRole = document.querySelector('input[name="userRole"]:checked');
            
            if (!selectedRole) {
                showAlert('‚ùå Por favor, selecciona un rol', 'warning');
                return;
            }
            
            const newRole = selectedRole.value;
            
            if (newRole === currentUserRole) {
                showAlert('‚ÑπÔ∏è El usuario ya tiene este rol asignado', 'info');
                closeChangeRoleModal();
                return;
            }
            
            try {
                const response = await fetch(`/api/usuarios/${currentUserId}/cambiar-rol/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ rol: newRole })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('‚úÖ Rol actualizado exitosamente', 'success');
                    closeChangeRoleModal();
                    loadUsers();
                } else {
                    showAlert(`‚ùå Error al actualizar rol: ${data.error || data.message}`, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('‚ùå Error de conexi√≥n', 'error');
            }
        }

        // Funci√≥n para mostrar alertas
        function showAlert(message, type = 'info') {
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6'
            };
            
            const icon = {
                success: 'bi-check-circle',
                error: 'bi-exclamation-triangle',
                warning: 'bi-exclamation-circle',
                info: 'bi-info-circle'
            }[type];
            
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type]}20;
                color: ${colors[type]};
                padding: 16px 20px;
                border-radius: 12px;
                border: 1px solid ${colors[type]}40;
                display: flex;
                align-items: center;
                gap: 10px;
                z-index: 9999;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                animation: slideInRight 0.3s ease-out;
            `;
            
            alertDiv.innerHTML = `
                <i class="bi ${icon}" style="font-size: 20px;"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.style.animation = 'slideOutRight 0.3s ease-in forwards';
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.parentNode.removeChild(alertDiv);
                    }
                }, 300);
            }, 3000);
        }

        // Funci√≥n para limpiar filtros
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('roleFilter').value = '';
            document.getElementById('statusFilter').value = '';
            loadUsers();
        }

        // Funci√≥n para obtener token CSRF
        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Verificar si el usuario actual es SuperAdmin
        function isSuperAdmin() {
            try {
                return window.__IS_SUPERADMIN === true;
            } catch (e) {
                return false;
            }
        }

        // Event listeners para filtros
        document.getElementById('searchInput').addEventListener('input', debounce(loadUsers, 300));
        document.getElementById('roleFilter').addEventListener('change', loadUsers);
        document.getElementById('statusFilter').addEventListener('change', loadUsers);

        // Funci√≥n debounce para b√∫squeda
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Cargar usuarios al iniciar
        document.addEventListener('DOMContentLoaded', loadUsers);

        // Cerrar modal al hacer clic fuera
        document.getElementById('changeRoleModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeChangeRoleModal();
            }
        });

        // Cerrar modal con ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeChangeRoleModal();
            }
        });

        // Actualizar badge de notificaciones (ejemplo)
        function updateNotifBadge(count) {
            const badge = document.getElementById('notifBadge');
            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'flex' : 'none';
            }
        }

        // Inicializar badge
        updateNotifBadge(0);

        // Animaci√≥n CSS para alertas
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    opacity: 0;
                    transform: translateX(100%);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }
            @keyframes slideOutRight {
                from {
                    opacity: 1;
                    transform: translateX(0);
                }
                to {
                    opacity: 0;
                    transform: translateX(100%);
                }
            }
        `;
        document.head.appendChild(style);
    </script>
    <script src="{% static 'js/theme.js' %}"></script>
</body>
</html>
============================================================


===== login.html =====
<!DOCTYPE html>
<html lang="es">
<head>
    {% include 'reservas/_theme_snippet.html' %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INACAP - Sistema de Reservas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            gap: 12px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: #dc2626;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .logo-text {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }

        .welcome-text {
            font-size: 24px;
            color: #333;
            margin-bottom: 30px;
            font-weight: 300;
        }

        .tab-container {
            margin-bottom: 30px;
        }

        .tabs {
            display: flex;
            background: #f3f4f6;
            border-radius: 12px;
            padding: 6px;
            margin-bottom: 20px;
            gap: 4px;
        }

        .tab {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: #666;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        .tab.active {
            background: white;
            color: #2563eb;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .user-type-selector {
            display: flex;
            background: #f3f4f6;
            border-radius: 12px;
            padding: 6px;
            margin-bottom: 30px;
            gap: 4px;
        }

        .user-type-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: #666;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        .user-type-btn.active {
            background: white;
            color: #2563eb;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .user-type-info {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 12px;
            color: #0369a1;
            text-align: left;
        }

        .form-container {
            display: none;
        }

        .form-container.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
            background: #f9fafb;
        }

        .form-input:focus {
            outline: none;
            border-color: #2563eb;
            background: white;
        }

        .name-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .password-container {
            position: relative;
        }

        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
        }

        .form-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #666;
            cursor: pointer;
        }

        .remember-checkbox {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 2px solid #ddd;
            cursor: pointer;
        }

        .forgot-password {
            color: #2563eb;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
        }

        .forgot-password:hover {
            text-decoration: underline;
        }

        .action-button {
            width: 100%;
            padding: 15px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-button:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
        }

        .action-button.loading {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .action-button.register {
            background: #10b981;
        }

        .action-button.register:hover {
            background: #059669;
        }

        .action-button.admin {
            background: #dc2626;
        }

        .action-button.admin:hover {
            background: #b91c1c;
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }



        .switch-form {
            margin-top: 20px;
            font-size: 14px;
            color: #666;
        }

        .switch-form a {
            color: #2563eb;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }

        .switch-form a:hover {
            text-decoration: underline;
        }
        .theme-toggle {
            width:40px;
            height:40px;
            border-radius:50%;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            background:#eef2ff;
            color:#1f2937;
            border:2px solid rgba(37,99,235,0.12);
            font-size:18px;
            cursor:pointer;
            box-shadow:0 6px 18px rgba(15,23,42,0.06);
        }
        .theme-toggle:hover{ transform:translateY(-2px); }
    </style>
        {% load static %}
        <link id="darkCss" rel="stylesheet" href="{% static 'css/dark.css' %}" disabled>
    </head>
<body>
    <div class="login-container">
        <div class="logo">
            <div class="logo-icon">IN</div>
            <div class="logo-text">INACAP</div>
            <button id="themeToggle" data-theme-toggle class="theme-toggle" title="Cambiar tema" style="margin-left:8px;">üåô</button>
        </div>

        <!-- Modal de Registro R√°pido -->
        <div id="registerModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
            <div style="background:white; border-radius:10px; width:90%; max-width:480px; padding:20px; box-shadow:0 8px 30px rgba(0,0,0,0.2);">
                <h4 style="margin-bottom:12px;">Crear Usuario</h4>
                <div id="registerMsg"></div>
                <div style="display:grid; gap:8px;">
                    <input id="r_firstName" placeholder="Nombre" class="form-input" style="padding:10px;" required />
                    <input id="r_lastName" placeholder="Apellido" class="form-input" style="padding:10px;" />
                    <input id="r_email" placeholder="Correo electr√≥nico" type="email" class="form-input" style="padding:10px;" required />
                    <input id="r_password" placeholder="Contrase√±a" type="password" class="form-input" style="padding:10px;" required minlength="6" />
                    <!-- campo departamento eliminado: el rol se asigna en backend -->
                    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:6px;">
                        <button id="closeRegisterModal" class="action-button" style="background:#6b7280">Cerrar</button>
                        <button id="submitRegisterModal" class="action-button register">Crear cuenta</button>
                    </div>
                </div>
            </div>
        </div>
        
        <h1 class="welcome-text">Sistema de Reservas</h1>

        <div class="tab-container">
            <div class="tabs">
                <button class="tab active" data-tab="login">üîê Iniciar Sesi√≥n</button>
            </div>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
        
        <!-- FORMULARIO DE LOGIN -->
        <div class="form-container active" id="loginFormContainer">
            <!-- Interfaz simplificada: solo correo y contrase√±a -->
            
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">üìß Correo Electr√≥nico</label>
                    <input 
                        type="email" 
                        id="loginEmail" 
                        class="form-input" 
                        placeholder="correo@institucion.cl"
                        required
                    >
                </div>
                
                <div class="form-group">
                    <label class="form-label">üîí Contrase√±a</label>
                    <div class="password-container">
                        <input 
                            type="password" 
                            id="loginPassword" 
                            class="form-input" 
                            placeholder="Tu contrase√±a"
                            required
                        >
                        <button type="button" class="toggle-password" onclick="togglePassword('loginPassword')">üëÅÔ∏è</button>
                    </div>
                </div>
                
                <div class="form-options">
                    <label class="remember-me">
                        <input type="checkbox" class="remember-checkbox" id="rememberMe">
                        Recordar sesi√≥n
                    </label>
                </div>
                <div style="text-align:left; margin-bottom:18px;">
                    <a href="/forgot-password/" class="forgot-password">¬øOlvidaste tu contrase√±a?</a>
                    &nbsp;|&nbsp;
                    <a href="#" id="openRegisterLink">Crear un usuario</a>
                </div>
                
                <button type="submit" class="action-button" id="loginBtn">
                    Iniciar Sesi√≥n
                </button>
            </form>


        </div>

        <!-- formulario de registro embebido eliminado (se usa modal de registro r√°pido) -->

    <script>
        function togglePassword(fieldId) {
            const passwordInput = document.getElementById(fieldId);
            const toggleButton = passwordInput.parentNode.querySelector('.toggle-password');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleButton.textContent = 'üîí';
            } else {
                passwordInput.type = 'password';
                toggleButton.textContent = 'üëÅÔ∏è';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        // Event listeners para pesta√±as
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                showTab(this.dataset.tab);
            });
        });

        // No hay selector usuario/admin en la interfaz simplificada

        // FUNCI√ìN MEJORADA DE LOGIN
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Limpiar mensajes anteriores
            hideMessages();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            console.log('üîÑ Iniciando proceso de login...');
            console.log('üìß Email:', email);
            console.log('üîë Password:', '*'.repeat(password.length));
            
            if (!email || !password) {
                showError('Por favor completa todos los campos');
                return;
            }

            // Mostrar loading
            const loginBtn = document.getElementById('loginBtn');
            const originalText = loginBtn.innerHTML;
            loginBtn.innerHTML = '‚è≥ Conectando...';
            loginBtn.disabled = true;

            try {
                console.log('üì§ Enviando solicitud al servidor...');
                
                const response = await fetch('/login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });

                console.log('üì• Respuesta recibida. Status:', response.status);
                
                const data = await response.json();
                console.log('üìä Datos de respuesta:', data);
                
                if (data.success) {
                    console.log('‚úÖ Login exitoso, redirigiendo...');
                    showSuccess('¬°Login exitoso! Redirigiendo...');
                    
                    // Redirigir despu√©s de breve delay
                    setTimeout(() => {
                        window.location.href = data.redirect_url || '/dashboard/';
                    }, 1000);
                    
                } else {
                    console.log('‚ùå Login fallido:', data.message);
                    showError(data.message || 'Credenciales incorrectas');
                }
                
            } catch (error) {
                console.error('üí• Error completo:', error);
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showError('Error de conexi√≥n. Verifica que el servidor est√© ejecut√°ndose en http://localhost:8000');
                } else {
                    showError('Error de conexi√≥n con el servidor');
                }
            } finally {
                console.log('üèÅ Finalizando proceso de login');
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;

                    // handlers del modal se asignan en DOMContentLoaded
            }
        });

        // FUNCI√ìN PARA OBTENER CSRF TOKEN
        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            
            console.log('üç™ CSRF Token:', cookieValue ? 'Encontrado' : 'No encontrado');
            return cookieValue;
        }

        // Inicializaciones al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ P√°gina de login cargada');

            // Inicializar tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    showTab(this.dataset.tab);
                });
            });

            // Inicializar modal de registro (enlace, cerrar, enviar)
            const openLink = document.getElementById('openRegisterLink');
            const modal = document.getElementById('registerModal');
            const closeBtn = document.getElementById('closeRegisterModal');
            const submitBtn = document.getElementById('submitRegisterModal');

            if (openLink && modal) {
                openLink.addEventListener('click', function(e){
                    e.preventDefault();
                    modal.style.display = 'flex';
                    const firstInput = modal.querySelector('input');
                    if (firstInput) firstInput.focus();
                });
            }

            if (closeBtn && modal) {
                closeBtn.addEventListener('click', function(e){
                    e.preventDefault();
                    modal.style.display = 'none';
                });
            }

            if (submitBtn && modal) {
                submitBtn.addEventListener('click', async function(e){
                    e.preventDefault();
                    const firstName = document.getElementById('r_firstName').value.trim();
                    const lastName = document.getElementById('r_lastName').value.trim();
                    const email = document.getElementById('r_email').value.trim();
                    const password = document.getElementById('r_password').value;

                    const msgDiv = document.getElementById('registerMsg');
                    msgDiv.innerHTML = '';

                    if (!firstName || !email || !password) {
                        msgDiv.innerHTML = '<div class="error-message" style="display:block">Completa nombre, email y contrase√±a</div>';
                        return;
                    }

                    try {
                        this.textContent = 'Creando...';
                        this.disabled = true;

                        const resp = await fetch('/api/registro/', {
                            method: 'POST',
                            headers: {'Content-Type':'application/json','X-CSRFToken': getCSRFToken()},
                            body: JSON.stringify({
                                first_name: firstName,
                                last_name: lastName,
                                email: email,
                                password: password
                            })
                        });
                        const data = await resp.json();
                        if (data.success) {
                            msgDiv.innerHTML = '<div class="success-message" style="display:block">Cuenta creada. Revisa tu correo o inicia sesi√≥n.</div>';
                            setTimeout(()=>{ modal.style.display='none'; }, 1500);
                        } else {
                            msgDiv.innerHTML = `<div class="error-message" style="display:block">${data.message || data.error}</div>`;
                        }
                    } catch (err) {
                        msgDiv.innerHTML = '<div class="error-message" style="display:block">Error de conexi√≥n</div>';
                    } finally {
                        this.textContent = 'Crear cuenta';
                        this.disabled = false;
                    }
                });
            }
        });
    </script>
    <script src="{% static 'js/theme.js' %}"></script>
</body>
</html>
============================================================


===== login_admin.html =====
<!DOCTYPE html>
<html lang="es">
<head>
    {% include 'reservas/_theme_snippet.html' %}
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INACAP - Login Administrador</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .logo { 
            font-size: 32px; 
            font-weight: bold; 
            color: #333; 
            margin-bottom: 10px;
        }
        .subtitle { 
            color: #666; 
            margin-bottom: 30px;
        }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-label { 
            display: block; 
            font-weight: 600; 
            color: #333; 
            margin-bottom: 8px; 
        }
        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .form-input:focus {
            outline: none;
            border-color: #dc2626;
        }
        .login-button {
            width: 100%;
            padding: 15px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        .login-button:hover {
            background: #b91c1c;
        }
        .user-link {
            display: block;
            margin-top: 20px;
            color: #dc2626;
            text-decoration: none;
        }
        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .warning {
            background: #fef3c7;
            color: #92400e;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
    </style>
        <link id="darkCss" rel="stylesheet" href="{% static 'css/dark.css' %}" disabled>
    </head>
<body>
    <div class="login-container">
        <div class="logo">inacap</div>
        <div class="subtitle">Panel de Administraci√≥n</div>
        
        <div class="warning">
            ‚ö†Ô∏è Acceso exclusivo para administradores
        </div>
        
        {% if messages %}
            {% for message in messages %}
                <div class="error-message">{{ message }}</div>
            {% endfor %}
        {% endif %}
        
        <form method="POST">
            {% csrf_token %}
            
            <div class="form-group">
                <label class="form-label">Usuario Administrador</label>
                <input type="text" name="username" class="form-input" placeholder="Usuario institucional" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Contrase√±a</label>
                <input type="password" name="password" class="form-input" placeholder="Contrase√±a" required>
            </div>
            
            <button type="submit" class="login-button">Acceder al Panel Admin</button>
        </form>
        
        <a href="{% url 'login_usuario' %}" class="user-link">‚Üê Volver al login de usuarios</a>
    </div>
    <script src="{% static 'js/theme.js' %}"></script>
</body>
</html>
============================================================


===== login_usuario.html =====
<!DOCTYPE html>
<html lang="es">
<head>
    {% include 'reservas/_theme_snippet.html' %}
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INACAP - Login Usuario</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .logo { 
            font-size: 32px; 
            font-weight: bold; 
            color: #333; 
            margin-bottom: 10px;
        }
        .subtitle { 
            color: #666; 
            margin-bottom: 30px;
        }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-label { 
            display: block; 
            font-weight: 600; 
            color: #333; 
            margin-bottom: 8px; 
        }
        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }
        .login-button {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        .login-button:hover {
            background: #5a6fd8;
        }
        .admin-link {
            display: block;
            margin-top: 20px;
            color: #667eea;
            text-decoration: none;
        }
        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
    </style>
        <link id="darkCss" rel="stylesheet" href="{% static 'css/dark.css' %}" disabled>
    </head>
<body>
    <div class="login-container">
        <div class="logo">inacap</div>
        <div class="subtitle">Sistema de Reservas - Usuarios</div>
        
        {% if messages %}
            {% for message in messages %}
                <div class="error-message">{{ message }}</div>
            {% endfor %}
        {% endif %}
        
        <form method="POST">
            {% csrf_token %}
            <input type="hidden" name="user_type" value="usuario">
            
            <div class="form-group">
                <label class="form-label">Usuario</label>
                <input type="text" name="username" class="form-input" placeholder="Ingresa tu usuario" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Contrase√±a</label>
                <input type="password" name="password" class="form-input" placeholder="Ingresa tu contrase√±a" required>
            </div>
            
            <button type="submit" class="login-button">Iniciar Sesi√≥n como Usuario</button>
        </form>
        
        <a href="{% url 'login_admin' %}" class="admin-link">¬øEres administrador? Accede aqu√≠</a>
    </div>
    <script src="{% static 'js/theme.js' %}"></script>
</body>
</html>
============================================================


===== notificaciones.html =====
<!DOCTYPE html>
<html lang="es">
<head>
  {% include 'reservas/_icons.html' %}
  {% include 'reservas/_theme_snippet.html' %}
  {% load static %}
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notificaciones</title>
  <!-- Bootstrap 5 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ENjdO4Dr2bkBIFxQpeoA6DQD5N2Q6F0n6U8U6p6YkE9j6M9g6t5F5F5F5F5F5F5F5" crossorigin="anonymous">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    /* Variables CSS para temas */
    :root {
      --bg-primary: #18191a;
      --bg-secondary: #23272f;
      --bg-tertiary: #2d3748;
      --text-primary: #ffffff;
      --text-secondary: #e5e7eb;
      --text-tertiary: #9ca3af;
      --border-color: #4b5563;
      --primary-color: #2563eb;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #dc3545;
      --card-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }

    [data-theme="light"] {
      --bg-primary: #f9fafb;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f3f4f6;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --text-tertiary: #9ca3af;
      --border-color: #e5e7eb;
      --primary-color: #2563eb;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #dc3545;
      --card-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Header Mejorado */
    .header {
      width: 100%;
      background: var(--bg-secondary);
      color: var(--text-primary);
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--card-shadow);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      height: 64px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .header-content {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 32px;
    }
    
    .logo-section {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 22px;
      font-weight: 700;
    }
    
    .logo {
      color: var(--warning-color);
      font-size: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .nav-menu {
      display: flex;
      gap: 24px;
    }
    
    .nav-item {
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 500;
      padding: 8px 16px;
      border-radius: 8px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .nav-item:hover, .nav-item.active {
      color: var(--primary-color);
      background: var(--bg-tertiary);
    }
    
    .user-menu {
      display: flex;
      align-items: center;
      gap: 16px;
      position: relative;
    }
    
    .user-avatar {
      font-size: 22px;
      color: var(--warning-color);
      cursor: pointer;
    }
    
    .user-name {
      font-size: 15px;
      color: var(--text-primary);
      font-weight: 500;
    }
    
    .logout-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 20px;
      cursor: pointer;
      margin-left: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }
    
    .logout-btn:hover {
      background: var(--bg-tertiary);
      color: var(--primary-color);
    }
    
    .logout-panel {
      display: none;
      position: absolute;
      top: 48px;
      right: 0;
      background: var(--bg-secondary);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      min-width: 180px;
      z-index: 200;
      border: 1px solid var(--border-color);
    }
    
    .logout-panel.active {
      display: block;
    }
    
    .panel-item {
      padding: 12px 20px;
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
      border-bottom: 1px solid var(--border-color);
    }
    
    .panel-item:hover {
      background: var(--primary-color);
      color: white;
    }
    
    .panel-item:last-child {
      border-bottom: none;
    }

    .container {
      width: 70%;
      padding: 20px;
      margin: 0 auto;
    }

    h2 {
      margin-bottom: 15px;
      color: var(--text-primary);
    }

    /* Filtros Mejorados */
    .filters {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filters button {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 500;
    }

    .filters button:hover {
      background: var(--primary-color);
      color: white;
      transform: translateY(-1px);
    }

    .filters button.active {
      background: var(--primary-color);
      color: white;
    }

    /* Notificaciones Mejoradas */
    .notification {
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 16px;
      border-left: 6px solid;
      display: block;
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
      border: 1px solid var(--border-color);
    }

    .notification:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .pendiente { 
      border-color: var(--warning-color);
      border-left-color: var(--warning-color);
    }
    
    .aprobada { 
      border-color: var(--success-color);
      border-left-color: var(--success-color);
    }
    
    .rechazada { 
      border-color: var(--danger-color);
      border-left-color: var(--danger-color);
    }

    .notification.unread {
      background: var(--bg-tertiary);
      border-left-width: 8px;
    }

    .notification b {
      color: var(--text-primary);
      font-size: 16px;
      display: block;
      margin-bottom: 8px;
    }

    .notification p {
      color: var(--text-secondary);
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 8px;
    }

    .notification small {
      color: var(--text-tertiary);
      display: block;
      margin-top: 8px;
      font-size: 12px;
    }

    .actions {
      margin-top: 15px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .actions button {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .actions button:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .btn-primary { 
      background: var(--primary-color); 
      color: white; 
    }
    
    .btn-danger { 
      background: var(--danger-color); 
      color: white; 
    }
    
    .btn-success { 
      background: var(--success-color); 
      color: white; 
    }
    
    .btn-warning { 
      background: var(--warning-color); 
      color: var(--text-primary); 
    }
    
    .btn-secondary { 
      background: var(--bg-tertiary); 
      color: var(--text-primary); 
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--primary-color);
      color: white;
    }

    /* Sidebar Mejorado */
    .sidebar {
      position: fixed;
      right: 20px;
      top: 84px;
      width: 280px;
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border-color);
    }

    .sidebar h3 {
      color: var(--text-primary);
      margin-bottom: 20px;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .preference {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .preference:last-child {
      border-bottom: none;
    }

    .preference span {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .toggle {
      width: 44px;
      height: 24px;
      background: var(--border-color);
      border-radius: 15px;
      position: relative;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle::after {
      content: "";
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: 0.3s;
    }

    .toggle.active {
      background: var(--success-color);
    }

    .toggle.active::after {
      left: 22px;
    }

    .frecuencia {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }

    .frecuencia h4 {
      color: var(--text-primary);
      margin-bottom: 15px;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .frecuencia label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 8px 0;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .frecuencia input[type="radio"] {
      margin: 0;
      accent-color: var(--primary-color);
    }

    /* Estados de carga y vac√≠o */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-tertiary);
      font-size: 16px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-tertiary);
      background: var(--bg-secondary);
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .empty-state p {
      font-size: 16px;
      margin-bottom: 8px;
    }

    .empty-state small {
      font-size: 14px;
    }

    .error-state {
      text-align: center;
      padding: 30px;
      color: var(--danger-color);
      background: rgba(220, 53, 69, 0.1);
      border-radius: 8px;
      margin: 10px 0;
      border: 1px solid rgba(220, 53, 69, 0.2);
    }

    .refresh-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 15px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .refresh-btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    /* Badges Mejorados */
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }

    .badge-pending { 
      background: rgba(245, 158, 11, 0.2); 
      color: var(--warning-color); 
      border: 1px solid rgba(245, 158, 11, 0.3);
    }
    
    .badge-approved { 
      background: rgba(16, 185, 129, 0.2); 
      color: var(--success-color); 
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    
    .badge-rejected { 
      background: rgba(220, 53, 69, 0.2); 
      color: var(--danger-color); 
      border: 1px solid rgba(220, 53, 69, 0.3);
    }

    /* Panel de debug */
    .debug-panel {
      background: var(--bg-tertiary);
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-size: 14px;
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
    }

    .data-source {
      margin-top: 10px;
      padding: 10px;
      background: rgba(37, 99, 235, 0.1);
      border-radius: 4px;
      font-size: 12px;
      color: var(--primary-color);
      border: 1px solid rgba(37, 99, 235, 0.2);
    }

    /* Indicador de actualizaci√≥n autom√°tica */
    .auto-refresh-indicator {
      background: rgba(16, 185, 129, 0.2);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 8px;
      padding: 12px 16px;
      margin: 10px 0;
      font-size: 14px;
      color: var(--success-color);
      display: none;
      align-items: center;
      gap: 8px;
    }

    .new-notification-badge {
      background: var(--danger-color);
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      margin-left: 10px;
      font-weight: 600;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* Alertas en tiempo real */
    .alert-container {
      position: fixed;
      top: 70px;
      right: 20px;
      z-index: 9999;
      max-width: 380px;
    }

    .alert-notification {
      background: var(--bg-secondary);
      border-left: 4px solid;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slideInRight 0.3s ease-out;
      cursor: pointer;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }

    .alert-notification:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideOutRight {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }

    /* Bot√≥n de notificaci√≥n en header */
    .notification-btn {
      position: relative;
      background: none;
      border: none;
      font-size: 22px;
      cursor: pointer;
      color: var(--primary-color);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .notification-btn:hover {
      background: var(--bg-tertiary);
      transform: scale(1.1);
    }

    /* Sistema de tema */
    .theme-toggle {
      display: none; /* Ya est√° en el snippet incluido */
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .container {
        width: 85%;
      }
    }

    @media (max-width: 992px) {
      .container {
        width: 90%;
      }
      
      .sidebar {
        position: static;
        width: 100%;
        margin-top: 20px;
      }
      
      .header-content {
        flex-wrap: wrap;
        gap: 16px;
      }
      
      .nav-menu {
        order: 3;
        width: 100%;
        justify-content: center;
        gap: 16px;
      }
    }

    @media (max-width: 768px) {
      .container {
        width: 95%;
        padding: 15px;
      }
      
      .header {
        padding: 0 16px;
        height: 60px;
      }
      
      .nav-menu {
        display: none; /* Se podr√≠a hacer un men√∫ hamburguesa */
      }
      
      .filters {
        justify-content: center;
      }
      
      .actions {
        justify-content: center;
      }
    }
  </style>
  <link id="darkCss" rel="stylesheet" href="{% static 'css/dark.css' %}" disabled>
</head>
<body> 
  <!-- Header Moderno con Bootstrap Icons -->
  <header class="header">
    <div class="header-content">
      <div class="logo-section">
        <div class="logo"><i class="bi bi-bell-fill"></i></div>
        <div style="color: var(--text-primary);">Notificaciones</div>
      </div>
      <nav class="nav-menu">
        <a href="{% url 'dashboard' %}" class="nav-item">
          <i class="bi bi-speedometer2"></i> Dashboard
        </a>
        <a href="{% url 'crear_reserva' %}" class="nav-item">
          <i class="bi bi-plus-circle"></i> Reservar
        </a>
        <a href="{% url 'reservas' %}" class="nav-item">
          <i class="bi bi-clock-history"></i> Historial
        </a>
        <a href="{% url 'calendario' %}" class="nav-item">
          <i class="bi bi-calendar3"></i> Calendario
        </a>
        <a href="{% url 'espacios' %}" class="nav-item">
          <i class="bi bi-door-open"></i> Espacios
        </a>
      </nav>
      <div class="user-menu" id="userMenu">
        <button class="notification-btn" id="notificationBtn">
          <i class="bi bi-bell"></i>
          <span id="notifBadge" style="display:none;position:absolute;top:2px;right:2px;background:var(--danger-color);color:#fff;font-size:11px;padding:2px 6px;border-radius:10px;min-width:18px;height:18px;display:flex;align-items:center;justify-content:center;">0</span>
        </button>
        <div class="user-avatar" id="userAvatar">
          <i class="bi bi-person-circle"></i>
        </div>
        <span class="user-name">
          {% if user.first_name %}{{ user.first_name }} {{ user.last_name }}
          {% else %}{{ user.username }}
          {% endif %}
        </span>
        <button class="logout-btn" id="logoutBtn" title="Cerrar sesi√≥n">
          <i class="bi bi-box-arrow-right"></i>
        </button>
        <div class="logout-panel" id="logoutPanel">
          <div class="panel-item" onclick="window.location.href='{% url 'logout' %}'">
            <i class="bi bi-box-arrow-right"></i> Cerrar sesi√≥n
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Contenido Principal -->
  <div class="container">
    <h2>
      <i class="bi bi-bell-fill"></i> Notificaciones 
      (<span id="notification-count">0</span>
      <span id="new-notification-badge" class="new-notification-badge" style="display: none;">!</span>)
    </h2>

    <!-- Indicador de actualizaci√≥n autom√°tica -->
    <div id="autoRefreshIndicator" class="auto-refresh-indicator">
      <i class="bi bi-arrow-clockwise"></i> Actualizando autom√°ticamente...
    </div>

    <!-- Filtros -->
    <div class="filters">
      <button class="active" data-filter="all">
        <i class="bi bi-funnel"></i> Todas
      </button>
      <button data-filter="pending">
        <i class="bi bi-clock"></i> Pendientes
      </button>
      <button data-filter="approved">
        <i class="bi bi-check-circle"></i> Aprobadas
      </button>
      <button data-filter="rejected">
        <i class="bi bi-x-circle"></i> Rechazadas
      </button>
    </div>

    <!-- Contenedor de notificaciones -->
    <div id="notifications-container">
      <div class="loading">
        <i class="bi bi-hourglass-split"></i> Cargando notificaciones desde la base de datos...
      </div>
    </div>
  </div>

  <!-- Sidebar de preferencias -->
  <div class="sidebar">
    <h3><i class="bi bi-gear"></i> Preferencias</h3>

    <div class="preference">
      <span>Notificaciones de reservas</span>
      <div class="toggle active" data-pref="reservas"></div>
    </div>

    <div class="preference">
      <span>Recordatorios</span>
      <div class="toggle active" data-pref="recordatorios"></div>
    </div>

    <div class="frecuencia">
      <h4><i class="bi bi-calendar-week"></i> Frecuencia</h4>
      <label>
        <input type="radio" name="frecuencia" value="immediate" checked>
        <i class="bi bi-lightning-charge"></i> Inmediata
      </label>
      <label>
        <input type="radio" name="frecuencia" value="daily">
        <i class="bi bi-sun"></i> Resumen diario
      </label>
      <label>
        <input type="radio" name="frecuencia" value="weekly">
        <i class="bi bi-calendar-week"></i> Resumen semanal
      </label>
    </div>
  </div>

  <!-- Sistema de Alertas en Tiempo Real -->
  <div id="alertContainer" class="alert-container"></div>

  <!-- JavaScript (TODO EL BACKEND MANTENIDO) -->
  <script>
    // Configuraci√≥n
    const API_BASE_URL = 'http://127.0.0.1:8000/api';
    let allNotifications = [];
    let currentFilter = 'all';
    let lastUpdateTime = null;
    let autoRefreshInterval = null;

    // ===== SISTEMA DE ACTUALIZACI√ìN AUTOM√ÅTICA CORREGIDO =====
    function startAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
        
        // Actualizar inmediatamente al iniciar
        setTimeout(() => checkForNewNotifications(), 1000);
        
        // Luego cada 15 segundos
        autoRefreshInterval = setInterval(() => {
            checkForNewNotifications();
        }, 15000); // 15 segundos
        
        console.log('üîÑ Sistema de actualizaci√≥n autom√°tica iniciado (15s)');
    }

    function stopAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
            console.log('‚èπÔ∏è Sistema de actualizaci√≥n autom√°tica detenido');
        }
    }

    async function checkForNewNotifications() {
        try {
            console.log('üîç Verificando nuevas notificaciones...');
            
            const response = await fetch(`${API_BASE_URL}/notificaciones/?no_leidas=true&limite=100&_t=${Date.now()}`, {
                credentials: 'include',
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    const newNotifications = data.notificaciones;
                    console.log(`üìä Notificaciones actuales: ${newNotifications.length}`);
                    
                    const hasNewNotifications = checkForNewNotificationsSinceLastUpdate(newNotifications);
                    
                    if (hasNewNotifications) {
                        console.log('üéØ ¬°Nuevas notificaciones encontradas!');
                        showAutoRefreshIndicator();
                        updateNewNotificationsBadge();
                        
                        // Recargar datos completos despu√©s de un breve delay
                        setTimeout(() => {
                            loadAllData().then(() => {
                                console.log('‚úÖ Datos actualizados despu√©s de nuevas notificaciones');
                                hideAutoRefreshIndicator();
                            });
                        }, 500);
                    } else {
                        console.log('‚ÑπÔ∏è No hay notificaciones nuevas');
                    }
                }
            }
        } catch (error) {
            console.log('‚ùå Error verificando nuevas notificaciones:', error);
        }
    }

    function checkForNewNotificationsSinceLastUpdate(newNotifications) {
        if (!lastUpdateTime) {
            console.log('‚è∞ Primera verificaci√≥n, estableciendo tiempo inicial');
            lastUpdateTime = new Date();
            return false;
        }
        
        console.log(`‚è∞ √öltima actualizaci√≥n: ${lastUpdateTime}`);
        
        let hasNew = false;
        
        newNotifications.forEach(notif => {
            try {
                // Parsear la fecha correctamente
                let notifTime;
                if (notif.fecha_creacion_formateada) {
                    // Formato: "dd/mm/yyyy HH:MM"
                    const [datePart, timePart] = notif.fecha_creacion_formateada.split(' ');
                    const [day, month, year] = datePart.split('/');
                    const [hours, minutes] = timePart.split(':');
                    notifTime = new Date(year, month - 1, day, hours, minutes);
                } else if (notif.fecha_creacion) {
                    // Formato ISO
                    notifTime = new Date(notif.fecha_creacion);
                } else {
                    notifTime = new Date();
                }
                
                console.log(`üìÖ Notificaci√≥n: ${notifTime} vs ${lastUpdateTime} - ${notifTime > lastUpdateTime ? 'NUEVA' : 'vieja'}`);
                
                if (notifTime > lastUpdateTime) {
                    hasNew = true;
                }
            } catch (error) {
                console.error('Error procesando fecha:', error);
            }
        });
        
        return hasNew;
    }

    function showAutoRefreshIndicator() {
        const indicator = document.getElementById('autoRefreshIndicator');
        if (indicator) {
            indicator.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Actualizando notificaciones...';
            indicator.style.display = 'flex';
        }
    }

    function hideAutoRefreshIndicator() {
        const indicator = document.getElementById('autoRefreshIndicator');
        if (indicator) {
            indicator.style.display = 'none';
        }
    }

    function updateNewNotificationsBadge() {
        const badge = document.getElementById('new-notification-badge');
        if (badge) {
            badge.style.display = 'inline-flex';
            badge.textContent = '!';
            badge.style.animation = 'pulse 1s infinite';
        }
    }

    function resetNewNotificationsBadge() {
        const badge = document.getElementById('new-notification-badge');
        if (badge) {
            badge.style.display = 'none';
            badge.style.animation = 'none';
        }
        lastUpdateTime = new Date();
        console.log('üîÑ Badge reiniciado, nuevo lastUpdateTime:', lastUpdateTime);
    }

    // ===== SISTEMA MEJORADO DE ALERTAS EN TIEMPO REAL =====
    class RealTimeAlertSystem {
        constructor() {
            this.alertContainer = document.getElementById('alertContainer');
            this.displayedIds = new Set();
            this.setupRealTimeSystem();
        }

        setupRealTimeSystem() {
            // Verificar alertas cada 10 segundos
            setInterval(() => this.checkForAlerts(), 1000);
            
            // Verificar cuando la p√°gina se activa
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    console.log('üì± P√°gina visible, verificando alertas...');
                    this.checkForAlerts();
                }
            });
            
            // Verificaci√≥n inicial despu√©s de 3 segundos
            setTimeout(() => this.checkForAlerts(), 3000);
        }

        async checkForAlerts() {
            try {
                console.log('üîî Verificando alertas en tiempo real...');
                
                const response = await fetch(`${API_BASE_URL}/notificaciones/?no_leidas=true&limite=10&_t=${Date.now()}`, {
                    credentials: 'include',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.notificaciones && data.notificaciones.length > 0) {
                        console.log(`üì® ${data.notificaciones.length} notificaciones encontradas`);
                        
                        // Filtrar solo las no mostradas
                        const newNotifications = data.notificaciones.filter(notification => 
                            !this.displayedIds.has(notification.id)
                        );
                        
                        console.log(`üéØ ${newNotifications.length} nuevas alertas para mostrar`);
                        
                        // Mostrar nuevas alertas
                        newNotifications.forEach(notification => {
                            this.displayedIds.add(notification.id);
                            this.showAlert(notification);
                        });
                    } else {
                        console.log('üì≠ No hay notificaciones nuevas');
                    }
                }
            } catch (error) {
                console.error('‚ùå Error verificando alertas:', error);
            }
        }

        showAlert(notification) {
            const alertId = `alert-${notification.id}`;
            
            const alertHTML = `
                <div id="${alertId}" class="alert-notification" 
                     onclick="realTimeAlertSystem.handleAlertClick('${alertId}', ${notification.id})"
                     style="border-left-color: ${this.getPriorityColor(notification.tipo)};">
                    <div style="display: flex; align-items: start; gap: 8px;">
                        <div style="font-size: 18px; flex-shrink: 0; margin-top: 2px;">
                            ${this.getIcon(notification.tipo)}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px; color: var(--text-primary); line-height: 1.3;">
                                ${notification.titulo}
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.3;">
                                ${notification.mensaje}
                            </div>
                            <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">
                                ${notification.fecha_creacion_formateada || 'Ahora'}
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); realTimeAlertSystem.closeAlert('${alertId}')" 
                                style="background: none; border: none; font-size: 16px; cursor: pointer; color: var(--text-tertiary); padding: 4px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">
                            √ó
                        </button>
                    </div>
                </div>
            `;

            this.alertContainer.insertAdjacentHTML('afterbegin', alertHTML);
            
            // Reproducir sonido
            this.playNotificationSound();
            
            // Vibrar si est√° disponible
            this.vibrateIfAvailable();
            
            // Auto-cerrar despu√©s de 8 segundos
            setTimeout(() => this.closeAlert(alertId), 8000);
            
            // Actualizar el badge de nuevas notificaciones
            updateNewNotificationsBadge();
        }

        handleAlertClick(alertId, notificationId) {
            console.log('üëÜ Alerta clickeada:', alertId);
            this.closeAlert(alertId);
            
            // Marcar como le√≠da en el servidor
            this.markNotificationAsRead(notificationId);
            
            // Recargar notificaciones para actualizar estado
            setTimeout(() => {
                loadAllData();
                resetNewNotificationsBadge(); // Resetear badge cuando el usuario interact√∫a
            }, 500);
        }

        async markNotificationAsRead(notificationId) {
            try {
                await fetch(`${API_BASE_URL}/notificaciones/${notificationId}/marcar-leida/`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                console.log('‚úÖ Notificaci√≥n marcada como le√≠da:', notificationId);
            } catch (error) {
                console.error('‚ùå Error marcando notificaci√≥n como le√≠da:', error);
            }
        }

        closeAlert(alertId) {
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.style.animation = 'slideOutRight 0.3s ease-in forwards';
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 300);
            }
        }

        vibrateIfAvailable() {
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }
        }

        getIcon(tipo) {
            const icons = {
                'reserva_aprobada': '<i class="bi bi-check-circle-fill"></i>',
                'reserva_rechazada': '<i class="bi bi-x-circle-fill"></i>',
                'reserva_creada': '<i class="bi bi-file-earmark-plus-fill"></i>',
                'reserva_cancelada': '<i class="bi bi-file-earmark-x-fill"></i>',
                'reserva_pendiente': '<i class="bi bi-clock-fill"></i>'
            };
            return icons[tipo] || '<i class="bi bi-bell-fill"></i>';
        }

        getPriorityColor(tipo) {
            const colors = {
                'reserva_aprobada': '#28a745',
                'reserva_rechazada': '#dc3545',
                'reserva_creada': '#0056d2',
                'reserva_cancelada': '#6c757d',
                'reserva_pendiente': '#ffc107'
            };
            return colors[tipo] || '#6c757d';
        }

        playNotificationSound() {
            try {
                // Sonido de notificaci√≥n simple
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.log('No se pudo reproducir sonido:', error);
            }
        }
    }

    // ===== FUNCIONES PRINCIPALES (MANTENIDAS DEL BACKEND) =====
    async function probarConexion() {
      const statusElement = document.getElementById('system-status');
      const dataSourceElement = document.getElementById('data-source');
      
      statusElement.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Conectando a la API...';
      
      try {
        const response = await fetch(`${API_BASE_URL}/reservas/`, {
          credentials: 'include'
        });
        
        if (response.ok) {
          const data = await response.json();
          statusElement.innerHTML = `<i class="bi bi-check-circle-fill"></i> Conexi√≥n exitosa! Se encontraron ${data.length} reservas REALES en la BD`;
          dataSourceElement.innerHTML = `<i class="bi bi-database"></i> Base de datos PostgreSQL (${data.length} reservas)`;
          
          console.log('üìä DATOS REALES DE LA BASE DE DATOS:', data);
          
          return data;
        } else {
          throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
      } catch (error) {
        statusElement.innerHTML = `<i class="bi bi-x-circle-fill"></i> Error de conexi√≥n: ${error.message}`;
        dataSourceElement.innerHTML = 'No se pudieron cargar los datos de la base de datos.';
        throw error;
      }
    }

    async function loadAllData() {
        try {
            console.log('üîÑ Cargando todos los datos...');
            
            // Cargar notificaciones del sistema PRIMERO
            const notificacionesSistema = await loadUserNotifications();
            
            // Generar notificaciones desde reservas
            const reservasReales = await loadUserReservas();
            const notificationsFromReservas = generateNotificationsFromRealData(reservasReales);
            
            // Combinar notificaciones
            allNotifications = [
                ...notificationsFromReservas,
                ...notificacionesSistema.map(notif => ({
                    id: `sys-${notif.id}`,
                    type: notif.tipo,
                    class: getNotificationClass(notif.tipo),
                    title: `${this.getIcon(notif.tipo)} ${getNotificationTitle(notif.tipo)}`,
                    message: notif.mensaje,
                    timestamp: notif.fecha_creacion,
                    read: notif.leida,
                    actions: [
                        { text: '<i class="bi bi-check"></i> Marcar como le√≠da', class: 'btn-secondary', action: 'mark-read' }
                    ],
                    notificationData: notif
                }))
            ];
            
            // Actualizar lastUpdateTime despu√©s de cargar
            lastUpdateTime = new Date();
            console.log('‚è∞ lastUpdateTime actualizado:', lastUpdateTime);
            
            // Renderizar con el filtro actual
            renderNotifications(allNotifications, currentFilter);
            
            console.log(`‚úÖ Datos cargados: ${reservasReales.length} reservas, ${notificacionesSistema.length} notificaciones sistema`);
            
        } catch (error) {
            console.error('‚ùå Error cargando datos:', error);
            document.getElementById('notifications-container').innerHTML = `
                <div class="error-state">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>No se pudieron cargar los datos reales</strong><br>
                    ${error.message}<br>
                    <small>Verifica que el servidor Django est√© corriendo en http://127.0.0.1:8000</small>
                    <button class="refresh-btn" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise"></i> Reintentar
                    </button>
                </div>
            `;
        }
    }

    // Funci√≥n para cargar reservas del usuario
    async function loadUserReservas() {
      try {
        const response = await fetch(`${API_BASE_URL}/reservas/`, {
          credentials: 'include'
        });
        
        if (response.ok) {
          const data = await response.json();
          return data.reservas || data || [];
        }
        return [];
      } catch (error) {
        console.error('Error cargando reservas:', error);
        return [];
      }
    }

    // Funci√≥n para cargar notificaciones del sistema
    async function loadUserNotifications() {
      try {
        const response = await fetch(`${API_BASE_URL}/notificaciones/?limite=50`, {
          credentials: 'include'
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            return data.notificaciones;
          }
        }
        return [];
      } catch (error) {
        console.error('Error cargando notificaciones:', error);
        return [];
      }
    }

    // ===== FUNCIONES DE RENDERIZADO =====
    function formatFecha(fecha) {
      if (!fecha) return 'Fecha no especificada';
      const partes = fecha.split('-');
      if (partes.length === 3) {
        return `${partes[2]}/${partes[1]}/${partes[0]}`;
      }
      return fecha;
    }

    function formatHora(hora) {
      if (!hora) return 'Hora no especificada';
      return hora.substring(0, 5);
    }

    function formatRelativeTime(dateString) {
      try {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return `Hace unos segundos`;
        if (diffMins < 60) return `Hace ${diffMins} minutos`;
        if (diffHours < 24) return `Hace ${diffHours} horas`;
        if (diffDays === 1) return `Ayer`;
        return `Hace ${diffDays} d√≠as`;
      } catch (error) {
        return 'Fecha no disponible';
      }
    }

    // Generar notificaciones desde datos REALES
    function generateNotificationsFromRealData(reservas) {
      console.log('üîÑ Generando notificaciones desde datos REALES:', reservas);
      
      const notificationsFromReservas = reservas.map(reserva => {
        const espacioNombre = reserva.espacio_nombre || reserva.espacio || 'Espacio no especificado';
        const fechaFormateada = formatFecha(reserva.fecha_reserva || reserva.fecha);
        const horaInicio = formatHora(reserva.hora_inicio);
        const horaFin = formatHora(reserva.hora_fin);
        const estado = reserva.estado || 'Pendiente';
        
        let mensaje = '';
        let clase = '';
        let icon = '';
        
        switch(estado) {
          case 'Pendiente':
            mensaje = `Tu solicitud para <strong>${espacioNombre}</strong> el <strong>${fechaFormateada}</strong> de <strong>${horaInicio} - ${horaFin}</strong> est√° en revisi√≥n.`;
            clase = 'pendiente';
            icon = '<i class="bi bi-clock"></i>';
            break;
          case 'Aprobada':
            mensaje = `¬°Tu reserva para <strong>${espacioNombre}</strong> el <strong>${fechaFormateada}</strong> de <strong>${horaInicio} - ${horaFin}</strong> ha sido aprobada!`;
            clase = 'aprobada';
            icon = '<i class="bi bi-check-circle"></i>';
            break;
          case 'Rechazada':
            mensaje = `Tu reserva para <strong>${espacioNombre}</strong> el <strong>${fechaFormateada}</strong> ha sido rechazada.`;
            clase = 'rechazada';
            icon = '<i class="bi bi-x-circle"></i>';
            break;
        }
        
        return {
          id: reserva.id,
          type: estado.toLowerCase(),
          class: clase,
          title: `${icon} ${estado === 'Pendiente' ? 'Solicitud de Reserva' : 'Reserva'} <span class="badge badge-${estado.toLowerCase()}">${estado}</span>`,
          message: mensaje,
          timestamp: reserva.fecha_solicitud || new Date().toISOString(),
          read: false,
          actions: [
            { text: '<i class="bi bi-eye"></i> Ver detalles', class: 'btn-primary', action: 'view' },
            ...(estado === 'Pendiente' ? [{ text: '<i class="bi bi-trash"></i> Cancelar reserva', class: 'btn-danger', action: 'cancel' }] : [])
          ],
          reservaData: reserva
        };
      });

      return notificationsFromReservas;
    }

    function renderNotifications(notifications, filter = 'all') {
      const container = document.getElementById('notifications-container');
      const countElement = document.getElementById('notification-count');
      
      let filteredNotifications = notifications;
      
      switch(filter) {
        case 'pending':
          filteredNotifications = notifications.filter(n => n.type === 'pendiente');
          break;
        case 'approved':
          filteredNotifications = notifications.filter(n => n.type === 'aprobada');
          break;
        case 'rejected':
          filteredNotifications = notifications.filter(n => n.type === 'rechazada');
          break;
      }
      
      countElement.textContent = filteredNotifications.length;
      
      if (filteredNotifications.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="bi bi-bell-slash" style="font-size: 48px; margin-bottom: 16px;"></i>
            <p>No hay notificaciones ${filter !== 'all' ? 'de ' + filter : ''}</p>
            <p><small><i class="bi bi-database"></i> Los datos se cargan directamente desde la base de datos PostgreSQL</small></p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = filteredNotifications.map(notif => `
        <div class="notification ${notif.class} ${!notif.read ? 'unread' : ''}">
          <b>${notif.title}</b>
          <p>${notif.message}</p>
          <small><i class="bi bi-clock"></i> ${formatRelativeTime(notif.timestamp)} - <em><i class="bi bi-database"></i> Datos reales de la BD</em></small>
          <div class="actions">
            ${notif.actions.map(action => 
              `<button class="${action.class}" data-action="${action.action}" data-reserva-id="${notif.id}">
                ${action.text}
              </button>`
            ).join('')}
          </div>
        </div>
      `).join('');
    }

    function getNotificationClass(tipo) {
      const classMap = {
        'reserva_aprobada': 'aprobada',
        'reserva_rechazada': 'rechazada',
        'reserva_creada': 'pendiente',
        'reserva_cancelada': 'rechazada',
        'reserva_pendiente': 'pendiente'
      };
      return classMap[tipo] || 'pendiente';
    }

    function getNotificationTitle(tipo) {
      const titleMap = {
        'reserva_aprobada': 'Reserva Aprobada',
        'reserva_rechazada': 'Reserva Rechazada',
        'reserva_creada': 'Nueva Reserva Creada',
        'reserva_cancelada': 'Reserva Cancelada',
        'reserva_pendiente': 'Reserva Pendiente'
      };
      return titleMap[tipo] || 'Notificaci√≥n del Sistema';
    }

    // ===== INICIALIZACI√ìN =====
    let realTimeAlertSystem;

    document.addEventListener('DOMContentLoaded', async function() {
      try {
        // Inicializar sistema de alertas
        realTimeAlertSystem = new RealTimeAlertSystem();
        
        // Cargar datos iniciales
        await loadAllData();
        
        // Iniciar sistema de actualizaci√≥n autom√°tica
        startAutoRefresh();
        
      } catch (error) {
        console.error('‚ùå Error inicializando:', error);
      }

      // Filtros
      document.querySelectorAll('.filters button').forEach(button => {
        button.addEventListener('click', function() {
          document.querySelectorAll('.filters button').forEach(btn => {
            btn.classList.remove('active');
          });
          this.classList.add('active');
          currentFilter = this.getAttribute('data-filter');
          renderNotifications(allNotifications, currentFilter);
        });
      });

      // Acciones de notificaciones
      document.addEventListener('click', function(e) {
        const button = e.target.closest('.actions button');
        if (button) {
          const action = button.getAttribute('data-action');
          const reservaId = button.getAttribute('data-reserva-id');
          const notificacion = allNotifications.find(n => n.id == reservaId);
          
          if (notificacion) {
            const reserva = notificacion.reservaData;
            const fechaFormateada = formatFecha(reserva.fecha_reserva);
            const horaInicio = formatHora(reserva.hora_inicio);
            const horaFin = formatHora(reserva.hora_fin);
            
            switch(action) {
              case 'view':
                alert(`üìã Detalles de la reserva (DESDE BASE DE DATOS):\n\nID: ${reserva.id}\nEspacio: ${reserva.espacio_nombre}\nFecha: ${fechaFormateada}\nHorario: ${horaInicio} - ${horaFin}\nEstado: ${reserva.estado}`);
                break;
              case 'cancel':
                if (confirm('¬øEst√°s seguro de que quieres cancelar esta reserva?')) {
                  alert('Funci√≥n de cancelaci√≥n (conectada a la API real)');
                }
                break;
              case 'mark-read':
                // Marcar notificaci√≥n como le√≠da
                const notificationElement = button.closest('.notification');
                notificationElement.classList.remove('unread');
                button.disabled = true;
                button.innerHTML = '<i class="bi bi-check-all"></i> ‚úì Le√≠da';
                break;
            }
          }
        }
      });

      // Manejo del men√∫ de usuario
      document.getElementById('userAvatar').addEventListener('click', function() {
        document.getElementById('logoutPanel').classList.toggle('active');
      });

      document.getElementById('logoutBtn').addEventListener('click', function() {
        document.getElementById('logoutPanel').classList.toggle('active');
      });

      // Cerrar men√∫ al hacer clic fuera
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.user-menu')) {
          document.getElementById('logoutPanel').classList.remove('active');
        }
      });

      // Detener actualizaci√≥n autom√°tica cuando la p√°gina no est√° visible
      document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
          stopAutoRefresh();
        } else {
          startAutoRefresh();
          setTimeout(() => realTimeAlertSystem.checkForAlerts(), 1000);
        }
      });

      // Toggles de preferencias
      document.querySelectorAll('.toggle').forEach(toggle => {
        toggle.addEventListener('click', function() {
          this.classList.toggle('active');
        });
      });
    });
  </script>
  <script src="{% static 'js/theme.js' %}"></script>
</body>
</html>
============================================================


===== notificaciones_admin.html =====
<!DOCTYPE html>
<html lang="es">
<head>
  {% include 'reservas/_icons.html' %}
  {% include 'reservas/_theme_snippet.html' %}
  {% load static %}
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notificaciones Administrador - Sistema de Reservas</title>
  <!-- Bootstrap 5 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ENjdO4Dr2bkBIFxQpeoA6DQD5N2Q6F0n6U8U6p6YkE9j6M9g6t5F5F5F5F5F5F5F5" crossorigin="anonymous">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    /* Variables CSS para temas */
    :root {
      --bg-primary: #18191a;
      --bg-secondary: #23272f;
      --bg-tertiary: #2d3748;
      --text-primary: #ffffff;
      --text-secondary: #e5e7eb;
      --text-tertiary: #9ca3af;
      --border-color: #4b5563;
      --primary-color: #2563eb;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #dc3545;
      --admin-color: #8b5cf6;
      --card-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }

    [data-theme="light"] {
      --bg-primary: #f9fafb;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f3f4f6;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --text-tertiary: #9ca3af;
      --border-color: #e5e7eb;
      --primary-color: #2563eb;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #dc3545;
      --admin-color: #7c3aed;
      --card-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Header Administrativo */
    .header {
      width: 100%;
      background: var(--bg-secondary);
      color: var(--text-primary);
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--card-shadow);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      height: 64px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .header-content {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 32px;
    }
    
    .logo-section {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 22px;
      font-weight: 700;
    }
    
    .admin-badge {
      background: var(--admin-color);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-left: 8px;
    }
    
    .nav-menu {
      display: flex;
      gap: 24px;
    }
    
    .nav-item {
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 500;
      padding: 8px 16px;
      border-radius: 8px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .nav-item:hover, .nav-item.active {
      color: var(--admin-color);
      background: var(--bg-tertiary);
    }
    
    .user-menu {
      display: flex;
      align-items: center;
      gap: 16px;
      position: relative;
    }
    
    .user-avatar {
      font-size: 22px;
      color: var(--admin-color);
      cursor: pointer;
    }
    
    .user-name {
      font-size: 15px;
      color: var(--text-primary);
      font-weight: 500;
    }
    
    .logout-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 20px;
      cursor: pointer;
      margin-left: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }
    
    .logout-btn:hover {
      background: var(--bg-tertiary);
      color: var(--admin-color);
    }
    
    .logout-panel {
      display: none;
      position: absolute;
      top: 48px;
      right: 0;
      background: var(--bg-secondary);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      min-width: 180px;
      z-index: 200;
      border: 1px solid var(--border-color);
    }
    
    .logout-panel.active {
      display: block;
    }
    
    .panel-item {
      padding: 12px 20px;
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
      border-bottom: 1px solid var(--border-color);
    }
    
    .panel-item:hover {
      background: var(--admin-color);
      color: white;
    }
    
    .panel-item:last-child {
      border-bottom: none;
    }

    .container {
      width: 70%;
      padding: 20px;
      margin: 0 auto;
    }

    h2 {
      margin-bottom: 15px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Estad√≠sticas Administrativas */
    .admin-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .stat-icon {
      font-size: 24px;
      margin-bottom: 10px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Filtros Mejorados */
    .filters {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filters button {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 500;
    }

    .filters button:hover {
      background: var(--admin-color);
      color: white;
      transform: translateY(-1px);
    }

    .filters button.active {
      background: var(--admin-color);
      color: white;
    }

    /* Notificaciones Mejoradas */
    .notification {
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 16px;
      border-left: 6px solid;
      display: block;
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
      border: 1px solid var(--border-color);
    }

    .notification:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .admin { 
      border-color: var(--admin-color);
      border-left-color: var(--admin-color);
    }
    
    .critico { 
      border-color: var(--danger-color);
      border-left-color: var(--danger-color);
    }
    
    .alerta { 
      border-color: var(--warning-color);
      border-left-color: var(--warning-color);
    }
    
    .informacion { 
      border-color: var(--primary-color);
      border-left-color: var(--primary-color);
    }

    .notification.unread {
      background: var(--bg-tertiary);
      border-left-width: 8px;
    }

    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .notification-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .notification b {
      color: var(--text-primary);
      font-size: 16px;
      margin-bottom: 8px;
      display: block;
    }

    .notification p {
      color: var(--text-secondary);
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 8px;
    }

    .notification small {
      color: var(--text-tertiary);
      display: block;
      margin-top: 8px;
      font-size: 12px;
    }

    .user-info {
      background: var(--bg-tertiary);
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* Acciones Administrativas */
    .admin-actions {
      margin-top: 15px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .admin-actions button {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .admin-actions button:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .btn-admin { 
      background: var(--admin-color); 
      color: white; 
    }
    
    .btn-danger { 
      background: var(--danger-color); 
      color: white; 
    }
    
    .btn-success { 
      background: var(--success-color); 
      color: white; 
    }
    
    .btn-warning { 
      background: var(--warning-color); 
      color: var(--text-primary); 
    }
    
    .btn-secondary { 
      background: var(--bg-tertiary); 
      color: var(--text-primary); 
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--admin-color);
      color: white;
    }

    /* Sidebar Administrativo */
    .sidebar {
      position: fixed;
      right: 20px;
      top: 84px;
      width: 300px;
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border-color);
    }

    .sidebar h3 {
      color: var(--text-primary);
      margin-bottom: 20px;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Sistema de Alertas */
    .alert-system {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .alert-preference {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .alert-preference:last-child {
      border-bottom: none;
    }

    .alert-preference span {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .toggle {
      width: 44px;
      height: 24px;
      background: var(--border-color);
      border-radius: 15px;
      position: relative;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle::after {
      content: "";
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: 0.3s;
    }

    .toggle.active {
      background: var(--success-color);
    }

    .toggle.active::after {
      left: 22px;
    }

    /* Estados de carga y vac√≠o */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-tertiary);
      font-size: 16px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-tertiary);
      background: var(--bg-secondary);
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .empty-state p {
      font-size: 16px;
      margin-bottom: 8px;
    }

    .empty-state small {
      font-size: 14px;
    }

    .error-state {
      text-align: center;
      padding: 30px;
      color: var(--danger-color);
      background: rgba(220, 53, 69, 0.1);
      border-radius: 8px;
      margin: 10px 0;
      border: 1px solid rgba(220, 53, 69, 0.2);
    }

    .refresh-btn {
      background: var(--admin-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 15px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .refresh-btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    /* Badges Mejorados */
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }

    .badge-admin { 
      background: rgba(139, 92, 246, 0.2); 
      color: var(--admin-color); 
      border: 1px solid rgba(139, 92, 246, 0.3);
    }
    
    .badge-critico { 
      background: rgba(220, 53, 69, 0.2); 
      color: var(--danger-color); 
      border: 1px solid rgba(220, 53, 69, 0.3);
    }
    
    .badge-alerta { 
      background: rgba(245, 158, 11, 0.2); 
      color: var(--warning-color); 
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    /* Indicador de actualizaci√≥n autom√°tica */
    .auto-refresh-indicator {
      background: rgba(16, 185, 129, 0.2);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 8px;
      padding: 12px 16px;
      margin: 10px 0;
      font-size: 14px;
      color: var(--success-color);
      display: none;
      align-items: center;
      gap: 8px;
    }

    .new-notification-badge {
      background: var(--danger-color);
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      margin-left: 10px;
      font-weight: 600;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* Alertas en tiempo real */
    .alert-container {
      position: fixed;
      top: 70px;
      right: 20px;
      z-index: 9999;
      max-width: 400px;
    }

    .alert-notification {
      background: var(--bg-secondary);
      border-left: 4px solid;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slideInRight 0.3s ease-out;
      cursor: pointer;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }

    .alert-notification:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideOutRight {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }

    /* Bot√≥n de notificaci√≥n en header */
    .notification-btn {
      position: relative;
      background: none;
      border: none;
      font-size: 22px;
      cursor: pointer;
      color: var(--admin-color);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .notification-btn:hover {
      background: var(--bg-tertiary);
      transform: scale(1.1);
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .container {
        width: 85%;
      }
      
      .sidebar {
        position: static;
        width: 100%;
        margin-top: 30px;
      }
    }

    @media (max-width: 992px) {
      .container {
        width: 90%;
      }
      
      .header-content {
        flex-wrap: wrap;
        gap: 16px;
      }
      
      .nav-menu {
        order: 3;
        width: 100%;
        justify-content: center;
        gap: 16px;
      }
    }

    @media (max-width: 768px) {
      .container {
        width: 95%;
        padding: 15px;
      }
      
      .header {
        padding: 0 16px;
        height: 60px;
      }
      
      .nav-menu {
        display: none;
      }
      
      .filters {
        justify-content: center;
      }
      
      .admin-actions {
        justify-content: center;
      }
      
      .admin-stats {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <link id="darkCss" rel="stylesheet" href="{% static 'css/dark.css' %}" disabled>
</head>
<body> 
  <!-- Header Administrativo -->
  <header class="header">
    <div class="header-content">
      <div class="logo-section">
        <div class="logo"><i class="bi bi-shield-check"></i></div>
        <div style="color: var(--text-primary);">
          Panel Administrativo
          <span class="admin-badge">Admin</span>
        </div>
      </div>
      <nav class="nav-menu">
        <a href="{% url 'admin_dashboard' %}" class="nav-item">
          <i class="bi bi-speedometer2"></i> Dashboard
        </a>
        <a href="{% url 'solicitudes_pendientes' %}" class="nav-item">
          <i class="bi bi-clock"></i> Solicitudes
        </a>
        <a href="{% url 'gestion_espacios' %}" class="nav-item">
          <i class="bi bi-door-open"></i> Espacios
        </a>
        <a href="{% url 'gestion_usuarios' %}" class="nav-item">
          <i class="bi bi-people"></i> Usuarios
        </a>
        <a href="{% url 'notificaciones_admin' %}" class="nav-item active">
          <i class="bi bi-bell-fill"></i> Notificaciones
        </a>
      </nav>
      <div class="user-menu" id="userMenu">
        <button class="notification-btn" id="notificationBtn">
          <i class="bi bi-bell"></i>
          <span id="notifBadge" style="display:none;position:absolute;top:2px;right:2px;background:var(--danger-color);color:#fff;font-size:11px;padding:2px 6px;border-radius:10px;min-width:18px;height:18px;display:flex;align-items:center;justify-content:center;">0</span>
        </button>
        <div class="user-avatar" id="userAvatar">
          <i class="bi bi-person-badge"></i>
        </div>
        <span class="user-name">
          {% if user.first_name %}{{ user.first_name }} {{ user.last_name }}
          {% else %}{{ user.username }}
          {% endif %}
        </span>
        <button class="logout-btn" id="logoutBtn" title="Cerrar sesi√≥n">
          <i class="bi bi-box-arrow-right"></i>
        </button>
        <div class="logout-panel" id="logoutPanel">
          <div class="panel-item" onclick="window.location.href='{% url 'admin_dashboard' %}'">
            <i class="bi bi-speedometer2"></i> Dashboard
          </div>
          <div class="panel-item" onclick="window.location.href='{% url 'logout' %}'">
            <i class="bi bi-box-arrow-right"></i> Cerrar sesi√≥n
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Contenido Principal -->
  <div class="container">
    <h2>
      <i class="bi bi-shield-check"></i> Notificaciones Administrativas 
      (<span id="notification-count">0</span>
      <span id="new-notification-badge" class="new-notification-badge" style="display: none;">!</span>)
    </h2>

    <!-- Estad√≠sticas Administrativas -->
    <div class="admin-stats">
      <div class="stat-card">
        <div class="stat-icon" style="color: var(--admin-color);">
          <i class="bi bi-bell-fill"></i>
        </div>
        <div class="stat-value" id="total-notifications">0</div>
        <div class="stat-label">Total Notificaciones</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="color: var(--danger-color);">
          <i class="bi bi-exclamation-triangle-fill"></i>
        </div>
        <div class="stat-value" id="critical-notifications">0</div>
        <div class="stat-label">Cr√≠ticas</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="color: var(--warning-color);">
          <i class="bi bi-clock-history"></i>
        </div>
        <div class="stat-value" id="pending-notifications">0</div>
        <div class="stat-label">Pendientes</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="color: var(--success-color);">
          <i class="bi bi-check-circle-fill"></i>
        </div>
        <div class="stat-value" id="resolved-notifications">0</div>
        <div class="stat-label">Resueltas</div>
      </div>
    </div>

    <!-- Indicador de actualizaci√≥n autom√°tica -->
    <div id="autoRefreshIndicator" class="auto-refresh-indicator">
      <i class="bi bi-arrow-clockwise"></i> Actualizando notificaciones...
    </div>

    <!-- Filtros B√°sicos -->
    <div class="filters">
      <button class="active" data-filter="all">
        <i class="bi bi-funnel"></i> Todas
      </button>
      <button data-filter="critical">
        <i class="bi bi-exclamation-triangle"></i> Cr√≠ticas
      </button>
      <button data-filter="alerts">
        <i class="bi bi-bell"></i> Alertas
      </button>
      <button data-filter="unread">
        <i class="bi bi-envelope"></i> No le√≠das
      </button>
    </div>

    <!-- Contenedor de notificaciones -->
    <div id="notifications-container">
      <div class="loading">
        <i class="bi bi-hourglass-split"></i> Cargando notificaciones administrativas...
      </div>
    </div>
  </div>

  <!-- Sidebar Administrativo -->
  <div class="sidebar">
    <h3><i class="bi bi-gear"></i> Configuraci√≥n</h3>
    
    <div class="alert-system">
      <h4><i class="bi bi-bell"></i> Sistema de Alertas</h4>
      <div class="alert-preference">
        <span>Alertas en tiempo real</span>
        <div class="toggle active" id="realtimeToggle"></div>
      </div>
      <div class="alert-preference">
        <span>Notificaciones por email</span>
        <div class="toggle active" id="emailToggle"></div>
      </div>
      <div class="alert-preference">
        <span>Alertas cr√≠ticas</span>
        <div class="toggle active" id="criticalToggle"></div>
      </div>
    </div>

    <div style="margin-top: 20px;">
      <h4><i class="bi bi-graph-up"></i> Reportes</h4>
      <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 12px;">
        <button class="btn-secondary" onclick="generarReporte('diario')">
          <i class="bi bi-file-earmark-text"></i> Reporte Diario
        </button>
        <button class="btn-secondary" onclick="generarReporte('semanal')">
          <i class="bi bi-file-earmark-text"></i> Reporte Semanal
        </button>
        <button class="btn-secondary" onclick="generarReporte('incidentes')">
          <i class="bi bi-exclamation-triangle"></i> Reporte de Incidentes
        </button>
      </div>
    </div>
  </div>

  <!-- Sistema de Alertas en Tiempo Real -->
  <div id="alertContainer" class="alert-container"></div>

  <!-- JavaScript Simplificado -->
  <script>
    // Configuraci√≥n
    const API_BASE_URL = 'http://127.0.0.1:8000/api';
    let allNotifications = [];
    let currentFilter = 'all';
    let lastUpdateTime = null;
    let autoRefreshInterval = null;

    // ===== SISTEMA DE ACTUALIZACI√ìN AUTOM√ÅTICA =====
    function startAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
        
        setTimeout(() => checkForNewNotifications(), 1000);
        
        autoRefreshInterval = setInterval(() => {
            checkForNewNotifications();
        }, 15000);
        
        console.log('üîÑ Sistema de actualizaci√≥n autom√°tica iniciado (15s)');
    }

    function stopAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
            console.log('‚èπÔ∏è Sistema de actualizaci√≥n autom√°tica detenido');
        }
    }

    async function checkForNewNotifications() {
        try {
            console.log('üîç Verificando nuevas notificaciones administrativas...');
            
            const response = await fetch(`${API_BASE_URL}/notificaciones-admin/?no_leidas=true&limite=100&_t=${Date.now()}`, {
                credentials: 'include',
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    const newNotifications = data.notificaciones;
                    console.log(`üìä Notificaciones actuales: ${newNotifications.length}`);
                    
                    const hasNewNotifications = checkForNewNotificationsSinceLastUpdate(newNotifications);
                    
                    if (hasNewNotifications) {
                        console.log('üéØ ¬°Nuevas notificaciones encontradas!');
                        showAutoRefreshIndicator();
                        updateNewNotificationsBadge();
                        
                        setTimeout(() => {
                            loadAllData().then(() => {
                                console.log('‚úÖ Datos actualizados despu√©s de nuevas notificaciones');
                                hideAutoRefreshIndicator();
                            });
                        }, 500);
                    } else {
                        console.log('‚ÑπÔ∏è No hay notificaciones nuevas');
                    }
                }
            }
        } catch (error) {
            console.log('‚ùå Error verificando nuevas notificaciones:', error);
        }
    }

    function checkForNewNotificationsSinceLastUpdate(newNotifications) {
        if (!lastUpdateTime) {
            console.log('‚è∞ Primera verificaci√≥n, estableciendo tiempo inicial');
            lastUpdateTime = new Date();
            return false;
        }
        
        console.log(`‚è∞ √öltima actualizaci√≥n: ${lastUpdateTime}`);
        
        let hasNew = false;
        
        newNotifications.forEach(notif => {
            try {
                let notifTime;
                if (notif.fecha_creacion_formateada) {
                    const [datePart, timePart] = notif.fecha_creacion_formateada.split(' ');
                    const [day, month, year] = datePart.split('/');
                    const [hours, minutes] = timePart.split(':');
                    notifTime = new Date(year, month - 1, day, hours, minutes);
                } else if (notif.fecha_creacion) {
                    notifTime = new Date(notif.fecha_creacion);
                } else {
                    notifTime = new Date();
                }
                
                console.log(`üìÖ Notificaci√≥n: ${notifTime} vs ${lastUpdateTime} - ${notifTime > lastUpdateTime ? 'NUEVA' : 'vieja'}`);
                
                if (notifTime > lastUpdateTime) {
                    hasNew = true;
                }
            } catch (error) {
                console.error('Error procesando fecha:', error);
            }
        });
        
        return hasNew;
    }

    function showAutoRefreshIndicator() {
        const indicator = document.getElementById('autoRefreshIndicator');
        if (indicator) {
            indicator.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Actualizando notificaciones...';
            indicator.style.display = 'flex';
        }
    }

    function hideAutoRefreshIndicator() {
        const indicator = document.getElementById('autoRefreshIndicator');
        if (indicator) {
            indicator.style.display = 'none';
        }
    }

    function updateNewNotificationsBadge() {
        const badge = document.getElementById('new-notification-badge');
        if (badge) {
            badge.style.display = 'inline-flex';
            badge.textContent = '!';
            badge.style.animation = 'pulse 1s infinite';
        }
    }

    function resetNewNotificationsBadge() {
        const badge = document.getElementById('new-notification-badge');
        if (badge) {
            badge.style.display = 'none';
            badge.style.animation = 'none';
        }
        lastUpdateTime = new Date();
        console.log('üîÑ Badge reiniciado, nuevo lastUpdateTime:', lastUpdateTime);
    }

    // ===== SISTEMA DE ALERTAS EN TIEMPO REAL =====
    class RealTimeAlertSystem {
        constructor() {
            this.alertContainer = document.getElementById('alertContainer');
            this.displayedIds = new Set();
            this.setupRealTimeSystem();
        }

        setupRealTimeSystem() {
            setInterval(() => this.checkForAlerts(), 1000);
            
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    console.log('üì± P√°gina visible, verificando alertas...');
                    this.checkForAlerts();
                }
            });
            
            setTimeout(() => this.checkForAlerts(), 3000);
        }

        async checkForAlerts() {
            try {
                console.log('üîî Verificando alertas administrativas...');
                
                const response = await fetch(`${API_BASE_URL}/notificaciones-admin/?no_leidas=true&limite=10&_t=${Date.now()}`, {
                    credentials: 'include',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.notificaciones && data.notificaciones.length > 0) {
                        console.log(`üì® ${data.notificaciones.length} notificaciones administrativas encontradas`);
                        
                        const newNotifications = data.notificaciones.filter(notification => 
                            !this.displayedIds.has(notification.id)
                        );
                        
                        console.log(`üéØ ${newNotifications.length} nuevas alertas para mostrar`);
                        
                        newNotifications.forEach(notification => {
                            this.displayedIds.add(notification.id);
                            this.showAlert(notification);
                        });
                    } else {
                        console.log('üì≠ No hay notificaciones nuevas');
                    }
                }
            } catch (error) {
                console.error('‚ùå Error verificando alertas:', error);
            }
        }

        showAlert(notification) {
            const alertId = `alert-${notification.id}`;
            
            const alertHTML = `
                <div id="${alertId}" class="alert-notification" 
                     onclick="realTimeAlertSystem.handleAlertClick('${alertId}', ${notification.id})"
                     style="border-left-color: ${this.getPriorityColor(notification.prioridad)};">
                    <div style="display: flex; align-items: start; gap: 8px;">
                        <div style="font-size: 20px; flex-shrink: 0; margin-top: 2px;">
                            ${this.getIcon(notification.tipo)}
                        </div>
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                <span style="font-weight: 700; font-size: 12px; color: ${this.getPriorityColor(notification.prioridad)}; text-transform: uppercase;">
                                    ${notification.prioridad || 'ALERTA'}
                                </span>
                                <span style="font-size: 11px; color: var(--text-tertiary);">
                                    <i class="bi bi-person"></i> ${notification.usuario || 'Sistema'}
                                </span>
                            </div>
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px; color: var(--text-primary); line-height: 1.3;">
                                ${notification.titulo}
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.3;">
                                ${notification.mensaje}
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); realTimeAlertSystem.closeAlert('${alertId}')" 
                                style="background: none; border: none; font-size: 16px; cursor: pointer; color: var(--text-tertiary); padding: 4px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">
                            √ó
                        </button>
                    </div>
                </div>
            `;

            this.alertContainer.insertAdjacentHTML('afterbegin', alertHTML);
            
            this.playNotificationSound();
            this.vibrateIfAvailable();
            
            setTimeout(() => this.closeAlert(alertId), 8000);
            
            updateNewNotificationsBadge();
        }

        handleAlertClick(alertId, notificationId) {
            console.log('üëÜ Alerta clickeada:', alertId);
            this.closeAlert(alertId);
            
            this.markNotificationAsRead(notificationId);
            
            setTimeout(() => {
                loadAllData();
                resetNewNotificationsBadge();
            }, 500);
        }

        async markNotificationAsRead(notificationId) {
            try {
                await fetch(`${API_BASE_URL}/notificaciones-admin/${notificationId}/marcar-leida/`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                console.log('‚úÖ Notificaci√≥n administrativa marcada como le√≠da:', notificationId);
            } catch (error) {
                console.error('‚ùå Error marcando notificaci√≥n como le√≠da:', error);
            }
        }

        closeAlert(alertId) {
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.style.animation = 'slideOutRight 0.3s ease-in forwards';
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 300);
            }
        }

        vibrateIfAvailable() {
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }
        }

        getIcon(tipo) {
            const icons = {
                'seguridad': '<i class="bi bi-shield-exclamation"></i>',
                'sistema': '<i class="bi bi-server"></i>',
                'reserva': '<i class="bi bi-calendar-event"></i>',
                'usuario': '<i class="bi bi-person-badge"></i>',
                'reporte': '<i class="bi bi-graph-up"></i>',
                'critico': '<i class="bi bi-exclamation-triangle-fill"></i>'
            };
            return icons[tipo] || '<i class="bi bi-bell-fill"></i>';
        }

        getPriorityColor(prioridad) {
            const colors = {
                'alta': '#dc3545',
                'media': '#f59e0b',
                'baja': '#2563eb',
                'critico': '#dc3545'
            };
            return colors[prioridad] || '#6c757d';
        }

        playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 1000;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.log('No se pudo reproducir sonido:', error);
            }
        }
    }

    // ===== FUNCIONES PRINCIPALES =====
    async function loadAllData() {
        try {
            console.log('üîÑ Cargando datos administrativos...');
            
            // Cargar notificaciones administrativas
            const notificacionesAdmin = await loadAdminNotifications();
            
            // Actualizar estad√≠sticas
            updateStatistics(notificacionesAdmin);
            
            // Generar notificaciones para mostrar
            allNotifications = generateAdminNotifications(notificacionesAdmin);
            
            // Actualizar lastUpdateTime despu√©s de cargar
            lastUpdateTime = new Date();
            console.log('‚è∞ lastUpdateTime actualizado:', lastUpdateTime);
            
            // Renderizar con el filtro actual
            renderNotifications(allNotifications, currentFilter);
            
            console.log(`‚úÖ Datos administrativos cargados: ${notificacionesAdmin.length} notificaciones`);
            
        } catch (error) {
            console.error('‚ùå Error cargando datos administrativos:', error);
            document.getElementById('notifications-container').innerHTML = `
                <div class="error-state">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>Error cargando datos administrativos</strong><br>
                    ${error.message}<br>
                    <button class="refresh-btn" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise"></i> Reintentar
                    </button>
                </div>
            `;
        }
    }

    // Funci√≥n para cargar notificaciones administrativas
    async function loadAdminNotifications() {
      try {
        const response = await fetch(`${API_BASE_URL}/notificaciones-admin/?limite=100`, {
          credentials: 'include'
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            return data.notificaciones || [];
          }
        }
        return [];
      } catch (error) {
        console.error('Error cargando notificaciones administrativas:', error);
        return [];
      }
    }

    function updateStatistics(notificaciones) {
        const total = notificaciones.length;
        const criticas = notificaciones.filter(n => n.prioridad === 'alta' || n.prioridad === 'critico').length;
        const pendientes = notificaciones.filter(n => !n.leida).length;
        const resueltas = notificaciones.filter(n => n.estado === 'resuelta').length;
        
        document.getElementById('total-notifications').textContent = total;
        document.getElementById('critical-notifications').textContent = criticas;
        document.getElementById('pending-notifications').textContent = pendientes;
        document.getElementById('resolved-notifications').textContent = resueltas;
        
        document.getElementById('notification-count').textContent = total;
    }

    function generateAdminNotifications(notificaciones) {
        console.log('üîÑ Generando notificaciones administrativas:', notificaciones);
        
        return notificaciones.map(notif => {
            const tipo = notif.tipo || 'sistema';
            const prioridad = notif.prioridad || 'media';
            const usuario = notif.usuario_nombre || notif.usuario || 'Sistema';
            
            let clase = 'informacion';
            let icon = '<i class="bi bi-info-circle"></i>';
            
            if (prioridad === 'alta' || prioridad === 'critico') {
                clase = 'critico';
                icon = '<i class="bi bi-exclamation-triangle-fill"></i>';
            } else if (prioridad === 'media') {
                clase = 'alerta';
                icon = '<i class="bi bi-exclamation-circle"></i>';
            } else if (tipo === 'admin') {
                clase = 'admin';
                icon = '<i class="bi bi-shield-check"></i>';
            }
            
            return {
                id: notif.id,
                type: tipo,
                priority: prioridad,
                class: clase,
                title: `${icon} ${notif.titulo} <span class="badge badge-${clase}">${prioridad.toUpperCase()}</span>`,
                message: notif.mensaje,
                timestamp: notif.fecha_creacion || new Date().toISOString(),
                read: notif.leida,
                usuario: usuario,
                estado: notif.estado || (notif.leida ? 'leida' : 'pendiente'),
                fechaCreacion: notif.fecha_creacion_formateada || notif.fecha_creacion,
                actions: [
                    { text: '<i class="bi bi-eye"></i> Ver detalles', class: 'btn-admin', action: 'view' },
                    { text: '<i class="bi bi-check"></i> Marcar como le√≠da', class: 'btn-success', action: 'mark-read' },
                    ...(prioridad === 'alta' ? [{ text: '<i class="bi bi-gear"></i> Resolver', class: 'btn-warning', action: 'resolve' }] : [])
                ],
                notificationData: notif
            };
        });
    }

    function formatRelativeTime(dateString) {
      try {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return `Hace unos segundos`;
        if (diffMins < 60) return `Hace ${diffMins} minutos`;
        if (diffHours < 24) return `Hace ${diffHours} horas`;
        if (diffDays === 1) return `Ayer`;
        return `Hace ${diffDays} d√≠as`;
      } catch (error) {
        return 'Fecha no disponible';
      }
    }

    // Funci√≥n de renderizado
    function renderNotifications(notifications, filter = 'all') {
        const container = document.getElementById('notifications-container');
        const countElement = document.getElementById('notification-count');
        
        let filteredNotifications = notifications;
        
        switch(filter) {
            case 'critical':
                filteredNotifications = notifications.filter(n => n.priority === 'alta' || n.priority === 'critico');
                break;
            case 'alerts':
                filteredNotifications = notifications.filter(n => n.priority === 'media');
                break;
            case 'unread':
                filteredNotifications = notifications.filter(n => !n.read);
                break;
        }
        
        countElement.textContent = filteredNotifications.length;
        
        if (filteredNotifications.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-bell-slash" style="font-size: 48px; margin-bottom: 16px;"></i>
                    <p>No hay notificaciones ${filter !== 'all' ? 'de ' + filter : ''}</p>
                    <p><small><i class="bi bi-database"></i> Panel Administrativo - Notificaciones del Sistema</small></p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = filteredNotifications.map(notif => `
            <div class="notification ${notif.class} ${!notif.read ? 'unread' : ''}">
                <div class="notification-header">
                    <div class="notification-title">
                        ${notif.title}
                    </div>
                    <small><i class="bi bi-clock"></i> ${formatRelativeTime(notif.timestamp)}</small>
                </div>
                <p>${notif.message}</p>
                <div class="user-info">
                    <i class="bi bi-person"></i> <strong>Usuario:</strong> ${notif.usuario} | 
                    <i class="bi bi-tag"></i> <strong>Tipo:</strong> ${notif.type} | 
                    <i class="bi bi-flag"></i> <strong>Prioridad:</strong> ${notif.priority}
                </div>
                <div class="admin-actions">
                    ${notif.actions.map(action => 
                        `<button class="${action.class}" data-action="${action.action}" data-notification-id="${notif.id}">
                            ${action.text}
                        </button>`
                    ).join('')}
                </div>
            </div>
        `).join('');
    }

    // ===== FUNCIONES ADMINISTRATIVAS =====
    function generarReporte(tipo) {
        const reportSummary = {
            tipo: tipo,
            fechaGeneracion: new Date().toLocaleString(),
            totalNotificaciones: allNotifications.length,
            criticas: allNotifications.filter(n => n.priority === 'alta' || n.priority === 'critico').length,
            pendientes: allNotifications.filter(n => !n.read).length,
            resueltas: allNotifications.filter(n => n.estado === 'resuelta').length
        };
        
        console.log('üìä Generando reporte:', reportSummary);
        
        // Crear contenido del reporte
        let reportContent = `REPORTE ADMINISTRATIVO - ${tipo.toUpperCase()}\n`;
        reportContent += `==========================================\n`;
        reportContent += `Fecha de generaci√≥n: ${reportSummary.fechaGeneracion}\n`;
        reportContent += `Total de notificaciones: ${reportSummary.totalNotificaciones}\n`;
        reportContent += `Cr√≠ticas: ${reportSummary.criticas}\n`;
        reportContent += `Pendientes: ${reportSummary.pendientes}\n`;
        reportContent += `Resueltas: ${reportSummary.resueltas}\n`;
        
        reportContent += `\n==========================================\n\n`;
        reportContent += `DETALLE DE NOTIFICACIONES:\n\n`;
        
        // Agregar detalles de cada notificaci√≥n
        allNotifications.forEach((notif, index) => {
            reportContent += `${index + 1}. ${notif.notificationData.titulo || notif.title}\n`;
            reportContent += `   ‚Ä¢ Tipo: ${notif.type}\n`;
            reportContent += `   ‚Ä¢ Prioridad: ${notif.priority}\n`;
            reportContent += `   ‚Ä¢ Usuario: ${notif.usuario}\n`;
            reportContent += `   ‚Ä¢ Estado: ${notif.estado}\n`;
            reportContent += `   ‚Ä¢ Fecha: ${notif.fechaCreacion || formatRelativeTime(notif.timestamp)}\n`;
            reportContent += `   ‚Ä¢ Mensaje: ${notif.notificationData.mensaje || notif.message}\n\n`;
        });
        
        // Crear y descargar el reporte
        const blob = new Blob([reportContent], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `reporte_${tipo}_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        alert(`Reporte ${tipo} generado y descargado exitosamente. Total: ${allNotifications.length} notificaciones.`);
    }

    // ===== INICIALIZACI√ìN =====
    let realTimeAlertSystem;

    document.addEventListener('DOMContentLoaded', async function() {
      try {
        // Inicializar sistema de alertas
        realTimeAlertSystem = new RealTimeAlertSystem();
        
        // Cargar datos iniciales
        await loadAllData();
        
        // Iniciar sistema de actualizaci√≥n autom√°tica
        startAutoRefresh();
        
      } catch (error) {
        console.error('‚ùå Error inicializando panel administrativo:', error);
      }

      // Filtros b√°sicos
      document.querySelectorAll('.filters button').forEach(button => {
        button.addEventListener('click', function() {
          document.querySelectorAll('.filters button').forEach(btn => {
            btn.classList.remove('active');
          });
          this.classList.add('active');
          currentFilter = this.getAttribute('data-filter');
          renderNotifications(allNotifications, currentFilter);
        });
      });

      // Acciones administrativas
      document.addEventListener('click', function(e) {
        const button = e.target.closest('.admin-actions button');
        if (button) {
          const action = button.getAttribute('data-action');
          const notificationId = button.getAttribute('data-notification-id');
          const notificacion = allNotifications.find(n => n.id == notificationId);
          
          if (notificacion) {
            const notification = notificacion.notificationData;
            
            switch(action) {
              case 'view':
                alert(`üîç Detalles de notificaci√≥n administrativa:\n\nID: ${notification.id}\nT√≠tulo: ${notification.titulo}\nMensaje: ${notification.mensaje}\nPrioridad: ${notification.prioridad}\nUsuario: ${notification.usuario}\nEstado: ${notification.estado || 'Pendiente'}`);
                break;
              case 'mark-read':
                // Marcar como le√≠da
                const notificationElement = button.closest('.notification');
                notificationElement.classList.remove('unread');
                button.disabled = true;
                button.innerHTML = '<i class="bi bi-check-all"></i> ‚úì Le√≠da';
                
                // Actualizar el estado en los datos
                notificacion.read = true;
                notificacion.estado = 'leida';
                break;
              case 'resolve':
                if (confirm('¬øMarcar esta alerta cr√≠tica como resuelta?')) {
                  const resolveElement = button.closest('.notification');
                  button.disabled = true;
                  button.innerHTML = '<i class="bi bi-check-all"></i> ‚úì Resuelta';
                  
                  // Actualizar el estado en los datos
                  notificacion.estado = 'resuelta';
                  
                  // Actualizar estad√≠sticas
                  setTimeout(() => updateStatistics(allNotifications.map(n => n.notificationData)), 500);
                }
                break;
            }
          }
        }
      });

      // Manejo del men√∫ de usuario
      document.getElementById('userAvatar').addEventListener('click', function() {
        document.getElementById('logoutPanel').classList.toggle('active');
      });

      document.getElementById('logoutBtn').addEventListener('click', function() {
        document.getElementById('logoutPanel').classList.toggle('active');
      });

      // Cerrar men√∫ al hacer clic fuera
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.user-menu')) {
          document.getElementById('logoutPanel').classList.remove('active');
        }
      });

      // Toggles de preferencias
      document.querySelectorAll('.toggle').forEach(toggle => {
        toggle.addEventListener('click', function() {
          this.classList.toggle('active');
        });
      });

      // Detener actualizaci√≥n autom√°tica cuando la p√°gina no est√° visible
      document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
          stopAutoRefresh();
        } else {
          startAutoRefresh();
          setTimeout(() => realTimeAlertSystem.checkForAlerts(), 1000);
        }
      });
    });
  </script>
  <script src="{% static 'js/theme.js' %}"></script>
</body>
</html> 
============================================================


===== reportes.html =====
<!DOCTYPE html>
<html lang="es">
<head>
    {% include 'reservas/_icons.html' %}
    {% include 'reservas/_theme_snippet.html' %}
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes - Sistema de Reservas</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ENjdO4Dr2bkBIFxQpeoA6DQD5N2Q6F0n6U8U6p6YkE9j6M9g6t5F5F5F5F5F5F5F5F5" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        /* Variables CSS para temas */
        :root {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border-color: #e5e7eb;
            --primary-color: #2563eb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #dc2626;
            --admin-color: #7c3aed;
            --card-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #18191a;
            --bg-secondary: #23272f;
            --bg-tertiary: #2d3748;
            --text-primary: #ffffff;
            --text-secondary: #e5e7eb;
            --text-tertiary: #9ca3af;
            --border-color: #4b5563;
            --primary-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --admin-color: #8b5cf6;
            --card-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--card-shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: var(--admin-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }

        .nav-menu {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .nav-item {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--admin-color);
            color: white;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: var(--success-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        /* Bot√≥n de tema */
        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            background: var(--bg-tertiary);
            color: var(--admin-color);
        }

        /* Main Content */
        .main-content {
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Breadcrumb */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .breadcrumb a {
            color: var(--admin-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .breadcrumb-separator {
            color: var(--text-tertiary);
        }

        /* Page Header */
        .page-header {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Estad√≠sticas R√°pidas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--card-shadow);
            border-left: 4px solid;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-card.total {
            border-left-color: var(--primary-color);
        }

        .stat-card.success {
            border-left-color: var(--success-color);
        }

        .stat-card.warning {
            border-left-color: var(--warning-color);
        }

        .stat-card.danger {
            border-left-color: var(--danger-color);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Reportes Disponibles */
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .report-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .report-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .report-icon {
            font-size: 48px;
            margin-bottom: 16px;
            text-align: center;
            color: var(--admin-color);
        }

        .report-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            text-align: center;
        }

        .report-description {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 20px;
            text-align: center;
        }

        .report-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .download-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .download-btn:hover {
            background: #b91c1c;
            transform: translateY(-1px);
        }

        /* Tablas de datos */
        .data-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-secondary);
        }

        .data-table td {
            color: var(--text-primary);
        }

        .data-table tr:hover {
            background: var(--bg-tertiary);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-tertiary);
        }

        /* Status badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .status-badge.approved {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .status-badge.pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .status-badge.rejected {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        .status-badge.cancelled {
            background: var(--bg-tertiary);
            color: var(--text-tertiary);
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            color: var(--text-primary);
        }

        .loading-spinner {
            border: 4px solid var(--bg-tertiary);
            border-top: 4px solid var(--admin-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 16px;
            }

            .header {
                padding: 0 16px;
                height: 60px;
            }

            .nav-menu {
                display: none;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .reports-grid {
                grid-template-columns: 1fr;
            }

            .data-table {
                font-size: 14px;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px;
            }

            .report-actions {
                flex-direction: column;
            }

            .download-btn {
                width: 100%;
            }
        }
    </style>
    <link id="darkCss" rel="stylesheet" href="{% static 'css/dark.css' %}" disabled>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo-section">
            <div class="logo"><i class="bi bi-shield-check"></i></div>
            <div style="font-weight: 600; color: var(--text-primary);">Panel Administrativo</div>
        </div>
        
        <nav class="nav-menu">
            <a href="{% url 'admin_dashboard' %}" class="nav-item">
                <i class="bi bi-speedometer2"></i> Dashboard
            </a>
            <a href="{% url 'solicitudes_pendientes' %}" class="nav-item">
                <i class="bi bi-clock"></i> Solicitudes
            </a>
            <a href="{% url 'gestion_espacios' %}" class="nav-item">
                <i class="bi bi-door-open"></i> Espacios
            </a>
            <a href="{% url 'gestion_usuarios' %}" class="nav-item">
                <i class="bi bi-people-fill"></i> Usuarios
            </a>
            <a href="{% url 'reportes' %}" class="nav-item active">
                <i class="bi bi-bar-chart"></i> Reportes
            </a>
            <a href="{% url 'notificaciones_admin' %}" class="nav-item">
                <i class="bi bi-bell"></i> Notificaciones
            </a>
        </nav>
        
        <div class="user-menu">
            <!-- Bot√≥n de cambio de tema -->
            <button class="theme-toggle" id="themeToggle" title="Cambiar tema">
                <i class="bi bi-moon" id="themeIcon"></i>
            </button>
            
            <!-- Notificaciones -->
            <button class="notification-btn" id="notificationBtn" style="background:none;border:none;position:relative;font-size:20px;cursor:pointer;color:var(--admin-color);">
                <i class="bi bi-bell"></i>
                <span id="notifBadge" style="display:none;position:absolute;top:-5px;right:-5px;background:var(--danger-color);color:#fff;font-size:11px;padding:2px 6px;border-radius:10px;min-width:18px;height:18px;display:flex;align-items:center;justify-content:center;">0</span>
            </button>
            
            <div class="user-avatar">
                {% if user.first_name and user.last_name %}
                    {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                {% else %}
                    {{ user.username|first|upper }}
                {% endif %}
            </div>
            <span style="color: var(--text-primary);">
                {% if user.first_name %}
                    {{ user.first_name }} {{ user.last_name }}
                {% else %}
                    {{ user.username }}
                {% endif %}
            </span>
            <a href="{% url 'logout' %}" class="theme-toggle" title="Cerrar sesi√≥n">
                <i class="bi bi-box-arrow-right"></i>
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Breadcrumb -->
        <nav class="breadcrumb">
            <a href="{% url 'admin_dashboard' %}">
                <i class="bi bi-house"></i> Dashboard
            </a>
            <span class="breadcrumb-separator">‚Ä∫</span>
            <span style="color: var(--text-primary);">Reportes y Estad√≠sticas</span>
        </nav>

        <!-- Page Header -->
        <div class="page-header">
            <div class="header-content">
                <h1 class="page-title">
                    <i class="bi bi-bar-chart"></i> Reportes y Estad√≠sticas
                </h1>
            </div>
        </div>

        <!-- Estad√≠sticas R√°pidas -->
        <div class="stats-grid">
            <div class="stat-card total">
                <div class="stat-value">{{ total_reservas }}</div>
                <div class="stat-label">
                    <i class="bi bi-calendar-check"></i> Total de Reservas
                </div>
            </div>
            <div class="stat-card success">
                <div class="stat-value">{{ usuarios_activos }}</div>
                <div class="stat-label">
                    <i class="bi bi-person-check"></i> Usuarios Activos
                </div>
            </div>
            <div class="stat-card warning">
                <div class="stat-value">{{ total_espacios }}</div>
                <div class="stat-label">
                    <i class="bi bi-building"></i> Espacios Disponibles
                </div>
            </div>
            <div class="stat-card danger">
                <div class="stat-value">{{ tasa_aprobacion }}%</div>
                <div class="stat-label">
                    <i class="bi bi-graph-up"></i> Tasa de Aprobaci√≥n
                </div>
            </div>
        </div>

        <!-- Reportes Disponibles -->
        <div class="reports-grid">
            <div class="report-card">
                <div class="report-icon">
                    <i class="bi bi-building"></i>
                </div>
                <h3 class="report-title">Reporte de Uso de Espacios</h3>
                <p class="report-description">
                    An√°lisis de utilizaci√≥n de espacios, horas pico y disponibilidad.
                </p>
                <div class="report-actions">
                    <a href="{% url 'generar_reporte_pdf' 'uso_espacios' %}" class="download-btn" target="_blank" onclick="showLoading(true)">
                        <i class="bi bi-file-earmark-pdf"></i> Descargar PDF
                    </a>
                </div>
            </div>

            <div class="report-card">
                <div class="report-icon">
                    <i class="bi bi-people"></i>
                </div>
                <h3 class="report-title">Reporte de Usuarios</h3>
                <p class="report-description">
                    Informe de actividad de usuarios, incluyendo estad√≠sticas de uso y preferencias.
                </p>
                <div class="report-actions">
                    <a href="{% url 'generar_reporte_pdf' 'usuarios' %}" class="download-btn" target="_blank" onclick="showLoading(true)">
                        <i class="bi bi-file-earmark-pdf"></i> Descargar PDF
                    </a>
                </div>
            </div>

            <div class="report-card">
                <div class="report-icon">
                    <i class="bi bi-calendar-month"></i>
                </div>
                <h3 class="report-title">Reporte Mensual</h3>
                <p class="report-description">
                    Resumen mensual de actividad del sistema, tendencias y m√©tricas clave.
                </p>
                <div class="report-actions">
                    <a href="{% url 'generar_reporte_pdf' 'mensual' %}" class="download-btn" target="_blank" onclick="showLoading(true)">
                        <i class="bi bi-file-earmark-pdf"></i> Descargar PDF
                    </a>
                </div>
            </div>
        </div>

        <!-- Datos Adicionales -->
        <div class="data-section">
            <h2 class="section-title">
                <i class="bi bi-trophy"></i> Espacios M√°s Utilizados
            </h2>
            {% if espacios_mas_usados %}
            <table class="data-table">
                <thead>
                    <tr>
                        <th><i class="bi bi-door-open"></i> Espacio</th>
                        <th><i class="bi bi-tag"></i> Tipo</th>
                        <th><i class="bi bi-people"></i> Capacidad</th>
                        <th><i class="bi bi-calendar-check"></i> Reservas</th>
                    </tr>
                </thead>
                <tbody>
                    {% for espacio in espacios_mas_usados %}
                    <tr>
                        <td>{{ espacio.nombre }}</td>
                        <td>{{ espacio.tipo }}</td>
                        <td>{{ espacio.capacidad }} personas</td>
                        <td>{{ espacio.num_reservas }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state">
                <i class="bi bi-inbox" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                <p>No hay datos de uso de espacios disponibles.</p>
            </div>
            {% endif %}
        </div>

        <div class="data-section">
            <h2 class="section-title">
                <i class="bi bi-star"></i> Usuarios M√°s Activos
            </h2>
            {% if usuarios_activos_top %}
            <table class="data-table">
                <thead>
                    <tr>
                        <th><i class="bi bi-person"></i> Usuario</th>
                        <th><i class="bi bi-person-badge"></i> Nombre</th>
                        <th><i class="bi bi-calendar-check"></i> Reservas</th>
                    </tr>
                </thead>
                <tbody>
                    {% for usuario in usuarios_activos_top %}
                    <tr>
                        <td>{{ usuario.username }}</td>
                        <td>{{ usuario.first_name }} {{ usuario.last_name }}</td>
                        <td>{{ usuario.num_reservas }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state">
                <i class="bi bi-people" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                <p>No hay datos de usuarios disponibles.</p>
            </div>
            {% endif %}
        </div>

        <div class="data-section">
            <h2 class="section-title">
                <i class="bi bi-clipboard-data"></i> Resumen de Estados
            </h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th><i class="bi bi-tag"></i> Estado</th>
                        <th><i class="bi bi-hash"></i> Cantidad</th>
                        <th><i class="bi bi-percent"></i> Porcentaje</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <span class="status-badge approved">
                                <i class="bi bi-check-circle"></i> Aprobadas
                            </span>
                        </td>
                        <td>{{ reservas_aprobadas }}</td>
                        <td>{{ tasa_aprobacion }}%</td>
                    </tr>
                    <tr>
                        <td>
                            <span class="status-badge pending">
                                <i class="bi bi-clock"></i> Pendientes
                            </span>
                        </td>
                        <td>{{ reservas_pendientes }}</td>
                        <td>{% widthratio reservas_pendientes total_reservas 100 %}%</td>
                    </tr>
                    <tr>
                        <td>
                            <span class="status-badge rejected">
                                <i class="bi bi-x-circle"></i> Rechazadas
                            </span>
                        </td>
                        <td>{{ reservas_rechazadas }}</td>
                        <td>{% widthratio reservas_rechazadas total_reservas 100 %}%</td>
                    </tr>
                    <tr>
                        <td>
                            <span class="status-badge cancelled">
                                <i class="bi bi-x-circle"></i> Canceladas
                            </span>
                        </td>
                        <td>{{ reservas_canceladas }}</td>
                        <td>{% widthratio reservas_canceladas total_reservas 100 %}%</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Generando reporte PDF...</p>
            <p style="font-size: 14px; color: var(--text-tertiary); margin-top: 10px;">Por favor, espera un momento</p>
        </div>
    </div>

    <script>
        // Sistema de tema claro/oscuro
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            const body = document.body;
            
            // Verificar tema guardado en localStorage
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                body.setAttribute('data-theme', 'dark');
                themeIcon.classList.remove('bi-moon');
                themeIcon.classList.add('bi-sun');
            }
            
            // Funci√≥n para cambiar tema
            themeToggle.addEventListener('click', () => {
                const isDark = body.getAttribute('data-theme') === 'dark';
                
                if (isDark) {
                    body.removeAttribute('data-theme');
                    themeIcon.classList.remove('bi-sun');
                    themeIcon.classList.add('bi-moon');
                    localStorage.setItem('theme', 'light');
                } else {
                    body.setAttribute('data-theme', 'dark');
                    themeIcon.classList.remove('bi-moon');
                    themeIcon.classList.add('bi-sun');
                    localStorage.setItem('theme', 'dark');
                }
            });
            
            // Funci√≥n para mostrar/ocultar loading
            window.showLoading = function(show) {
                const overlay = document.getElementById('loadingOverlay');
                overlay.style.display = show ? 'flex' : 'none';
                
                // Ocultar autom√°ticamente despu√©s de 5 segundos (por si acaso)
                if (show) {
                    setTimeout(() => {
                        showLoading(false);
                    }, 5000);
                }
            };
            
            // A√±adir eventos a los enlaces de PDF para mostrar loading
            document.querySelectorAll('a.download-btn').forEach(link => {
                link.addEventListener('click', function(e) {
                    // Mostrar loading
                    showLoading(true);
                    
                    // El enlace se abrir√° en nueva pesta√±a, el loading se ocultar√° autom√°ticamente
                });
            });
            
            // Funci√≥n para mostrar alertas
            function showAlert(message, type = 'info') {
                const colors = {
                    success: '#10b981',
                    error: '#ef4444',
                    warning: '#f59e0b',
                    info: '#3b82f6'
                };
                
                const icon = {
                    success: 'bi-check-circle',
                    error: 'bi-exclamation-triangle',
                    warning: 'bi-exclamation-circle',
                    info: 'bi-info-circle'
                }[type];
                
                const alertDiv = document.createElement('div');
                alertDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${colors[type]}20;
                    color: ${colors[type]};
                    padding: 16px 20px;
                    border-radius: 12px;
                    border: 1px solid ${colors[type]}40;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    z-index: 9999;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    animation: slideInRight 0.3s ease-out;
                `;
                
                alertDiv.innerHTML = `
                    <i class="bi ${icon}" style="font-size: 20px;"></i>
                    <span>${message}</span>
                `;
                
                document.body.appendChild(alertDiv);
                
                setTimeout(() => {
                    alertDiv.style.animation = 'slideOutRight 0.3s ease-in forwards';
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.parentNode.removeChild(alertDiv);
                        }
                    }, 300);
                }, 5000);
            }
            
            // Animaci√≥n CSS para alertas
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from {
                        opacity: 0;
                        transform: translateX(100%);
                    }
                    to {
                        opacity: 1;
                        transform: translateX(0);
                    }
                }
                @keyframes slideOutRight {
                    from {
                        opacity: 1;
                        transform: translateX(0);
                    }
                    to {
                        opacity: 0;
                        transform: translateX(100%);
                    }
                }
            `;
            document.head.appendChild(style);
            
            console.log('Reportes cargados correctamente');
        });
    </script>
    <script src="{% static 'js/theme.js' %}"></script>
</body>
</html>
============================================================


===== reservas.html =====
<!DOCTYPE html>
<html lang="es">
<head>
    {% include 'reservas/_icons.html' %}
    {% include 'reservas/_theme_snippet.html' %}
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Reservas - Sistema de Reservas</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ENjdO4Dr2bkBIFxQpeoA6DQD5N2Q6F0n6U8U6p6YkE9j6M9g6t5F5F5F5F5F5F5F5F5" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        /* Variables CSS para temas */
        :root {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border-color: #e5e7eb;
            --primary-color: #2563eb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #dc2626;
            --card-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #18191a;
            --bg-secondary: #23272f;
            --bg-tertiary: #2d3748;
            --text-primary: #ffffff;
            --text-secondary: #e5e7eb;
            --text-tertiary: #9ca3af;
            --border-color: #4b5563;
            --primary-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --card-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--card-shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }

        .nav-menu {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .nav-item {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .nav-item i {
            font-size: 16px;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--primary-color);
            color: white;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--success-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        /* Bot√≥n de tema */
        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            background: var(--bg-tertiary);
            color: var(--primary-color);
        }

        /* Main Content */
        .main-content {
            padding: 24px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title i {
            color: var(--primary-color);
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
        }

        /* Filters */
        .filters-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
        }

        .status-tabs {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 16px;
        }

        .status-tab {
            flex: 1;
            padding: 8px 16px;
            border: none;
            background: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            color: var(--text-secondary);
        }

        .status-tab.active {
            background: var(--bg-secondary);
            color: var(--primary-color);
            box-shadow: var(--card-shadow);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .filter-select, .filter-input {
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: border-color 0.3s ease;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Reservations List */
        .reservations-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .reservation-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            border-left: 4px solid;
            border: 1px solid var(--border-color);
        }

        .reservation-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .reservation-card.approved {
            border-left-color: var(--success-color);
        }

        .reservation-card.pending {
            border-left-color: var(--warning-color);
        }

        .reservation-card.rejected {
            border-left-color: var(--danger-color);
        }

        .reservation-card.cancelled {
            border-left-color: var(--text-tertiary);
        }

        .reservation-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .reservation-info {
            flex: 1;
        }

        .reservation-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .reservation-datetime {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .reservation-user {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .reservation-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.approved {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .status-badge.pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .status-badge.rejected {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        .status-badge.cancelled {
            background: var(--bg-tertiary);
            color: var(--text-tertiary);
        }

        .reservation-id {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .reservation-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-icon {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .detail-label {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .detail-value {
            color: var(--text-tertiary);
            font-size: 14px;
        }

        .reservation-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .action-btn {
            padding: 8px 16px;
            border: 2px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: var(--text-primary);
        }

        .action-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .action-btn.primary {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .action-btn.primary:hover {
            background: #1d4ed8;
        }

        .action-btn.danger {
            background: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }

        .action-btn.danger:hover {
            background: #b91c1c;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
            color: var(--text-tertiary);
        }

        .empty-state-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .empty-state-text {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .empty-state-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--primary-color);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .empty-state-btn:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 0 16px;
            }

            .nav-menu {
                display: none;
            }

            .main-content {
                padding: 16px;
            }

            .reservation-header {
                flex-direction: column;
                gap: 12px;
            }

            .reservation-meta {
                align-items: flex-start;
            }

            .reservation-details {
                grid-template-columns: 1fr;
            }

            .reservation-actions {
                justify-content: flex-start;
                flex-wrap: wrap;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <link id="darkCss" rel="stylesheet" href="{% static 'css/dark.css' %}" disabled>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo-section">
            <div class="logo">
                <i class="bi bi-calendar-check"></i>
            </div>
            <div style="font-weight: 600; color: var(--text-primary);">Sistema de Reservas</div>
        </div>
        
        <nav class="nav-menu">
            <a href="{% url 'dashboard' %}" class="nav-item">
                <i class="bi bi-speedometer2"></i>
                Dashboard
            </a>
            <a href="{% url 'crear_reserva' %}" class="nav-item">
                <i class="bi bi-plus-circle"></i>
                Reservar
            </a>
            <a href="{% url 'reservas' %}" class="nav-item active">
                <i class="bi bi-clock-history"></i>
                Historial
            </a>
            <a href="{% url 'calendario' %}" class="nav-item">
                <i class="bi bi-calendar-week"></i>
                Calendario
            </a>
            <a href="{% url 'espacios' %}" class="nav-item">
                <i class="bi bi-building"></i>
                Espacios
            </a>
            <a href="{% url 'notificaciones' %}" class="nav-item">
                <i class="bi bi-bell"></i>
                Notificaciones
            </a>
        </nav>
        
        <div class="user-menu">
            <!-- Bot√≥n de cambio de tema -->
            <button class="theme-toggle" id="themeToggle" title="Cambiar tema">
                <i class="bi bi-moon" id="themeIcon"></i>
            </button>
            
            <div class="user-avatar">
                {% if user.first_name and user.last_name %}
                    {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                {% else %}
                    {{ user.username|first|upper }}
                {% endif %}
            </div>
            <span style="color: var(--text-primary);">
                {% if user.first_name %}
                    {{ user.first_name }} {{ user.last_name }}
                {% else %}
                    {{ user.username }}
                {% endif %}
            </span>
            <a href="{% url 'logout' %}" class="theme-toggle" title="Cerrar sesi√≥n">
                <i class="bi bi-box-arrow-right"></i>
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title">
                <i class="bi bi-clock-history"></i>
                Historial de Reservas
            </h1>
            <p class="page-subtitle">
                Gestiona y revisa todas tus solicitudes de reserva
            </p>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <div class="status-tabs">
                <button class="status-tab active" data-status="all">Todas</button>
                <button class="status-tab" data-status="approved">Aprobadas</button>
                <button class="status-tab" data-status="pending">Pendientes</button>
                <button class="status-tab" data-status="rejected">Rechazadas</button>
                <button class="status-tab" data-status="cancelled">Canceladas</button>
            </div>

            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">üìÖ Fecha desde</label>
                    <input type="date" class="filter-input" id="dateFrom">
                </div>

                <div class="filter-group">
                    <label class="filter-label">üìÖ Fecha hasta</label>
                    <input type="date" class="filter-input" id="dateTo">
                </div>

                <div class="filter-group">
                    <label class="filter-label">üè¢ Espacio</label>
                    <select class="filter-select" id="spaceFilter">
                        <option value="">Todos los espacios</option>
                        {% for reserva in reservas %}
                            {% ifchanged reserva.espacio.nombre %}
                                <option value="{{ reserva.espacio.id }}">{{ reserva.espacio.nombre }}</option>
                            {% endifchanged %}
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">üîç Buscar</label>
                    <input type="text" class="filter-input" id="searchInput" placeholder="Buscar por ID o prop√≥sito...">
                </div>
            </div>
        </div>

        <!-- Reservations List -->
        <div class="reservations-list" id="reservationsList">
            {% for reserva in reservas %}
            <div class="reservation-card {{ reserva.estado|lower }}" 
                data-status="{{ reserva.estado|lower }}" 
                data-space="{{ reserva.espacio.id }}"
                data-date="{{ reserva.fecha_reserva|date:'Y-m-d' }}"
                data-id="{{ reserva.id }}"
                data-purpose="{{ reserva.proposito|lower }}">
                <div class="reservation-header">
                    <div class="reservation-info">
                        <div class="reservation-title">{{ reserva.espacio.nombre }}</div>
                        <div class="reservation-datetime">
                            <i class="bi bi-calendar"></i> {{ reserva.fecha_reserva|date:"l, d M Y" }} ‚Ä¢ 
                            <i class="bi bi-clock"></i> {{ reserva.hora_inicio|time:"H:i" }} - {{ reserva.hora_fin|time:"H:i" }}
                        </div>
                        <div class="reservation-user">
                            <i class="bi bi-person"></i> Solicitante: T√∫
                        </div>
                    </div>
                    <div class="reservation-meta">
                        <span class="status-badge {{ reserva.estado|lower }}">
                            {{ reserva.estado }}
                        </span>
                        <span class="reservation-id">#{{ reserva.id }}</span>
                    </div>
                </div>

                <div class="reservation-details">
                    <div class="detail-item">
                        <span class="detail-icon"><i class="bi bi-clock-history"></i></span>
                        <span class="detail-label">Duraci√≥n:</span>
                        <span class="detail-value">
                            {% with inicio=reserva.hora_inicio fin=reserva.hora_fin %}
                                {{ fin.hour|add:fin.minute|divisibleby:60 }} horas
                            {% endwith %}
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-icon"><i class="bi bi-clock"></i></span>
                        <span class="detail-label">Solicitado:</span>
                        <span class="detail-value">{{ reserva.fecha_solicitud|date:"d M, H:i" }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-icon"><i class="bi bi-bullseye"></i></span>
                        <span class="detail-label">Prop√≥sito:</span>
                        <span class="detail-value">{{ reserva.proposito }}</span>
                    </div>
                </div>

                <div class="reservation-actions">
                    <button class="action-btn" onclick="verDetalles({{ reserva.id }})">
                        <i class="bi bi-eye"></i>
                        Ver Detalles
                    </button>
                    {% if reserva.estado == 'Pendiente' or reserva.estado == 'Aprobada' %}
                    <button class="action-btn danger" onclick="cancelarReserva({{ reserva.id }})">
                        <i class="bi bi-x-circle"></i>
                        Cancelar
                    </button>
                    {% endif %}
                    {% if reserva.estado == 'Aprobada' %}
                    <button class="action-btn primary">
                        <i class="bi bi-calendar-plus"></i>
                        Agregar al Calendario
                    </button>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="bi bi-clipboard"></i>
                </div>
                <h2 class="empty-state-title">No hay reservas encontradas</h2>
                <p class="empty-state-text">
                    A√∫n no has realizado ninguna reserva.
                </p>
                <a href="{% url 'crear_reserva' %}" class="empty-state-btn">
                    <i class="bi bi-plus-lg"></i>
                    Crear Nueva Reserva
                </a>
            </div>
            {% endfor %}
        </div>
    </main>

    <script>
        // Sistema de tema claro/oscuro
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            const body = document.body;
            
            // Verificar tema guardado en localStorage
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                body.setAttribute('data-theme', 'dark');
                themeIcon.classList.remove('bi-moon');
                themeIcon.classList.add('bi-sun');
            }
            
            // Funci√≥n para cambiar tema
            themeToggle.addEventListener('click', () => {
                const isDark = body.getAttribute('data-theme') === 'dark';
                
                if (isDark) {
                    body.removeAttribute('data-theme');
                    themeIcon.classList.remove('bi-sun');
                    themeIcon.classList.add('bi-moon');
                    localStorage.setItem('theme', 'light');
                } else {
                    body.setAttribute('data-theme', 'dark');
                    themeIcon.classList.remove('bi-moon');
                    themeIcon.classList.add('bi-sun');
                    localStorage.setItem('theme', 'dark');
                }
            });
            
            // ========== SISTEMA DE FILTRADO ==========
            
            let currentFilters = {
                status: 'all',
                dateFrom: '',
                dateTo: '',
                space: '',
                search: ''
            };

            // Filtros por estado
            document.querySelectorAll('.status-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const status = this.dataset.status;
                    currentFilters.status = status;
                    
                    // Update active tab
                    document.querySelectorAll('.status-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    applyFilters();
                });
            });

            // Filtro por fecha desde
            document.getElementById('dateFrom').addEventListener('change', function() {
                currentFilters.dateFrom = this.value;
                applyFilters();
            });

            // Filtro por fecha hasta
            document.getElementById('dateTo').addEventListener('change', function() {
                currentFilters.dateTo = this.value;
                applyFilters();
            });

            // Filtro por espacio
            document.getElementById('spaceFilter').addEventListener('change', function() {
                currentFilters.space = this.value;
                applyFilters();
            });

            // Filtro de b√∫squeda
            document.getElementById('searchInput').addEventListener('input', function(e) {
                currentFilters.search = e.target.value.toLowerCase().trim();
                applyFilters();
            });

            // Funci√≥n principal de filtrado
            function applyFilters() {
                const cards = document.querySelectorAll('.reservation-card');
                let visibleCount = 0;
                
                cards.forEach(card => {
                    if (!card.dataset.status) {
                        console.warn('Tarjeta sin data-status:', card);
                        return;
                    }
                    
                    const cardStatus = card.dataset.status;
                    const cardSpace = card.dataset.space || '';
                    const cardDate = card.dataset.date || '';
                    const cardId = card.dataset.id || '';
                    const cardPurpose = card.dataset.purpose || '';
                    
                    let show = true;
                    
                    // 1. Filtro por estado
                    if (currentFilters.status !== 'all') {
                        const statusMap = {
                            'approved': 'aprobada',
                            'pending': 'pendiente', 
                            'rejected': 'rechazada',
                            'cancelled': 'cancelada'
                        };
                        
                        const targetStatus = statusMap[currentFilters.status] || currentFilters.status;
                        if (cardStatus !== targetStatus) {
                            show = false;
                        }
                    }
                    
                    // 2. Filtro por espacio
                    if (currentFilters.space && cardSpace !== currentFilters.space) {
                        show = false;
                    }
                    
                    // 3. Filtro por fecha desde
                    if (currentFilters.dateFrom && cardDate < currentFilters.dateFrom) {
                        show = false;
                    }
                    
                    // 4. Filtro por fecha hasta
                    if (currentFilters.dateTo && cardDate > currentFilters.dateTo) {
                        show = false;
                    }
                    
                    // 5. Filtro de b√∫squeda
                    if (currentFilters.search) {
                        const searchTerm = currentFilters.search;
                        const matchesId = cardId.toString().includes(searchTerm);
                        const matchesPurpose = cardPurpose.includes(searchTerm);
                        
                        if (!matchesId && !matchesPurpose) {
                            show = false;
                        }
                    }
                    
                    // Aplicar visibilidad
                    if (show) {
                        card.style.display = 'block';
                        visibleCount++;
                    } else {
                        card.style.display = 'none';
                    }
                });
                
                updateEmptyState(visibleCount);
            }

            // Actualizar estado vac√≠o
            function updateEmptyState(visibleCount) {
                const reservationsList = document.getElementById('reservationsList');
                const existingCards = document.querySelectorAll('.reservation-card').length;
                const existingEmptyState = document.querySelector('.empty-state.filter-empty-state');
                
                if (visibleCount === 0 && existingCards > 0) {
                    if (!existingEmptyState) {
                        const emptyHtml = `
                            <div class="empty-state filter-empty-state">
                                <div class="empty-state-icon">
                                    <i class="bi bi-search"></i>
                                </div>
                                <h2 class="empty-state-title">No hay reservas encontradas</h2>
                                <p class="empty-state-text">
                                    No se encontraron reservas que coincidan con los filtros seleccionados.
                                </p>
                                <button class="empty-state-btn" onclick="resetFilters()">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                    Restablecer Filtros
                                </button>
                            </div>
                        `;
                        reservationsList.insertAdjacentHTML('beforeend', emptyHtml);
                    }
                } else {
                    if (existingEmptyState) {
                        existingEmptyState.remove();
                    }
                }
                
                if (existingCards === 0) {
                    const originalEmptyState = document.querySelector('.empty-state');
                    if (originalEmptyState && !originalEmptyState.classList.contains('filter-empty-state')) {
                        originalEmptyState.style.display = 'block';
                    }
                }
            }

            // Restablecer filtros
            function resetFilters() {
                document.querySelectorAll('.status-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector('.status-tab[data-status="all"]').classList.add('active');
                
                document.getElementById('dateFrom').value = '';
                document.getElementById('dateTo').value = '';
                document.getElementById('spaceFilter').value = '';
                document.getElementById('searchInput').value = '';
                
                currentFilters = {
                    status: 'all',
                    dateFrom: '',
                    dateTo: '',
                    space: '',
                    search: ''
                };
                
                applyFilters();
            }

            // Inicializar filtros al cargar la p√°gina
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateTo').max = today;
            applyFilters();
        });

        // Funciones para manejar reservas
        function verDetalles(reservaId) {
            window.location.href = `/detalle-reserva/?id=${reservaId}`;
        }

        function cancelarReserva(reservaId) {
            if (confirm('¬øEst√°s seguro de que deseas cancelar esta reserva?')) {
                fetch(`/api/reservas/${reservaId}/cancelar/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Reserva cancelada exitosamente');
                        location.reload();
                    } else {
                        alert('Error al cancelar la reserva: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al cancelar la reserva');
                });
            }
        }

        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
    <script src="{% static 'js/theme.js' %}"></script>
</body>
</html>
============================================================


===== reserva_exitosa.html =====
<!DOCTYPE html>
<html lang="es">
<head>
    {% include 'reservas/_theme_snippet.html' %}
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmaci√≥n - Sistema de Reservas</title>
    <style>
        :root {
            --bg-primary: #f9fafb;
            --bg-secondary: white;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border-color: #e5e7eb;
            --accent-color: #2563eb;
            --success-color: #10b981;
            --success-light: #d1fae5;
            --success-dark: #059669;
            --warning-color: #f59e0b;
            --danger-color: #dc2626;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .theme-dark {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-tertiary: #9ca3af;
            --border-color: #4b5563;
            --accent-color: #3b82f6;
            --success-color: #10b981;
            --success-light: #064e3b;
            --success-dark: #047857;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: var(--accent-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--success-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--bg-tertiary);
            color: var(--accent-color);
        }

        .main-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 24px;
        }

        .confirmation-container {
            background: var(--bg-secondary);
            border-radius: 16px;
            box-shadow: var(--shadow-hover);
            padding: 48px 40px;
            max-width: 700px;
            width: 100%;
            text-align: center;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .confirmation-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--success-color), var(--success-dark));
        }

        /* Success Animation */
        .success-animation {
            width: 140px;
            height: 140px;
            margin: 0 auto 32px;
            position: relative;
        }

        .success-icon {
            width: 140px;
            height: 140px;
            background: linear-gradient(135deg, var(--success-color), var(--success-dark));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 56px;
            color: white;
            box-shadow: 0 12px 40px rgba(16, 185, 129, 0.3);
            animation: successIconPulse 2s ease-in-out infinite;
            z-index: 2;
            position: relative;
        }

        .checkmark {
            width: 60px;
            height: 60px;
            position: relative;
            transform: rotate(45deg);
        }

        .checkmark-stem {
            position: absolute;
            width: 5px;
            height: 40px;
            background-color: white;
            left: 28px;
            top: 8px;
            transform: scaleY(0);
            transform-origin: top;
            animation: drawStem 0.5s ease-out 0.3s forwards;
        }

        .checkmark-kick {
            position: absolute;
            width: 20px;
            height: 5px;
            background-color: white;
            left: 13px;
            top: 38px;
            transform: scaleX(0);
            transform-origin: left;
            animation: drawKick 0.3s ease-out 0.8s forwards;
        }

        @keyframes drawStem {
            to { transform: scaleY(1); }
        }

        @keyframes drawKick {
            to { transform: scaleX(1); }
        }

        @keyframes successIconPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .success-rings {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 140px;
            height: 140px;
        }

        .success-ring {
            position: absolute;
            border: 3px solid var(--success-color);
            border-radius: 50%;
            opacity: 0;
            animation: ringExpand 2s ease-out infinite;
        }

        .success-ring:nth-child(1) {
            animation-delay: 0s;
        }

        .success-ring:nth-child(2) {
            animation-delay: 0.5s;
        }

        .success-ring:nth-child(3) {
            animation-delay: 1s;
        }

        @keyframes ringExpand {
            0% {
                width: 140px;
                height: 140px;
                opacity: 0.7;
            }
            100% {
                width: 240px;
                height: 240px;
                opacity: 0;
            }
        }

        /* Confetti Animation */
        .confetti-container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 1;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--success-color);
            top: -20px;
            opacity: 0;
            animation: confettiFall 3s ease-in forwards;
        }

        .confetti:nth-child(odd) {
            background: var(--accent-color);
        }

        .confetti:nth-child(even) {
            background: var(--warning-color);
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(500px) rotate(720deg);
                opacity: 0;
            }
        }

        /* Content Styling */
        .success-title {
            font-size: 36px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            position: relative;
            z-index: 2;
        }

        .success-message {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 40px;
            line-height: 1.6;
            position: relative;
            z-index: 2;
        }

        .reservation-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 28px;
            margin-bottom: 32px;
            text-align: left;
            transition: all 0.3s ease;
            position: relative;
            z-index: 2;
        }

        .reservation-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .reservation-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .reservation-number {
            background: var(--accent-color);
            color: white;
            padding: 10px 20px;
            border-radius: 24px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .reservation-number:hover {
            background: var(--success-color);
            transform: scale(1.05);
        }

        .reservation-status {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--success-light);
            color: var(--success-dark);
            padding: 8px 16px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
        }

        .reservation-status.pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .reservation-status.approved {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .reservation-status.rejected {
            background: rgba(220, 38, 38, 0.1);
            color: var(--danger-color);
        }

        .reservation-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
        }

        .detail-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .detail-item:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .detail-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-color), var(--success-color));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            flex-shrink: 0;
        }

        .detail-content {
            flex: 1;
        }

        .detail-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-size: 16px;
            color: var(--text-primary);
            font-weight: 500;
            line-height: 1.4;
        }

        .info-section {
            background: rgba(59, 130, 246, 0.05);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            text-align: left;
            position: relative;
            z-index: 2;
        }

        .info-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .info-header .detail-icon {
            width: 40px;
            height: 40px;
            background: var(--accent-color);
            font-size: 18px;
        }

        .info-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent-color);
        }

        .info-content {
            color: var(--text-secondary);
            font-size: 15px;
            line-height: 1.6;
        }

        .info-list {
            margin: 16px 0 0 20px;
            padding: 0;
            list-style: none;
        }

        .info-list li {
            margin-bottom: 10px;
            position: relative;
            padding-left: 24px;
        }

        .info-list li::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: var(--success-color);
            font-weight: bold;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
            position: relative;
            z-index: 2;
        }

        .action-btn {
            padding: 16px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .action-btn.primary {
            background: var(--success-color);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .action-btn.primary:hover {
            background: var(--success-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .action-btn.secondary {
            background: var(--accent-color);
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .action-btn.secondary:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
        }

        .action-btn.link {
            background: transparent;
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
        }

        .action-btn.link:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .additional-info {
            background: rgba(16, 185, 129, 0.05);
            border-left: 4px solid var(--success-color);
            padding: 20px;
            border-radius: 0 10px 10px 0;
            text-align: left;
            position: relative;
            z-index: 2;
        }

        .additional-info-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--success-dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .additional-info-text {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .countdown-timer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 32px 0;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            position: relative;
            z-index: 2;
        }

        .timer-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .timer-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--success-color);
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .timer-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px 16px;
            }

            .confirmation-container {
                padding: 32px 24px;
            }

            .success-title {
                font-size: 28px;
            }

            .success-message {
                font-size: 16px;
            }

            .reservation-details {
                grid-template-columns: 1fr;
            }

            .reservation-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .action-buttons {
                grid-template-columns: 1fr;
            }

            .success-animation {
                width: 120px;
                height: 120px;
            }

            .success-icon {
                width: 120px;
                height: 120px;
                font-size: 48px;
            }

            .checkmark {
                width: 50px;
                height: 50px;
            }
        }

        @media (max-width: 480px) {
            .success-animation {
                width: 100px;
                height: 100px;
            }

            .success-icon {
                width: 100px;
                height: 100px;
                font-size: 40px;
            }

            .checkmark {
                width: 40px;
                height: 40px;
            }

            .timer-value {
                width: 50px;
                height: 50px;
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo-section">
            <div class="logo">
                <i class="bi bi-calendar-check"></i>
            </div>
            <div style="font-weight: 600; color: var(--text-primary);">Sistema de Reservas</div>
        </div>
        
        <div class="user-menu">
            <button class="theme-toggle" id="themeToggle" title="Cambiar tema">
                <i class="bi bi-moon" id="themeIcon"></i>
            </button>
            
            <div class="user-avatar">
                {% if user.first_name and user.last_name %}
                    {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                {% else %}
                    {{ user.username|first|upper }}
                {% endif %}
            </div>
            <span style="color: var(--text-primary);">
                {% if user.first_name %}
                    {{ user.first_name }} {{ user.last_name }}
                {% else %}
                    {{ user.username }}
                {% endif %}
            </span>
            <a href="{% url 'logout' %}" class="theme-toggle" title="Cerrar sesi√≥n">
                <i class="bi bi-box-arrow-right"></i>
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="confirmation-container">
            <!-- Confetti Animation -->
            <div class="confetti-container" id="confettiContainer"></div>

            <!-- Success Animation -->
            <div class="success-animation">
                <div class="success-icon">
                    <div class="checkmark">
                        <div class="checkmark-stem"></div>
                        <div class="checkmark-kick"></div>
                    </div>
                </div>
                <div class="success-rings">
                    <div class="success-ring"></div>
                    <div class="success-ring"></div>
                    <div class="success-ring"></div>
                </div>
            </div>

            <!-- Success Message -->
            <h1 class="success-title">
                {% if reserva %}
                    ¬°Reserva Enviada con √âxito!
                {% else %}
                    ¬°Reserva Procesada!
                {% endif %}
            </h1>
            <p class="success-message">
                {% if reserva and reserva.estado == 'Pendiente' %}
                    Tu solicitud de reserva ha sido enviada correctamente y est√° pendiente de aprobaci√≥n.
                    Te notificaremos por correo electr√≥nico cuando sea procesada.
                {% elif reserva and reserva.estado == 'Aprobada' %}
                    ¬°Excelente! Tu reserva ha sido aprobada. Ya puedes utilizar el espacio en la fecha y hora solicitadas.
                {% elif reserva and reserva.estado == 'Rechazada' %}
                    Tu solicitud ha sido procesada. Lamentablemente, no fue aprobada en esta ocasi√≥n.
                {% else %}
                    Tu reserva ha sido procesada exitosamente.
                {% endif %}
            </p>

            <!-- Countdown Timer (only for approved reservations) -->
            {% if reserva and reserva.estado == 'Aprobada' %}
            <div class="countdown-timer" id="countdownTimer">
                <div class="timer-item">
                    <div class="timer-value" id="days">00</div>
                    <div class="timer-label">D√≠as</div>
                </div>
                <div class="timer-item">
                    <div class="timer-value" id="hours">00</div>
                    <div class="timer-label">Horas</div>
                </div>
                <div class="timer-item">
                    <div class="timer-value" id="minutes">00</div>
                    <div class="timer-label">Minutos</div>
                </div>
                <div class="timer-item">
                    <div class="timer-value" id="seconds">00</div>
                    <div class="timer-label">Segundos</div>
                </div>
            </div>
            {% endif %}

            <!-- Reservation Details Card -->
            {% if reserva %}
            <div class="reservation-card">
                <div class="reservation-header">
                    <div class="reservation-number" id="reservationNumber">
                        #SR-{{ reserva.id|stringformat:"04d" }}
                    </div>
                    <div class="reservation-status {% if reserva.estado == 'Pendiente' %}pending{% elif reserva.estado == 'Aprobada' %}approved{% elif reserva.estado == 'Rechazada' %}rejected{% endif %}">
                        {% if reserva.estado == 'Pendiente' %}
                            <i class="bi bi-clock"></i> Pendiente de Aprobaci√≥n
                        {% elif reserva.estado == 'Aprobada' %}
                            <i class="bi bi-check-circle"></i> Aprobada
                        {% elif reserva.estado == 'Rechazada' %}
                            <i class="bi bi-x-circle"></i> Rechazada
                        {% else %}
                            <i class="bi bi-file-text"></i> {{ reserva.estado }}
                        {% endif %}
                    </div>
                </div>

                <div class="reservation-details">
                    <div class="detail-item">
                        <div class="detail-icon">
                            <i class="bi bi-building"></i>
                        </div>
                        <div class="detail-content">
                            <div class="detail-label">Espacio</div>
                            <div class="detail-value">{{ reserva.espacio.nombre }}</div>
                        </div>
                    </div>

                    <div class="detail-item">
                        <div class="detail-icon">
                            <i class="bi bi-calendar"></i>
                        </div>
                        <div class="detail-content">
                            <div class="detail-label">Fecha</div>
                            <div class="detail-value">{{ reserva.fecha_reserva|date:"l, d F Y" }}</div>
                        </div>
                    </div>

                    <div class="detail-item">
                        <div class="detail-icon">
                            <i class="bi bi-clock"></i>
                        </div>
                        <div class="detail-content">
                            <div class="detail-label">Horario</div>
                            <div class="detail-value">{{ reserva.hora_inicio|time:"H:i" }} - {{ reserva.hora_fin|time:"H:i" }}</div>
                        </div>
                    </div>

                    <div class="detail-item">
                        <div class="detail-icon">
                            <i class="bi bi-stopwatch"></i>
                        </div>
                        <div class="detail-content">
                            <div class="detail-label">Duraci√≥n</div>
                            <div class="detail-value" id="durationValue">
                                {% if reserva.hora_inicio and reserva.hora_fin %}
                                    {% with hora_inicio=reserva.hora_inicio|time:"H:i" hora_fin=reserva.hora_fin|time:"H:i" %}
                                        {{ hora_inicio }} - {{ hora_fin }}
                                    {% endwith %}
                                {% else %}
                                    No especificado
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="detail-item">
                        <div class="detail-icon">
                            <i class="bi bi-people"></i>
                        </div>
                        <div class="detail-content">
                            <div class="detail-label">Asistentes</div>
                            <div class="detail-value">{{ reserva.num_asistentes }} persona{{ reserva.num_asistentes|pluralize }}</div>
                        </div>
                    </div>

                    <div class="detail-item">
                        <div class="detail-icon">
                            <i class="bi bi-card-text"></i>
                        </div>
                        <div class="detail-content">
                            <div class="detail-label">Prop√≥sito</div>
                            <div class="detail-value">{{ reserva.proposito }}</div>
                        </div>
                    </div>
                </div>

                <!-- Reservation QR Code Placeholder -->
                {% if reserva.estado == 'Aprobada' %}
                <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 10px;">
                        <i class="bi bi-qr-code"></i> QR de acceso disponible en el dashboard
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Information Section -->
            <div class="info-section">
                <div class="info-header">
                    <div class="detail-icon">
                        <i class="bi bi-info-circle"></i>
                    </div>
                    <h3 class="info-title">Informaci√≥n Importante</h3>
                </div>
                <div class="info-content">
                    {% if reserva.estado == 'Pendiente' %}
                    <strong>Tiempo estimado de respuesta:</strong> 24-48 horas laborables
                    <ul class="info-list">
                        <li>Recibir√°s una notificaci√≥n por correo electr√≥nico cuando tu solicitud sea revisada</li>
                        <li>Puedes consultar el estado de tu reserva en cualquier momento desde tu historial</li>
                        <li>Si tu solicitud es rechazada, recibir√°s informaci√≥n sobre motivos y alternativas</li>
                        <li>Recibir√°s un recordatorio 24 horas antes de tu reserva si es aprobada</li>
                    </ul>
                    {% elif reserva.estado == 'Aprobada' %}
                    <strong>Instrucciones para tu reserva:</strong>
                    <ul class="info-list">
                        <li>Llega con 10 minutos de anticipaci√≥n a tu reserva</li>
                        <li>Trae contigo tu identificaci√≥n institucional</li>
                        <li>Respeta los horarios establecidos para permitir el uso a otros usuarios</li>
                        <li>Deja el espacio en las mismas condiciones en que lo encontraste</li>
                        <li>En caso de cancelaci√≥n, avisa con al menos 24 horas de anticipaci√≥n</li>
                    </ul>
                    {% endif %}
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <a href="{% url 'reservas' %}" class="action-btn primary">
                    <i class="bi bi-clock-history"></i>
                    Ver en Historial
                </a>
                <a href="{% url 'crear_reserva' %}" class="action-btn secondary">
                    <i class="bi bi-plus-circle"></i>
                    Nueva Reserva
                </a>
                <a href="{% url 'dashboard' %}" class="action-btn link">
                    <i class="bi bi-speedometer2"></i>
                    Ir al Dashboard
                </a>
            </div>

            <!-- Additional Info -->
            <div class="additional-info">
                <h4 class="additional-info-title">
                    <i class="bi bi-envelope-check"></i>
                    Confirmaci√≥n por Email
                </h4>
                <p class="additional-info-text">
                    Se ha enviado una copia de esta solicitud a tu correo electr√≥nico 
                    <strong>{{ user.email }}</strong> para tus registros.
                    {% if reserva.estado == 'Pendiente' %}
                    Revisa tu bandeja de entrada (y spam) para confirmar la recepci√≥n.
                    {% endif %}
                </p>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ========== SISTEMA DE TEMA ==========
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            const body = document.body;
            
            // Verificar tema guardado
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                body.classList.add('theme-dark');
                themeIcon.classList.remove('bi-moon');
                themeIcon.classList.add('bi-sun');
            }
            
            // Funci√≥n para cambiar tema
            themeToggle.addEventListener('click', () => {
                const isDark = body.classList.contains('theme-dark');
                
                if (isDark) {
                    body.classList.remove('theme-dark');
                    themeIcon.classList.remove('bi-sun');
                    themeIcon.classList.add('bi-moon');
                    localStorage.setItem('theme', 'light');
                } else {
                    body.classList.add('theme-dark');
                    themeIcon.classList.remove('bi-moon');
                    themeIcon.classList.add('bi-sun');
                    localStorage.setItem('theme', 'dark');
                }
            });

            // ========== CONFETTI ANIMATION ==========
            function createConfetti() {
                const container = document.getElementById('confettiContainer');
                const colors = ['#10b981', '#2563eb', '#f59e0b', '#8b5cf6', '#ec4899'];
                
                for (let i = 0; i < 50; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    
                    // Random position
                    confetti.style.left = Math.random() * 100 + '%';
                    
                    // Random size
                    const size = Math.random() * 10 + 5;
                    confetti.style.width = size + 'px';
                    confetti.style.height = size + 'px';
                    
                    // Random color
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    
                    // Random animation delay
                    confetti.style.animationDelay = Math.random() * 2 + 's';
                    
                    // Random rotation
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                    
                    container.appendChild(confetti);
                    
                    // Remove after animation completes
                    setTimeout(() => {
                        confetti.remove();
                    }, 3000);
                }
            }
            
            // Create confetti on load
            setTimeout(createConfetti, 500);
            
            // Create more confetti every 3 seconds for 15 seconds
            const confettiInterval = setInterval(createConfetti, 3000);
            setTimeout(() => clearInterval(confettiInterval), 15000);

            // ========== COUNTDOWN TIMER ==========
            {% if reserva and reserva.estado == 'Aprobada' and reserva.fecha_reserva and reserva.hora_inicio %}
            function updateCountdown() {
                // Get reservation date and time from Django template
                const reservationDateStr = '{{ reserva.fecha_reserva|date:"Y-m-d" }}';
                const reservationTimeStr = '{{ reserva.hora_inicio|time:"H:i:s" }}';
                
                // Create date object
                const reservationDateTime = new Date(reservationDateStr + 'T' + reservationTimeStr);
                const now = new Date();
                
                // Calculate difference
                const diff = reservationDateTime - now;
                
                if (diff > 0) {
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    
                    // Update display
                    document.getElementById('days').textContent = days.toString().padStart(2, '0');
                    document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
                    document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
                    document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
                    
                    // Add pulse animation to seconds
                    const secondsEl = document.getElementById('seconds');
                    secondsEl.style.animation = 'none';
                    setTimeout(() => {
                        secondsEl.style.animation = '';
                    }, 10);
                } else {
                    // Reservation has passed
                    document.getElementById('countdownTimer').innerHTML = `
                        <div style="text-align: center; width: 100%;">
                            <div style="font-size: 24px; color: var(--success-color); margin-bottom: 8px;">
                                <i class="bi bi-check-circle"></i>
                            </div>
                            <div style="color: var(--text-secondary); font-weight: 500;">
                                ¬°La reserva est√° en curso o ha finalizado!
                            </div>
                        </div>
                    `;
                    clearInterval(countdownInterval);
                }
            }
            
            // Start countdown
            updateCountdown();
            const countdownInterval = setInterval(updateCountdown, 1000);
            {% endif %}

            // ========== COPY RESERVATION NUMBER ==========
            const reservationNumber = document.getElementById('reservationNumber');
            if (reservationNumber) {
                reservationNumber.addEventListener('click', function() {
                    const text = this.textContent.trim();
                    navigator.clipboard.writeText(text).then(() => {
                        const originalText = this.textContent;
                        const originalBg = this.style.background;
                        
                        this.textContent = '‚úì Copiado!';
                        this.style.background = 'var(--success-color)';
                        
                        setTimeout(() => {
                            this.textContent = originalText;
                            this.style.background = originalBg;
                        }, 2000);
                    }).catch(() => {
                        this.textContent = 'Error al copiar';
                        setTimeout(() => {
                            this.textContent = text;
                        }, 2000);
                    });
                });
            }

            // ========== CARD HOVER EFFECTS ==========
            const reservationCard = document.querySelector('.reservation-card');
            if (reservationCard) {
                reservationCard.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-4px)';
                });

                reservationCard.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });
            }

            // ========== BUTTON EFFECTS ==========
            const buttons = document.querySelectorAll('.action-btn');
            buttons.forEach(button => {
                button.addEventListener('mousedown', function() {
                    this.style.transform = 'scale(0.95)';
                });
                
                button.addEventListener('mouseup', function() {
                    this.style.transform = '';
                });
                
                button.addEventListener('mouseleave', function() {
                    this.style.transform = '';
                });
            });

            // ========== DETAIL ITEM HOVER EFFECTS ==========
            const detailItems = document.querySelectorAll('.detail-item');
            detailItems.forEach(item => {
                item.addEventListener('mouseenter', function() {
                    const icon = this.querySelector('.detail-icon');
                    icon.style.transform = 'rotate(10deg) scale(1.1)';
                });
                
                item.addEventListener('mouseleave', function() {
                    const icon = this.querySelector('.detail-icon');
                    icon.style.transform = '';
                });
            });

            // ========== AUTO-SCROLL ANIMATION ==========
            setTimeout(() => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }, 100);

            // ========== PRINT SUPPORT ==========
            window.addEventListener('beforeprint', () => {
                document.querySelector('.confetti-container').style.display = 'none';
            });
            
            window.addEventListener('afterprint', () => {
                document.querySelector('.confetti-container').style.display = 'block';
            });

            console.log('P√°gina de confirmaci√≥n cargada correctamente');
        });
    </script>
</body>
</html>
============================================================


===== reset_password.html =====
<!DOCTYPE html>
<html lang="es">
<head>
    {% load static %}
    {% include 'reservas/_theme_snippet.html' %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restablecer contrase√±a - INACAP</title>
    <style>body{font-family:Segoe UI, Tahoma, sans-serif;background:#f3f4f6;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}.card{background:white;padding:28px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.08);width:420px}.form-input{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:8px}.action-button{width:100%;padding:12px;background:#2563eb;color:white;border:none;border-radius:8px;cursor:pointer}</style>
    <!-- external dark CSS kept for backward-compatibility; inline snippet handles theme when static serving fails -->
    <link id="darkCss" rel="stylesheet" href="{% static 'css/dark.css' %}" disabled>
</head>
<body>
    <div class="card">
        <h2>Restablecer contrase√±a</h2>
        <div id="msg" style="color:#dc2626;margin-bottom:8px"></div>
        <input id="new_password" class="form-input" type="password" placeholder="Nueva contrase√±a" />
        <input id="new_password2" class="form-input" type="password" placeholder="Repetir nueva contrase√±a" style="margin-top:8px" />
        <button id="saveBtn" class="action-button" style="margin-top:12px">Guardar contrase√±a</button>
        <p style="margin-top:12px"><a href="/login/">Volver al inicio de sesi√≥n</a></p>
    </div>
<script>
const uidb64 = window.location.pathname.split('/').filter(Boolean).slice(-2)[0];
const token = window.location.pathname.split('/').filter(Boolean).slice(-1)[0];

document.getElementById('saveBtn').addEventListener('click', async function(){
    const p1 = document.getElementById('new_password').value;
    const p2 = document.getElementById('new_password2').value;
    const msg = document.getElementById('msg'); msg.textContent='';
    if(!p1 || p1!==p2){ msg.textContent='Las contrase√±as no coinciden.'; return; }
    this.disabled = true; this.textContent='Guardando...';
    try{
        const resp = await fetch(`/reset/${uidb64}/${token}/`,{
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRFToken':(function(){const name='csrftoken';let v=null;if(document.cookie&&document.cookie!==''){document.cookie.split(';').forEach(c=>{const t=c.trim(); if(t.indexOf(name+'=')===0) v=decodeURIComponent(t.substring(name.length+1));});}return v;})()},
            body: JSON.stringify({new_password: p1, new_password2: p2})
        });
        const data = await resp.json();
        if(data.success){ alert('Contrase√±a actualizada. Inicia sesi√≥n con tu nueva contrase√±a.'); window.location.href='/login/'; }
        else{ msg.textContent = data.message || 'Error'; }
    }catch(e){ msg.textContent='Error de conexi√≥n'; }
    finally{ this.disabled=false; this.textContent='Guardar contrase√±a'; }
});
</script>
    <!-- Inline theme snippet included in head initializes theme and provides toggle; external theme.js left commented out to avoid duplication. -->
    <!-- <script src="{% static 'js/theme.js' %}"></script> -->
</body>
</html>
============================================================


===== reset_via_otp.html =====
<!DOCTYPE html>
<html lang="es">
<head>
    {% include 'reservas/_theme_snippet.html' %}
    {% load static %}
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Restablecer con c√≥digo - INACAP</title>
    <style>body{font-family:Segoe UI, Tahoma, sans-serif;background:#f3f4f6;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}.card{background:white;padding:24px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.08);width:420px}.form-input{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;margin-top:8px}.action-button{width:100%;padding:12px;background:#2563eb;color:white;border:none;border-radius:8px;cursor:pointer;margin-top:12px}</style>
    <link id="darkCss" rel="stylesheet" href="{% static 'css/dark.css' %}" disabled>
</head>
<body>
    <div class="card">
        <h3>Restablecer contrase√±a (c√≥digo temporal)</h3>
        <p>Ingresa tu correo y el c√≥digo temporal que recibiste por email. El c√≥digo funciona una sola vez y expira.</p>
        <div id="msg" style="color:#dc2626;margin-bottom:8px"></div>
        <input id="email" class="form-input" placeholder="correo@institucion.cl" />
        <input id="temp" class="form-input" placeholder="C√≥digo temporal recibido" />
        <input id="new1" class="form-input" type="password" placeholder="Nueva contrase√±a" />
        <input id="new2" class="form-input" type="password" placeholder="Repetir nueva contrase√±a" />
        <button id="saveBtn" class="action-button">Cambiar contrase√±a</button>
        <p style="margin-top:10px"><a href="/login/">Volver al inicio de sesi√≥n</a></p>
    </div>
<script>
document.getElementById('saveBtn').addEventListener('click', async function(){
    const email = document.getElementById('email').value.trim();
    const temp = document.getElementById('temp').value.trim();
    const p1 = document.getElementById('new1').value;
    const p2 = document.getElementById('new2').value;
    const msg = document.getElementById('msg'); msg.textContent='';
    if(!email || !temp || !p1 || !p2){ msg.textContent='Completa todos los campos.'; return; }
    if(p1!==p2){ msg.textContent='Las contrase√±as no coinciden.'; return; }
    this.disabled=true; this.textContent='Guardando...';
    try{
        const resp = await fetch('/reset-otp/', {
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRFToken':(function(){const name='csrftoken';let v=null;if(document.cookie&&document.cookie!==''){document.cookie.split(';').forEach(c=>{const t=c.trim(); if(t.indexOf(name+'=')===0) v=decodeURIComponent(t.substring(name.length+1));});}return v;})()},
            body: JSON.stringify({email: email, temp_password: temp, new_password: p1, new_password2: p2})
        });
        const data = await resp.json();
        if(data.success){ alert('Contrase√±a actualizada. Inicia sesi√≥n.'); window.location.href='/login/'; }
        else{ msg.textContent = data.message || 'Error'; }
    }catch(e){ msg.textContent='Error de conexi√≥n'; }
    finally{ this.disabled=false; this.textContent='Cambiar contrase√±a'; }
});
</script>
    <script src="{% static 'js/theme.js' %}"></script>
</body>
</html>
============================================================


===== revisar_solicitud.html =====
<!DOCTYPE html>
<html lang="es" data-bs-theme="auto">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revisar Solicitud - Sistema de Reservas</title>
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        :root {
            --primary-color: #2563eb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --purple-color: #8b5cf6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-card: #ffffff;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        [data-bs-theme="dark"] {
            --primary-color: #3b82f6;
            --success-color: #34d399;
            --warning-color: #fbbf24;
            --danger-color: #f87171;
            --purple-color: #a78bfa;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-card: #1f2937;
            --border-color: #374151;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            padding: 0 24px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color), var(--purple-color));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .nav-menu {
            display: flex;
            gap: 24px;
        }

        .nav-item {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            padding: 10px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--success-color), var(--primary-color));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        /* Theme Toggle */
        .theme-toggle {
            margin-left: 16px;
        }

        .theme-toggle-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .theme-toggle-btn:hover {
            transform: scale(1.1);
            border-color: var(--primary-color);
        }

        /* Main Content */
        .main-content {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Breadcrumb */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            font-size: 14px;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }

        .breadcrumb a {
            color: var(--primary-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .breadcrumb a:hover {
            background: var(--bg-secondary);
            text-decoration: none;
        }

        .breadcrumb-separator {
            color: var(--text-secondary);
        }

        /* Alert Messages */
        #alertMessage {
            margin-bottom: 24px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Page Header */
        .page-header {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border-left: 6px solid var(--primary-color);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }

        .page-title {
            font-size: 34px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-badge {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 14px 24px;
            border-radius: 10px;
            font-weight: 600;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Solicitud Container */
        .solicitud-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .solicitud-container {
                grid-template-columns: 1fr;
            }
        }

        /* Info Grid */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Info Card */
        .info-card {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 28px;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .info-card:hover {
            transform: translateY(-4px);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 24px;
            padding-bottom: 18px;
            border-bottom: 2px solid var(--border-color);
        }

        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .card-icon.blue {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(37, 99, 235, 0.2));
            color: var(--primary-color);
        }

        .card-icon.green {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.2));
            color: var(--success-color);
        }

        .card-icon.purple {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.2));
            color: var(--purple-color);
        }

        .card-icon.yellow {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.2));
            color: var(--warning-color);
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Info Item */
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 18px;
            padding-bottom: 18px;
            border-bottom: 1px solid var(--border-color);
        }

        .info-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .info-label {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-value {
            color: var(--text-primary);
            font-weight: 600;
            text-align: right;
            max-width: 220px;
        }

        /* Estado Badges */
        .estado-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: 2px solid;
        }

        .estado-pendiente {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.2));
            color: var(--warning-color);
            border-color: var(--warning-color);
        }

        .estado-aprobada {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.2));
            color: var(--success-color);
            border-color: var(--success-color);
        }

        .estado-rechazada {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.2));
            color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .estado-finalizada {
            background: linear-gradient(135deg, rgba(107, 114, 128, 0.1), rgba(107, 114, 128, 0.2));
            color: var(--text-secondary);
            border-color: var(--text-secondary);
        }

        /* Actions Panel */
        .actions-panel {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 28px;
            box-shadow: var(--shadow);
            height: fit-content;
            position: sticky;
            top: 100px;
            border: 1px solid var(--border-color);
        }

        @media (max-width: 1024px) {
            .actions-panel {
                position: static;
                order: -1;
            }
        }

        .actions-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 24px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .actions-buttons {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Buttons */
        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 15px;
            text-align: center;
        }

        .btn-aprobar {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-aprobar:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .btn-rechazar {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-rechazar:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        .btn-volver {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-volver:hover {
            background: var(--border-color);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Prop√≥sito Section */
        .proposito-section {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 32px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .proposito-content {
            background: var(--bg-secondary);
            padding: 24px;
            border-radius: 10px;
            border-left: 4px solid var(--primary-color);
            margin-top: 20px;
        }

        .proposito-text {
            color: var(--text-primary);
            line-height: 1.8;
            font-size: 16px;
            white-space: pre-wrap;
        }

        /* Quick Info */
        .quick-info {
            margin-top: 24px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 10px;
            border-left: 4px solid var(--success-color);
        }

        .quick-info h4 {
            font-size: 15px;
            font-weight: 600;
            color: var(--success-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quick-info p {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Modales */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--bg-card);
            padding: 40px;
            border-radius: 18px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.4s ease-out;
            border: 1px solid var(--border-color);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-title {
            font-size: 26px;
            font-weight: 600;
            margin-bottom: 24px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .form-group {
            margin-bottom: 28px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-control {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            resize: vertical;
            min-height: 120px;
            font-family: inherit;
            font-size: 15px;
            transition: all 0.3s ease;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 16px;
            justify-content: flex-end;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 2px solid var(--border-color);
        }

        /* Alertas */
        .alert {
            padding: 18px 22px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: none;
            border: 2px solid transparent;
            font-weight: 500;
            animation: slideIn 0.3s ease-out;
        }

        .alert-success {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border-color: #10b981;
        }

        .alert-error {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #dc2626;
            border-color: #ef4444;
        }

        /* Detail Highlight */
        .detail-highlight {
            background: linear-gradient(135deg, var(--primary-color), var(--purple-color));
            color: white;
            padding: 6px 14px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .info-value-large {
            font-size: 17px;
            font-weight: 700;
        }

        /* Space Features */
        .space-features {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 16px;
        }

        .feature-tag {
            background: var(--bg-secondary);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 13px;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 16px;
            }
            
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            
            .nav-menu {
                gap: 12px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .page-title {
                font-size: 28px;
            }
            
            .modal-content {
                padding: 24px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 0 16px;
                height: 60px;
            }
            
            .nav-item span {
                display: none;
            }
            
            .nav-item i {
                font-size: 18px;
            }
            
            .user-menu span {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo-section">
            <div class="logo">SR</div>
            <div style="font-weight: 600; color: var(--text-primary); font-size: 18px;">
                Sistema de Reservas
            </div>
        </div>
        
        <nav class="nav-menu">
            <a href="{% url 'dashboard' %}" class="nav-item">
                <i class="bi bi-speedometer2"></i>
                <span>Dashboard</span>
            </a>
            <a href="{% url 'solicitudes_pendientes' %}" class="nav-item active">
                <i class="bi bi-list-check"></i>
                <span>Solicitudes</span>
            </a>
            <a href="{% url 'gestion_espacios' %}" class="nav-item">
                <i class="bi bi-building"></i>
                <span>Espacios</span>
            </a>
            <a href="{% url 'gestion_usuarios' %}" class="nav-item">
                <i class="bi bi-people"></i>
                <span>Usuarios</span>
            </a>
            <a href="{% url 'reportes' %}" class="nav-item">
                <i class="bi bi-graph-up"></i>
                <span>Reportes</span>
            </a>
        </nav>
        
        <div class="user-menu">
            <div class="user-avatar">
                {% if user.first_name and user.last_name %}
                    {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                {% else %}
                    {{ user.username|first|upper }}
                {% endif %}
            </div>
            <span style="font-weight: 500; color: var(--text-primary);">
                {% if user.first_name %}
                    {{ user.first_name }} {{ user.last_name }}
                {% else %}
                    {{ user.username }}
                {% endif %}
            </span>
            
            <div class="theme-toggle">
                <button class="theme-toggle-btn" id="themeToggle">
                    <i class="bi bi-moon-stars"></i>
                </button>
            </div>
            
            <a href="{% url 'logout' %}" style="color: var(--text-secondary); text-decoration: none; font-size: 18px;" 
               title="Cerrar sesi√≥n">
                <i class="bi bi-box-arrow-right"></i>
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Breadcrumb -->
        <nav class="breadcrumb">
            <a href="{% url 'dashboard' %}">
                <i class="bi bi-house-door"></i>
                Dashboard
            </a>
            <span class="breadcrumb-separator">
                <i class="bi bi-chevron-right"></i>
            </span>
            <a href="{% url 'solicitudes_pendientes' %}">
                <i class="bi bi-list-check"></i>
                Solicitudes Pendientes
            </a>
            <span class="breadcrumb-separator">
                <i class="bi bi-chevron-right"></i>
            </span>
            <span style="color: var(--text-secondary);">
                <i class="bi bi-eye"></i>
                Revisar Solicitud #{{ solicitud.id }}
            </span>
        </nav>

        <!-- Alert Messages -->
        <div id="alertMessage" class="alert"></div>

        <!-- Page Header -->
        <div class="page-header">
            <div class="header-content">
                <div>
                    <h1 class="page-title">
                        <i class="bi bi-clipboard-check"></i>
                        Revisar Solicitud de Reserva
                    </h1>
                    <p class="page-subtitle">
                        <i class="bi bi-info-circle"></i>
                        Detalles completos de la solicitud para su revisi√≥n y aprobaci√≥n
                    </p>
                </div>
                <div class="header-badge">
                    <i class="bi bi-tag"></i>
                    <span>ID: {{ solicitud.id }} | Estado:</span>
                    <span class="estado-badge estado-{{ solicitud.estado|lower }}">
                        <i class="bi bi-{% if solicitud.estado == 'Pendiente' %}clock{% elif solicitud.estado == 'Aprobada' %}check-circle{% elif solicitud.estado == 'Rechazada' %}x-circle{% else %}circle{% endif %}"></i>
                        {{ solicitud.estado }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Solicitud Container -->
        <div class="solicitud-container">
            <!-- Informaci√≥n Principal -->
            <div>
                <!-- Grid de Informaci√≥n -->
                <div class="info-grid">
                    <!-- Informaci√≥n del Espacio -->
                    <div class="info-card">
                        <div class="card-header">
                            <div class="card-icon blue">
                                <i class="bi bi-building"></i>
                            </div>
                            <h3 class="card-title">Informaci√≥n del Espacio</h3>
                        </div>
                        <div class="info-item">
                            <span class="info-label">
                                <i class="bi bi-building"></i>
                                Nombre del Espacio:
                            </span>
                            <span class="info-value info-value-large">{{ solicitud.espacio.nombre }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">
                                <i class="bi bi-tag"></i>
                                Tipo:
                            </span>
                            <span class="info-value">{{ solicitud.espacio.tipo }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">
                                <i class="bi bi-people"></i>
                                Capacidad:
                            </span>
                            <span class="info-value detail-highlight">
                                <i class="bi bi-person"></i>
                                {{ solicitud.espacio.capacidad }} personas
                            </span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">
                                <i class="bi bi-geo-alt"></i>
                                Ubicaci√≥n:
                            </span>
                            <span class="info-value">
                                {% if solicitud.espacio.edificio %}
                                    <i class="bi bi-building"></i>
                                    {{ solicitud.espacio.edificio }}, Piso {{ solicitud.espacio.piso|default:"N/A" }}
                                {% else %}
                                    <i class="bi bi-building"></i>
                                    Edificio Principal
                                {% endif %}
                            </span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">
                                <i class="bi bi-info-circle"></i>
                                Estado del Espacio:
                            </span>
                            <span class="info-value">{{ solicitud.espacio.estado }}</span>
                        </div>
                        
                        {% if solicitud.espacio.equipamiento %}
                        <div class="space-features">
                            <span class="info-label">
                                <i class="bi bi-tools"></i>
                                Equipamiento:
                            </span>
                            <div style="flex: 1; display: flex; flex-wrap: wrap; gap: 8px;">
                                {% for equipo in solicitud.espacio.equipamiento.split %}
                                    <span class="feature-tag">
                                        <i class="bi bi-check-circle"></i>
                                        {{ equipo }}
                                    </span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Informaci√≥n de la Reserva -->
                    <div class="info-card">
                        <div class="card-header">
                            <div class="card-icon green">
                                <i class="bi bi-calendar-check"></i>
                            </div>
                            <h3 class="card-title">Detalles de la Reserva</h3>
                        </div>
                        <div class="info-item">
                            <span class="info-label">
                                <i class="bi bi-calendar-date"></i>
                                Fecha:
                            </span>
                            <span class="info-value info-value-large">
                                <i class="bi bi-calendar3"></i>
                                {{ solicitud.fecha_reserva|date:"l, d F Y" }}
                            </span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">
                                <i class="bi bi-clock"></i>
                                Horario:
                            </span>
                            <span class="info-value detail-highlight">
                                <i class="bi bi-clock-history"></i>
                                {{ solicitud.hora_inicio|time:"H:i" }} - {{ solicitud.hora_fin|time:"H:i" }}
                            </span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">
                                <i class="bi bi-hourglass-split"></i>
                                Duraci√≥n:
                            </span>
                            <span class="info-value" id="duracionCalculada">
                                <i class="bi bi-hourglass-top"></i>
                                Calculando...
                            </span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">
                                <i class="bi bi-person-arms-up"></i>
                                Asistentes:
                            </span>
                            <span class="info-value">
                                <i class="bi bi-people"></i>
                                {{ solicitud.num_asistentes }} personas
                            </span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">
                                <i class="bi bi-activity"></i>
                                Estado:
                            </span>
                            <span class="info-value">
                                <span class="estado-badge estado-{{ solicitud.estado|lower }}">
                                    <i class="bi bi-{% if solicitud.estado == 'Pendiente' %}clock{% elif solicitud.estado == 'Aprobada' %}check-circle{% elif solicitud.estado == 'Rechazada' %}x-circle{% else %}circle{% endif %}"></i>
                                    {{ solicitud.estado }}
                                </span>
                            </span>
                        </div>
                    </div>

                    <!-- Informaci√≥n del Solicitante -->
                    <div class="info-card">
                        <div class="card-header">
                            <div class="card-icon purple">
                                <i class="bi bi-person-circle"></i>
                            </div>
                            <h3 class="card-title">Informaci√≥n del Solicitante</h3>
                        </div>
                        <div class="info-item">
                            <span class="info-label">
                                <i class="bi bi-person"></i>
                                Nombre:
                            </span>
                            <span class="info-value info-value-large">
                                <i class="bi bi-person-badge"></i>
                                {% if solicitud.solicitante.first_name %}
                                    {{ solicitud.solicitante.first_name }} {{ solicitud.solicitante.last_name }}
                                {% else %}
                                    {{ solicitud.solicitante.username }}
                                {% endif %}
                            </span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">
                                <i class="bi bi-envelope"></i>
                                Email:
                            </span>
                            <span class="info-value">
                                <i class="bi bi-envelope-at"></i>
                                {{ solicitud.solicitante.email }}
                            </span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">
                                <i class="bi bi-person-vcard"></i>
                                Usuario:
                            </span>
                            <span class="info-value">
                                <i class="bi bi-person-square"></i>
                                {{ solicitud.solicitante.username }}
                            </span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">
                                <i class="bi bi-calendar-plus"></i>
                                Fecha de Solicitud:
                            </span>
                            <span class="info-value">
                                <i class="bi bi-clock-history"></i>
                                {{ solicitud.fecha_solicitud|date:"d/m/Y H:i" }}
                            </span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">
                                <i class="bi bi-telephone"></i>
                                Contacto:
                            </span>
                            <span class="info-value">
                                <i class="bi bi-telephone-forward"></i>
                                {% if solicitud.solicitante.telefono %}
                                    {{ solicitud.solicitante.telefono }}
                                {% else %}
                                    No especificado
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Prop√≥sito de la Reserva -->
                <div class="proposito-section">
                    <div class="card-header">
                        <div class="card-icon yellow">
                            <i class="bi bi-bullseye"></i>
                        </div>
                        <h3 class="card-title">Prop√≥sito de la Reserva</h3>
                    </div>
                    <div class="proposito-content">
                        <p class="proposito-text">
                            <i class="bi bi-chat-left-quote" style="float: left; margin-right: 10px; font-size: 24px; color: var(--primary-color);"></i>
                            {{ solicitud.proposito }}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Panel de Acciones -->
            <div class="actions-panel">
                <h3 class="actions-title">
                    <i class="bi bi-lightning-charge"></i>
                    Acciones de Revisi√≥n
                </h3>
                
                {% if solicitud.estado == 'Pendiente' %}
                <div class="actions-buttons">
                    <button class="btn btn-aprobar" onclick="mostrarModalAprobar()" id="btnAprobar">
                        <i class="bi bi-check-circle"></i>
                        Aprobar Reserva
                    </button>
                    <button class="btn btn-rechazar" onclick="mostrarModalRechazar()" id="btnRechazar">
                        <i class="bi bi-x-circle"></i>
                        Rechazar Reserva
                    </button>
                    <a href="{% url 'solicitudes_pendientes' %}" class="btn btn-volver">
                        <i class="bi bi-arrow-left-circle"></i>
                        Volver al Listado
                    </a>
                </div>
                {% else %}
                <div class="actions-buttons">
                    <div style="text-align: center; padding: 24px; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 20px; border: 2px dashed var(--border-color);">
                        <i class="bi bi-{% if solicitud.estado == 'Aprobada' %}check-circle-fill text-success{% elif solicitud.estado == 'Rechazada' %}x-circle-fill text-danger{% else %}info-circle-fill text-secondary{% endif %}" 
                           style="font-size: 48px; margin-bottom: 12px;"></i>
                        <p style="color: var(--text-secondary); font-weight: 500; font-size: 16px;">
                            Esta solicitud ya ha sido 
                            <strong style="color: var(--text-primary);">{{ solicitud.estado|lower }}</strong>
                        </p>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-top: 8px;">
                            <i class="bi bi-clock-history"></i>
                            {{ solicitud.fecha_revision|date:"d/m/Y H:i"|default:"Fecha no disponible" }}
                        </p>
                    </div>
                    <a href="{% url 'solicitudes_pendientes' %}" class="btn btn-volver">
                        <i class="bi bi-arrow-left-circle"></i>
                        Volver al Listado
                    </a>
                </div>
                {% endif %}

                <!-- Informaci√≥n R√°pida -->
                <div class="quick-info">
                    <h4>
                        <i class="bi bi-lightning-charge"></i>
                        Informaci√≥n R√°pida
                    </h4>
                    <p>
                        <i class="bi bi-building"></i> <strong>Espacio:</strong> {{ solicitud.espacio.nombre }}<br>
                        <i class="bi bi-calendar-date"></i> <strong>Fecha:</strong> {{ solicitud.fecha_reserva|date:"d/m/Y" }}<br>
                        <i class="bi bi-clock"></i> <strong>Horario:</strong> {{ solicitud.hora_inicio|time:"H:i" }}-{{ solicitud.hora_fin|time:"H:i" }}<br>
                        <i class="bi bi-person"></i> <strong>Solicitante:</strong> {{ solicitud.solicitante.username }}<br>
                        <i class="bi bi-people"></i> <strong>Asistentes:</strong> {{ solicitud.num_asistentes }}
                    </p>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal para Aprobar -->
    <div id="modalAprobar" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">
                <i class="bi bi-check-circle-fill"></i>
                Aprobar Reserva
            </h3>
            <form id="formAprobar">
                <div class="form-group">
                    <label class="form-label">
                        <i class="bi bi-chat-left-text"></i>
                        Comentario (opcional):
                    </label>
                    <textarea class="form-control" id="comentarioAprobar" 
                              placeholder="Puedes agregar un comentario opcional para el usuario..."></textarea>
                    <small style="color: var(--text-secondary); font-size: 13px; margin-top: 6px; display: block;">
                        <i class="bi bi-info-circle"></i>
                        Este comentario ser√° visible para el usuario solicitante.
                    </small>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-volver" onclick="cerrarModalAprobar()">
                        <i class="bi bi-x-circle"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-aprobar" id="btnConfirmarAprobar">
                        <i class="bi bi-check-circle"></i>
                        Confirmar Aprobaci√≥n
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Rechazar -->
    <div id="modalRechazar" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">
                <i class="bi bi-x-circle-fill"></i>
                Rechazar Reserva
            </h3>
            <form id="formRechazar">
                <div class="form-group">
                    <label class="form-label">
                        <i class="bi bi-exclamation-triangle"></i>
                        Motivo del rechazo *
                    </label>
                    <textarea class="form-control" id="motivoRechazar" 
                              placeholder="Explica detalladamente el motivo del rechazo..." required></textarea>
                    <small style="color: var(--text-secondary); font-size: 13px; margin-top: 6px; display: block;">
                        <i class="bi bi-info-circle"></i>
                        Este motivo ser√° enviado al usuario solicitante.
                    </small>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-volver" onclick="cerrarModalRechazar()">
                        <i class="bi bi-x-circle"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-rechazar" id="btnConfirmarRechazar">
                        <i class="bi bi-x-circle"></i>
                        Confirmar Rechazo
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Theme Toggle Functionality
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = themeToggle.querySelector('i');
        
        function setTheme(theme) {
            document.documentElement.setAttribute('data-bs-theme', theme);
            localStorage.setItem('theme', theme);
            updateThemeIcon(theme);
        }
        
        function updateThemeIcon(theme) {
            if (theme === 'dark') {
                themeIcon.className = 'bi bi-sun';
            } else {
                themeIcon.className = 'bi bi-moon-stars';
            }
        }
        
        // Load saved theme or detect system preference
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            setTheme(savedTheme);
        } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            setTheme('dark');
        }
        
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-bs-theme');
            setTheme(currentTheme === 'dark' ? 'light' : 'dark');
        });

        // Calcular duraci√≥n autom√°ticamente
        function calcularDuracion() {
            const horaInicio = "{{ solicitud.hora_inicio|time:'H:i' }}";
            const horaFin = "{{ solicitud.hora_fin|time:'H:i' }}";
            
            const [hIni, mIni] = horaInicio.split(':').map(Number);
            const [hFin, mFin] = horaFin.split(':').map(Number);
            
            let totalMinutos = (hFin * 60 + mFin) - (hIni * 60 + mIni);
            
            if (totalMinutos < 0) totalMinutos += 24 * 60;
            
            const horas = Math.floor(totalMinutos / 60);
            const minutos = totalMinutos % 60;
            
            let duracion = '';
            if (horas > 0) {
                duracion += `${horas} hora${horas > 1 ? 's' : ''} `;
            }
            if (minutos > 0) {
                duracion += `${minutos} minuto${minutos > 1 ? 's' : ''}`;
            }
            
            const duracionElement = document.getElementById('duracionCalculada');
            duracionElement.innerHTML = `<i class="bi bi-hourglass-split"></i> ${duracion || '0 minutos'}`;
        }

        // Mostrar alertas
        function showAlert(message, type) {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}" 
                       style="font-size: 20px;"></i>
                    <span>${message}</span>
                </div>
            `;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            setTimeout(() => { 
                alertDiv.style.display = 'none'; 
            }, 5000);
        }

        // Funciones para modales
        function mostrarModalAprobar() {
            document.getElementById('modalAprobar').style.display = 'flex';
            document.getElementById('comentarioAprobar').focus();
        }

        function cerrarModalAprobar() {
            document.getElementById('modalAprobar').style.display = 'none';
            document.getElementById('comentarioAprobar').value = '';
        }

        function mostrarModalRechazar() {
            document.getElementById('modalRechazar').style.display = 'flex';
            document.getElementById('motivoRechazar').focus();
        }

        function cerrarModalRechazar() {
            document.getElementById('modalRechazar').style.display = 'none';
            document.getElementById('motivoRechazar').value = '';
        }

        // Obtener CSRF token
        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Aprobar reserva
        document.getElementById('formAprobar').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const comentario = document.getElementById('comentarioAprobar').value;
            const reservaId = {{ solicitud.id }};
            
            const submitBtn = document.getElementById('btnConfirmarAprobar');
            const originalContent = submitBtn.innerHTML;
            submitBtn.innerHTML = '<div class="loading"></div> Aprobando...';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch(`/api/reservas/${reservaId}/aprobar/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ 
                        comentario: comentario,
                        aprobador_id: {% if user.id %}{{ user.id }}{% else %}null{% endif %}
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert(`‚úÖ ${data.message || 'Solicitud aprobada correctamente'}`, 'success');
                    cerrarModalAprobar();
                    
                    // Deshabilitar botones de acci√≥n
                    document.getElementById('btnAprobar').disabled = true;
                    document.getElementById('btnRechazar').disabled = true;
                    
                    // Actualizar estado en la interfaz
                    const estadoBadge = document.querySelector('.estado-badge');
                    estadoBadge.className = 'estado-badge estado-aprobada';
                    estadoBadge.innerHTML = '<i class="bi bi-check-circle"></i> Aprobada';
                    
                    setTimeout(() => {
                        window.location.href = "{% url 'solicitudes_pendientes' %}";
                    }, 2000);
                } else {
                    const errorMsg = data.error || data.detail || 'Error desconocido al aprobar';
                    showAlert(`‚ùå ${errorMsg}`, 'error');
                    submitBtn.innerHTML = originalContent;
                    submitBtn.disabled = false;
                }
            } catch (error) {
                showAlert(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                submitBtn.innerHTML = originalContent;
                submitBtn.disabled = false;
            }
        });

        // Rechazar reserva
        document.getElementById('formRechazar').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const motivo = document.getElementById('motivoRechazar').value;
            const reservaId = {{ solicitud.id }};
            
            if (!motivo.trim()) {
                showAlert('‚ùå Por favor, proporciona un motivo para el rechazo', 'error');
                document.getElementById('motivoRechazar').focus();
                return;
            }
            
            const submitBtn = document.getElementById('btnConfirmarRechazar');
            const originalContent = submitBtn.innerHTML;
            submitBtn.innerHTML = '<div class="loading"></div> Rechazando...';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch(`/api/reservas/${reservaId}/rechazar/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ 
                        motivo: motivo,
                        aprobador_id: {% if user.id %}{{ user.id }}{% else %}null{% endif %}
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert(`‚úÖ ${data.message || 'Solicitud rechazada correctamente'}`, 'success');
                    cerrarModalRechazar();
                    
                    // Deshabilitar botones de acci√≥n
                    document.getElementById('btnAprobar').disabled = true;
                    document.getElementById('btnRechazar').disabled = true;
                    
                    // Actualizar estado en la interfaz
                    const estadoBadge = document.querySelector('.estado-badge');
                    estadoBadge.className = 'estado-badge estado-rechazada';
                    estadoBadge.innerHTML = '<i class="bi bi-x-circle"></i> Rechazada';
                    
                    setTimeout(() => {
                        window.location.href = "{% url 'solicitudes_pendientes' %}";
                    }, 2000);
                } else {
                    const errorMsg = data.error || data.detail || 'Error desconocido al rechazar';
                    showAlert(`‚ùå ${errorMsg}`, 'error');
                    submitBtn.innerHTML = originalContent;
                    submitBtn.disabled = false;
                }
            } catch (error) {
                showAlert(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                submitBtn.innerHTML = originalContent;
                submitBtn.disabled = false;
            }
        });

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            calcularDuracion();
            
            // Cerrar modales al hacer clic fuera
            window.onclick = function(event) {
                const modalAprobar = document.getElementById('modalAprobar');
                const modalRechazar = document.getElementById('modalRechazar');
                
                if (event.target === modalAprobar) {
                    cerrarModalAprobar();
                }
                if (event.target === modalRechazar) {
                    cerrarModalRechazar();
                }
            }

            // Cerrar modales con Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    cerrarModalAprobar();
                    cerrarModalRechazar();
                }
            });

            // Validar textareas en tiempo real
            const textareas = document.querySelectorAll('.form-control');
            textareas.forEach(textarea => {
                textarea.addEventListener('input', function() {
                    if (this.value.trim()) {
                        this.style.borderColor = 'var(--success-color)';
                    } else if (this.required) {
                        this.style.borderColor = 'var(--danger-color)';
                    } else {
                        this.style.borderColor = 'var(--border-color)';
                    }
                });
            });
        });
    </script>
</body>
</html>
============================================================


===== solicitudes_pendientes.html =====

<!DOCTYPE html>
<html lang="es">
<head>
    {% include 'reservas/_icons.html' %}
    {% include 'reservas/_theme_snippet.html' %}
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitudes Pendientes - Sistema de Reservas</title>
    <link id="darkCss" rel="stylesheet" href="{% static 'css/dark.css' %}" disabled>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--bg); color: var(--text); line-height: 1.6; }
        .header { width: 100%; background: #23272f; color: #fff; position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 3px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: space-between; padding: 0 32px; height: 70px; }
        .header-content { width: 100%; display: flex; align-items: center; justify-content: space-between; gap: 32px; }
        .logo-section { display: flex; align-items: center; gap: 12px; font-size: 22px; font-weight: 700; }
        .logo { color: #facc15; font-size: 28px; display: flex; align-items: center; justify-content: center; }
        .nav-menu { display: flex; gap: 28px; }
        .nav-item { color: #e5e7eb; text-decoration: none; font-weight: 500; padding: 8px 16px; border-radius: 8px; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .nav-item:hover, .nav-item.active { color: #2563eb; background: #23272f; }
        .user-menu { display: flex; align-items: center; gap: 16px; position: relative; }
        .user-avatar { font-size: 22px; color: #facc15; }
        .user-name { font-size: 15px; color: #fff; font-weight: 500; }
        .logout-btn { background: none; border: none; color: #e5e7eb; font-size: 20px; cursor: pointer; margin-left: 8px; }
        .logout-panel { display: none; position: absolute; top: 48px; right: 0; background: #23272f; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); min-width: 160px; z-index: 200; }
        .logout-panel.active { display: block; }
        .panel-item { padding: 12px 20px; color: #fff; cursor: pointer; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #23272f; }
        .panel-item:last-child { border-bottom: none; }
        .main-content { max-width: 1400px; margin: 0 auto; padding: 24px; }
        .page-title { font-size: 32px; font-weight: 700; margin-bottom: 8px; color: var(--text); }
        .page-subtitle { color: var(--muted); margin-bottom: 32px; }
        .solicitudes-grid { display: grid; gap: 20px; }
        .solicitud-card { background: var(--card); border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #F59E0B; }
        .solicitud-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .espacio-nombre { font-size: 20px; font-weight: 600; color: var(--text); }
        .solicitud-fecha { color: var(--muted); font-size: 14px; }
        .solicitud-info { margin-bottom: 20px; }
        .info-item { margin-bottom: 8px; font-size: 14px; }
        .solicitud-actions { display: flex; gap: 12px; }
        .btn-approve, .btn-rechazar, .btn-details { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s; display: flex; align-items: center; gap: 8px; font-size: 1.1em; }
        .btn-approve { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .btn-approve:hover { background: #059669; }
        .btn-rechazar { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .btn-rechazar:hover { background: #b91c1c; }
        .btn-details { background: #2563EB; color: white; text-decoration: none; }
        .btn-details:hover { background: #1d4ed8; }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
        .empty-icon { font-size: 64px; margin-bottom: 16px; }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo-section">
            <div class="logo"><i class="bi bi-building"></i></div>
            <div style="font-weight: 600; color: #fff;">Panel Administrativo</div>
        </div>
        <nav class="nav-menu">
            <a href="{% url 'admin_dashboard' %}" class="nav-item"><i class="bi bi-speedometer2"></i> Dashboard</a>
            <a href="{% url 'solicitudes_pendientes' %}" class="nav-item active"><i class="bi bi-inbox"></i> Solicitudes</a>
            <a href="{% url 'gestion_espacios' %}" class="nav-item"><i class="bi bi-door-open"></i> Espacios</a>
            <a href="{% url 'gestion_usuarios' %}" class="nav-item"><i class="bi bi-people"></i> Usuarios</a>
            <a href="{% url 'reportes' %}" class="nav-item"><i class="bi bi-bar-chart"></i> Reportes</a>
        </nav>
        <div class="user-menu" id="userMenu" style="display: flex; align-items: center; gap: 18px;">
            <button class="notification-btn" id="notificationBtn" style="background:none;border:none;position:relative;font-size:22px;cursor:pointer;color:#facc15;">
                <i class="bi bi-bell"></i>
                <span id="notifBadge" style="display:none;position:absolute;top:0;right:0;background:#ef4444;color:#fff;font-size:11px;padding:2px 6px;border-radius:10px;">0</span>
            </button>
            <div class="user-avatar"><i class="bi bi-person-circle"></i></div>
            <span class="user-name">
                {% if user.first_name %}
                    {{ user.first_name }} {{ user.last_name }}
                {% else %}
                    {{ user.username }}
                {% endif %}
            </span>
            <a href="{% url 'logout' %}" style="margin-left: 10px; color: #666; text-decoration: none;" title="Cerrar sesi√≥n"><i class="bi bi-box-arrow-right"></i></a>
        </div>
    </header>
    <script>
    function updateNotifBadge(count) {
        const badge = document.getElementById('notifBadge');
        if (badge) {
            badge.textContent = count;
            badge.style.display = count > 0 ? 'inline-block' : 'none';
        }
    }
    updateNotifBadge(0);
    </script>
    <main class="main-content">
        <div class="page-title">üìã Solicitudes Pendientes</div>
        <div class="page-subtitle">Gestiona las solicitudes de reserva pendientes de aprobaci√≥n</div>
        <div class="solicitudes-grid">
            {% for solicitud in solicitudes %}
            <div class="solicitud-card">
                <div class="solicitud-header">
                    <h3 class="espacio-nombre">{{ solicitud.espacio.nombre }}</h3>
                    <span class="solicitud-fecha">{{ solicitud.fecha_solicitud|date:"d M Y H:i" }}</span>
                </div>
                <div class="solicitud-info">
                    <div class="info-item"><strong>Solicitante:</strong> {{ solicitud.solicitante.first_name }} {{ solicitud.solicitante.last_name }}</div>
                    <div class="info-item"><strong>Email:</strong> {{ solicitud.solicitante.email }}</div>
                    <div class="info-item"><strong>Fecha Reserva:</strong> {{ solicitud.fecha_reserva }}</div>
                    <div class="info-item"><strong>Horario:</strong> {{ solicitud.hora_inicio|time:"H:i" }} - {{ solicitud.hora_fin|time:"H:i" }}</div>
                    <div class="info-item"><strong>Asistentes:</strong> {{ solicitud.num_asistentes }} personas</div>
                    <div class="info-item"><strong>Prop√≥sito:</strong> {{ solicitud.proposito }}</div>
                </div>
                <div class="solicitud-actions">
                    <button class="btn-approve" onclick="aprobarSolicitud({{ solicitud.id }})"><i class="bi bi-check-circle-fill"></i> Aprobar</button>
                    <button class="btn-rechazar" onclick="rechazarSolicitud({{ solicitud.id }})"><i class="bi bi-x-circle-fill"></i> Rechazar</button>
                    <a href="{% url 'revisar_solicitud' %}?id={{ solicitud.id }}" class="btn-details"><i class="bi bi-clipboard-data"></i> Detalles</a>
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <div class="empty-icon">üéâ</div>
                <h3>No hay solicitudes pendientes</h3>
                <p>Todas las solicitudes han sido procesadas</p>
            </div>
            {% endfor %}
        </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Men√∫ flotante de logout
        const logoutBtn = document.getElementById('logoutBtn');
        const logoutPanel = document.getElementById('logoutPanel');
        const userAvatar = document.getElementById('userAvatar');
        if (logoutBtn && logoutPanel) {
            logoutBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                logoutPanel.classList.toggle('active');
            });
            userAvatar.addEventListener('click', function(e) {
                e.stopPropagation();
                logoutPanel.classList.toggle('active');
            });
            document.addEventListener('click', function(e) {
                if (!logoutPanel.contains(e.target) && !logoutBtn.contains(e.target) && !userAvatar.contains(e.target)) {
                    logoutPanel.classList.remove('active');
                }
            });
        }
        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        async function aprobarSolicitud(solicitudId) {
            if (confirm('¬øEst√°s seguro de que deseas aprobar esta solicitud?')) {
                try {
                    const response = await fetch(`/api/reservas/${solicitudId}/aprobar/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()
                        },
                        body: JSON.stringify({})
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('Solicitud aprobada exitosamente');
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                } catch (error) {
                    alert('Error de conexi√≥n: ' + error);
                }
            }
        }
        async function rechazarSolicitud(solicitudId) {
            const motivo = prompt('Ingresa el motivo del rechazo:');
            if (motivo) {
                try {
                    const response = await fetch(`/api/reservas/${solicitudId}/rechazar/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()
                        },
                        body: JSON.stringify({ motivo: motivo })
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('Solicitud rechazada exitosamente');
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                } catch (error) {
                    alert('Error de conexi√≥n: ' + error);
                }
            }
        }
    </script>
    <script src="{% static 'js/theme.js' %}"></script>
</body>
</html>
============================================================


===== _icons.html =====
<!-- Bootstrap Icons CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

============================================================


===== _theme_snippet.html =====
<!-- Snippet de modo oscuro (inline): prevenci√≥n flash, variables CSS y toggle JS -->



<style>
    :root{
        --bg: #ffffff;
        --text: #111827;
        --card: #ffffff;
        --muted: #6b7280;
        --accent: #2563eb;
    }
    html[data-theme="dark"]{
        --bg: #071126;
        --text: #e6eef8;
        --card: #071126;
        --muted: #9ca3af;
        --accent: #60a5fa;
    }
    body, html{background:var(--bg);color:var(--text)}
    /* Reglas con mayor prioridad para evitar que estilos inline o CSS externos anulen el tema */
    html[data-theme="dark"] body{background:var(--bg) !important;color:var(--text) !important}
    html[data-theme="dark"] .card, html[data-theme="dark"] .card-custom{background:var(--card) !important;color:var(--text) !important;border-color:rgba(255,255,255,0.03) !important}
    html[data-theme="dark"] .header, html[data-theme="dark"] .logo-text{color:var(--text) !important}
    .theme-toggle{position:fixed;right:18px;bottom:18px;z-index:9999;background:var(--card);color:var(--text);border:1px solid rgba(0,0,0,0.08);padding:10px 12px;border-radius:999px;cursor:pointer;box-shadow:0 6px 18px rgba(2,6,23,0.12);font-size:16px}
</style>

<!-- Bot√≥n toggle (puedes moverlo dentro del body donde prefieras) -->
<button id="themeToggle" class="theme-toggle" aria-label="Alternar tema">üåì</button>

<script>
(function(){
    function updateIcon(btn, dark){
        if(!btn) return;
        try{
            btn.textContent = dark ? 'üåô' : '‚òÄÔ∏è';
            btn.setAttribute('aria-pressed', dark ? 'true' : 'false');
        }catch(e){console.warn('[theme-snippet] updateIcon error', e)}
    }

    function setTheme(dark){
        try{ localStorage.setItem('theme', dark? 'dark' : 'light'); }catch(e){}
        if(dark) document.documentElement.setAttribute('data-theme','dark'); else document.documentElement.removeAttribute('data-theme');
        updateIcon(document.getElementById('themeToggle'), dark);
        console.log('[theme-snippet] setTheme ->', dark ? 'dark' : 'light');
    }

    // No aplicar ning√∫n tema por defecto aqu√≠. Solo el bot√≥n controla el tema.

    function init(){
        const btn = document.getElementById('themeToggle');
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        if(btn) updateIcon(btn, isDark);
        if(btn){
            btn.addEventListener('click', function(){
                const currentlyDark = document.documentElement.getAttribute('data-theme') === 'dark';
                setTheme(!currentlyDark);
            });
        } else {
            // log for debugging: button not found
            console.log('[theme-snippet] themeToggle button not found in DOM');
        }
    }

    if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();
})();
</script>

<!-- Inline overrides de alta prioridad para cubrir elementos con fondo blanco/estilos inline -->
<style id="inline-dark-overrides">
html[data-theme="dark"], body.dark-theme {
    background-color: #071126 !important;
    color: #e6eef8 !important;
}
html[data-theme="dark"] body *, body.dark-theme * {
    color: #e6eef8 !important;
}

/* Forzar fondos oscuros en elementos comunes */
html[data-theme="dark"] .login-container,
html[data-theme="dark"] .card,
html[data-theme="dark"] .card-custom,
html[data-theme="dark"] .page-header,
html[data-theme="dark"] .filters-section,
html[data-theme="dark"] .calendar-section,
html[data-theme="dark"] .sidebar,
html[data-theme="dark"] .demo-credentials,
html[data-theme="dark"] .modal-content,
body.dark-theme .login-container,
body.dark-theme .card,
body.dark-theme .card-custom,
body.dark-theme .page-header,
body.dark-theme .filters-section,
body.dark-theme .calendar-section,
body.dark-theme .sidebar,
body.dark-theme .demo-credentials,
body.dark-theme .modal-content {
    background-color: #0f172a !important;
    color: #e6eef8 !important;
    border-color: rgba(255,255,255,0.03) !important;
}

/* Inputs, selects, textareas */
html[data-theme="dark"] input, html[data-theme="dark"] textarea, html[data-theme="dark"] select,
body.dark-theme input, body.dark-theme textarea, body.dark-theme select {
    background-color: #1f2937 !important;
    color: #e6eef8 !important;
    border: 1px solid rgba(255,255,255,0.04) !important;
}

/* Forzar fondo oscuro en elementos con estilo inline 'background: white' */
html[data-theme="dark"] [style*="background: white"], body.dark-theme [style*="background: white"]{
    background-color: #0f172a !important;
    color: #e6eef8 !important;
}

/* Botones neutros y tarjetas */
html[data-theme="dark"] .action-button, body.dark-theme .action-button,
html[data-theme="dark"] .btn, body.dark-theme .btn {
    color: #fff !important;
}

/* Header/Nav */
html[data-theme="dark"] .header, body.dark-theme .header{
    background-color: #0b1220 !important;
    color: #e6eef8 !important;
}

/* Asegurar visibilidad de placeholders */
html[data-theme="dark"] ::placeholder, body.dark-theme ::placeholder{ color: rgba(230,238,248,0.6) !important; }

/* Evitar que cajas blancas con !important sobresalgan */
html[data-theme="dark"] [style*="background: white !important"], body.dark-theme [style*="background: white !important"]{
    background-color: #0f172a !important;
    color: #e6eef8 !important;
}
</style>

<!-- Inline fallback toggle: asegura que el bot√≥n #themeToggle funcione incluso si theme.js no se ha cargado -->
<script>
(function(){
    if(window.__inlineThemeToggleInstalled) return; // evitar doble registro
    window.__inlineThemeToggleInstalled = true;

    function applyDark(dark){
        try{ if(dark) document.documentElement.setAttribute('data-theme','dark'); else document.documentElement.removeAttribute('data-theme'); }catch(e){}
        try{ if(dark) document.body.classList.add('dark-theme'); else document.body.classList.remove('dark-theme'); }catch(e){}
        try{ localStorage.setItem('theme', dark ? 'dark' : 'light'); }catch(e){}
    }

    // Delegated click listener para el bot√≥n del login u otros botones con data-theme-toggle
    document.addEventListener('click', function(ev){
        var btn = ev.target.closest && ev.target.closest('#themeToggle, [data-theme-toggle], #themeToggleBtn');
        if(!btn) return;
        ev.preventDefault();
        var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        applyDark(!isDark);
        // actualizar texto/√≠cono si existe
        try{
            if(btn.tagName === 'BUTTON' || btn.nodeType === 1){
                btn.textContent = !isDark ? '‚òÄÔ∏è' : 'üåô';
            }
        }catch(e){}
    }, {capture:false});

    // Sincronizar icono inicial si existe el bot√≥n
    try{
        var initialBtn = document.querySelector('#themeToggle') || document.querySelector('#themeToggleBtn') || document.querySelector('[data-theme-toggle]');
        if(initialBtn){
            var darkNow = document.documentElement.getAttribute('data-theme') === 'dark';
            initialBtn.textContent = darkNow ? '‚òÄÔ∏è' : 'üåô';
        }
    }catch(e){}
})();
</script>

============================================================


################################################################################
üìÅ Carpeta: D:\todo\Universidad\4_semestre\proyecto_integrado\Backend\Reservadeaula\Inacap_reserva\reservas\templates\reservas\email
################################################################################


===== forgot_password_email.html =====
<html><body style="font-family:Segoe UI, Tahoma, sans-serif;color:#111">
    <p>Hola {{ user.first_name }},</p>
    <p>Se ha solicitado recuperar la contrase√±a de tu cuenta en <strong>{{ site_name }}</strong>.</p>
    <p>Se ha generado una contrase√±a temporal para tu cuenta:</p>
    <p>Contrase√±a temporal (v√°lida una sola vez):</p>
    <p style="background:#f3f4f6;padding:12px;border-radius:6px;display:inline-block"> <strong>{{ temp_password }}</strong></p>
    <p>Para restablecer tu contrase√±a visita:</p>
    <p><a href="{{ reset_link }}">Formulario de restablecimiento</a></p>
    <p>Si no solicitaste este cambio, ignora este correo.</p>
    <p>Saludos,<br>El equipo de {{ site_name }}</p>
</body></html>
============================================================


################################################################################
üìÅ Carpeta: D:\todo\Universidad\4_semestre\proyecto_integrado\Backend\Reservadeaula\Inacap_reserva\static\css
################################################################################


===== dark.css =====
[file name]: dark.css
[file content begin]
/* dark.css - Tema oscuro para el sistema de reservas */

/* Variables para tema oscuro */
:root {
    --dark-bg-primary: #121212;
    --dark-bg-secondary: #1e1e1e;
    --dark-bg-tertiary: #2d2d2d;
    --dark-text-primary: #ffffff;
    --dark-text-secondary: #b0b0b0;
    --dark-text-tertiary: #888888;
    --dark-border-color: #444444;
    --dark-accent-color: #2563eb;
    --dark-accent-hover: #1d4ed8;
    --dark-success-color: #10b981;
    --dark-warning-color: #f59e0b;
    --dark-danger-color: #ef4444;
    --dark-shadow-color: rgba(0, 0, 0, 0.5);
}

/* ========== APLICAR SOLO EN TEMA OSCURO ========== */
html[data-theme="dark"],
body.dark-theme {

    /* Fondo general */
    background: var(--dark-bg-primary) !important;
    color: var(--dark-text-primary) !important;
}

/* Elementos principales en tema oscuro */
html[data-theme="dark"] body,
body.dark-theme body,
html[data-theme="dark"] #container,
body.dark-theme #container,
html[data-theme="dark"] .main-content,
body.dark-theme .main-content {
    background: var(--dark-bg-primary) !important;
    color: var(--dark-text-primary) !important;
}

/* Header */
html[data-theme="dark"] .header,
body.dark-theme .header {
    background-color: var(--dark-bg-secondary) !important;
    border-bottom-color: var(--dark-border-color) !important;
    box-shadow: 0 1px 3px var(--dark-shadow-color) !important;
}

/* Logo y navegaci√≥n */
html[data-theme="dark"] .logo-section div,
body.dark-theme .logo-section div {
    color: var(--dark-text-primary) !important;
}

html[data-theme="dark"] .nav-item,
body.dark-theme .nav-item {
    color: var(--dark-text-secondary) !important;
}

html[data-theme="dark"] .nav-item:hover,
body.dark-theme .nav-item:hover,
html[data-theme="dark"] .nav-item.active,
body.dark-theme .nav-item.active {
    background-color: var(--dark-accent-color) !important;
    color: white !important;
}

/* Breadcrumb */
html[data-theme="dark"] .breadcrumb,
body.dark-theme .breadcrumb {
    color: var(--dark-text-secondary) !important;
}

html[data-theme="dark"] .breadcrumb a,
body.dark-theme .breadcrumb a {
    color: var(--dark-accent-color) !important;
}

/* Secciones de tarjetas */
html[data-theme="dark"] .page-header,
body.dark-theme .page-header,
html[data-theme="dark"] .filters-section,
body.dark-theme .filters-section,
html[data-theme="dark"] .calendar-section,
body.dark-theme .calendar-section,
html[data-theme="dark"] .sidebar,
body.dark-theme .sidebar {
    background-color: var(--dark-bg-secondary) !important;
    border-color: var(--dark-border-color) !important;
    box-shadow: 0 1px 3px var(--dark-shadow-color) !important;
}

html[data-theme="dark"] .page-title,
body.dark-theme .page-title {
    color: var(--dark-text-primary) !important;
}

/* Filtros */
html[data-theme="dark"] .filter-label,
body.dark-theme .filter-label {
    color: var(--dark-text-secondary) !important;
}

html[data-theme="dark"] .filter-select,
body.dark-theme .filter-select,
html[data-theme="dark"] .filter-input,
body.dark-theme .filter-input {
    background-color: var(--dark-bg-tertiary) !important;
    border-color: var(--dark-border-color) !important;
    color: var(--dark-text-primary) !important;
}

html[data-theme="dark"] .filter-select:focus,
body.dark-theme .filter-select:focus,
html[data-theme="dark"] .filter-input:focus,
body.dark-theme .filter-input:focus {
    border-color: var(--dark-accent-color) !important;
    outline: none !important;
}

/* Botones */
html[data-theme="dark"] .view-toggles,
body.dark-theme .view-toggles {
    background-color: var(--dark-bg-tertiary) !important;
}

html[data-theme="dark"] .view-toggle,
body.dark-theme .view-toggle {
    color: var(--dark-text-secondary) !important;
}

html[data-theme="dark"] .view-toggle.active,
body.dark-theme .view-toggle.active {
    background-color: var(--dark-bg-secondary) !important;
    color: var(--dark-accent-color) !important;
}

/* ========== CALENDARIO (FullCalendar) ========== */
html[data-theme="dark"] .fc,
body.dark-theme .fc {
    --fc-page-bg-color: var(--dark-bg-secondary) !important;
    --fc-border-color: var(--dark-border-color) !important;
    --fc-neutral-bg-color: var(--dark-bg-tertiary) !important;
    --fc-neutral-text-color: var(--dark-text-secondary) !important;
    --fc-button-bg-color: var(--dark-bg-tertiary) !important;
    --fc-button-border-color: var(--dark-border-color) !important;
    --fc-button-text-color: var(--dark-text-primary) !important;
    --fc-button-hover-bg-color: var(--dark-accent-color) !important;
    --fc-button-hover-border-color: var(--dark-accent-color) !important;
    --fc-button-active-bg-color: var(--dark-accent-hover) !important;
    --fc-button-active-border-color: var(--dark-accent-hover) !important;
    --fc-today-bg-color: rgba(37, 99, 235, 0.1) !important;
}

html[data-theme="dark"] .fc-header-toolbar button,
body.dark-theme .fc-header-toolbar button {
    background-color: var(--dark-bg-tertiary) !important;
    border-color: var(--dark-border-color) !important;
    color: var(--dark-text-primary) !important;
}

html[data-theme="dark"] .fc-header-toolbar button:hover,
body.dark-theme .fc-header-toolbar button:hover {
    background-color: var(--dark-accent-color) !important;
    border-color: var(--dark-accent-color) !important;
}

html[data-theme="dark"] .fc-toolbar-title,
body.dark-theme .fc-toolbar-title {
    color: var(--dark-text-primary) !important;
}

html[data-theme="dark"] .fc-daygrid-day,
body.dark-theme .fc-daygrid-day {
    background-color: var(--dark-bg-secondary) !important;
}

html[data-theme="dark"] .fc-col-header-cell,
body.dark-theme .fc-col-header-cell {
    background-color: var(--dark-bg-tertiary) !important;
    color: var(--dark-text-primary) !important;
}

html[data-theme="dark"] .fc-day-today,
body.dark-theme .fc-day-today {
    background-color: rgba(37, 99, 235, 0.15) !important;
}

/* Leyenda del calendario */
html[data-theme="dark"] .calendar-legend,
body.dark-theme .calendar-legend {
    background-color: var(--dark-bg-tertiary) !important;
}

/* Reservas en sidebar */
html[data-theme="dark"] .selected-date,
body.dark-theme .selected-date {
    background-color: var(--dark-bg-tertiary) !important;
}

html[data-theme="dark"] .selected-date-text,
body.dark-theme .selected-date-text {
    color: var(--dark-accent-color) !important;
}

html[data-theme="dark"] .reservation-item,
body.dark-theme .reservation-item {
    background-color: var(--dark-bg-tertiary) !important;
}

html[data-theme="dark"] .reservation-time,
body.dark-theme .reservation-time {
    color: var(--dark-text-secondary) !important;
}

html[data-theme="dark"] .reservation-space,
body.dark-theme .reservation-space {
    color: var(--dark-text-primary) !important;
}

/* ========== TARJETAS Y CONTENEDORES ========== */
html[data-theme="dark"] .card,
body.dark-theme .card,
html[data-theme="dark"] .panel,
body.dark-theme .panel,
html[data-theme="dark"] .modal-content,
body.dark-theme .modal-content,
html[data-theme="dark"] .white-card,
body.dark-theme .white-card,
html[data-theme="dark"] .bg-white,
body.dark-theme .bg-white {
    background-color: var(--dark-bg-secondary) !important;
    color: var(--dark-text-primary) !important;
    border-color: rgba(255, 255, 255, 0.1) !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
}

/* T√≠tulos dentro de tarjetas */
html[data-theme="dark"] .card .card-title,
body.dark-theme .card .card-title,
html[data-theme="dark"] .card h3,
body.dark-theme .card h3,
html[data-theme="dark"] .page-title,
body.dark-theme .page-title {
    color: var(--dark-text-primary) !important;
}

/* Texto dentro de tarjetas */
html[data-theme="dark"] .card .card-text,
body.dark-theme .card .card-text,
html[data-theme="dark"] .card p,
body.dark-theme .card p {
    color: var(--dark-text-secondary) !important;
}

/* ========== TABLAS ========== */
html[data-theme="dark"] table,
body.dark-theme table,
html[data-theme="dark"] .table,
body.dark-theme .table {
    background: transparent !important;
    color: var(--dark-text-primary) !important;
}

html[data-theme="dark"] table th,
body.dark-theme table th,
html[data-theme="dark"] table td,
body.dark-theme table td,
html[data-theme="dark"] .table th,
body.dark-theme .table th,
html[data-theme="dark"] .table td,
body.dark-theme .table td {
    background: transparent !important;
    color: var(--dark-text-secondary) !important;
    border-color: rgba(255, 255, 255, 0.1) !important;
}

/* ========== FORMULARIOS E INPUTS ========== */
html[data-theme="dark"] input,
body.dark-theme input,
html[data-theme="dark"] select,
body.dark-theme select,
html[data-theme="dark"] textarea,
body.dark-theme textarea,
html[data-theme="dark"] .form-input,
body.dark-theme .form-input {
    background-color: var(--dark-bg-tertiary) !important;
    color: var(--dark-text-primary) !important;
    border: 1px solid var(--dark-border-color) !important;
}

html[data-theme="dark"] input:focus,
body.dark-theme input:focus,
html[data-theme="dark"] select:focus,
body.dark-theme select:focus,
html[data-theme="dark"] textarea:focus,
body.dark-theme textarea:focus {
    border-color: var(--dark-accent-color) !important;
    outline: none !important;
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2) !important;
}

/* ========== BOTONES ========== */
html[data-theme="dark"] .btn-primary,
body.dark-theme .btn-primary {
    background-color: var(--dark-accent-color) !important;
    color: white !important;
    border-color: var(--dark-accent-color) !important;
}

html[data-theme="dark"] .btn-primary:hover,
body.dark-theme .btn-primary:hover {
    background-color: var(--dark-accent-hover) !important;
    border-color: var(--dark-accent-hover) !important;
}

html[data-theme="dark"] .btn-secondary,
body.dark-theme .btn-secondary {
    background-color: var(--dark-bg-tertiary) !important;
    color: var(--dark-text-primary) !important;
    border-color: var(--dark-border-color) !important;
}

/* ========== LINKS ========== */
html[data-theme="dark"] a,
body.dark-theme a,
html[data-theme="dark"] a:link,
body.dark-theme a:link,
html[data-theme="dark"] a:visited,
body.dark-theme a:visited {
    color: var(--dark-accent-color) !important;
}

html[data-theme="dark"] a:hover,
body.dark-theme a:hover {
    color: var(--dark-accent-hover) !important;
}

/* ========== ESTADOS Y BADGES ========== */
html[data-theme="dark"] .success-message,
body.dark-theme .success-message,
html[data-theme="dark"] .btn-success,
body.dark-theme .btn-success,
html[data-theme="dark"] .badge-success,
body.dark-theme .badge-success {
    background: var(--dark-success-color) !important;
    color: white !important;
    border-color: var(--dark-success-color) !important;
}

html[data-theme="dark"] .btn-danger,
body.dark-theme .btn-danger,
html[data-theme="dark"] .badge-danger,
body.dark-theme .badge-danger {
    background: var(--dark-danger-color) !important;
    color: white !important;
    border-color: var(--dark-danger-color) !important;
}

html[data-theme="dark"] .btn-warning,
body.dark-theme .btn-warning,
html[data-theme="dark"] .badge-warning,
body.dark-theme .badge-warning {
    background: var(--dark-warning-color) !important;
    color: #000000 !important;
    border-color: var(--dark-warning-color) !important;
}

html[data-theme="dark"] .badge-info,
body.dark-theme .badge-info {
    background: var(--dark-accent-color) !important;
    color: white !important;
    border-color: var(--dark-accent-color) !important;
}

/* ========== SCROLLBARS ========== */
html[data-theme="dark"] ::-webkit-scrollbar,
body.dark-theme ::-webkit-scrollbar {
    width: 10px;
    background-color: var(--dark-bg-tertiary);
}

html[data-theme="dark"] ::-webkit-scrollbar-thumb,
body.dark-theme ::-webkit-scrollbar-thumb {
    background-color: var(--dark-border-color);
    border-radius: 5px;
}

html[data-theme="dark"] ::-webkit-scrollbar-thumb:hover,
body.dark-theme ::-webkit-scrollbar-thumb:hover {
    background-color: var(--dark-accent-color);
}

/* ========== OVERRIDES ESPEC√çFICOS ========== */

/* Sobreescribir fondos blancos inline */
html[data-theme="dark"] [style*="background: white"],
html[data-theme="dark"] [style*="background:#fff"],
html[data-theme="dark"] [style*="background: #fff"],
html[data-theme="dark"] [style*="background: #ffffff"],
html[data-theme="dark"] [style*="background-color: white"],
html[data-theme="dark"] [style*="background-color:#fff"],
html[data-theme="dark"] [style*="background-color: #fff"],
html[data-theme="dark"] [style*="background-color: #ffffff"] {
    background-color: var(--dark-bg-secondary) !important;
    color: var(--dark-text-primary) !important;
}

/* Sobreescribir fondos grises claros */
html[data-theme="dark"] [style*="background: #f5f5f5"],
html[data-theme="dark"] [style*="background: #f8f9fa"],
html[data-theme="dark"] [style*="background: #e9ecef"],
html[data-theme="dark"] [style*="background: #e6e6e6"] {
    background-color: var(--dark-bg-tertiary) !important;
    color: var(--dark-text-primary) !important;
}

/* Wizard y pasos */
html[data-theme="dark"] .step-wizard,
body.dark-theme .step-wizard,
html[data-theme="dark"] .wizard-header,
body.dark-theme .wizard-header {
    background-color: var(--dark-bg-secondary) !important;
    border-color: rgba(255, 255, 255, 0.1) !important;
}

html[data-theme="dark"] .step-number,
body.dark-theme .step-number {
    background-color: var(--dark-bg-tertiary) !important;
    color: var(--dark-text-primary) !important;
}

html[data-theme="dark"] .step.active .step-number,
body.dark-theme .step.active .step-number {
    background-color: var(--dark-accent-color) !important;
    color: white !important;
}

/* Notificaciones */
html[data-theme="dark"] .notification,
body.dark-theme .notification,
html[data-theme="dark"] .notification-card,
body.dark-theme .notification-card {
    background-color: var(--dark-bg-secondary) !important;
    border-color: rgba(255, 255, 255, 0.1) !important;
}

html[data-theme="dark"] .notification.unread,
body.dark-theme .notification.unread {
    border-left-color: var(--dark-accent-color) !important;
}

/* Login y autenticaci√≥n */
html[data-theme="dark"] .login-container,
body.dark-theme .login-container {
    background-color: var(--dark-bg-primary) !important;
}

html[data-theme="dark"] .login-card,
body.dark-theme .login-card {
    background-color: var(--dark-bg-secondary) !important;
    border-color: rgba(255, 255, 255, 0.1) !important;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
}

/* Ayuda de teclado */
html[data-theme="dark"] .keyboard-help,
body.dark-theme .keyboard-help {
    background-color: var(--dark-bg-tertiary) !important;
    border-color: var(--dark-border-color) !important;
}

html[data-theme="dark"] .keyboard-help-title,
body.dark-theme .keyboard-help-title {
    color: var(--dark-text-primary) !important;
}

html[data-theme="dark"] .keyboard-shortcuts,
body.dark-theme .keyboard-shortcuts {
    color: var(--dark-text-secondary) !important;
}

/* Estados vac√≠os */
html[data-theme="dark"] .empty-state,
body.dark-theme .empty-state {
    background-color: var(--dark-bg-secondary) !important;
    color: var(--dark-text-secondary) !important;
}

html[data-theme="dark"] .empty-state-title,
body.dark-theme .empty-state-title {
    color: var(--dark-text-primary) !important;
}

/* ========== UTILIDADES ========== */
html[data-theme="dark"] .text-muted,
body.dark-theme .text-muted,
html[data-theme="dark"] .muted,
body.dark-theme .muted {
    color: var(--dark-text-tertiary) !important;
}

html[data-theme="dark"] .border,
body.dark-theme .border {
    border-color: rgba(255, 255, 255, 0.1) !important;
}

html[data-theme="dark"] .shadow,
body.dark-theme .shadow {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
}

/* ========== ANIMACIONES SUTILES ========== */
html[data-theme="dark"] .card,
body.dark-theme .card,
html[data-theme="dark"] .btn,
body.dark-theme .btn {
    transition: all 0.2s ease !important;
}

/* ========== RESPONSIVE ========== */
@media (max-width: 768px) {
    html[data-theme="dark"] body,
    body.dark-theme body {
        font-size: 14px !important;
    }
    
    html[data-theme="dark"] .card,
    body.dark-theme .card {
        margin: 8px !important;
        padding: 12px !important;
    }
}
[file content end]  
============================================================


===== dark_admin.css =====
[file name]: dark_admin.css
[file content begin]
/* dark_admin.css: Fuerza tema oscuro y corrige fondos/textos claros en el admin de Django */

/* Aplicar solo cuando el usuario ha seleccionado tema oscuro */
html[data-theme="dark"] body,
html[data-theme="dark"] #container,
html[data-theme="dark"] .login,
html[data-theme="dark"] .module,
html[data-theme="dark"] .dashboard,
html[data-theme="dark"] .form-row,
html[data-theme="dark"] .selector,
html[data-theme="dark"] .selector-available-title,
html[data-theme="dark"] .selector-chosen-title,
html[data-theme="dark"] .selector-chosen .list-footer-display,
html[data-theme="dark"] .selector-filter,
html[data-theme="dark"] .paginator,
html[data-theme="dark"] .breadcrumbs,
html[data-theme="dark"] .object-tools,
html[data-theme="dark"] .submit-row,
html[data-theme="dark"] .messagelist,
html[data-theme="dark"] .inline-group,
html[data-theme="dark"] .change-form,
html[data-theme="dark"] .change-list {
    background: #181818 !important;
    color: #e6eef8 !important;
    border-color: #232b3a !important;
}

html[data-theme="dark"] input,
html[data-theme="dark"] select,
html[data-theme="dark"] textarea {
    background: #232b3a !important;
    color: #e6eef8 !important;
    border-color: #232b3a !important;
}

html[data-theme="dark"] input:focus,
html[data-theme="dark"] select:focus,
html[data-theme="dark"] textarea:focus {
    border-color: #7da2ff !important;
    outline: none !important;
    box-shadow: 0 0 0 2px rgba(125, 162, 255, 0.2) !important;
}

html[data-theme="dark"] a,
html[data-theme="dark"] a:link,
html[data-theme="dark"] a:visited {
    color: #7da2ff !important;
    text-decoration: none !important;
}

html[data-theme="dark"] a:hover {
    color: #a0c1ff !important;
    text-decoration: underline !important;
}

html[data-theme="dark"] .theme-toggle {
    background: transparent !important;
    color: #e6eef8 !important;
}

html[data-theme="dark"] .errornote,
html[data-theme="dark"] .errorlist {
    background: #570808 !important;
    color: #fff !important;
    border-color: #7a0d0d !important;
}

html[data-theme="dark"] .success {
    background: #006b1b !important;
    color: #fff !important;
    border-color: #008a22 !important;
}

html[data-theme="dark"] .warning {
    background: #583305 !important;
    color: #fff !important;
    border-color: #7a4707 !important;
}

/* Corrige cualquier fondo blanco o gris claro inline */
html[data-theme="dark"] [style*="background: #fff"],
html[data-theme="dark"] [style*="background:#fff"],
html[data-theme="dark"] [style*="background: #e6e6e6"],
html[data-theme="dark"] [style*="background:#e6e6e6"],
html[data-theme="dark"] [style*="background: rgb(230,230,230)"],
html[data-theme="dark"] [style*="background-color: #fff"],
html[data-theme="dark"] [style*="background-color:#fff"],
html[data-theme="dark"] [style*="background-color: #e6e6e6"],
html[data-theme="dark"] [style*="background-color:#e6e6e6"],
html[data-theme="dark"] [style*="background-color: rgb(230,230,230)"] {
    background: #181818 !important;
    color: #e6eef8 !important;
}

/* Tablas admin */
html[data-theme="dark"] table,
html[data-theme="dark"] thead,
html[data-theme="dark"] tbody,
html[data-theme="dark"] tr,
html[data-theme="dark"] th,
html[data-theme="dark"] td {
    background: #181818 !important;
    color: #e6eef8 !important;
    border-color: #232b3a !important;
}

html[data-theme="dark"] thead th {
    background: #232b3a !important;
    color: #e6eef8 !important;
}

/* Botones admin */
html[data-theme="dark"] .button,
html[data-theme="dark"] input[type="submit"],
html[data-theme="dark"] input[type="button"] {
    background: #232b3a !important;
    color: #e6eef8 !important;
    border-color: #2d3a4d !important;
}

html[data-theme="dark"] .button:hover,
html[data-theme="dark"] input[type="submit"]:hover,
html[data-theme="dark"] input[type="button"]:hover {
    background: #2d3a4d !important;
    border-color: #7da2ff !important;
}

html[data-theme="dark"] .button.default {
    background: #7da2ff !important;
    color: #181818 !important;
    border-color: #7da2ff !important;
}

html[data-theme="dark"] .button.default:hover {
    background: #a0c1ff !important;
    border-color: #a0c1ff !important;
}

/* Header admin */
html[data-theme="dark"] #header {
    background: #232b3a !important;
    color: #e6eef8 !important;
}

html[data-theme="dark"] #branding h1 {
    color: #e6eef8 !important;
}

html[data-theme="dark"] #user-tools {
    color: #e6eef8 !important;
}

html[data-theme="dark"] #user-tools a {
    color: #7da2ff !important;
}

html[data-theme="dark"] #user-tools a:hover {
    color: #a0c1ff !important;
}

/* Sidebar admin */
html[data-theme="dark"] #content-related {
    background: #181818 !important;
    border-color: #232b3a !important;
}

html[data-theme="dark"] #content-related .module {
    background: transparent !important;
}

html[data-theme="dark"] #content-related h3 {
    color: #e6eef8 !important;
    background: #232b3a !important;
}

/* Dashboard */
html[data-theme="dark"] .dashboard #content {
    background: #181818 !important;
}

html[data-theme="dark"] .dashboard .module {
    background: #232b3a !important;
}

html[data-theme="dark"] .dashboard .module h2 {
    background: #181818 !important;
    color: #e6eef8 !important;
    border-color: #232b3a !important;
}

/* Login page */
html[data-theme="dark"] .login #header {
    background: transparent !important;
}

html[data-theme="dark"] .login #content {
    background: #181818 !important;
    padding: 20px !important;
    border-radius: 8px !important;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
}

html[data-theme="dark"] .login .form-row {
    background: transparent !important;
}

html[data-theme="dark"] .login .submit-row {
    background: transparent !important;
    padding: 10px 0 !important;
}

/* Responsive admin */
@media (max-width: 767px) {
    html[data-theme="dark"] body {
        font-size: 14px !important;
    }
    
    html[data-theme="dark"] #header {
        padding: 10px !important;
    }
}
[file content end]
============================================================


################################################################################
üìÅ Carpeta: D:\todo\Universidad\4_semestre\proyecto_integrado\Backend\Reservadeaula\Inacap_reserva\static\js
################################################################################


===== theme.js =====
[file name]: theme.js
[file content begin]
// theme.js - Controlador del tema oscuro/claro - CONTROL EXCLUSIVO POR USUARIO

class ThemeManager {
    constructor() {
        this.darkCss = document.getElementById('darkCss');
        this.darkAdminCss = document.getElementById('darkAdminCss');
        this.themeToggle = null;
        this.init();
    }

    init() {
        // 1. SIEMPRE aplicar el tema guardado por el usuario como prioridad absoluta
        const savedTheme = localStorage.getItem('theme');
        
        // 2. IGNORAR COMPLETAMENTE el tema del sistema al inicio
        if (savedTheme === 'dark') {
            this.enableDarkTheme();
        } else {
            // Si no hay preferencia guardada o es 'light', usar tema claro
            this.disableDarkTheme();
            if (!savedTheme) {
                localStorage.setItem('theme', 'light'); // Guarda la preferencia por defecto
            }
        }

        // 3. Buscar y configurar el toggle del tema
        const existingToggle = document.getElementById('themeToggle') || document.getElementById('themeToggleBtn');
        if (existingToggle) {
            this.themeToggle = existingToggle;
            this.themeToggle.id = this.themeToggle.id || 'themeToggleBtn';
            this.themeToggle.classList.add('theme-toggle-btn');
            this.themeToggle.addEventListener('click', () => this.handleToggleClick());
        } else {
            this.themeToggle = this.createThemeToggle();
            this.addThemeToggleToDOM();
        }

        // 4. Actualizar el estado inicial del toggle
        this.updateToggleState();

        // 5. Aplicar clase al body para facilitar el CSS
        document.addEventListener('DOMContentLoaded', () => {
            this.updateBodyClass();
        });
    }

    createThemeToggle() {
        const toggle = document.createElement('button');
        toggle.id = 'themeToggleBtn';
        toggle.type = 'button';
        toggle.innerHTML = `<span class="theme-icon"></span><span class="theme-text">Tema</span>`;
        toggle.className = 'theme-toggle-btn';
        toggle.setAttribute('aria-label', 'Alternar tema oscuro/claro');
        toggle.setAttribute('title', 'Click para cambiar tema');
        return toggle;
    }

    addThemeToggleToDOM() {
        // Buscar el header para agregar el toggle
        const header = document.querySelector('.header') || document.querySelector('header');
        if (header) {
            // Agregar al final del header
            header.appendChild(this.themeToggle);
        } else {
            // Si no hay header, agregar al body con posici√≥n fija
            document.body.appendChild(this.themeToggle);
            this.themeToggle.classList.add('outside-header');
        }

        // Agregar estilos para el bot√≥n
        this.addToggleStyles();
        this.themeToggle.addEventListener('click', () => this.handleToggleClick());
        this.updateToggleState();
    }

    handleToggleClick() {
        this.toggleTheme();
    }

    addToggleStyles() {
        const styles = `
            /* Estilos limpios y consistentes para bot√≥n de toggle */
            .theme-toggle-btn{
                background: rgba(255,255,255,0.95);
                border: 0;
                padding: 8px 12px;
                border-radius: 999px;
                display: inline-flex;
                align-items: center;
                gap: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                color: #111827;
                box-shadow: 0 6px 20px rgba(18, 25, 40, 0.12);
                transition: all 200ms ease;
                z-index: 10000;
                position: relative;
            }
            .theme-toggle-btn:hover{ 
                transform: translateY(-2px); 
                background: rgba(255,255,255,1); 
                box-shadow: 0 8px 25px rgba(18, 25, 40, 0.15);
            }
            .theme-toggle-btn:active{ 
                transform: translateY(0); 
            }
            .theme-toggle-btn .theme-icon{ 
                font-size: 16px;
                transition: transform 300ms ease;
            }
            .theme-toggle-btn .theme-text{ 
                display: none;
                font-weight: 500;
            }
            @media(min-width: 720px){ 
                .theme-toggle-btn .theme-text{ display: inline } 
            }

            /* Bot√≥n inyectado por snippet Django */
            #themeToggle{ 
                all: unset; 
                display: inline-block;
                cursor: pointer;
            }

            /* Posicionamiento cuando el bot√≥n est√° fuera del header */
            .theme-toggle-btn.outside-header{ 
                position: fixed; 
                right: 20px; 
                bottom: 20px; 
                z-index: 9999;
                background: rgba(255,255,255,0.95);
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            }

            /* Tema oscuro para el propio bot√≥n */
            html[data-theme="dark"] .theme-toggle-btn,
            body.dark-theme .theme-toggle-btn { 
                background: rgba(17, 24, 39, 0.95); 
                color: #e6eef8; 
                box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
            }
            html[data-theme="dark"] .theme-toggle-btn:hover,
            body.dark-theme .theme-toggle-btn:hover { 
                background: rgba(17, 24, 39, 1); 
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            }
            
            /* Cuando est√° fuera del header en tema oscuro */
            html[data-theme="dark"] .theme-toggle-btn.outside-header,
            body.dark-theme .theme-toggle-btn.outside-header { 
                background: rgba(17, 24, 39, 0.95); 
                color: #e6eef8; 
                box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
            }

            /* Tema claro para el bot√≥n */
            html[data-theme="light"] .theme-toggle-btn,
            :not(html[data-theme="dark"]) .theme-toggle-btn:not(.dark-theme) { 
                background: rgba(255, 255, 255, 0.95); 
                color: #111827; 
                box-shadow: 0 6px 20px rgba(18, 25, 40, 0.12);
            }
        `;

        const styleSheet = document.createElement('style');
        styleSheet.id = 'theme-toggle-styles';
        styleSheet.textContent = styles;
        document.head.appendChild(styleSheet);
    }

    enableDarkTheme() {
        // Habilitar CSS de tema oscuro
        if (this.darkCss) {
            this.darkCss.disabled = false;
        }
        if (this.darkAdminCss) {
            this.darkAdminCss.disabled = false;
        }
        
        // Aplicar clases y atributos
        document.body.classList.add('dark-theme');
        document.body.classList.remove('light-theme');
        document.documentElement.setAttribute('data-theme', 'dark');
        
        // Guardar preferencia
        localStorage.setItem('theme', 'dark');
        
        // Actualizar toggle
        this.updateToggleState();
        
        // Disparar evento personalizado
        this.dispatchThemeChange('dark');
    }

    disableDarkTheme() {
        // Deshabilitar CSS de tema oscuro
        if (this.darkCss) {
            this.darkCss.disabled = true;
        }
        if (this.darkAdminCss) {
            this.darkAdminCss.disabled = true;
        }
        
        // Aplicar clases y atributos
        document.body.classList.remove('dark-theme');
        document.body.classList.add('light-theme');
        document.documentElement.setAttribute('data-theme', 'light');
        
        // Guardar preferencia
        localStorage.setItem('theme', 'light');
        
        // Actualizar toggle
        this.updateToggleState();
        
        // Disparar evento personalizado
        this.dispatchThemeChange('light');
    }

    toggleTheme() {
        const isDark = document.body.classList.contains('dark-theme') || 
                      document.documentElement.getAttribute('data-theme') === 'dark';
        
        if (isDark) {
            this.disableDarkTheme();
        } else {
            this.enableDarkTheme();
        }
        
        // Opcional: recargar solo en desarrollo para aplicar cambios inmediatos
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            setTimeout(() => { 
                console.log('Recargando para aplicar cambios de tema...');
                window.location.reload(); 
            }, 300);
        }
    }

    updateToggleState() {
        if (!this.themeToggle) return;
        
        const isDark = localStorage.getItem('theme') === 'dark' ||
                      document.body.classList.contains('dark-theme') ||
                      document.documentElement.getAttribute('data-theme') === 'dark';
        
        const iconElement = this.themeToggle.querySelector('.theme-icon');
        const textElement = this.themeToggle.querySelector('.theme-text');
        
        if (iconElement) {
            iconElement.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            // Animaci√≥n sutil
            iconElement.style.transform = 'scale(1.2)';
            setTimeout(() => {
                iconElement.style.transform = 'scale(1)';
            }, 200);
        }
        
        if (textElement) {
            textElement.textContent = isDark ? ' Claro' : ' Oscuro';
        }
        
        // Actualizar t√≠tulo del bot√≥n
        this.themeToggle.setAttribute('title', isDark ? 
            'Cambiar a tema claro' : 'Cambiar a tema oscuro');
    }

    updateBodyClass() {
        const currentTheme = localStorage.getItem('theme') || 'light';
        if (currentTheme === 'dark') {
            document.body.classList.add('dark-theme');
            document.body.classList.remove('light-theme');
            document.documentElement.setAttribute('data-theme', 'dark');
        } else {
            document.body.classList.remove('dark-theme');
            document.body.classList.add('light-theme');
            document.documentElement.setAttribute('data-theme', 'light');
        }
    }

    dispatchThemeChange(theme) {
        const event = new CustomEvent('themeChanged', {
            detail: { theme: theme }
        });
        window.dispatchEvent(event);
    }

    getCurrentTheme() {
        return localStorage.getItem('theme') || 'light';
    }
}

// Inicializar cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', () => {
    window.themeManager = new ThemeManager();
});

// Tambi√©n inicializar inmediatamente para p√°ginas que ya cargaron
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        window.themeManager = new ThemeManager();
    });
} else {
    window.themeManager = new ThemeManager();
}

// Exportar para uso global
if (typeof module !== 'undefined' && module.exports) {
    module.exports = ThemeManager;
}
[file content end]
============================================================
