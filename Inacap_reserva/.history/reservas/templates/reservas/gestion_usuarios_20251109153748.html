<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Usuarios - Sistema de Reservas</title>
    <style>
        /* Estilos existentes... */
        
        /* Nuevos estilos para filtros */
        .filters-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        .filter-input, .filter-select {
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: border-color 0.3s ease;
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: #2563eb;
        }

        .filter-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .loading-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            color: #6b7280;
            font-size: 14px;
        }

        .results-info {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: none;
        }

        .user-status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background: #d1fae5;
            color: #065f46;
        }

        .status-inactive {
            background: #fee2e2;
            color: #dc2626;
        }

        .rol-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            background: #e0e7ff;
            color: #3730a3;
        }
    </style>
</head>
<body>
    <!-- Header existente... -->

    <main class="main-content">
        <!-- Breadcrumb existente... -->

        <!-- Page Header existente... -->

        <!-- Secci√≥n de Filtros (NUEVA) -->
        <div class="filters-section">
            <h3 style="margin-bottom: 16px; color: #111827;">üîç Filtrar Usuarios</h3>
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">Buscar por nombre, email o usuario</label>
                    <input type="text" class="filter-input" id="searchInput" 
                           placeholder="Ej: Juan, juan@email.com...">
                </div>

                <div class="filter-group">
                    <label class="filter-label">Filtrar por Rol</label>
                    <select class="filter-select" id="rolFilter">
                        <option value="">Todos los roles</option>
                        <option value="Usuario">Usuario</option>
                        <option value="Docente">Docente</option>
                        <option value="Investigacion">Investigaci√≥n</option>
                        <option value="Administrativo">Administrativo</option>
                        <option value="Aprobador">Aprobador</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Filtrar por Estado</label>
                    <select class="filter-select" id="estadoFilter">
                        <option value="">Todos los estados</option>
                        <option value="activo">Activo</option>
                        <option value="inactivo">Inactivo</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">&nbsp;</label>
                    <div class="filter-actions">
                        <button class="btn btn-primary" onclick="filtrarUsuarios()">
                            üîç Aplicar Filtros
                        </button>
                        <button class="btn btn-secondary" onclick="limpiarFiltros()">
                            üóëÔ∏è Limpiar
                        </button>
                    </div>
                </div>
            </div>

            <div class="loading-indicator" id="loadingIndicator">
                <span>‚è≥ Cargando...</span>
            </div>
        </div>

        <!-- Informaci√≥n de resultados -->
        <div class="results-info" id="resultsInfo">
            <strong>üìä Resultados de la b√∫squeda:</strong>
            <span id="resultsCount">0</span> usuarios encontrados
            <button class="btn btn-secondary" onclick="mostrarTodos()" style="margin-left: auto; padding: 4px 12px; font-size: 12px;">
                üëÅÔ∏è Mostrar todos
            </button>
        </div>

        <!-- Tabla de usuarios existente (se actualizar√° din√°micamente) -->
        <div class="table-section">
            <div class="table-container">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Nombre Completo</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Estado</th>
                            <th>Fecha Registro</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Los datos se cargar√°n din√°micamente aqu√≠ -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // Funci√≥n para obtener el token CSRF
        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Funci√≥n para filtrar usuarios
        async function filtrarUsuarios() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const resultsInfo = document.getElementById('resultsInfo');
            const tableBody = document.getElementById('usersTableBody');
            
            // Mostrar loading
            loadingIndicator.style.display = 'flex';
            tableBody.innerHTML = '';

            try {
                // Obtener valores de los filtros
                const searchTerm = document.getElementById('searchInput').value;
                const rolFilter = document.getElementById('rolFilter').value;
                const estadoFilter = document.getElementById('estadoFilter').value;

                // Construir URL con par√°metros
                const params = new URLSearchParams();
                if (searchTerm) params.append('search', searchTerm);
                if (rolFilter) params.append('rol', rolFilter);
                if (estadoFilter) params.append('estado', estadoFilter);

                const response = await fetch(`/api/usuarios/filtrar/?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Actualizar informaci√≥n de resultados
                    document.getElementById('resultsCount').textContent = data.total;
                    resultsInfo.style.display = 'flex';

                    // Actualizar tabla
                    if (data.usuarios.length > 0) {
                        tableBody.innerHTML = data.usuarios.map(usuario => `
                            <tr>
                                <td>
                                    <div style="font-weight: 500;">${usuario.username}</div>
                                </td>
                                <td>${usuario.first_name || ''} ${usuario.last_name || ''}</td>
                                <td>${usuario.email}</td>
                                <td>
                                    <span class="rol-badge">${usuario.rol}</span>
                                </td>
                                <td>
                                    <span class="user-status-badge ${usuario.is_active ? 'status-active' : 'status-inactive'}">
                                        ${usuario.is_active ? '‚úÖ Activo' : '‚ùå Inactivo'}
                                    </span>
                                </td>
                                <td>${usuario.date_joined}</td>
                                <td>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn-action" onclick="editarUsuario(${usuario.id})" title="Editar">
                                            ‚úèÔ∏è
                                        </button>
                                        <button class="btn-action ${usuario.is_active ? 'btn-danger' : 'btn-success'}" 
                                                onclick="cambiarEstadoUsuario(${usuario.id}, ${!usuario.is_active})"
                                                title="${usuario.is_active ? 'Desactivar' : 'Activar'}">
                                            ${usuario.is_active ? '‚ùå' : '‚úÖ'}
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                                    üîç No se encontraron usuarios con los filtros aplicados
                                </td>
                            </tr>
                        `;
                    }
                } else {
                    alert('Error al filtrar usuarios: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n al filtrar usuarios');
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        // Funci√≥n para limpiar filtros
        function limpiarFiltros() {
            document.getElementById('searchInput').value = '';
            document.getElementById('rolFilter').value = '';
            document.getElementById('estadoFilter').value = '';
            document.getElementById('resultsInfo').style.display = 'none';
            
            // Recargar todos los usuarios
            mostrarTodos();
        }

        // Funci√≥n para mostrar todos los usuarios
        function mostrarTodos() {
            limpiarFiltros();
            // Aqu√≠ puedes recargar la tabla completa si es necesario
            location.reload(); // O implementa una funci√≥n para cargar todos los usuarios
        }

        // Cargar filtros al iniciar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            // Opcional: cargar todos los usuarios inicialmente
            // filtrarUsuarios();
        });

        // B√∫squeda en tiempo real (opcional)
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (this.value.length >= 3 || this.value.length === 0) {
                    filtrarUsuarios();
                }
            }, 500);
        });

        // Las funciones editarUsuario y cambiarEstadoUsuario deber√≠an estar en tu JavaScript existente
        function editarUsuario(userId) {
            // Tu funci√≥n existente para editar usuario
            console.log('Editar usuario:', userId);
        }

        function cambiarEstadoUsuario(userId, nuevoEstado) {
            // Tu funci√≥n existente para cambiar estado
            console.log('Cambiar estado usuario:', userId, nuevoEstado);
        }
    </script>
</body>
</html>