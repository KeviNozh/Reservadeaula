<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Usuario - Sistema de Reservas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f9fafb;
            color: #111827;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 24px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #2563eb;
        }

        .form-input:read-only {
            background-color: #f9fafb;
            color: #6b7280;
            cursor: not-allowed;
        }

        .read-only-field {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            color: #6b7280;
            font-size: 14px;
        }

        .read-only-label {
            color: #6b7280;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
        }

        .btn-primary {
            background: #10b981;
            color: white;
        }

        .btn-primary:hover {
            background: #059669;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #2563eb;
            text-decoration: none;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .user-info-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .user-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-label {
            color: #64748b;
            font-weight: 500;
        }

        .info-value {
            color: #1e293b;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <a href="{% url 'gestion_usuarios' %}" class="back-link">
        ‚Üê Volver a Gesti√≥n de Usuarios
    </a>

    <div class="container">
        <h1>‚úèÔ∏è Editar Usuario</h1>

        <div id="alertMessage" class="alert"></div>

        <!-- Informaci√≥n del usuario (solo lectura) -->
        <div class="user-info-card">
            <div class="user-info-item">
                <span class="info-label">Usuario ID:</span>
                <span class="info-value" id="userId">Cargando...</span>
            </div>
            <div class="user-info-item">
                <span class="info-label">Username:</span>
                <span class="info-value" id="userUsername">Cargando...</span>
            </div>
            <div class="user-info-item">
                <span class="info-label">Fecha de registro:</span>
                <span class="info-value" id="userDateJoined">Cargando...</span>
            </div>
        </div>

        <form id="editUserForm">
            <!-- Campos editables -->
            <div class="form-group">
                <label class="form-label">Nombre *</label>
                <input type="text" class="form-input" id="first_name" name="first_name" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Apellido *</label>
                <input type="text" class="form-input" id="last_name" name="last_name" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Email *</label>
                <input type="email" class="form-input" id="email" name="email" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Rol *</label>
                <select class="form-select" id="rol" name="rol" required>
                    <option value="">Seleccionar rol...</option>
                    <option value="Usuario">Usuario</option>
                    <option value="Docente">Docente</option>
                    <option value="Investigacion">Investigaci√≥n</option>
                    <option value="Administrativo">Administrativo</option>
                    <option value="Aprobador">Aprobador</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Departamento</label>
                <input type="text" class="form-input" id="departamento" name="departamento">
            </div>
            
            <div class="form-group">
                <label class="form-label">Estado</label>
                <select class="form-select" id="is_active" name="is_active">
                    <option value="true">Activo</option>
                    <option value="false">Inactivo</option>
                </select>
            </div>
            
            <div class="form-actions">
                <a href="{% url 'gestion_usuarios' %}" class="btn btn-secondary">Cancelar</a>
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </form>
    </div>

    <script>
        // Obtener ID del usuario de la URL
        function getUserIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        function showAlert(message, type) {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            setTimeout(() => { alertDiv.style.display = 'none'; }, 5000);
        }

        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Cargar datos del usuario
        async function loadUserData() {
            const userId = getUserIdFromUrl();
            if (!userId) {
                showAlert('‚ùå No se especific√≥ ID de usuario', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/usuarios/${userId}/`);
                const data = await response.json();

                if (data.success) {
                    const user = data.usuario;
                    
                    // Llenar campos de informaci√≥n (solo lectura)
                    document.getElementById('userId').textContent = user.id;
                    document.getElementById('userUsername').textContent = user.username;
                    document.getElementById('userDateJoined').textContent = user.date_joined;
                    
                    // Llenar campos editables
                    document.getElementById('first_name').value = user.first_name || '';
                    document.getElementById('last_name').value = user.last_name || '';
                    document.getElementById('email').value = user.email || '';
                    document.getElementById('rol').value = user.rol || 'Usuario';
                    document.getElementById('departamento').value = user.departamento || '';
                    document.getElementById('is_active').value = user.is_active.toString();
                    
                } else {
                    showAlert('‚ùå Error al cargar datos del usuario: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('‚ùå Error de conexi√≥n al cargar datos', 'error');
            }
        }

        // Form submission
        document.getElementById('editUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const userId = getUserIdFromUrl();
            if (!userId) {
                showAlert('‚ùå ID de usuario no v√°lido', 'error');
                return;
            }
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '‚è≥ Guardando...';
            submitBtn.disabled = true;
            
            const formData = {
                first_name: document.getElementById('first_name').value,
                last_name: document.getElementById('last_name').value,
                email: document.getElementById('email').value,
                rol: document.getElementById('rol').value,
                departamento: document.getElementById('departamento').value,
                is_active: document.getElementById('is_active').value === 'true'
            };

            console.log('üì§ Enviando datos:', formData);

            try {
                const response = await fetch(`/api/usuarios/${userId}/actualizar/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                console.log('üì• Respuesta recibida:', data);

                if (data.success) {
                    showAlert('‚úÖ ' + data.message, 'success');
                    setTimeout(() => {
                        window.location.href = "{% url 'gestion_usuarios' %}";
                    }, 1500);
                } else {
                    const errorMsg = data.error || 'Error desconocido al actualizar el usuario';
                    showAlert('‚ùå Error: ' + errorMsg, 'error');
                }
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n:', error);
                showAlert('‚ùå Error de conexi√≥n: ' + error.message, 'error');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // Cargar datos cuando la p√°gina est√© lista
        document.addEventListener('DOMContentLoaded', loadUserData);
    </script>
</body>
</html>
<script src="/static/js/theme.js"></script>