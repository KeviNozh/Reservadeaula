<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notificaciones - Sistema de Reservas</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f9fafb;
      color: #111827;
      margin: 0;
      padding: 0;
    }

    /* Header */
    .header {
      background: white;
      border-bottom: 1px solid #e5e7eb;
      padding: 0 24px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 40px;
      height: 40px;
      background: #2563eb;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }

    .nav-menu {
      display: flex;
      gap: 32px;
    }

    .nav-item {
      color: #6b7280;
      text-decoration: none;
      font-weight: 500;
      padding: 8px 12px;
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    .nav-item:hover, .nav-item.active {
      background: #2563eb;
      color: white;
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      background: #10b981;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    /* Main Content */
    .main-content {
      padding: 24px;
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      gap: 24px;
    }

    /* Content Area */
    .content-area {
      flex: 1;
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Page Header */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .page-title {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .action-btn {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .action-btn.primary {
      background: #10b981;
      color: white;
    }

    .action-btn.primary:hover {
      background: #059669;
      transform: translateY(-1px);
    }

    .action-btn.secondary {
      background: #6b7280;
      color: white;
    }

    .action-btn.secondary:hover {
      background: #4b5563;
    }

    /* Filters */
    .filters {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 8px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      background: white;
      color: #6b7280;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .filter-btn:hover {
      border-color: #2563eb;
      color: #2563eb;
    }

    .filter-btn.active {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }

    /* Notifications */
    .notifications-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .notification {
      background: white;
      padding: 20px;
      border-radius: 12px;
      border-left: 6px solid;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .notification:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .notification.unread {
      background: #f8fafc;
      border-left-width: 8px;
    }

    .notification.pending { border-color: #f59e0b; background: #fffbeb; }
    .notification.approved { border-color: #10b981; background: #f0fdf4; }
    .notification.rejected { border-color: #ef4444; background: #fef2f2; }
    .notification.canceled { border-color: #6b7280; background: #f9fafb; }

    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .notification-title {
      font-weight: 600;
      color: #111827;
      font-size: 16px;
    }

    .notification-time {
      font-size: 12px;
      color: #6b7280;
    }

    .notification-message {
      color: #374151;
      line-height: 1.5;
      margin-bottom: 12px;
    }

    .notification-actions {
      display: flex;
      gap: 8px;
    }

    .action-btn-small {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .action-btn-small.primary { background: #2563eb; color: white; }
    .action-btn-small.success { background: #10b981; color: white; }
    .action-btn-small.danger { background: #ef4444; color: white; }
    .action-btn-small.secondary { background: #6b7280; color: white; }

    .action-btn-small:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    /* Status Indicators */
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-online { background: #10b981; }
    .status-offline { background: #ef4444; }
    .status-connecting { background: #f59e0b; }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }

    .badge-pending { background: #fef3c7; color: #92400e; }
    .badge-approved { background: #d1fae5; color: #065f46; }
    .badge-rejected { background: #fee2e2; color: #991b1b; }
    .badge-canceled { background: #e5e7eb; color: #374151; }

    /* Auto Refresh Indicator */
    .auto-refresh-indicator {
      background: #d1fae5;
      border: 1px solid #a7f3d0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
      font-size: 14px;
      color: #065f46;
      display: none;
      animation: pulse 2s infinite;
    }

    .new-notification-badge {
      background: #ef4444;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      margin-left: 8px;
      animation: pulse 2s infinite;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Sidebar */
    .sidebar {
      width: 300px;
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      height: fit-content;
    }

    .sidebar-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #111827;
    }

    .preference {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 16px 0;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
    }

    .toggle {
      width: 44px;
      height: 24px;
      background: #d1d5db;
      border-radius: 12px;
      position: relative;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .toggle::after {
      content: "";
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: 0.3s ease;
    }

    .toggle.active {
      background: #10b981;
    }

    .toggle.active::after {
      left: 22px;
    }

    .frequency-settings {
      margin-top: 24px;
      background: #f8fafc;
      padding: 16px;
      border-radius: 8px;
    }

    .frequency-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #374151;
    }

    .frequency-option {
      margin: 8px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .frequency-option input {
      margin: 0;
    }

    .frequency-option label {
      cursor: pointer;
      font-size: 14px;
    }

    /* Real-time Alerts */
    .user-alert {
      background: white;
      border-left: 4px solid;
      padding: 16px;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slideInRight 0.3s ease-out;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .user-alert:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .alert-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 3px;
      animation: progressBar 8s linear forwards;
    }

    /* Animations */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100%) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    @keyframes slideOutRight {
      from {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
      to {
        opacity: 0;
        transform: translateX(100%) scale(0.9);
      }
    }

    @keyframes progressBar {
      from { transform: scaleX(1); }
      to { transform: scaleX(0); }
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .main-content {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo-section">
      <div class="logo">SR</div>
      <div style="font-weight: 600; color: #111827;">Sistema de Reservas</div>
    </div>
    
    <nav class="nav-menu">
      <a href="{% url 'dashboard' %}" class="nav-item">Dashboard</a>
      <a href="{% url 'crear_reserva' %}" class="nav-item">Reservar</a>
      <a href="{% url 'reservas' %}" class="nav-item">Historial</a>
      <a href="{% url 'calendario' %}" class="nav-item">Calendario</a>
      <a href="{% url 'espacios' %}" class="nav-item">Espacios</a>
      <a href="{% url 'notificaciones' %}" class="nav-item active">Notificaciones</a>
    </nav>
    
    <div class="user-menu">
      <div class="user-avatar">
        {% if user.first_name and user.last_name %}
          {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
        {% else %}
          {{ user.username|first|upper }}
        {% endif %}
      </div>
      <span>
        {% if user.first_name %}
          {{ user.first_name }} {{ user.last_name }}
        {% else %}
          {{ user.username }}
        {% endif %}
      </span>
      <a href="{% url 'logout' %}" style="margin-left: 10px; color: #666; text-decoration: none;">üö™</a>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Content Area -->
    <div class="content-area">
      <!-- Page Header -->
      <div class="page-header">
        <div class="header-title">
          <h1 class="page-title">üîî Notificaciones 
            <span id="notification-count">0</span>
            <span id="new-notification-badge" class="new-notification-badge" style="display: none;">!</span>
          </h1>
          <span id="connection-status" class="status-indicator status-connecting"></span>
        </div>
        <div class="header-actions">
          <button class="action-btn primary" onclick="forceRefresh()">
            üîÑ Actualizar
          </button>
          <button class="action-btn secondary" onclick="markAllAsRead()">
            ‚úì Marcar todas le√≠das
          </button>
        </div>
      </div>

      <!-- Auto Refresh Indicator -->
      <div id="autoRefreshIndicator" class="auto-refresh-indicator">
        üîÑ Actualizando notificaciones autom√°ticamente...
      </div>

      <!-- Filters -->
      <div class="filters">
        <button class="filter-btn active" data-filter="all">Todas</button>
        <button class="filter-btn" data-filter="unread">üîî No le√≠das</button>
        <button class="filter-btn" data-filter="pending">‚è≥ Pendientes</button>
        <button class="filter-btn" data-filter="approved">‚úÖ Aprobadas</button>
        <button class="filter-btn" data-filter="rejected">‚ùå Rechazadas</button>
        <button class="filter-btn" data-filter="canceled">üìù Canceladas</button>
      </div>

      <!-- Notifications Container -->
      <div id="notifications-container" class="notifications-container">
        <div class="empty-state">
          <div class="empty-state-icon">üîî</div>
          <h3>Cargando notificaciones...</h3>
          <p>Obteniendo datos actualizados del sistema</p>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
      <h3 class="sidebar-title">‚öôÔ∏è Preferencias</h3>

      <div class="preference">
        <span>üîî Notificaciones de reservas</span>
        <div class="toggle active" data-pref="reservas" onclick="togglePreference(this)"></div>
      </div>

      <div class="preference">
        <span>‚è∞ Recordatorios</span>
        <div class="toggle active" data-pref="recordatorios" onclick="togglePreference(this)"></div>
      </div>

      <div class="preference">
        <span>üìß Notificaciones por email</span>
        <div class="toggle" data-pref="email" onclick="togglePreference(this)"></div>
      </div>

      <div class="frequency-settings">
        <div class="frequency-title">üìÖ Frecuencia de Actualizaci√≥n</div>
        <div class="frequency-option">
          <input type="radio" id="freq-10" name="frecuencia" value="10" checked>
          <label for="freq-10">Cada 10 segundos</label>
        </div>
        <div class="frequency-option">
          <input type="radio" id="freq-30" name="frecuencia" value="30">
          <label for="freq-30">Cada 30 segundos</label>
        </div>
        <div class="frequency-option">
          <input type="radio" id="freq-60" name="frecuencia" value="60">
          <label for="freq-60">Cada 1 minuto</label>
        </div>
        <div class="frequency-option">
          <input type="radio" id="freq-0" name="frecuencia" value="0">
          <label for="freq-0">Manual</label>
        </div>
      </div>

      <div style="margin-top: 24px; padding: 16px; background: #eff6ff; border-radius: 8px;">
        <h4 style="color: #1e40af; margin-bottom: 8px;">üí° Informaci√≥n</h4>
        <p style="font-size: 12px; color: #374151; line-height: 1.4;">
          ‚Ä¢ Las notificaciones se actualizan autom√°ticamente<br>
          ‚Ä¢ Las alertas aparecen en tiempo real<br>
          ‚Ä¢ Puedes filtrar por estado de reserva<br>
          ‚Ä¢ Las notificaciones se sincronizan con la base de datos
        </p>
      </div>
    </div>
  </main>

  <!-- Real-time Alerts Container -->
  <div id="userNotificationAlerts" style="position: fixed; top: 80px; right: 20px; z-index: 9999; max-width: 400px;"></div>

  <script>
    // ===== CONFIGURACI√ìN Y ESTADO GLOBAL =====
    const API_BASE_URL = '/api'; // URL relativa para evitar problemas CORS
    let allNotifications = [];
    let currentFilter = 'all';
    let lastUpdateTime = null;
    let autoRefreshInterval = null;
    let displayedNotificationIds = new Set();
    let refreshRate = 10000; // 10 segundos por defecto
    let connectionStatus = 'connecting';

    // ===== SISTEMA DE ACTUALIZACI√ìN AUTOM√ÅTICA CORREGIDO =====
    function startAutoRefresh() {
      // Limpiar intervalo anterior si existe
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
      
      // No iniciar si la frecuencia es 0 (manual)
      if (refreshRate === 0) {
        console.log('‚èπÔ∏è Actualizaci√≥n autom√°tica desactivada (modo manual)');
        updateConnectionStatus('offline');
        return;
      }
      
      // Actualizar seg√∫n la frecuencia configurada
      autoRefreshInterval = setInterval(async () => {
        await checkForNewNotifications();
      }, refreshRate);
      
      console.log(`üîÑ Sistema de actualizaci√≥n autom√°tica iniciado (cada ${refreshRate/1000}s)`);
      updateConnectionStatus('online');
      
      // Actualizar indicador de pr√≥xima actualizaci√≥n
      updateNextUpdateTime();
    }

    function stopAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        console.log('‚èπÔ∏è Sistema de actualizaci√≥n autom√°tica detenido');
        updateConnectionStatus('offline');
      }
    }

    function updateRefreshRate() {
      const selectedRate = document.querySelector('input[name="frecuencia"]:checked').value;
      refreshRate = parseInt(selectedRate) * 1000;
      
      console.log(`üîÑ Actualizando frecuencia a: ${selectedRate} segundos`);
      
      // Reiniciar el auto-refresh con la nueva frecuencia
      stopAutoRefresh();
      startAutoRefresh();
      
      showTemporaryMessage(`üîÑ Frecuencia actualizada: cada ${selectedRate} segundos`);
    }

    async function checkForNewNotifications() {
      try {
        console.log('üîç Verificando nuevas notificaciones...');
        
        const response = await fetch(`${API_BASE_URL}/notificaciones/?no_leidas=true&limite=50`, {
          credentials: 'include',
          headers: {
            'Cache-Control': 'no-cache'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            const newNotifications = data.notificaciones;
            const hasNewNotifications = checkForNewNotificationsSinceLastUpdate(newNotifications);
            
            if (hasNewNotifications) {
              console.log('üÜï Se encontraron notificaciones nuevas');
              showAutoRefreshIndicator();
              updateNewNotificationsBadge();
              
              // Recargar datos completos
              await loadAllData();
              
              hideAutoRefreshIndicator();
              resetNewNotificationsBadge();
              
              // Mostrar alertas para las nuevas notificaciones
              showNewNotificationsAlerts(newNotifications);
            }
          }
        }
      } catch (error) {
        console.error('‚ùå Error verificando nuevas notificaciones:', error);
        updateConnectionStatus('offline');
      }
    }

    function checkForNewNotificationsSinceLastUpdate(newNotifications) {
      if (!lastUpdateTime) {
        lastUpdateTime = new Date();
        return false;
      }
      
      const hasNew = newNotifications.some(notif => {
        const notifTime = new Date(notif.fecha_creacion);
        return notifTime > lastUpdateTime && !displayedNotificationIds.has(notif.id);
      });
      
      return hasNew;
    }

    function showNewNotificationsAlerts(newNotifications) {
      const newOnes = newNotifications.filter(notif => {
        const notifTime = new Date(notif.fecha_creacion);
        return notifTime > lastUpdateTime && !displayedNotificationIds.has(notif.id);
      });
      
      newOnes.forEach(notif => {
        displayedNotificationIds.add(notif.id);
        userAlertSystem.showAlert(notif);
      });
    }

    function showAutoRefreshIndicator() {
      const indicator = document.getElementById('autoRefreshIndicator');
      if (indicator) {
        indicator.style.display = 'block';
      }
    }

    function hideAutoRefreshIndicator() {
      const indicator = document.getElementById('autoRefreshIndicator');
      if (indicator) {
        indicator.style.display = 'none';
      }
    }

    function updateNewNotificationsBadge() {
      const badge = document.getElementById('new-notification-badge');
      if (badge) {
        badge.style.display = 'inline-flex';
      }
    }

    function resetNewNotificationsBadge() {
      const badge = document.getElementById('new-notification-badge');
      if (badge) {
        badge.style.display = 'none';
      }
      lastUpdateTime = new Date();
      updateLastUpdateTime();
    }

    function updateLastUpdateTime() {
      // Esta funci√≥n se puede expandir para mostrar el √∫ltimo update
      console.log('üïí √öltima actualizaci√≥n:', new Date().toLocaleTimeString());
    }

    function updateNextUpdateTime() {
      // Esta funci√≥n se puede expandir para mostrar el pr√≥ximo update
      if (refreshRate > 0) {
        const nextUpdate = new Date(Date.now() + refreshRate);
        console.log('‚è≠Ô∏è Pr√≥xima actualizaci√≥n:', nextUpdate.toLocaleTimeString());
      }
    }

    function updateConnectionStatus(status) {
      connectionStatus = status;
      const indicator = document.getElementById('connection-status');
      
      if (indicator) {
        indicator.className = 'status-indicator status-' + status;
        
        const statusMessages = {
          'online': 'Conectado - Actualizando autom√°ticamente',
          'offline': 'Desconectado - Modo manual',
          'connecting': 'Conectando al servidor...'
        };
        
        indicator.title = statusMessages[status] || status;
      }
    }

    // ===== FUNCIONES PRINCIPALES =====
    async function loadAllData() {
      try {
        console.log('üîÑ Cargando todos los datos...');
        
        // Cargar notificaciones del usuario
        const userNotifications = await loadUserNotifications();
        
        // Si hay notificaciones del usuario, usarlas; si no, generar desde reservas
        if (userNotifications.length > 0) {
          allNotifications = userNotifications.map(notif => ({
            id: notif.id,
            type: notif.tipo,
            class: getNotificationClass(notif.tipo),
            title: `üîî ${getNotificationTitle(notif.tipo)}`,
            message: notif.mensaje,
            timestamp: notif.fecha_creacion,
            read: notif.leida,
            actions: [
              { text: 'Marcar como le√≠da', class: 'secondary', action: 'mark-read' }
            ],
            notificationData: notif
          }));
        } else {
          // Fallback: cargar desde reservas
          const reservas = await loadUserReservas();
          allNotifications = generateNotificationsFromRealData(reservas);
        }
        
        // Renderizar con el filtro actual
        renderNotifications(allNotifications, currentFilter);
        
        console.log(`‚úÖ Datos cargados: ${allNotifications.length} notificaciones`);
        
      } catch (error) {
        console.error('‚ùå Error cargando datos:', error);
        showErrorState('Error al cargar las notificaciones');
      }
    }

    async function loadUserNotifications() {
      try {
        const response = await fetch(`${API_BASE_URL}/notificaciones/?limite=50`, {
          credentials: 'include',
          headers: {
            'Cache-Control': 'no-cache'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            return data.notificaciones;
          }
        }
        return [];
      } catch (error) {
        console.error('Error cargando notificaciones:', error);
        return [];
      }
    }

    async function loadUserReservas() {
      try {
        const response = await fetch(`${API_BASE_URL}/reservas/`, {
          credentials: 'include'
        });
        
        if (response.ok) {
          const data = await response.json();
          return data.reservas || [];
        }
        return [];
      } catch (error) {
        console.error('Error cargando reservas:', error);
        return [];
      }
    }

    // ===== FUNCIONES DE FORMATEO =====
    function formatRelativeTime(dateString) {
      try {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return `Hace unos segundos`;
        if (diffMins < 60) return `Hace ${diffMins} minuto${diffMins !== 1 ? 's' : ''}`;
        if (diffHours < 24) return `Hace ${diffHours} hora${diffHours !== 1 ? 's' : ''}`;
        if (diffDays === 1) return `Ayer`;
        return `Hace ${diffDays} d√≠as`;
      } catch (error) {
        return 'Fecha no disponible';
      }
    }

    // ===== GENERACI√ìN DE NOTIFICACIONES =====
    function generateNotificationsFromRealData(reservas) {
      console.log('üîÑ Generando notificaciones desde datos REALES:', reservas);
      
      const notificationsFromReservas = reservas.map(reserva => {
        const espacioNombre = reserva.espacio || 'Espacio no especificado';
        const fechaFormateada = reserva.fecha || 'Fecha no especificada';
        const horaInicio = reserva.hora_inicio || '--:--';
        const horaFin = reserva.hora_fin || '--:--';
        const estado = reserva.estado || 'Pendiente';
        
        let mensaje = '';
        let clase = '';
        let icono = '';
        
        switch(estado.toLowerCase()) {
          case 'pendiente':
            mensaje = `Tu solicitud para <strong>${espacioNombre}</strong> el <strong>${fechaFormateada}</strong> de <strong>${horaInicio} - ${horaFin}</strong> est√° en revisi√≥n.`;
            clase = 'pending';
            icono = '‚è≥';
            break;
          case 'aprobada':
            mensaje = `¬°Tu reserva para <strong>${espacioNombre}</strong> el <strong>${fechaFormateada}</strong> de <strong>${horaInicio} - ${horaFin}</strong> ha sido <strong style="color: #10b981;">APROBADA</strong>!`;
            clase = 'approved';
            icono = '‚úÖ';
            break;
          case 'rechazada':
            mensaje = `Tu reserva para <strong>${espacioNombre}</strong> el <strong>${fechaFormateada}</strong> ha sido <strong style="color: #ef4444;">RECHAZADA</strong>.`;
            clase = 'rejected';
            icono = '‚ùå';
            break;
          case 'cancelada':
            mensaje = `Tu reserva para <strong>${espacioNombre}</strong> el <strong>${fechaFormateada}</strong> ha sido <strong style="color: #6b7280;">CANCELADA</strong>.`;
            clase = 'canceled';
            icono = 'üìù';
            break;
        }
        
        return {
          id: `reserva-${reserva.id}`,
          type: estado.toLowerCase(),
          class: clase,
          title: `${icono} ${estado === 'Pendiente' ? 'Solicitud de Reserva' : 'Reserva'} <span class="badge badge-${estado.toLowerCase()}">${estado}</span>`,
          message: mensaje,
          timestamp: reserva.fecha_solicitud || new Date().toISOString(),
          read: false,
          actions: [
            { text: 'üëÅÔ∏è Ver detalles', class: 'primary', action: 'view' },
            ...(estado.toLowerCase() === 'pendiente' ? [{ text: 'üóëÔ∏è Cancelar', class: 'danger', action: 'cancel' }] : []),
            ...(estado.toLowerCase() === 'aprobada' ? [{ text: 'üìÖ Ver en calendario', class: 'success', action: 'calendar' }] : [])
          ],
          reservaData: reserva
        };
      });

      return notificationsFromReservas;
    }

    // ===== RENDERIZADO Y FILTROS =====
    function renderNotifications(notifications, filter = 'all') {
      const container = document.getElementById('notifications-container');
      const countElement = document.getElementById('notification-count');
      
      let filteredNotifications = notifications;
      
      switch(filter) {
        case 'pending':
          filteredNotifications = notifications.filter(n => n.type === 'pending' || n.type === 'reserva_pendiente');
          break;
        case 'approved':
          filteredNotifications = notifications.filter(n => n.type === 'approved' || n.type === 'reserva_aprobada');
          break;
        case 'rejected':
          filteredNotifications = notifications.filter(n => n.type === 'rejected' || n.type === 'reserva_rechazada');
          break;
        case 'canceled':
          filteredNotifications = notifications.filter(n => n.type === 'canceled' || n.type === 'reserva_cancelada');
          break;
        case 'unread':
          filteredNotifications = notifications.filter(n => !n.read);
          break;
      }
      
      countElement.textContent = filteredNotifications.length;
      
      if (filteredNotifications.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üîî</div>
            <h3>No hay notificaciones ${filter !== 'all' ? 'con este filtro' : ''}</h3>
            <p>${getEmptyStateMessage(filter)}</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = filteredNotifications.map(notif => `
        <div class="notification ${notif.class} ${!notif.read ? 'unread' : ''}" 
             onclick="handleNotificationClick(${notif.id})">
          <div class="notification-header">
            <div class="notification-title">${notif.title}</div>
            <div class="notification-time">${formatRelativeTime(notif.timestamp)}</div>
          </div>
          <div class="notification-message">${notif.message}</div>
          <div class="notification-actions">
            ${notif.actions.map(action => 
              `<button class="action-btn-small ${action.class}" 
                      data-action="${action.action}" 
                      data-notification-id="${notif.id}"
                      onclick="event.stopPropagation(); handleNotificationAction('${action.action}', '${notif.id}')">
                ${action.text}
              </button>`
            ).join('')}
          </div>
        </div>
      `).join('');
    }

    function getEmptyStateMessage(filter) {
      const messages = {
        'all': 'No tienes notificaciones en el sistema.',
        'pending': 'No hay solicitudes pendientes de aprobaci√≥n.',
        'approved': 'No hay reservas aprobadas.',
        'rejected': 'No hay reservas rechazadas.',
        'canceled': 'No hay reservas canceladas.',
        'unread': 'No hay notificaciones sin leer.'
      };
      return messages[filter] || 'No hay notificaciones que mostrar.';
    }

    function showErrorState(message) {
      const container = document.getElementById('notifications-container');
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">‚ùå</div>
          <h3>Error al cargar</h3>
          <p>${message}</p>
          <button class="action-btn primary" onclick="loadAllData()" style="margin-top: 16px;">
            üîÑ Reintentar
          </button>
        </div>
      `;
    }

    // ===== MANEJO DE ACCIONES =====
    function handleNotificationClick(notificationId) {
      console.log('üìù Click en notificaci√≥n:', notificationId);
      // Aqu√≠ puedes implementar la l√≥gica para mostrar detalles
    }

    function handleNotificationAction(action, notificationId) {
      const notification = allNotifications.find(n => n.id == notificationId);
      
      if (!notification) return;

      switch(action) {
        case 'view':
          showNotificationDetails(notification);
          break;
        case 'cancel':
          cancelReservation(notification);
          break;
        case 'calendar':
          showInCalendar(notification);
          break;
        case 'mark-read':
          markAsRead(notificationId);
          break;
      }
    }

    function showNotificationDetails(notification) {
      const reserva = notification.reservaData;
      let details = `üìã **Detalles de la Notificaci√≥n**\n\n`;
      
      if (reserva) {
        details += `üè¢ **Espacio:** ${reserva.espacio || 'No especificado'}\n`;
        details += `üìÖ **Fecha:** ${reserva.fecha || 'No especificada'}\n`;
        details += `‚è∞ **Horario:** ${reserva.hora_inicio || '--:--'} - ${reserva.hora_fin || '--:--'}\n`;
        details += `üìä **Estado:** ${reserva.estado || 'No especificado'}\n`;
      } else {
        details += `üí¨ **Mensaje:** ${notification.message}\n`;
        details += `üïí **Enviado:** ${formatRelativeTime(notification.timestamp)}\n`;
      }
      
      alert(details);
    }

    async function markAsRead(notificationId) {
      try {
        // En una implementaci√≥n real, aqu√≠ llamar√≠as a la API
        console.log(`‚úÖ Marcando notificaci√≥n ${notificationId} como le√≠da`);
        
        // Actualizar localmente
        const notification = allNotifications.find(n => n.id == notificationId);
        if (notification) {
          notification.read = true;
        }
        
        // Re-renderizar
        renderNotifications(allNotifications, currentFilter);
        
        showTemporaryMessage('‚úÖ Notificaci√≥n marcada como le√≠da');
      } catch (error) {
        console.error('Error marcando como le√≠da:', error);
        showTemporaryMessage('‚ùå Error al marcar como le√≠da');
      }
    }

    function cancelReservation(notification) {
      if (confirm('¬øEst√°s seguro de que quieres cancelar esta reserva?')) {
        showTemporaryMessage('üîÑ Cancelando reserva...');
        // Aqu√≠ ir√≠a la llamada a la API real
        setTimeout(() => {
          showTemporaryMessage('‚úÖ Reserva cancelada correctamente');
          loadAllData(); // Recargar datos
        }, 1000);
      }
    }

    function showInCalendar(notification) {
      showTemporaryMessage('üìÖ Redirigiendo al calendario...');
      // Aqu√≠ ir√≠a la navegaci√≥n al calendario
      // window.location.href = '/calendario/';
    }

    // ===== SISTEMA DE ALERTAS EN TIEMPO REAL =====
    class RealTimeUserAlertSystem {
      constructor() {
        this.alertContainer = document.getElementById('userNotificationAlerts');
        this.displayedIds = new Set();
        console.log('üöÄ Sistema de alertas de usuario inicializado');
      }

      showAlert(notification) {
        // Evitar mostrar duplicados
        if (this.displayedIds.has(notification.id)) {
          return;
        }

        this.displayedIds.add(notification.id);
        const alertId = `user-alert-${notification.id}`;
        
        const alertHTML = `
          <div id="${alertId}" class="user-alert" 
               style="border-left-color: ${this.getPriorityColor(notification.tipo)};"
               onclick="userAlertSystem.handleAlertClick('${alertId}', ${notification.id})">
            <div style="display: flex; align-items: start; gap: 12px;">
              <div style="font-size: 20px; flex-shrink: 0; margin-top: 2px;">
                ${this.getIcon(notification.tipo)}
              </div>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 14px; margin-bottom: 6px; color: #111827; line-height: 1.3;">
                  ${notification.titulo || notification.title}
                </div>
                <div style="font-size: 13px; color: #6b7280; line-height: 1.4;">
                  ${notification.mensaje || notification.message}
                </div>
                <div style="margin-top: 8px; font-size: 11px; color: #9ca3af;">
                  ${this.formatTime(notification.fecha_creacion || notification.timestamp)}
                </div>
              </div>
              <button onclick="event.stopPropagation(); userAlertSystem.closeAlert('${alertId}')" 
                      style="background: none; border: none; font-size: 16px; cursor: pointer; 
                             color: #9ca3af; padding: 0; width: 20px; height: 20px; 
                             display: flex; align-items: center; justify-content: center;">
                √ó
              </button>
            </div>
            <div class="alert-progress" style="background: ${this.getPriorityColor(notification.tipo)};"></div>
          </div>
        `;

        this.alertContainer.insertAdjacentHTML('afterbegin', alertHTML);
        
        // Reproducir sonido para alertas importantes
        this.playNotificationSound();
        
        // Auto-cerrar despu√©s de 8 segundos
        setTimeout(() => this.closeAlert(alertId), 8000);
        
        console.log('‚úÖ Alerta mostrada:', notification.titulo || notification.title);
      }

      handleAlertClick(alertId, notificationId) {
        console.log('üëÜ Alerta clickeada:', notificationId);
        
        // Marcar como le√≠da
        this.markAsRead(notificationId);
        
        // Cerrar la alerta
        this.closeAlert(alertId);
        
        // Recargar notificaciones
        setTimeout(() => {
          loadAllData();
        }, 500);
      }

      async markAsRead(notificationId) {
        try {
          const response = await fetch(`/api/notificaciones/${notificationId}/marcar-leida/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': this.getCSRFToken(),
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            console.log(`‚úÖ Notificaci√≥n ${notificationId} marcada como le√≠da`);
          }
        } catch (error) {
          console.error('Error marcando notificaci√≥n como le√≠da:', error);
        }
      }

      closeAlert(alertId) {
        const alert = document.getElementById(alertId);
        if (alert) {
          alert.style.animation = 'slideOutRight 0.3s ease-in forwards';
          setTimeout(() => {
            if (alert.parentNode) {
              alert.parentNode.removeChild(alert);
            }
          }, 300);
        }
      }

      getCSRFToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      getIcon(tipo) {
        const icons = {
          'reserva_aprobada': '‚úÖ',
          'reserva_rechazada': '‚ùå',
          'reserva_creada': 'üìã',
          'reserva_cancelada': 'üìù',
          'reserva_pendiente': '‚è≥',
          'approved': '‚úÖ',
          'rejected': '‚ùå',
          'pending': '‚è≥',
          'canceled': 'üìù'
        };
        return icons[tipo] || 'üîî';
      }

      getPriorityColor(tipo) {
        const colors = {
          'reserva_aprobada': '#10b981',
          'reserva_rechazada': '#ef4444',
          'reserva_creada': '#2563eb',
          'reserva_cancelada': '#6b7280',
          'reserva_pendiente': '#f59e0b',
          'approved': '#10b981',
          'rejected': '#ef4444',
          'pending': '#f59e0b',
          'canceled': '#6b7280'
        };
        return colors[tipo] || '#6b7280';
      }

      formatTime(timestamp) {
        try {
          const date = new Date(timestamp);
          return date.toLocaleTimeString('es-ES', { 
            hour: '2-digit', 
            minute: '2-digit' 
          });
        } catch (error) {
          return 'Ahora';
        }
      }

      playNotificationSound() {
        try {
          // Sonido de notificaci√≥n simple usando el Web Audio API
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.frequency.value = 800;
          oscillator.type = 'sine';
          
          gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
          
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.5);
        } catch (error) {
          console.log('No se pudo reproducir sonido:', error);
        }
      }

      // M√©todo para testing
      simulateNotification(type = 'reserva_aprobada') {
        const testNotification = {
          id: Date.now(),
          tipo: type,
          titulo: type === 'reserva_aprobada' ? '‚úÖ Reserva Aprobada' : 
                 type === 'reserva_rechazada' ? '‚ùå Reserva Rechazada' : 'üß™ Notificaci√≥n de Prueba',
          mensaje: type === 'reserva_aprobada' ? 
                   '¬°Tu solicitud de reserva ha sido APROBADA! Ya puedes usar el espacio.' :
                   type === 'reserva_rechazada' ?
                   'Tu solicitud de reserva ha sido RECHAZADA. Contacta administraci√≥n.' :
                   'Esta es una notificaci√≥n de prueba del sistema de alertas',
          fecha_creacion: new Date().toISOString(),
          leida: false
        };
        
        this.showAlert(testNotification);
      }
    }

    // ===== FUNCIONES AUXILIARES =====
    function getNotificationClass(tipo) {
      const classMap = {
        'reserva_aprobada': 'approved',
        'reserva_rechazada': 'rejected',
        'reserva_creada': 'pending',
        'reserva_cancelada': 'canceled',
        'reserva_pendiente': 'pending',
        'approved': 'approved',
        'rejected': 'rejected',
        'pending': 'pending',
        'canceled': 'canceled'
      };
      return classMap[tipo] || 'pending';
    }

    function getNotificationTitle(tipo) {
      const titleMap = {
        'reserva_aprobada': 'Reserva Aprobada',
        'reserva_rechazada': 'Reserva Rechazada',
        'reserva_creada': 'Nueva Reserva Creada',
        'reserva_cancelada': 'Reserva Cancelada',
        'reserva_pendiente': 'Reserva Pendiente',
        'approved': 'Reserva Aprobada',
        'rejected': 'Reserva Rechazada',
        'pending': 'Reserva Pendiente',
        'canceled': 'Reserva Cancelada'
      };
      return titleMap[tipo] || 'Notificaci√≥n del Sistema';
    }

    function showTemporaryMessage(message, duration = 3000) {
      // Eliminar mensajes existentes
      const existingMessages = document.querySelectorAll('.temp-message');
      existingMessages.forEach(msg => msg.remove());
      
      const messageDiv = document.createElement('div');
      messageDiv.className = 'temp-message';
      messageDiv.style.cssText = `
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: #10b981;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        font-weight: 600;
        font-size: 14px;
      `;
      messageDiv.textContent = message;
      document.body.appendChild(messageDiv);
      
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.parentNode.removeChild(messageDiv);
        }
      }, duration);
    }

    async function forceRefresh() {
      showTemporaryMessage('üîÑ Actualizando datos...');
      try {
        await loadAllData();
        showTemporaryMessage('‚úÖ Datos actualizados correctamente', 2000);
      } catch (error) {
        showTemporaryMessage('‚ùå Error al actualizar datos', 2000);
      }
    }

    async function markAllAsRead() {
      try {
        const response = await fetch('/api/notificaciones/marcar-todas-leidas/', {
          method: 'POST',
          headers: {
            'X-CSRFToken': userAlertSystem.getCSRFToken(),
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          showTemporaryMessage('‚úÖ Todas las notificaciones marcadas como le√≠das');
          // Recargar datos
          setTimeout(() => loadAllData(), 1000);
        }
      } catch (error) {
        console.error('Error marcando todas como le√≠das:', error);
        showTemporaryMessage('‚ùå Error al marcar como le√≠das');
      }
    }

    function togglePreference(element) {
      element.classList.toggle('active');
      const preference = element.getAttribute('data-pref');
      showTemporaryMessage(`‚öôÔ∏è Preferencia ${preference} ${element.classList.contains('active') ? 'activada' : 'desactivada'}`);
    }

    // ===== INICIALIZACI√ìN =====
    let userAlertSystem;

    document.addEventListener('DOMContentLoaded', async function() {
      try {
        // Inicializar sistema de alertas
        userAlertSystem = new RealTimeUserAlertSystem();
        
        // Configurar event listeners para filtros
        document.querySelectorAll('.filter-btn').forEach(button => {
          button.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
              btn.classList.remove('active');
            });
            this.classList.add('active');
            currentFilter = this.getAttribute('data-filter');
            renderNotifications(allNotifications, currentFilter);
            
            // Mostrar mensaje del filtro aplicado
            const filterNames = {
              'all': 'Todas',
              'pending': 'Pendientes',
              'approved': 'Aprobadas', 
              'rejected': 'Rechazadas',
              'canceled': 'Canceladas',
              'unread': 'No le√≠das'
            };
            showTemporaryMessage(`üîç Filtro aplicado: ${filterNames[currentFilter]}`);
          });
        });
        
        // Configurar event listeners para frecuencia
        document.querySelectorAll('input[name="frecuencia"]').forEach(radio => {
          radio.addEventListener('change', updateRefreshRate);
        });
        
        // Cargar datos iniciales
        await loadAllData();
        
        // Iniciar sistema de actualizaci√≥n autom√°tica
        startAutoRefresh();
        
        console.log('‚úÖ Sistema de notificaciones inicializado correctamente');
        
      } catch (error) {
        console.error('‚ùå Error inicializando:', error);
        showErrorState('No se pudieron cargar las notificaciones. Verifica la conexi√≥n al servidor.');
      }

      // Detener actualizaci√≥n autom√°tica cuando la p√°gina no est√° visible
      document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
          stopAutoRefresh();
        } else {
          startAutoRefresh();
          // Forzar una verificaci√≥n al volver a la p√°gina
          setTimeout(() => checkForNewNotifications(), 1000);
        }
      });
    });

    // Toggles de preferencias
    document.querySelectorAll('.toggle').forEach(toggle => {
      toggle.addEventListener('click', function() {
        this.classList.toggle('active');
      });
    });
  </script>
</body>
</html>