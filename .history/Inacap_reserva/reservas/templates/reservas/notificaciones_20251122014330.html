<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notificaciones</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 0;
      display: flex;
    }

    .container {
      width: 70%;
      padding: 20px;
    }

    h2 {
      margin-bottom: 15px;
    }

    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .filters button {
      padding: 8px 14px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background: #e6e6e6;
      transition: background 0.3s;
    }

    .filters button:hover {
      background: #d4d4d4;
    }

    .filters button.active {
      background: #0056d2;
      color: white;
    }

    .notification {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 12px;
      border-left: 6px solid;
      display: block;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
    }

    .notification:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .pendiente { border-color: #ffc107; background: #fffbf0; }
    .aprobada { border-color: #28a745; background: #f0fff4; }
    .rechazada { border-color: #dc3545; background: #fff5f5; }
    .cancelada { border-color: #6c757d; background: #f8f9fa; }

    .notification.unread {
      background: #f8f9fa;
      border-left-width: 8px;
      font-weight: 600;
    }

    .notification small {
      color: gray;
      display: block;
      margin-top: 6px;
    }

    .actions {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .actions button {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 12px;
    }

    .actions button:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .btn-primary { background: #0056d2; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-warning { background: #ffc107; color: black; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-info { background: #17a2b8; color: white; }

    .sidebar {
      width: 30%;
      background: white;
      padding: 20px;
      border-left: 1px solid #ddd;
      min-height: 100vh;
      box-shadow: -2px 0 5px rgba(0,0,0,0.1);
    }

    .sidebar h3 {
      margin-bottom: 15px;
      color: #333;
    }

    .preference {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      align-items: center;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .toggle {
      width: 40px;
      height: 20px;
      background: #ddd;
      border-radius: 15px;
      position: relative;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle::after {
      content: "";
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 1px;
      left: 1px;
      transition: 0.3s;
    }

    .toggle.active {
      background: #28a745;
    }

    .toggle.active::after {
      left: 21px;
    }

    .frecuencia {
      margin-top: 20px;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
    }

    .frecuencia h4 {
      margin-bottom: 10px;
      color: #333;
    }

    .frecuencia label {
      display: block;
      margin: 8px 0;
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: background 0.3s;
    }

    .frecuencia label:hover {
      background: #e9ecef;
    }

    .loading {
      text-align: center;
      padding: 40px 20px;
      color: #6c757d;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6c757d;
      background: white;
      border-radius: 8px;
      margin: 20px 0;
    }

    .error-state {
      text-align: center;
      padding: 20px;
      color: #dc3545;
      background: #f8d7da;
      border-radius: 8px;
      margin: 10px 0;
    }

    .refresh-btn {
      background: #0056d2;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
      transition: background 0.3s;
    }

    .refresh-btn:hover {
      background: #0041a8;
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 8px;
    }

    .badge-pending { background: #fff3cd; color: #856404; }
    .badge-approved { background: #d4edda; color: #155724; }
    .badge-rejected { background: #f8d7da; color: #721c24; }
    .badge-canceled { background: #e2e3e5; color: #383d41; }

    .debug-panel {
      background: #e9ecef;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-size: 14px;
      border-left: 4px solid #0056d2;
    }

    .data-source {
      margin-top: 10px;
      padding: 8px;
      background: #d1ecf1;
      border-radius: 4px;
      font-size: 12px;
    }

    /* Nuevos estilos para actualizaci√≥n autom√°tica */
    .auto-refresh-indicator {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      border-radius: 4px;
      padding: 8px 12px;
      margin: 10px 0;
      font-size: 14px;
      color: #155724;
      display: none;
      animation: pulse 2s infinite;
    }

    .new-notification-badge {
      background: #dc3545;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      margin-left: 8px;
      animation: pulse 2s infinite;
    }

    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-online { background: #28a745; }
    .status-offline { background: #dc3545; }
    .status-connecting { background: #ffc107; }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* Estilos para las alertas en tiempo real */
    .user-alert {
      transition: all 0.3s ease;
      border: 1px solid #e5e7eb !important;
      position: relative;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .user-alert:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15) !important;
    }

    /* Header mejorado */
    .page-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .action-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background: #0056d2;
      color: white;
      transition: background 0.3s;
    }

    .action-btn:hover {
      background: #0041a8;
    }

    .action-btn.secondary {
      background: #6c757d;
    }

    .action-btn.secondary:hover {
      background: #545b62;
    }

    /* Estilos para alertas en tiempo real */
    .alert-container {
      position: fixed;
      top: 70px;
      right: 20px;
      z-index: 9999;
      max-width: 400px;
    }

    .alert-notification {
      background: white;
      border-left: 4px solid;
      padding: 16px;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slideInRight 0.3s ease-out;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .alert-notification:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .alert-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 3px;
      animation: progressBar 8s linear forwards;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100%) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    @keyframes slideOutRight {
      from {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
      to {
        opacity: 0;
        transform: translateX(100%) scale(0.9);
      }
    }

    @keyframes progressBar {
      from { transform: scaleX(1); }
      to { transform: scaleX(0); }
    }
  </style>
</head>
<body> 
  <div class="container">
    <div class="page-header">
      <div class="header-title">
        <h2>üîî Notificaciones (<span id="notification-count">0</span><span id="new-notification-badge" class="new-notification-badge" style="display: none;">!</span>)</h2>
        <span id="connection-status" class="status-indicator status-connecting"></span>
      </div>
      <div class="header-actions">
        <button class="action-btn" onclick="forceRefresh()">üîÑ Actualizar</button>
        <button class="action-btn secondary" onclick="markAllAsRead()">‚úì Marcar todas le√≠das</button>
      </div>
    </div>

    <!-- Indicador de actualizaci√≥n autom√°tica -->
    <div id="autoRefreshIndicator" class="auto-refresh-indicator">
      üîÑ Actualizando autom√°ticamente...
    </div>

    <div class="filters">
      <button class="active" data-filter="all">Todas</button>
      <button data-filter="pending">‚è≥ Pendientes</button>
      <button data-filter="approved">‚úÖ Aprobadas</button>
      <button data-filter="rejected">‚ùå Rechazadas</button>
      <button data-filter="canceled">üìù Canceladas</button>
      <button data-filter="unread">üîî No le√≠das</button>
    </div>
    

    <div class="debug-panel">
      <strong>Estado del Sistema:</strong>
      <div id="system-status">Conectando al servidor...</div>
      <div class="data-source" id="data-source-info">
        Fuente de datos: <span id="data-source">Cargando...</span>
        <br>
        √öltima actualizaci√≥n: <span id="last-update-time">--:--:--</span>
        <br>
        Pr√≥xima actualizaci√≥n: <span id="next-update-time">--:--:--</span>
      </div>
      <button onclick="probarConexion()" style="margin-top: 10px; padding: 5px 10px; background: #0056d2; color: white; border: none; border-radius: 3px; cursor: pointer;">
        Probar Conexi√≥n API
      </button>
    </div>

    <div id="notifications-container">
      <div class="loading">Cargando notificaciones desde la base de datos...</div>
    </div>
  </div>

  <div class="sidebar">
    <h3>‚öôÔ∏è Preferencias</h3>

    <div class="preference">
      <span>üîî Notificaciones de reservas</span>
      <div class="toggle active" data-pref="reservas" onclick="togglePreference(this)"></div>
    </div>

    <div class="preference">
      <span>‚è∞ Recordatorios</span>
      <div class="toggle active" data-pref="recordatorios" onclick="togglePreference(this)"></div>
    </div>

    <div class="preference">
      <span>üìß Notificaciones por email</span>
      <div class="toggle" data-pref="email" onclick="togglePreference(this)"></div>
    </div>

    <div class="frecuencia">
      <h4>üìÖ Frecuencia de Actualizaci√≥n</h4>
      <label><input type="radio" name="frecuencia" value="10" checked> Cada 10 segundos</label>
      <label><input type="radio" name="frecuencia" value="30"> Cada 30 segundos</label>
      <label><input type="radio" name="frecuencia" value="60"> Cada 1 minuto</label>
      <label><input type="radio" name="frecuencia" value="0"> Manual</label>
    </div>

    <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 8px;">
      <h4>üí° Informaci√≥n</h4>
      <p style="font-size: 12px; margin: 5px 0;">‚Ä¢ Las notificaciones se actualizan autom√°ticamente</p>
      <p style="font-size: 12px; margin: 5px 0;">‚Ä¢ Las alertas aparecen en tiempo real</p>
      <p style="font-size: 12px; margin: 5px 0;">‚Ä¢ Puedes filtrar por estado de reserva</p>
    </div>
  </div>

  <!-- Sistema de Alertas en Tiempo Real -->
  <div id="alertContainer" class="alert-container"></div>

  <script>
    // ===== CONFIGURACI√ìN Y ESTADO GLOBAL =====
    const API_BASE_URL = '/api';
    let allNotifications = [];
    let currentFilter = 'all';
    let lastUpdateTime = null;
    let autoRefreshInterval = null;
    let displayedNotificationIds = new Set();
    let refreshRate = 10000; // 10 segundos por defecto
    let connectionStatus = 'connecting';

    // ===== SISTEMA DE ACTUALIZACI√ìN AUTOM√ÅTICA =====
    function startAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
      
      if (refreshRate === 0) {
        console.log('‚èπÔ∏è Actualizaci√≥n autom√°tica desactivada (modo manual)');
        updateConnectionStatus('offline');
        return;
      }
      
      autoRefreshInterval = setInterval(async () => {
        await checkForNewNotifications();
      }, refreshRate);
      
      console.log(`üîÑ Sistema de actualizaci√≥n autom√°tica iniciado (cada ${refreshRate/1000}s)`);
      updateConnectionStatus('online');
      updateNextUpdateTime();
    }

    function stopAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        console.log('‚èπÔ∏è Sistema de actualizaci√≥n autom√°tica detenido');
        updateConnectionStatus('offline');
      }
    }

    function updateRefreshRate() {
      const selectedRate = document.querySelector('input[name="frecuencia"]:checked').value;
      refreshRate = parseInt(selectedRate) * 1000;
      
      stopAutoRefresh();
      startAutoRefresh();
      
      showTemporaryMessage(`üîÑ Frecuencia actualizada: cada ${selectedRate} segundos`);
    }

    async function checkForNewNotifications() {
      try {
        const response = await fetch(`${API_BASE_URL}/notificaciones/?no_leidas=true&limite=50`, {
          credentials: 'include'
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            const newNotifications = data.notificaciones;
            const hasNewNotifications = checkForNewNotificationsSinceLastUpdate(newNotifications);
            
            if (hasNewNotifications) {
              showAutoRefreshIndicator();
              updateNewNotificationsBadge();
              
              // Recargar datos completos si hay notificaciones nuevas
              setTimeout(() => {
                loadAllData().then(() => {
                  hideAutoRefreshIndicator();
                  resetNewNotificationsBadge();
                });
              }, 1000);
            }
          }
        }
      } catch (error) {
        console.log('Error verificando nuevas notificaciones:', error);
        updateConnectionStatus('offline');
      }
    }

    function checkForNewNotificationsSinceLastUpdate(newNotifications) {
      if (!lastUpdateTime) {
        lastUpdateTime = new Date();
        return false;
      }
      
      return newNotifications.some(notif => {
        const notifTime = new Date(notif.fecha_creacion);
        return notifTime > lastUpdateTime;
      });
    }

    function showAutoRefreshIndicator() {
      const indicator = document.getElementById('autoRefreshIndicator');
      if (indicator) {
        indicator.style.display = 'block';
        setTimeout(() => {
          indicator.style.display = 'none';
        }, 3000);
      }
    }

    function hideAutoRefreshIndicator() {
      const indicator = document.getElementById('autoRefreshIndicator');
      if (indicator) {
        indicator.style.display = 'none';
      }
    }

    function updateNewNotificationsBadge() {
      const badge = document.getElementById('new-notification-badge');
      if (badge) {
        badge.style.display = 'inline-flex';
      }
    }

    function resetNewNotificationsBadge() {
      const badge = document.getElementById('new-notification-badge');
      if (badge) {
        badge.style.display = 'none';
      }
      lastUpdateTime = new Date();
      updateLastUpdateTime();
    }

    function updateLastUpdateTime() {
      const element = document.getElementById('last-update-time');
      if (element) {
        element.textContent = new Date().toLocaleTimeString('es-ES');
      }
    }

    function updateNextUpdateTime() {
      const element = document.getElementById('next-update-time');
      if (element && refreshRate > 0) {
        const nextUpdate = new Date(Date.now() + refreshRate);
        element.textContent = nextUpdate.toLocaleTimeString('es-ES');
      }
    }

    function updateConnectionStatus(status) {
      connectionStatus = status;
      const indicator = document.getElementById('connection-status');
      const statusElement = document.getElementById('system-status');
      
      if (indicator) {
        indicator.className = 'status-indicator status-' + status;
      }
      
      if (statusElement) {
        const messages = {
          'online': '‚úÖ Conectado - Actualizando autom√°ticamente',
          'offline': '‚ùå Desconectado - Modo manual',
          'connecting': 'üîÑ Conectando al servidor...'
        };
        statusElement.textContent = messages[status] || status;
      }
    }

    // ===== FUNCIONES PRINCIPALES =====

    async function probarConexion() {
      const statusElement = document.getElementById('system-status');
      const dataSourceElement = document.getElementById('data-source');
      
      statusElement.innerHTML = 'üîÑ Conectando a la API...';
      updateConnectionStatus('connecting');
      
      try {
        const response = await fetch(`${API_BASE_URL}/notificaciones/`, {
          credentials: 'include'
        });
        
        if (response.ok) {
          const data = await response.json();
          statusElement.innerHTML = `‚úÖ Conexi√≥n exitosa! Se encontraron ${data.notificaciones ? data.notificaciones.length : 0} notificaciones REALES en la BD`;
          dataSourceElement.innerHTML = `Base de datos PostgreSQL (${data.notificaciones ? data.notificaciones.length : 0} notificaciones)`;
          updateConnectionStatus('online');
          
          console.log('üìä DATOS REALES DE LA BASE DE DATOS:', data);
          
          return data;
        } else {
          throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
      } catch (error) {
        statusElement.innerHTML = `‚ùå Error de conexi√≥n: ${error.message}`;
        dataSourceElement.innerHTML = 'Datos de ejemplo (fallback)';
        updateConnectionStatus('offline');
        throw error;
      }
    }

    async function loadAllData() {
      try {
        console.log('üîÑ Cargando todos los datos...');
        
        // Cargar notificaciones desde la API
        const notificaciones = await loadUserNotifications();

        // Formatear notificaciones para mostrar
        const userNotifications = notificaciones.map(notif => ({
          id: notif.id,
          type: notif.tipo,
          class: getNotificationClass(notif.tipo),
          title: `üîî ${getNotificationTitle(notif.tipo)}`,
          message: notif.mensaje,
          timestamp: notif.fecha_creacion,
          read: notif.leida,
          actions: [
            { text: 'Marcar como le√≠da', class: 'btn-secondary', action: 'mark-read' }
          ],
          notificationData: notif
        }));

        allNotifications = userNotifications;
        
        // Renderizar con el filtro actual
        renderNotifications(allNotifications, currentFilter);
        
        console.log(`‚úÖ Datos cargados: ${userNotifications.length} notificaciones`);
        
      } catch (error) {
        console.error('‚ùå Error cargando datos:', error);
        // En caso de error, cargar datos de ejemplo
        loadExampleData();
      }
    }

    async function loadUserNotifications() {
      try {
        const response = await fetch(`${API_BASE_URL}/notificaciones/?limite=50`, {
          credentials: 'include'
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            return data.notificaciones;
          }
        }
        return [];
      } catch (error) {
        console.error('Error cargando notificaciones:', error);
        return [];
      }
    }

    // ===== FUNCIONES DE FORMATEO =====
    function formatFecha(fecha) {
      if (!fecha) return 'Fecha no especificada';
      const partes = fecha.split('-');
      if (partes.length === 3) {
        return `${partes[2]}/${partes[1]}/${partes[0]}`;
      }
      return fecha;
    }

    function formatHora(hora) {
      if (!hora) return 'Hora no especificada';
      return hora.substring(0, 5);
    }

    function formatRelativeTime(dateString) {
      try {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return `Hace unos segundos`;
        if (diffMins < 60) return `Hace ${diffMins} minutos`;
        if (diffHours < 24) return `Hace ${diffHours} horas`;
        if (diffDays === 1) return `Ayer`;
        return `Hace ${diffDays} d√≠as`;
      } catch (error) {
        return 'Fecha no disponible';
      }
    }

    // ===== RENDERIZADO Y FILTROS =====
    function renderNotifications(notifications, filter = 'all') {
      const container = document.getElementById('notifications-container');
      const countElement = document.getElementById('notification-count');
      
      let filteredNotifications = notifications;
      
      switch(filter) {
        case 'pending':
          filteredNotifications = notifications.filter(n => n.type === 'reserva_pendiente' || n.type === 'reserva_creada');
          break;
        case 'approved':
          filteredNotifications = notifications.filter(n => n.type === 'reserva_aprobada');
          break;
        case 'rejected':
          filteredNotifications = notifications.filter(n => n.type === 'reserva_rechazada');
          break;
        case 'canceled':
          filteredNotifications = notifications.filter(n => n.type === 'reserva_cancelada');
          break;
        case 'unread':
          filteredNotifications = notifications.filter(n => !n.read);
          break;
      }
      
      countElement.textContent = filteredNotifications.length;
      
      if (filteredNotifications.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div style="font-size: 48px; margin-bottom: 16px;">üîî</div>
            <h3>No hay notificaciones ${filter !== 'all' ? filter : ''}</h3>
            <p>${getEmptyStateMessage(filter)}</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = filteredNotifications.map(notif => `
        <div class="notification ${notif.class} ${!notif.read ? 'unread' : ''}">
          <b>${notif.title}</b>
          <p>${notif.message}</p>
          <small>${formatRelativeTime(notif.timestamp)} - <em>Datos reales de la BD</em></small>
          <div class="actions">
            ${notif.actions.map(action => 
              `<button class="${action.class}" data-action="${action.action}" data-notification-id="${notif.id}">
                ${action.text}
              </button>`
            ).join('')}
          </div>
        </div>
      `).join('');
    }

    function getEmptyStateMessage(filter) {
      const messages = {
        'all': 'No tienes notificaciones en el sistema.',
        'pending': 'No hay solicitudes pendientes de aprobaci√≥n.',
        'approved': 'No hay reservas aprobadas.',
        'rejected': 'No hay reservas rechazadas.',
        'canceled': 'No hay reservas canceladas.',
        'unread': 'No hay notificaciones sin leer.'
      };
      return messages[filter] || 'No hay notificaciones que mostrar.';
    }

    // ===== SISTEMA DE ALERTAS EN TIEMPO REAL =====
    class RealTimeAlertSystem {
      constructor() {
        this.alertContainer = document.getElementById('alertContainer');
        this.displayedIds = new Set();
        this.setupRealTimeSystem();
        console.log('üöÄ Sistema de alertas en tiempo real inicializado');
      }

      setupRealTimeSystem() {
        // Polling cada 15 segundos para alertas
        setInterval(() => this.checkForAlerts(), 15000);
        
        // Verificar cuando la p√°gina se activa
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden) {
            this.checkForAlerts();
          }
        });
        
        // Verificaci√≥n inicial
        setTimeout(() => this.checkForAlerts(), 3000);
      }

      async checkForAlerts() {
        try {
          const response = await fetch(`${API_BASE_URL}/notificaciones/?no_leidas=true&limite=10`, {
            credentials: 'include'
          });
          
          if (response.ok) {
            const data = await response.json();
            
            if (data.success && data.notificaciones && data.notificaciones.length > 0) {
              // Filtrar solo las no mostradas
              const newNotifications = data.notificaciones.filter(notification => 
                !this.displayedIds.has(notification.id)
              );
              
              // Mostrar nuevas alertas
              newNotifications.forEach(notification => {
                this.displayedIds.add(notification.id);
                setTimeout(() => {
                  this.showAlert(notification);
                }, 500);
              });
            }
          }
        } catch (error) {
          console.error('üí• Error verificando alertas:', error);
        }
      }

      showAlert(notification) {
        const alertId = `alert-${notification.id}`;
        
        const alertHTML = `
          <div id="${alertId}" class="alert-notification" 
               onclick="realTimeAlertSystem.handleAlertClick('${alertId}', ${notification.id})"
               style="border-left-color: ${this.getPriorityColor(notification.tipo)};">
            <div style="display: flex; align-items: start; gap: 12px;">
              <div style="font-size: 20px; flex-shrink: 0; margin-top: 2px;">
                ${this.getIcon(notification.tipo)}
              </div>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 14px; margin-bottom: 6px; color: #111827; line-height: 1.3;">
                  ${notification.titulo}
                </div>
                <div style="font-size: 13px; color: #6b7280; line-height: 1.4;">
                  ${notification.mensaje}
                </div>
                <div style="margin-top: 8px; font-size: 11px; color: #9ca3af;">
                  ${this.formatTime(notification.fecha_creacion)}
                </div>
              </div>
              <button onclick="event.stopPropagation(); realTimeAlertSystem.closeAlert('${alertId}')" 
                      style="background: none; border: none; font-size: 16px; cursor: pointer; 
                             color: #9ca3af; padding: 0; width: 20px; height: 20px; 
                             display: flex; align-items: center; justify-content: center;">
                √ó
              </button>
            </div>
            <div class="alert-progress" style="background: ${this.getPriorityColor(notification.tipo)};"></div>
          </div>
        `;

        this.alertContainer.insertAdjacentHTML('afterbegin', alertHTML);
        
        // Reproducir sonido
        this.playNotificationSound();
        
        // Auto-cerrar despu√©s de 8 segundos
        setTimeout(() => this.closeAlert(alertId), 8000);
      }

      handleAlertClick(alertId, notificationId) {
        // Marcar como le√≠da
        this.markAsRead(notificationId);
        // Cerrar la alerta
        this.closeAlert(alertId);
        // Recargar notificaciones
        setTimeout(() => loadAllData(), 500);
      }

      async markAsRead(notificationId) {
        try {
          const response = await fetch(`${API_BASE_URL}/notificaciones/${notificationId}/marcar-leida/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': this.getCSRFToken(),
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            console.log(`‚úÖ Notificaci√≥n ${notificationId} marcada como le√≠da`);
          }
        } catch (error) {
          console.error('Error marcando notificaci√≥n como le√≠da:', error);
        }
      }

      closeAlert(alertId) {
        const alert = document.getElementById(alertId);
        if (alert) {
          alert.style.animation = 'slideOutRight 0.3s ease-in forwards';
          setTimeout(() => {
            if (alert.parentNode) {
              alert.parentNode.removeChild(alert);
            }
          }, 300);
        }
      }

      getCSRFToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      getIcon(tipo) {
        const icons = {
          'reserva_aprobada': '‚úÖ',
          'reserva_rechazada': '‚ùå',
          'reserva_creada': 'üìã',
          'reserva_cancelada': 'üìù',
          'reserva_pendiente': '‚è≥'
        };
        return icons[tipo] || 'üîî';
      }

      getPriorityColor(tipo) {
        const colors = {
          'reserva_aprobada': '#28a745',
          'reserva_rechazada': '#dc3545',
          'reserva_creada': '#0056d2',
          'reserva_cancelada': '#6c757d',
          'reserva_pendiente': '#ffc107'
        };
        return colors[tipo] || '#6c757d';
      }

      formatTime(timestamp) {
        try {
          const date = new Date(timestamp);
          return date.toLocaleTimeString('es-ES', { 
            hour: '2-digit', 
            minute: '2-digit' 
          });
        } catch (error) {
          return 'Ahora';
        }
      }

      playNotificationSound() {
        try {
          // Sonido de notificaci√≥n simple
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.frequency.value = 800;
          oscillator.type = 'sine';
          
          gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
          
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.5);
        } catch (error) {
          console.log('No se pudo reproducir sonido:', error);
        }
      }
    }

    // ===== FUNCIONES AUXILIARES =====
    function getNotificationClass(tipo) {
      const classMap = {
        'reserva_aprobada': 'aprobada',
        'reserva_rechazada': 'rechazada',
        'reserva_creada': 'pendiente',
        'reserva_cancelada': 'cancelada',
        'reserva_pendiente': 'pendiente'
      };
      return classMap[tipo] || 'pendiente';
    }

    function getNotificationTitle(tipo) {
      const titleMap = {
        'reserva_aprobada': 'Reserva Aprobada',
        'reserva_rechazada': 'Reserva Rechazada',
        'reserva_creada': 'Nueva Reserva Creada',
        'reserva_cancelada': 'Reserva Cancelada',
        'reserva_pendiente': 'Reserva Pendiente'
      };
      return titleMap[tipo] || 'Notificaci√≥n del Sistema';
    }

    function showTemporaryMessage(message, duration = 3000) {
      const messageDiv = document.createElement('div');
      messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #28a745;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        font-weight: 600;
      `;
      messageDiv.textContent = message;
      document.body.appendChild(messageDiv);
      
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.parentNode.removeChild(messageDiv);
        }
      }, duration);
    }

    function forceRefresh() {
      showTemporaryMessage('üîÑ Actualizando datos...');
      loadAllData().then(() => {
        showTemporaryMessage('‚úÖ Datos actualizados correctamente', 2000);
      }).catch(error => {
        showTemporaryMessage('‚ùå Error al actualizar datos', 2000);
      });
    }

    async function markAllAsRead() {
      try {
        const response = await fetch(`${API_BASE_URL}/notificaciones/marcar-todas-leidas/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': realTimeAlertSystem.getCSRFToken(),
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          showTemporaryMessage('‚úÖ Todas las notificaciones marcadas como le√≠das');
          setTimeout(() => loadAllData(), 1000);
        }
      } catch (error) {
        console.error('Error marcando todas como le√≠das:', error);
        showTemporaryMessage('‚ùå Error al marcar como le√≠das');
      }
    }

    function togglePreference(element) {
      element.classList.toggle('active');
      const preference = element.getAttribute('data-pref');
      showTemporaryMessage(`‚öôÔ∏è Preferencia ${preference} ${element.classList.contains('active') ? 'activada' : 'desactivada'}`);
    }

    // ===== INICIALIZACI√ìN =====
    let realTimeAlertSystem;

    document.addEventListener('DOMContentLoaded', async function() {
      try {
        // Inicializar sistema de alertas
        realTimeAlertSystem = new RealTimeAlertSystem();
        
        // Cargar datos iniciales
        await loadAllData();
        
        // Iniciar sistema de actualizaci√≥n autom√°tica
        startAutoRefresh();
        
        // Configurar event listeners para frecuencia
        document.querySelectorAll('input[name="frecuencia"]').forEach(radio => {
          radio.addEventListener('change', updateRefreshRate);
        });
        
        console.log('‚úÖ Sistema de notificaciones inicializado correctamente');
        
      } catch (error) {
        console.error('‚ùå Error inicializando:', error);
      }

      // Filtros
      document.querySelectorAll('.filters button').forEach(button => {
        button.addEventListener('click', function() {
          document.querySelectorAll('.filters button').forEach(btn => {
            btn.classList.remove('active');
          });
          this.classList.add('active');
          currentFilter = this.getAttribute('data-filter');
          renderNotifications(allNotifications, currentFilter);
          
          const filterNames = {
            'all': 'Todas',
            'pending': 'Pendientes',
            'approved': 'Aprobadas', 
            'rejected': 'Rechazadas',
            'canceled': 'Canceladas',
            'unread': 'No le√≠das'
          };
          showTemporaryMessage(`üîç Filtro aplicado: ${filterNames[currentFilter]}`);
        });
      });

      // Acciones de notificaciones
      document.addEventListener('click', function(e) {
        const button = e.target.closest('.actions button');
        if (button) {
          const action = button.getAttribute('data-action');
          const notificationId = button.getAttribute('data-notification-id');
          const notificacion = allNotifications.find(n => n.id == notificationId);
          
          if (notificacion) {
            switch(action) {
              case 'mark-read':
                realTimeAlertSystem.markAsRead(notificationId);
                const notificationElement = button.closest('.notification');
                notificationElement.classList.remove('unread');
                button.disabled = true;
                button.textContent = '‚úì Le√≠da';
                button.style.opacity = '0.6';
                break;
            }
          }
        }
      });

      // Detener actualizaci√≥n autom√°tica cuando la p√°gina no est√° visible
      document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
          stopAutoRefresh();
        } else {
          startAutoRefresh();
          setTimeout(() => realTimeAlertSystem.checkForAlerts(), 1000);
        }
      });
    });

    // Toggles de preferencias
    document.querySelectorAll('.toggle').forEach(toggle => {
      toggle.addEventListener('click', function() {
        this.classList.toggle('active');
      });
    });

    // Funci√≥n de fallback para datos de ejemplo
    function loadExampleData() {
      console.log('üìù Cargando datos de ejemplo...');
      const exampleNotifications = [
        {
          id: 1,
          type: 'reserva_aprobada',
          class: 'aprobada',
          title: 'üîî Reserva Aprobada <span class="badge badge-approved">Aprobada</span>',
          message: 'Tu reserva para <strong>Sala de Conferencias A1</strong> el <strong>15/03/2025</strong> de <strong>09:00 - 11:30</strong> ha sido <strong style="color: #28a745;">APROBADA</strong>!',
          timestamp: new Date().toISOString(),
          read: false,
          actions: [
            { text: 'Marcar como le√≠da', class: 'btn-secondary', action: 'mark-read' }
          ]
        }
      ];
      
      allNotifications = exampleNotifications;
      renderNotifications(allNotifications, currentFilter);
      document.getElementById('data-source').textContent = 'Datos de ejemplo (fallback)';
    }
  </script>
</body>
</html>